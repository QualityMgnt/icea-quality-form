<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Evaluations - Quality Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }
        .top-header {
            background-color: #003366;
            color: white;
            padding: 1rem;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 64px;
        }
        .main-nav {
            background-color: #002347;
            color: white;
            position: fixed;
            top: 64px;
            left: 0;
            height: calc(100% - 64px);
            width: 256px;
            z-index: 999;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #004a8d;
        }
        .logout-button {
            background-color: #ff6f61;
            color: white;
        }
        main {
            padding-top: 80px;
            padding-left: 272px;
            padding-right: 16px;
            padding-bottom: 16px;
        }
        .dashboard-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
        }
        .evaluation-table thead th {
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 2px solid #e5e7eb;
        }
        .evaluation-table tbody td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .hidden { display: none !important; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-container {
            background-color: white;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="top-header flex items-center justify-between px-4">
        <div></div>
        <span class="text-xl font-semibold">ICEA LION QUALITY EVALUATION AND MONITORING</span>
        <div class="relative">
            <i class="fas fa-bell text-2xl"></i>
            <span id="notification-badge" class="notification-badge hidden">0</span>
        </div>
    </header>

    <nav class="main-nav" id="mainNav">
        <div class="sidebar p-4 h-full relative">
            <ul>
                <li class="nav-tab mb-2"><a href="home.html" class="flex items-center p-2 rounded-md"><i class="fas fa-home w-6 mr-2"></i> Home</a></li>
                <li class="nav-tab mb-2"><a href="Dashboard.html" class="flex items-center p-2 rounded-md"><i class="fas fa-chart-bar w-6 mr-2"></i> Dashboard</a></li>
                <li class="nav-tab mb-2"><a href="index.html" class="flex items-center p-2 rounded-md"><i class="fas fa-file-alt w-6 mr-2"></i> Evaluation Form</a></li>
                <li class="nav-tab mb-2"><a href="myEvaluations.html" class="active flex items-center p-2 rounded-md"><i class="fas fa-user-check w-6 mr-2"></i> My Evaluations</a></li>
                <li class="nav-tab mb-2"><a href="images.html" class="flex items-center p-2 rounded-md"><i class="fas fa-image w-6 mr-2"></i> Images</a></li>
            </ul>
            <div class="absolute bottom-4 w-full pr-8">
                 <button id="logoutBtn" class="logout-button w-full font-bold py-2 px-4 rounded-md shadow-md">Logout</button>
            </div>
        </div>
    </nav>

    <main id="mainContent">
        <div id="loadingMessage" class="text-center py-12 text-lg text-gray-600">
            Loading Your Evaluations...
        </div>

        <div id="myEvaluationsContent" class="hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">My Evaluations</h1>
            
            <!-- My QA Audit Scores Table -->
            <div class="dashboard-card">
                <h2 class="text-xl font-semibold mb-4">My QA Audit Scores</h2>
                <div class="overflow-x-auto">
                    <table class="evaluation-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Contact ID</th>
                                <th>Reviewer</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="myCerScoresTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Review Requests Section (for reviewers) -->
            <div id="reviewRequestsSection" class="dashboard-card mt-6 hidden">
                <h2 class="text-xl font-semibold mb-4 text-orange-600">Review Requests</h2>
                <div class="overflow-x-auto">
                    <table class="evaluation-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Agent Name</th>
                                <th>Contact ID</th>
                                <th>Agent Comments</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reviewRequestsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Request Review Modal -->
    <div id="requestReviewModal" class="modal-overlay hidden">
        <div class="modal-container p-6">
            <h2 class="text-2xl font-bold mb-4">Request Review</h2>
            <input type="hidden" id="reviewRecordId">
            <label for="reviewComments" class="block font-medium mb-2">Please provide your reasons for requesting a review:</label>
            <textarea id="reviewComments" rows="5" class="w-full p-2 border rounded-md"></textarea>
            <div class="flex justify-end gap-4 mt-4">
                <button id="closeReviewModalBtn" class="bg-gray-200 px-4 py-2 rounded-md">Cancel</button>
                <button id="submitReviewRequestBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Submit Request</button>
            </div>
        </div>
    </div>
    
    <!-- Re-evaluation Modal -->
    <div id="reEvaluationModal" class="modal-overlay hidden">
        <div class="modal-container p-6">
            <h2 class="text-2xl font-bold mb-4">Re-evaluate Interaction</h2>
            <div id="reEvaluationBody" class="space-y-4"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="closeReEvalModalBtn" class="bg-gray-200 px-4 py-2 rounded-md">Cancel</button>
                <button id="submitReEvaluationBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md">Submit Re-evaluation</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.appspot.com",
            messagingSenderId: "820082472004",
            appId: "1:820082472004:web:8caddf941e1b5b667faf811",
        };
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const EVALUATION_RECORDS_PATH = `artifacts/${appId}/public/data/evaluation_records`;
        const USERS_PROFILE_COLLECTION_PATH = `artifacts/${appId}/users`;
        const QUESTIONS_CONFIG_DOC_REF = doc(db, `artifacts/${appId}/public/data/questions`, 'question_configurations');
        
        let loggedInUserName = null;
        let allRolesQuestions = {};
        let allMyEvaluations = [];
        let currentReEvalRecordId = null;

        async function fetchData(user) {
            const userProfileDocRef = doc(db, USERS_PROFILE_COLLECTION_PATH, user.uid);
            const docSnap = await getDoc(userProfileDocRef);
            loggedInUserName = docSnap.exists() ? docSnap.data().name : user.email;

            const questionsSnap = await getDoc(QUESTIONS_CONFIG_DOC_REF);
            allRolesQuestions = questionsSnap.exists() ? questionsSnap.data() : {};

            const cerQuery = query(collection(db, EVALUATION_RECORDS_PATH), where("CER Name", "==", loggedInUserName));
            onSnapshot(cerQuery, (snapshot) => {
                allMyEvaluations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCerScoresTable(allMyEvaluations);
            });

            const reviewRequestQuery = query(collection(db, EVALUATION_RECORDS_PATH), where("Reviewer's Name", "==", loggedInUserName), where("reviewStatus", "==", "Under Review"));
            onSnapshot(reviewRequestQuery, (snapshot) => {
                const requests = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderReviewRequests(requests);
                updateNotificationBell(requests.length);
            });

            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('myEvaluationsContent').classList.remove('hidden');
        }
        
        function renderCerScoresTable(records) {
            const tableBody = document.getElementById('myCerScoresTableBody');
            tableBody.innerHTML = '';
            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No audit scores found.</td></tr>`;
                return;
            }
            records.forEach(record => {
                const row = tableBody.insertRow();
                const status = record.reviewStatus || 'Completed';
                let statusClass = '';
                if (status === 'Under Review') statusClass = 'text-yellow-600';
                if (status === 'Review Completed') statusClass = 'text-green-600';

                row.innerHTML = `
                    <td>${record.submittedAt?.toDate().toLocaleDateString() || 'N/A'}</td>
                    <td>${record['Contact ID'] || 'N/A'}</td>
                    <td>${record["Reviewer's Name"] || 'N/A'}</td>
                    <td>${record['Overall Score'] || 'N/A'}</td>
                    <td class="font-bold ${statusClass}">${status}</td>
                    <td>
                        <button class="bg-blue-500 text-white px-2 py-1 rounded request-review-btn" data-record-id="${record.id}" ${status !== 'Completed' ? 'disabled' : ''}>Request Review</button>
                    </td>
                `;
            });
        }
        
        function renderReviewRequests(requests) {
            const section = document.getElementById('reviewRequestsSection');
            const tableBody = document.getElementById('reviewRequestsTableBody');
            tableBody.innerHTML = '';

            if (requests.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            requests.forEach(req => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${req.submittedAt?.toDate().toLocaleDateString() || 'N/A'}</td>
                    <td>${req['CER Name']}</td>
                    <td>${req['Contact ID']}</td>
                    <td class="text-sm">${req.reviewRequestComments || ''}</td>
                    <td><button class="bg-green-500 text-white px-2 py-1 rounded re-evaluate-btn" data-record-id="${req.id}">Re-evaluate</button></td>
                `;
            });
        }

        function updateNotificationBell(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        async function submitReviewRequest() {
            const recordId = document.getElementById('reviewRecordId').value;
            const comments = document.getElementById('reviewComments').value;
            if(!comments) {
                alert("Please provide comments for your review request.");
                return;
            }
            
            const docRef = doc(db, EVALUATION_RECORDS_PATH, recordId);
            await updateDoc(docRef, {
                reviewStatus: "Under Review",
                reviewRequestComments: comments
            });

            alert("Review request submitted!");
            document.getElementById('requestReviewModal').classList.add('hidden');
        }

        function openReEvaluationModal(recordId) {
            currentReEvalRecordId = recordId;
            const record = allMyEvaluations.find(r => r.id === recordId);
            if (!record) return;

            const body = document.getElementById('reEvaluationBody');
            body.innerHTML = '';
            const role = record['CER Role'];
            if (role && allRolesQuestions[role]) {
                Object.entries(allRolesQuestions[role]).forEach(([section, questions]) => {
                    body.innerHTML += `<h3 class="text-xl font-bold mt-4">${section}</h3>`;
                    questions.forEach(q => {
                        const rating = record[`${q.desc} (Rating)`] || '';
                        const remarks = record[`${q.desc} (Remarks)`] || '';
                        body.innerHTML += `
                            <div class="p-2 border rounded-md">
                                <p class="font-semibold">${q.desc}</p>
                                <select class="w-full p-1 border mt-1" data-question="${q.desc}">
                                    <option value="Yes" ${rating === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${rating === 'No' ? 'selected' : ''}>No</option>
                                    <option value="N/A" ${rating === 'N/A' ? 'selected' : ''}>N/A</option>
                                </select>
                                <textarea class="w-full p-1 border mt-1" rows="2" data-question="${q.desc}">${remarks}</textarea>
                            </div>
                        `;
                    });
                });
            }
            document.getElementById('reEvaluationModal').classList.remove('hidden');
        }

        async function submitReEvaluation() {
            if (!currentReEvalRecordId) return;

            const updatedData = { reviewStatus: 'Review Completed' };
            const reEvalBody = document.getElementById('reEvaluationBody');
            
            reEvalBody.querySelectorAll('select').forEach(select => {
                updatedData[`${select.dataset.question} (Rating)`] = select.value;
            });
            reEvalBody.querySelectorAll('textarea').forEach(textarea => {
                updatedData[`${textarea.dataset.question} (Remarks)`] = textarea.value;
            });

            // Recalculate score (simplified for this example)
            // A full implementation would use the question weights
            let yesCount = 0;
            let totalApplicable = 0;
            Object.entries(updatedData).forEach(([key, value]) => {
                if(key.includes('(Rating)') && (value === 'Yes' || value === 'No')) {
                    totalApplicable++;
                    if(value === 'Yes') yesCount++;
                }
            });
            updatedData['Overall Score'] = totalApplicable > 0 ? `${((yesCount / totalApplicable) * 100).toFixed(1)}%` : '0%';

            const docRef = doc(db, EVALUATION_RECORDS_PATH, currentReEvalRecordId);
            await updateDoc(docRef, updatedData);

            alert("Re-evaluation submitted!");
            document.getElementById('reEvaluationModal').classList.add('hidden');
        }
        

        onAuthStateChanged(auth, (user) => {
            if (user) {
                fetchData(user);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Event Listeners
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
        document.getElementById('closeReviewModalBtn').addEventListener('click', () => document.getElementById('requestReviewModal').classList.add('hidden'));
        document.getElementById('closeReEvalModalBtn').addEventListener('click', () => document.getElementById('reEvaluationModal').classList.add('hidden'));
        
        document.getElementById('myCerScoresTableBody').addEventListener('click', (e) => {
            if (e.target.classList.contains('request-review-btn')) {
                document.getElementById('reviewRecordId').value = e.target.dataset.recordId;
                document.getElementById('requestReviewModal').classList.remove('hidden');
            }
        });

        document.getElementById('reviewRequestsTableBody').addEventListener('click', (e) => {
            if (e.target.classList.contains('re-evaluate-btn')) {
                openReEvaluationModal(e.target.dataset.recordId);
            }
        });

        document.getElementById('submitReviewRequestBtn').addEventListener('click', submitReviewRequest);
        document.getElementById('submitReEvaluationBtn').addEventListener('click', submitReEvaluation);

    </script>
</body>
</html>
