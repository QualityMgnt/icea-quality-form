<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .signup-container {
            width: 100%;
            max-width: 400px;
        }
        .signup-header {
            background-color: #800080;
            color: white;
        }
    </style>
</head>
<body>
    <div id="messageBoxOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96 max-w-lg">
            <div id="messageBoxSpinner" class="spinner hidden mx-auto mb-4"></div>
            <h3 id="messageBoxTitle" class="text-xl font-semibold mb-4 text-center"></h3>
            <p id="messageBoxContent" class="text-gray-700 mb-4 text-center"></p>
            <div class="flex justify-center space-x-2">
                <button id="messageBoxCloseBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md">Close</button>
            </div>
        </div>
    </div>
    
    <div class="signup-container">
        <div class="bg-white p-8 rounded-lg shadow-md w-full">
            <div class="signup-header p-6 rounded-t-lg text-center">
                <h2 class="text-2xl font-semibold">Agent Sign Up</h2>
            </div>
            <form id="signupForm" class="p-8 space-y-6">
                <div>
                    <label for="cerName" class="block text-sm font-medium text-gray-700">Your Name (as CER)</label>
                    <select id="cerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                        <option value="">Select your name</option>
                    </select>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-md">Register</button>
                <p id="signupMessage" class="text-red-500 text-xs italic mt-4 hidden"></p>
                <p class="text-center text-sm mt-4">
                    Already have an account? <a href="index.html" class="text-blue-500 hover:underline">Log in</a>
                </p>
            </form>
        </div>
    </div>

    <script type="module" src="firebase-config.js"></script>
    <script type="module">
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const { auth, db, appId, fs, showMessageBox, hideMessageBox } = window.firebase;

        const signupForm = document.getElementById('signupForm');
        const cerNameSelect = document.getElementById('cerName');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signupMessage = document.getElementById('signupMessage');

        // Fetch CER names to populate dropdown
        async function fetchCerNamesAndPopulate() {
            const dropdownDocRef = fs.doc(db, `artifacts/${appId}/public/data/dropdown_options`, 'general_options');
            const docSnap = await fs.getDoc(dropdownDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const cerNames = data.cerNames || [];
                cerNameSelect.innerHTML = '<option value="">Select your name</option>';
                cerNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    cerNameSelect.appendChild(option);
                });
            }
        }

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            signupMessage.classList.add('hidden');
            showMessageBox('Registering...', 'Creating your new account.', false, true, false);

            const cerName = cerNameSelect.value;
            const email = emailInput.value;
            const password = passwordInput.value;

            if (password.length < 6) {
                hideMessageBox();
                showMessageBox('Error', 'Password must be at least 6 characters.', true, false, true);
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userProfile = {
                    name: cerName,
                    email: email,
                    role: 'agent',
                };
                await fs.setDoc(fs.doc(db, `artifacts/${appId}/users`, user.uid), userProfile);

                hideMessageBox();
                showMessageBox('Success', 'Account created successfully! You can now log in.', false, false, true, () => {
                    window.location.href = 'index.html';
                });
            } catch (error) {
                hideMessageBox();
                let msg = 'Registration failed. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    msg = 'This email is already registered.';
                }
                showMessageBox('Error', msg, true, false, true);
            }
        });

        window.addEventListener('load', () => {
            fetchCerNamesAndPopulate();
        });
    </script>
</body>
</html>
