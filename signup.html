<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Quality Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem; text-align: center; }
        .icealion-blue { background-color: #1a73e8; color: white; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-sm">
        <div class="icealion-blue p-6 rounded-t-lg text-center">
            <h1 class="text-2xl font-semibold">Create an Account</h1>
        </div>

        <form id="signUpForm" class="p-8 space-y-6">
            <div>
                <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="fullName" name="fullName"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                        required placeholder="e.g., Jane Doe">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" id="email" name="email"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                        required placeholder="you@example.com">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" name="password"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                        required placeholder="Minimum 6 characters">
            </div>
            <button type="button" id="signUpButton"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                Sign Up
            </button>
             <div class="text-center text-sm text-gray-600">
                Already have an account? 
                <a href="index.html" class="font-medium text-blue-600 hover:underline">Log In</a>
            </div>
            <div id="signUpMessage" class="error-message"></div>
        </form>
    </div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.firebasestorage.app",
            messagingSenderId: "820082472004",
            appId: "1:820082472004:web:8caddf941e1b5b667faf811",
            measurementId: "G-1RJJTT3QET"
        };
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;

        let appInstance;
        if (!getApps().length) {
            appInstance = initializeApp(firebaseConfig);
        } else {
            appInstance = getApp();
        }
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);

        const USERS_PROFILE_COLLECTION_PATH = `artifacts/${appId}/users`;
        const DROPDOWN_DATA_DOC_REF = doc(db, `artifacts/${appId}/public/data/dropdown_options`, 'general_options');

        const signUpButton = document.getElementById('signUpButton');
        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signUpMessage = document.getElementById('signUpMessage');

        signUpButton.addEventListener('click', async () => {
            const fullName = fullNameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            signUpMessage.textContent = '';

            if (!fullName || !email || !password) {
                signUpMessage.textContent = 'All fields are required.';
                return;
            }

            if (password.length < 6) {
                signUpMessage.textContent = 'Password must be at least 6 characters long.';
                return;
            }

            try {
                signUpButton.disabled = true;
                signUpButton.textContent = 'Signing up...';

                // 1. Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. Create user profile in Firestore with "Agent" role
                await setDoc(doc(db, USERS_PROFILE_COLLECTION_PATH, user.uid), {
                    name: fullName,
                    email: email,
                    role: 'Agent'
                });

                // 3. Add the new user's name to the CER Name dropdown list
                await updateDoc(DROPDOWN_DATA_DOC_REF, {
                    cerNames: arrayUnion({ name: fullName, email: email }) // Add as an object
                });

                alert('Sign-up successful! You will now be redirected to the login page.');
                window.location.href = 'index.html';

            } catch (error) {
                console.error("Sign Up Error:", error);
                if (error.code === 'auth/email-already-in-use') {
                    signUpMessage.textContent = 'This email address is already registered.';
                } else if (error.code === 'auth/invalid-email') {
                    signUpMessage.textContent = 'Please enter a valid email address.';
                } else {
                    signUpMessage.textContent = `An error occurred: ${error.message}`;
                }
            } finally {
                signUpButton.disabled = false;
                signUpButton.textContent = 'Sign Up';
            }
        });
    </script>
</body>
</html>
