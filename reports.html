<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles - consistent with index.html, users.html, admin.html */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Navigation styles (consistent sidebar) */
        .main-nav {
            width: auto;
            background-color: transparent;
            color: inherit;
            padding: 0;
            display: block;
            box-shadow: none;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .sidebar {
            width: 125px; /* Half width */
            background-color: #1a73e8;
            color: white;
            padding: 1rem 0;
            height: 100%;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar ul {
            list-style: none;
            margin: 0;
            padding: 0;
            flex-grow: 1;
        }
        .sidebar ul li {
            margin-right: 0;
            margin-bottom: 0.5rem;
        }
        .sidebar ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.75rem 0.5rem; /* Adjusted padding */
            display: block;
            border-radius: 0;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column; /* Stack icon and text */
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem; /* Smaller font */
            text-align: center;
        }
        .sidebar ul li a .fas {
            margin-bottom: 0.25rem;
            font-size: 1.2rem;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #0d47a1;
        }

        .logout-button {
            background-color: #f57c00;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin: 1rem auto;
            width: calc(100% - 2rem);
            font-size: 0.75rem;
        }
        .logout-button:hover {
            background-color: #e65100;
        }

        /* Main content area for reports.html */
        .main-content {
            margin-left: 125px; /* Matches sidebar width */
            width: calc(100% - 125px); /* Fills remaining space */
            padding: 1.5rem;
            min-height: 100vh;
            box-sizing: border-box; /* Include padding in width */
            display: block; /* Ensure it's visible by default without login check */
        }
        .reports-container {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 2rem;
            max-width: 900px; /* Limit width of reports content */
            margin: 0 auto; /* Center it */
        }

        /* Message Box styles (copied from index.html for consistency) */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8;
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Message Box Overlay (for loading, errors, confirmations) -->
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <!-- Main Navigation / Sidebar -->
    <nav class="main-nav" id="mainNav">
        <div class="sidebar">
            <ul>
                <!-- Ensure these paths are correct relative to reports.html -->
                <li><a href="index.html" id="auditFormTab"><i class="fas fa-file-alt"></i> Evaluation Form</a></li>
                <li><a href="index.html#database" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
                <li><a href="reports.html" id="reportsTab" class="active"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="autofails.html" id="autofailsTab"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
                <li><a href="index.html#shareResponse" id="shareResponseTab"><i class="fas fa-share-square"></i> Share Response</a></li>
                <li><a href="users.html" id="usersTab"><i class="fas fa-users"></i> Users</a></li>
                <li><a href="admin.html" id="adminTab"><i class="fas fa-user-cog"></i> Admin</a></li>
            </ul>
            <button id="logoutBtn" class="logout-button">Logout</button>
        </div>
    </nav>

    <!-- Main Content Area for Reports -->
    <div class="main-content" id="reportsContent">
        <div class="reports-container">
            <div class="icealion-blue p-4 text-xl font-semibold text-center">
                Reports Overview
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-4">
                    This section will display various reports and analytics based on the submitted quality assessment data.
                </p>
                <p class="text-blue-600 font-bold mb-4">
                    NOTE: Report generation would typically involve fetching aggregated data from Firestore and using a charting library (e.g., Chart.js, D3.js) to visualize the data.
                </p>

                <h3 class="text-2xl font-semibold text-gray-800 mt-8 mb-4">Sample Report Placeholder</h3>
                <div id="reportDisplayArea" class="border border-gray-300 p-4 rounded-md bg-gray-50 min-h-[200px] flex items-center justify-center text-gray-500 text-center">
                    <p>Click "Generate Report" to see data.</p>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Report Options:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="reportType" class="block text-sm font-medium text-gray-700">Report Type:</label>
                            <select id="reportType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                <option value="">Select a report</option>
                                <option value="overallScore">Overall Score Trends</option>
                                <option value="cerPerformance">CER Performance Breakdown</option>
                                <option value="autofailTrends">Autofail Trends</option>
                            </select>
                        </div>
                        <div>
                            <label for="dateRange" class="block text-sm font-medium text-gray-700">Date Range:</label>
                            <input type="month" id="dateRange" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    <button id="generateReportBtn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md">
                        Generate Report
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase SDK (Basic setup for logout functionality and consistency) -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signOut, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";


        // --- Your Web App's Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
          authDomain: "icea-lion-qa.firebaseapp.com",
          projectId: "icea-lion-qa",
          storageBucket: "icea-lion-qa.firebasestorage.app",
          messagingSenderId: "820082472004",
          appId: "1:820082472004:web:8caddf941e1b5b6dfaf811",
          measurementId: "G-1RJJTT3QET"
        };

        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase App and Services ONCE
        let appInstance;
        if (!getApps().length) {
            appInstance = initializeApp(firebaseConfig);
        } else {
            appInstance = getApp();
        }
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance); // Initialize Firestore

        window.auth = auth;
        window.currentUserId = null;
        window.isAuthReady = false;

        // Firestore Collection Path (consistent with index.html)
        const EVALUATION_RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/evaluation_records`;

        // Message Box functions (copied from index.html for consistency)
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxSpinner = document.getElementById('messageBoxSpinner');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxContent = document.getElementById('messageBoxContent');
            const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

            messageBoxTitle.textContent = title;
            if (typeof message === 'string' && message.startsWith('<pre>')) {
                messageBoxContent.innerHTML = message;
                messageBoxContent.classList.add('message-box-content-pre');
            } else {
                messageBoxContent.textContent = message;
                messageBoxContent.classList.remove('message-box-content-pre');
            }

            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            if (isError) {
                messageBoxTitle.style.color = '#dc2626';
            } else {
                messageBoxTitle.style.color = '#1a73e8';
            }

            messageBoxCloseBtn.onclick = null; 
            if (showCloseButton) {
                messageBoxCloseBtn.onclick = () => {
                    messageBoxOverlay.classList.add('hidden');
                    if (onClose) onClose();
                };
            }
        }

        function hideMessageBox() {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            messageBoxOverlay.classList.add('hidden');
        }


        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase Auth State Changed (reports.html): User logged in:", user.uid);
            } else {
                console.log("Firebase Auth State Changed (reports.html): No user logged in. Attempting sign-in.");
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        window.currentUserId = auth.currentUser.uid;
                        console.log("Signed in with custom token (reports.html):", window.currentUserId);
                    } catch (error) {
                        console.error("Error signing in with custom token (reports.html):", error);
                        try {
                            await signInAnonymously(auth);
                            window.currentUserId = auth.currentUser.uid;
                            console.log("Signed in anonymously (reports.html):", window.currentUserId);
                        } catch (anonError) {
                            console.error("Error signing in anonymously (reports.html):", anonError);
                        }
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                        window.currentUserId = auth.currentUser.uid;
                        console.log("Signed in anonymously (reports.html):", window.currentUserId);
                    } catch (anonError) {
                        console.error("Error signing in anonymously (reports.html):", anonError);
                    }
                }
                if (!window.currentUserId) {
                    console.error("No user ID available after authentication attempts (reports.html). Using random UUID as fallback.");
                    window.currentUserId = crypto.randomUUID();
                }
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('firebaseAuthReadyReportsPage')); // Custom event for this page
        });

        // Function to generate and display reports
        async function generateReport() {
            const reportDisplayArea = document.getElementById('reportDisplayArea');
            const reportType = document.getElementById('reportType').value;
            const dateRange = document.getElementById('dateRange').value; // YYYY-MM format

            if (!window.isAuthReady || !window.currentUserId) {
                showMessageBox("Authentication Required", "Please wait for authentication to complete before generating reports.", false, true, false);
                return;
            }
            if (!db) {
                showMessageBox("Database Not Ready", "Firestore is not initialized.", true, false, true);
                return;
            }

            showMessageBox("Generating Report", "Fetching data and preparing report...", false, true, false);

            reportDisplayArea.innerHTML = '<p class="text-gray-500">Loading report data...</p>';

            try {
                const recordsColRef = collection(db, EVALUATION_RECORDS_COLLECTION_PATH);
                const querySnapshot = await getDocs(recordsColRef);
                const allRecords = [];
                querySnapshot.forEach(doc => {
                    allRecords.push({ id: doc.id, ...doc.data() });
                });

                if (allRecords.length === 0) {
                    reportDisplayArea.innerHTML = '<p class="text-gray-500">No evaluation records found to generate a report.</p>';
                    hideMessageBox();
                    return;
                }

                let filteredRecords = allRecords;

                // Apply date range filter if selected
                if (dateRange) {
                    filteredRecords = allRecords.filter(record => {
                        const submittedAt = record.submittedAt;
                        if (!submittedAt) return false;

                        let recordDate;
                        try {
                            recordDate = typeof submittedAt.toDate === 'function' ? submittedAt.toDate() : new Date(submittedAt);
                            if (isNaN(recordDate.getTime())) return false; // Invalid date
                        } catch (e) {
                            return false; // Error parsing date
                        }
                        
                        const recordMonth = recordDate.getFullYear() + '-' + String(recordDate.getMonth() + 1).padStart(2, '0');
                        return recordMonth === dateRange;
                    });
                }

                let reportHtml = '';
                if (filteredRecords.length === 0) {
                    reportHtml = `<p class="text-gray-500">No records found for the selected criteria (Report Type: ${reportType || 'All'}, Date Range: ${dateRange || 'All'}).</p>`;
                } else {
                    switch (reportType) {
                        case 'overallScore':
                            // Calculate average overall score
                            let totalScore = 0;
                            let validScoresCount = 0;
                            filteredRecords.forEach(record => {
                                const scoreStr = record['Overall Score'];
                                if (scoreStr && scoreStr.endsWith('%')) {
                                    const score = parseFloat(scoreStr.replace('%', ''));
                                    if (!isNaN(score)) {
                                        totalScore += score;
                                        validScoresCount++;
                                    }
                                }
                            });
                            const averageScore = validScoresCount > 0 ? (totalScore / validScoresCount).toFixed(2) : 'N/A';
                            reportHtml = `
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Overall Score Trend for ${dateRange || 'All Time'}</h4>
                                <p class="text-2xl font-bold text-blue-700 mb-4">Average Overall Score: ${averageScore}%</p>
                                <p class="text-sm text-gray-600">Based on ${validScoresCount} evaluations.</p>
                                <div class="mt-4 text-left">
                                    <h5 class="font-semibold">Recent Scores:</h5>
                                    <ul class="list-disc list-inside">
                                        ${filteredRecords.slice(0, 5).map(r => `<li>${r['CER Name'] || 'N/A'} - ${r['Overall Score'] || 'N/A'} (Contact ID: ${r['Contact ID'] || 'N/A'}, Date: ${r.submittedAt ? new Date(r.submittedAt.toDate()).toLocaleDateString() : 'N/A'})</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                            break;
                        case 'cerPerformance':
                            // Group by CER Name and calculate average score
                            const cerScores = {};
                            filteredRecords.forEach(record => {
                                const cerName = record['CER Name'];
                                const scoreStr = record['Overall Score'];
                                if (cerName && scoreStr && scoreStr.endsWith('%')) {
                                    const score = parseFloat(scoreStr.replace('%', ''));
                                    if (!isNaN(score)) {
                                        if (!cerScores[cerName]) {
                                            cerScores[cerName] = { total: 0, count: 0 };
                                        }
                                        cerScores[cerName].total += score;
                                        cerScores[cerName].count++;
                                    }
                                }
                            });

                            reportHtml = `<h4 class="text-lg font-semibold text-gray-700 mb-2">CER Performance Breakdown for ${dateRange || 'All Time'}</h4>`;
                            if (Object.keys(cerScores).length > 0) {
                                reportHtml += `<ul class="list-disc list-inside text-left">`;
                                for (const cerName in cerScores) {
                                    const avg = (cerScores[cerName].total / cerScores[cerName].count).toFixed(2);
                                    reportHtml += `<li><strong>${cerName}</strong>: Average Score ${avg}% (${cerScores[cerName].count} evaluations)</li>`;
                                }
                                reportHtml += `</ul>`;
                            } else {
                                reportHtml += `<p class="text-gray-500">No CER performance data found for the selected period.</p>`;
                            }
                            break;
                        case 'autofailTrends':
                            // Count autofail types
                            const autofailCounts = {};
                            filteredRecords.forEach(record => {
                                const autofailType = record['Auto Fail Type'];
                                if (autofailType) {
                                    autofailCounts[autofailType] = (autofailCounts[autofailType] || 0) + 1;
                                }
                            });

                            reportHtml = `<h4 class="text-lg font-semibold text-gray-700 mb-2">Autofail Trends for ${dateRange || 'All Time'}</h4>`;
                            if (Object.keys(autofailCounts).length > 0) {
                                reportHtml += `<ul class="list-disc list-inside text-left">`;
                                for (const type in autofailCounts) {
                                    reportHtml += `<li><strong>${type}</strong>: ${autofailCounts[type]} occurrences</li>`;
                                }
                                reportHtml += `</ul>`;
                            } else {
                                reportHtml += `<p class="text-gray-500">No autofail incidents recorded for the selected period.</p>`;
                            }
                            break;
                        default:
                            reportHtml = `<p class="text-gray-500">Please select a report type to generate a specific report.</p>`;
                            break;
                    }
                }
                
                reportDisplayArea.innerHTML = reportHtml;
                hideMessageBox();

            } catch (error) {
                console.error("Error generating report:", error);
                reportDisplayArea.innerHTML = `<p class="text-red-500">Error generating report: ${error.message}</p>`;
                hideMessageBox();
                showMessageBox("Report Generation Failed", `Could not generate report: ${error.message}`, true, false, true);
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            const mainNav = document.getElementById('mainNav');
            const logoutBtn = document.getElementById('logoutBtn');
            const reportsContent = document.getElementById('reportsContent');
            const generateReportBtn = document.getElementById('generateReportBtn'); // Get the button

            // --- Function to check login state and display content ---
            const checkLoginAndDisplayContent = () => {
                const isLoggedIn = sessionStorage.getItem('loggedIn');
                if (isLoggedIn === 'true') {
                    mainNav.style.display = 'block'; // Show sidebar
                    reportsContent.style.display = 'block'; // Show reports content
                    // Highlight the current tab
                    document.querySelectorAll('.sidebar ul li a').forEach(link => {
                        link.classList.remove('active');
                        if (link.href.includes('reports.html')) {
                            link.classList.add('active');
                        }
                    });
                } else {
                    // If not logged in via sessionStorage, redirect to index.html
                    window.location.href = 'index.html';
                }
            };

            // Call initializer on Firebase Auth Ready
            document.addEventListener('firebaseAuthReadyReportsPage', checkLoginAndDisplayContent);

            // Fallback for fast loads where auth might be ready before DOMContentLoaded
            if (document.readyState === 'complete' && window.isAuthReady !== null) {
                checkLoginAndDisplayContent();
            }

            // --- Logout Functionality ---
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth); // Sign out from Firebase Auth
                    sessionStorage.removeItem('loggedIn'); // Clear custom login state
                    window.location.href = 'index.html'; // Redirect to main login page
                } catch (error) {
                    console.error("Error signing out:", error);
                    // No specific error message display for reports page for now, just redirect
                }
            });

            // --- Navigation Link Event Listeners (for other pages) ---
            // These ensure the sidebar links work correctly on reports.html
            document.getElementById('auditFormTab').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'index.html'; });
            document.getElementById('databaseTab').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'index.html#database'; });
            document.getElementById('autofailsTab').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'autofails.html'; });
            document.getElementById('shareResponseTab').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'index.html#shareResponse'; });
            document.getElementById('usersTab').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'users.html'; });
            document.getElementById('adminTab').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'admin.html'; });

            // --- Generate Report Button Listener ---
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', generateReport);
            }
        });
    </script>
</body>
</html>
