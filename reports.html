<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js Library for dynamic graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles */
        .error-message {
            color: #dc2626; /* red-700 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }

        /* Navigation styles */
        .main-nav {
            width: 100%;
            background-color: #1a73e8;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .main-nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .main-nav ul li {
            margin-right: 1.5rem;
        }
        .main-nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.3s ease;
        }
        .main-nav ul li a:hover,
        .main-nav ul li a.active {
            background-color: #0d47a1; /* A darker blue for hover/active */
        }
        .logout-button {
            background-color: #f57c00; /* icealion-orange */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background-color: #e65100; /* darker orange */
        }

        /* Report specific styles */
        .report-section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .report-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937; /* gray-800 */
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .report-table th, .report-table td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        .report-table th {
            background-color: #eff6ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
        }
        .report-table tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        .report-table tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        /* Loading Spinner for reports */
        .report-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        /* Message Box styles */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8; /* icealion-blue */
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }

        /* NEW: Styles for aligning table and chart */
        .report-content-flex {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            gap: 1.5rem; /* Space between table and chart */
            align-items: flex-start; /* Align content to the top */
        }
        .report-content-flex > div {
            flex: 1 1 45%; /* Allow divs to grow/shrink, base width ~45% */
            min-width: 300px; /* Minimum width before wrapping */
        }
        .table-container, .chart-container {
            flex: 1; /* Allow equal distribution if there's space */
        }

        .chart-container {
            padding: 1rem;
            background-color: #f8fafc; /* light blue background */
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; /* Use flex to center message/spinner if no chart */
            align-items: center;
            justify-content: center;
            min-height: 250px; /* Ensure chart container has a minimum height */
        }
        canvas {
            max-width: 100%;
            height: 300px; /* Fixed height for charts for consistency */
        }
        /* Hide canvas when no data or loading */
        canvas.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="report-spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <div class="login-container absolute inset-0 flex items-center justify-center p-4 md:p-8 z-10" id="loginPage">
        <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-md">
            <div class="icealion-blue p-6 rounded-t-lg text-center">
                <h1 class="text-2xl font-semibold">ICEALION GROUP Login</h1>
            </div>

            <form id="loginForm" class="p-8 space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your username">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your password">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Login
                </button>
                <div id="loginMessage" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <nav class="main-nav" id="mainNav" style="display: none;">
        <ul>
            <li><a href="index.html" id="auditFormTab"><i class="fas fa-file-alt"></i> Audit Form</a></li>
            <li><a href="index.html#database" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
            <li><a href="reports.html" id="reportsTab" class="active"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="autofails.html" id="autofailsTab"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
        </ul>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </nav>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-4xl mt-8 mb-8" id="reportsContent" style="display: none;">
        <div class="icealion-blue p-4 text-xl font-semibold text-center">
            Agent Performance Reports
        </div>
        <div class="p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Report Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="reportMonth" class="block text-sm font-medium text-gray-700">Month</label>
                    <select id="reportMonth" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        <option value="">Select Month</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div>
                    <label for="reportYear" class="block text-sm font-medium text-gray-700">Year</label>
                    <input type="number" id="reportYear" min="2020" max="2100" value="2025"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="flex items-end">
                    <button id="generateReportBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-chart-line mr-2"></i>Generate Report
                    </button>
                </div>
            </div>

            <!-- Report Section: Audits Per Agent -->
            <div id="auditsPerAgentReport" class="report-section">
                <h3>Audits Per Agent</h3>
                <div class="report-content-flex">
                    <div class="table-container">
                        <div class="report-loading-spinner report-spinner hidden"></div>
                        <p id="auditsPerAgentMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                        <table class="report-table hidden">
                            <thead>
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Number of Audits</th>
                                </tr>
                            </thead>
                            <tbody id="auditsPerAgentTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="auditsPerAgentChart" class="hidden"></canvas>
                        <p id="auditsPerAgentChartMessage" class="text-sm text-gray-500 text-center">No chart data available for this report.</p>
                    </div>
                </div>
            </div>

            <!-- Report Section: Autofails Per CER Role -->
            <div id="autofailsPerRoleReport" class="report-section">
                <h3>Number of Autofails Per CER Role</h3>
                <div class="report-content-flex">
                    <div class="table-container">
                        <div class="report-loading-spinner report-spinner hidden"></div>
                        <p id="autofailsPerRoleMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                        <table class="report-table hidden">
                            <thead>
                                <tr>
                                    <th>CER Role</th>
                                    <th>Autofail Count</th>
                                </tr>
                            </thead>
                            <tbody id="autofailsPerRoleTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="autofailsPerRoleChart" class="hidden"></canvas>
                        <p id="autofailsPerRoleChartMessage" class="text-sm text-gray-500 text-center">No chart data available for this report.</p>
                    </div>
                </div>
            </div>

            <!-- Report Section: Average Quality Score Per CER Role -->
            <div id="qualityScorePerRoleReport" class="report-section">
                <h3>Average Quality Score Per CER Role</h3>
                <div class="report-content-flex">
                    <div class="table-container">
                        <div class="report-loading-spinner report-spinner hidden"></div>
                        <p id="qualityScorePerRoleMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                        <table class="report-table hidden">
                            <thead>
                                <tr>
                                    <th>CER Role</th>
                                    <th>Average Score</th>
                                </tr>
                            </thead>
                            <tbody id="qualityScorePerRoleTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="qualityScorePerRoleChart" class="hidden"></canvas>
                        <p id="qualityScorePerRoleChartMessage" class="text-sm text-gray-500 text-center">No chart data available for this report.</p>
                    </div>
                </div>
            </div>

            <!-- Report Section: Number of Autofails Per CER Name -->
            <div id="autofailsPerCERNameReport" class="report-section">
                <h3>Number of Autofails Per CER Name</h3>
                <div class="report-content-flex">
                    <div class="table-container">
                        <div class="report-loading-spinner report-spinner hidden"></div>
                        <p id="autofailsPerCERNameMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                        <table class="report-table hidden">
                            <thead>
                                <tr>
                                    <th>CER Name</th>
                                    <th>Autofail Count</th>
                                </tr>
                            </thead>
                            <tbody id="autofailsPerCERNameTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="autofailsPerCERNameChart" class="hidden"></canvas>
                        <p id="autofailsPerCERNameChartMessage" class="text-sm text-gray-500 text-center">No chart data available for this report.</p>
                    </div>
                </div>
            </div>

            <!-- Report Section: Number of Audits Per CER Name -->
            <div id="auditsPerCERNameReport" class="report-section">
                <h3>Number of Audits Per CER Name</h3>
                <div class="report-content-flex">
                    <div class="table-container">
                        <div class="report-loading-spinner report-spinner hidden"></div>
                        <p id="auditsPerCERNameMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                        <table class="report-table hidden">
                            <thead>
                                <tr>
                                    <th>CER Name</th>
                                    <th>Number of Audits</th>
                                </tr>
                            </thead>
                            <tbody id="auditsPerCERNameTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="auditsPerCERNameChart" class="hidden"></canvas>
                        <p id="auditsPerCERNameChartMessage" class="text-sm text-gray-500 text-center">No chart data available for this report.</p>
                    </div>
                </div>
            </div>

            <!-- Report Section: Average QA Score Per CER Name -->
            <div id="averageQAScoreReport" class="report-section">
                <h3>Average QA Score Per CER Name</h3>
                <div class="report-content-flex">
                    <div class="table-container">
                        <div class="report-loading-spinner report-spinner hidden"></div>
                        <p id="averageQAScoreMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                        <table class="report-table hidden">
                            <thead>
                                <tr>
                                    <th>CER Name</th>
                                    <th>Average Score</th>
                                </tr>
                            </thead>
                            <tbody id="averageQAScoreTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="averageQAScoreChart" class="hidden"></canvas>
                        <p id="averageQAScoreChartMessage" class="text-sm text-gray-500 text-center">No chart data available for this report.</p>
                    </div>
                </div>
            </div>

            <!-- Report Section: Autofails Per Autofail Area -->
            <div id="autofailsPerAreaReport" class="report-section">
                <h3>Number of Autofails Per Autofail Area</h3>
                <div class="report-content-flex">
                    <div class="table-container">
                        <div class="report-loading-spinner report-spinner hidden"></div>
                        <p id="autofailsPerAreaMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                        <table class="report-table hidden">
                            <thead>
                                <tr>
                                    <th>Autofail Area</th>
                                    <th>Autofail Count</th>
                                </tr>
                            </thead>
                            <tbody id="autofailsPerAreaTableBody"></tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="autofailsPerAreaChart" class="hidden"></canvas>
                        <p id="autofailsPerAreaChartMessage" class="text-sm text-gray-500 text-center">No chart data available for this report.</p>
                    </div>
                </div>
            </div>

            <!-- Report Section: Autofails Overview (No Chart for this summary) -->
            <div id="autofailsOverviewReport" class="report-section">
                <h3>Autofails Overview (Total for Period)</h3>
                <div class="report-loading-spinner report-spinner hidden"></div>
                <p id="autofailsOverviewMessage" class="text-sm text-gray-500 text-center">Select a month and year and click "Generate Report".</p>
                <table class="report-table hidden">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="autofailsOverviewTableBody">
                        <tr><td>Total Audits:</td><td id="totalAuditsCount">0</td></tr>
                        <tr><td>Total Autofails:</td><td id="totalAutofailsCount">0</td></tr>
                        <tr><td>Autofail Percentage:</td><td id="autofailPercentage">0%</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // --- Your Web App's Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
          authDomain: "icea-lion-qa.firebaseapp.com",
          projectId: "icea-lion-qa",
          storageBucket: "icea-lion-qa.firebasestorage.app",
          messagingSenderId: "820082472004",
          appId: "1:820082472004:web:8caddf941e1b5b6dfaf811",
          measurementId: "G-1RJJTT3QET"
        };

        // Determine the 'appId' for Firestore collection paths.
        // Use the injected __app_id from Canvas environment if available, otherwise use the appId from your firebaseConfig.
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;

        // The initialAuthToken is for specific hosting environments. For general GitHub Pages, it will be null.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- GLOBAL Firebase Objects (accessible via window) ---
        // Initialize Firebase App, Firestore, and Auth.
        // These are made global so the main script can access them after the module loads.
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        
        // Expose necessary Firestore functions for the report logic
        window.fsCollection = collection;
        window.fsGetDocs = getDocs; 
        window.fsQuery = query;
        window.fsWhere = where;

        window.currentUserId = null;
        window.isAuthReady = false;

        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase Auth State Changed: User logged in:", user.uid);
            } else {
                console.log("Firebase Auth State Changed: No user logged in. Attempting sign-in.");
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in with custom token:", window.currentUserId);
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        try {
                            await signInAnonymously(window.auth);
                            window.currentUserId = window.auth.currentUser.uid;
                            console.log("Signed in anonymously:", window.currentUserId);
                        } catch (anonError) {
                            console.error("Error signing in anonymously (fallback):", anonError);
                        }
                    }
                } else {
                    try {
                        await signInAnonymously(window.auth);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in anonymously:", window.currentUserId);
                    } catch (anonError) {
                        console.error("Error signing in anonymously:", anonError);
                    }
                }
                if (!window.currentUserId) {
                    console.error("No user ID available after authentication attempts. Using random UUID as fallback.");
                    window.currentUserId = crypto.randomUUID();
                }
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
        });

        // Moved this definition here to ensure it's available after Firebase is initialized
        window.EVALUATION_RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/evaluation_records`;

    </script>
    <script>
        // --- GLOBAL DATA STORES ---
        let allReportRecords = []; // Stores records fetched for current report
        let reportMonth = new Date().getMonth() + 1; // Default to current month
        let reportYear = new Date().getFullYear(); // Default to current year

        // Global Chart.js instances to allow updating existing charts
        let chartInstances = {};

        // --- UI ELEMENTS ---
        const loginPage = document.getElementById('loginPage');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');

        const mainNav = document.getElementById('mainNav');
        const reportsTab = document.getElementById('reportsTab'); // This page's tab
        const logoutBtn = document.getElementById('logoutBtn');

        const reportsContent = document.getElementById('reportsContent');

        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearInput = document.getElementById('reportYear');
        const generateReportBtn = document.getElementById('generateReportBtn');

        // References for each report section's elements
        const reportSections = [
            'auditsPerAgent', 'autofailsPerRole', 'qualityScorePerRole',
            'autofailsPerCERName', 'auditsPerCERName', 'averageQAScore',
            'autofailsPerArea', 'autofailsOverview' // Overview section does not get a chart
        ].reduce((acc, id) => {
            acc[id] = {
                div: document.getElementById(`${id}Report`),
                message: document.getElementById(`${id}Message`),
                spinner: document.getElementById(`${id}Report`).querySelector('.report-spinner'),
                table: document.getElementById(`${id}Report`).querySelector('.report-table'),
                tableBody: document.getElementById(`${id}TableBody`),
                chartCanvas: document.getElementById(`${id}Chart`), // May be null for overview
                chartMessage: document.getElementById(`${id}ChartMessage`), // May be null for overview
            };
            return acc;
        }, {});

        // Specific overview elements
        const totalAuditsCount = document.getElementById('totalAuditsCount');
        const totalAutofailsCount = document.getElementById('totalAutofailsCount');
        const autofailPercentage = document.getElementById('autofailPercentage');

        // Message Box elements
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxSpinner = document.getElementById('messageBoxSpinner');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');


        // --- MESSAGE BOX FUNCTIONS ---
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            if (isError) {
                messageBoxTitle.style.color = '#dc2626';
            } else {
                messageBoxTitle.style.color = '#1a73e8';
            }

            messageBoxCloseBtn.onclick = () => {
                messageBoxOverlay.classList.add('hidden');
                if (onClose) onClose();
            };
        }

        function hideMessageBox() {
            messageBoxOverlay.classList.add('hidden');
        }

        // Helper to safely parse score percentage (e.g., "94%" to 94)
        function parseScore(scoreString) {
            if (typeof scoreString !== 'string') return 0;
            const match = scoreString.match(/(\d+\.?\d*)%/); // Allows for decimal scores
            return match ? parseFloat(match[1]) : 0;
        }

        // Helper function to create or update a Chart.js instance
        function createOrUpdateChart(chartId, type, labels, data, title, xLabel, yLabel, backgroundColor = 'rgba(26, 115, 232, 0.7)') {
            const chartCanvas = reportSections[chartId].chartCanvas;
            const chartMessage = reportSections[chartId].chartMessage;

            if (!chartCanvas) return; // No canvas for this report (e.g., overview)

            if (data.length === 0) {
                chartCanvas.classList.add('hidden');
                chartMessage.classList.remove('hidden');
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy(); // Destroy old instance if no data
                    delete chartInstances[chartId];
                }
                return;
            }

            chartCanvas.classList.remove('hidden');
            chartMessage.classList.add('hidden');

            const chartData = {
                labels: labels,
                datasets: [{
                    label: yLabel, // Use yLabel for dataset label
                    data: data,
                    backgroundColor: backgroundColor,
                    borderColor: 'rgba(26, 115, 232, 1)', // Darker border for icealion-blue
                    borderWidth: 1
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: yLabel
                        },
                        ticks: {
                            callback: function(value) {
                                // Add '%' for score charts
                                return title.includes('Score') ? `${value}%` : value;
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: xLabel
                        }
                    }
                }
            };

            if (chartInstances[chartId]) {
                // Update existing chart
                chartInstances[chartId].data = chartData;
                chartInstances[chartId].options = chartOptions;
                chartInstances[chartId].update();
            } else {
                // Create new chart
                const ctx = chartCanvas.getContext('2d');
                chartInstances[chartId] = new Chart(ctx, {
                    type: type,
                    data: chartData,
                    options: chartOptions
                });
            }
        }


        // --- REPORT GENERATION FUNCTIONS ---

        async function generateReport() {
            if (!window.db || !window.currentUserId) {
                showMessageBox("Authentication Required", "Please log in to generate reports.", true, false, true);
                return;
            }
            if (!window.EVALUATION_RECORDS_COLLECTION_PATH) {
                showMessageBox("Configuration Error", "Firestore paths not set up. Check Firebase configuration. Collection path missing.", true, false, true);
                return;
            }

            const selectedMonth = parseInt(reportMonthSelect.value);
            const selectedYear = parseInt(reportYearInput.value);

            if (isNaN(selectedMonth) || isNaN(selectedYear) || selectedMonth < 1 || selectedMonth > 12) {
                showMessageBox("Invalid Date", "Please select a valid month and year.", true, false, true);
                return;
            }

            // Hide previous tables/charts, show loading indicators
            Object.values(reportSections).forEach(section => {
                section.message.classList.add('hidden');
                section.table.classList.add('hidden');
                section.spinner.classList.remove('hidden');
                if (section.chartCanvas) section.chartCanvas.classList.add('hidden');
                if (section.chartMessage) section.chartMessage.classList.add('hidden');
            });

            showMessageBox("Generating Report", `Fetching data for ${reportMonthSelect.options[reportMonthSelect.selectedIndex].text}, ${selectedYear}...`, false, true, false);

            try {
                const recordsColRef = window.fsCollection(window.db, window.EVALUATION_RECORDS_COLLECTION_PATH);
                
                // Firestore queries for month/year range
                // submittedAt is a Firestore Timestamp, which needs to be compared with Timestamp objects
                const startDate = new Date(selectedYear, selectedMonth - 1, 1); // Month is 0-indexed
                const endDate = new Date(selectedYear, selectedMonth, 0, 23, 59, 59, 999); // Last day of month, end of day

                const q = window.fsQuery(recordsColRef, 
                    window.fsWhere('submittedAt', '>=', startDate),
                    window.fsWhere('submittedAt', '<=', endDate)
                );
                
                const querySnapshot = await window.fsGetDocs(q);
                allReportRecords = [];
                querySnapshot.forEach(doc => {
                    allReportRecords.push(doc.data());
                });

                console.log(`Fetched ${allReportRecords.length} records for report.`);

                // Render all reports and charts
                renderAutofailsOverviewReport(allReportRecords);
                renderAuditsPerAgentReport(allReportRecords);
                renderAutofailsPerRoleReport(allReportRecords);
                renderQualityScorePerRoleReport(allReportRecords);
                renderAutofailsPerCERNameReport(allReportRecords);
                renderAuditsPerCERNameReport(allReportRecords);
                renderAverageQAScoreReport(allReportRecords);
                renderAutofailsPerAreaReport(allReportRecords);

                hideMessageBox(); // Hide message box on success

            } catch (error) {
                console.error("Error generating report:", error);
                showMessageBox("Report Error", `Failed to generate report: ${error.message}`, true, false, true);
            } finally {
                // Hide all spinners regardless of success or failure
                Object.values(reportSections).forEach(section => {
                    section.spinner.classList.add('hidden');
                });
            }
        }

        // Render functions for each report table and its corresponding chart
        function renderAuditsPerAgentReport(records) {
            reportSections.auditsPerAgent.tableBody.innerHTML = '';
            const agentCounts = {};

            records.forEach(record => {
                const cerName = record['CER Name'] || 'N/A';
                agentCounts[cerName] = (agentCounts[cerName] || 0) + 1;
            });

            const labels = Object.keys(agentCounts);
            const data = Object.values(agentCounts);

            if (labels.length === 0) {
                reportSections.auditsPerAgent.message.textContent = "No audits found for selected period.";
                reportSections.auditsPerAgent.message.classList.remove('hidden');
                reportSections.auditsPerAgent.table.classList.add('hidden');
            } else {
                for (const agent in agentCounts) {
                    const row = reportSections.auditsPerAgent.tableBody.insertRow();
                    row.insertCell().textContent = agent;
                    row.insertCell().textContent = agentCounts[agent];
                }
                reportSections.auditsPerAgent.message.classList.add('hidden');
                reportSections.auditsPerAgent.table.classList.remove('hidden');
            }
            createOrUpdateChart('auditsPerAgent', 'bar', labels, data, 'Audits Per Agent', 'Agent Name', 'Number of Audits');
        }

        function renderAutofailsOverviewReport(records) {
            let totalAudits = records.length;
            // Use 'Auto Fail Type' field to check for autofails, as per previous conversation
            let totalAutofails = records.filter(record => record['Auto Fail Type'] && record['Auto Fail Type'].trim() !== '').length;
            let autofailPct = totalAudits > 0 ? ((totalAutofails / totalAudits) * 100).toFixed(0) : 0;

            totalAuditsCount.textContent = totalAudits;
            totalAutofailsCount.textContent = totalAutofails;
            autofailPercentage.textContent = `${autofailPct}%`;

            reportSections.autofailsOverview.message.classList.add('hidden');
            reportSections.autofailsOverview.table.classList.remove('hidden');
        }

        function renderAutofailsPerRoleReport(records) {
            reportSections.autofailsPerRole.tableBody.innerHTML = '';
            const roleAutofailCounts = {};

            records.forEach(record => {
                const cerRole = record['CER Role'] || 'N/A';
                if (record['Auto Fail Type'] && record['Auto Fail Type'].trim() !== '') { // Check for any autofail type
                    roleAutofailCounts[cerRole] = (roleAutofailCounts[cerRole] || 0) + 1;
                }
            });

            const labels = Object.keys(roleAutofailCounts);
            const data = Object.values(roleAutofailCounts);

            if (labels.length === 0) {
                reportSections.autofailsPerRole.message.textContent = "No autofails found per CER role for selected period.";
                reportSections.autofailsPerRole.message.classList.remove('hidden');
                reportSections.autofailsPerRole.table.classList.add('hidden');
            } else {
                for (const role in roleAutofailCounts) {
                    const row = reportSections.autofailsPerRole.tableBody.insertRow();
                    row.insertCell().textContent = role;
                    row.insertCell().textContent = roleAutofailCounts[role];
                }
                reportSections.autofailsPerRole.message.classList.add('hidden');
                reportSections.autofailsPerRole.table.classList.remove('hidden');
            }
            createOrUpdateChart('autofailsPerRole', 'bar', labels, data, 'Autofails Per CER Role', 'CER Role', 'Autofail Count', 'rgba(245, 124, 0, 0.7)'); // icealion-orange
        }

        function renderQualityScorePerRoleReport(records) {
            reportSections.qualityScorePerRole.tableBody.innerHTML = '';
            const roleScores = {}; // { 'Role': { sum: 0, count: 0 } }

            records.forEach(record => {
                const cerRole = record['CER Role'] || 'N/A';
                const score = parseScore(record['Overall Score']);

                if (!isNaN(score) && record['Overall Score'] && record['Overall Score'].trim() !== '') { // Ensure score is valid and not empty
                    if (!roleScores[cerRole]) {
                        roleScores[cerRole] = { sum: 0, count: 0 };
                    }
                    roleScores[cerRole].sum += score;
                    roleScores[cerRole].count++;
                }
            });

            const labels = Object.keys(roleScores);
            const data = labels.map(role => roleScores[role].count > 0 ? (roleScores[role].sum / roleScores[role].count).toFixed(0) : 0);

            if (labels.length === 0) {
                reportSections.qualityScorePerRole.message.textContent = "No scores found per CER role for selected period.";
                reportSections.qualityScorePerRole.message.classList.remove('hidden');
                reportSections.qualityScorePerRole.table.classList.add('hidden');
            } else {
                for (const role in roleScores) {
                    const avg = roleScores[role].count > 0 ? (roleScores[role].sum / roleScores[role].count).toFixed(0) : 0;
                    const row = reportSections.qualityScorePerRole.tableBody.insertRow();
                    row.insertCell().textContent = role;
                    row.insertCell().textContent = `${avg}%`;
                }
                reportSections.qualityScorePerRole.message.classList.add('hidden');
                reportSections.qualityScorePerRole.table.classList.remove('hidden');
            }
            createOrUpdateChart('qualityScorePerRole', 'bar', labels, data, 'Average Quality Score Per CER Role', 'CER Role', 'Average Score (%)', 'rgba(76, 175, 80, 0.7)'); // Greenish color
        }

        function renderAutofailsPerCERNameReport(records) {
            reportSections.autofailsPerCERName.tableBody.innerHTML = '';
            const cerNameAutofailCounts = {};

            records.forEach(record => {
                const cerName = record['CER Name'] || 'N/A';
                if (record['Auto Fail Type'] && record['Auto Fail Type'].trim() !== '') { // Check for any autofail type
                    cerNameAutofailCounts[cerName] = (cerNameAutofailCounts[cerName] || 0) + 1;
                }
            });

            const labels = Object.keys(cerNameAutofailCounts);
            const data = Object.values(cerNameAutofailCounts);

            if (labels.length === 0) {
                reportSections.autofailsPerCERName.message.textContent = "No autofails found per CER name for selected period.";
                reportSections.autofailsPerCERName.message.classList.remove('hidden');
                reportSections.autofailsPerCERName.table.classList.add('hidden');
            } else {
                for (const name in cerNameAutofailCounts) {
                    const row = reportSections.autofailsPerCERName.tableBody.insertRow();
                    row.insertCell().textContent = name;
                    row.insertCell().textContent = cerNameAutofailCounts[name];
                }
                reportSections.autofailsPerCERName.message.classList.add('hidden');
                reportSections.autofailsPerCERName.table.classList.remove('hidden');
            }
            createOrUpdateChart('autofailsPerCERName', 'bar', labels, data, 'Autofails Per CER Name', 'CER Name', 'Autofail Count', 'rgba(239, 68, 68, 0.7)'); // Reddish color
        }

        function renderAuditsPerCERNameReport(records) {
            reportSections.auditsPerCERName.tableBody.innerHTML = '';
            const cerNameAuditCounts = {};

            records.forEach(record => {
                const cerName = record['CER Name'] || 'N/A';
                cerNameAuditCounts[cerName] = (cerNameAuditCounts[cerName] || 0) + 1;
            });

            const labels = Object.keys(cerNameAuditCounts);
            const data = Object.values(cerNameAuditCounts);

            if (labels.length === 0) {
                reportSections.auditsPerCERName.message.textContent = "No audits found per CER name for selected period.";
                reportSections.auditsPerCERName.message.classList.remove('hidden');
                reportSections.auditsPerCERName.table.classList.add('hidden');
            } else {
                for (const name in cerNameAuditCounts) {
                    const row = reportSections.auditsPerCERName.tableBody.insertRow();
                    row.insertCell().textContent = name;
                    row.insertCell().textContent = cerNameAuditCounts[name];
                }
                reportSections.auditsPerCERName.message.classList.add('hidden');
                reportSections.auditsPerCERName.table.classList.remove('hidden');
            }
            createOrUpdateChart('auditsPerCERName', 'bar', labels, data, 'Audits Per CER Name', 'CER Name', 'Number of Audits', 'rgba(59, 130, 246, 0.7)'); // Blue
        }

        function renderAverageQAScoreReport(records) {
            reportSections.averageQAScore.tableBody.innerHTML = '';
            const cerNameScores = {}; // { 'Name': { sum: 0, count: 0 } }

            records.forEach(record => {
                const cerName = record['CER Name'] || 'N/A';
                const score = parseScore(record['Overall Score']);

                if (!isNaN(score) && record['Overall Score'] && record['Overall Score'].trim() !== '') {
                    if (!cerNameScores[cerName]) {
                        cerNameScores[cerName] = { sum: 0, count: 0 };
                    }
                    cerNameScores[cerName].sum += score;
                    cerNameScores[cerName].count++;
                }
            });

            const labels = Object.keys(cerNameScores);
            const data = labels.map(name => cerNameScores[name].count > 0 ? (cerNameScores[name].sum / cerNameScores[name].count).toFixed(0) : 0);

            if (labels.length === 0) {
                reportSections.averageQAScore.message.textContent = "No scores found per CER name for selected period.";
                reportSections.averageQAScore.message.classList.remove('hidden');
                reportSections.averageQAScore.table.classList.add('hidden');
            } else {
                for (const name in cerNameScores) {
                    const avg = cerNameScores[name].count > 0 ? (cerNameScores[name].sum / cerNameScores[name].count).toFixed(0) : 0;
                    const row = reportSections.averageQAScore.tableBody.insertRow();
                    row.insertCell().textContent = name;
                    row.insertCell().textContent = `${avg}%`;
                }
                reportSections.averageQAScore.message.classList.add('hidden');
                reportSections.averageQAScore.table.classList.remove('hidden');
            }
            createOrUpdateChart('averageQAScore', 'bar', labels, data, 'Average QA Score Per CER Name', 'CER Name', 'Average Score (%)', 'rgba(139, 92, 246, 0.7)'); // Purple-ish
        }

        function renderAutofailsPerAreaReport(records) {
            reportSections.autofailsPerArea.tableBody.innerHTML = '';
            const autofailAreaCounts = {};

            records.forEach(record => {
                // Ensure 'Auto Fail Type' is a non-empty string for it to be considered an autofail area
                const autofailType = (record['Auto Fail Type'] && record['Auto Fail Type'].trim() !== '') ? record['Auto Fail Type'] : 'N/A (No Type)';
                if (autofailType !== 'N/A (No Type)') { // Only count if a valid autofail type exists
                    autofailAreaCounts[autofailType] = (autofailAreaCounts[autofailType] || 0) + 1;
                }
            });

            const labels = Object.keys(autofailAreaCounts);
            const data = Object.values(autofailAreaCounts);

            if (labels.length === 0) {
                reportSections.autofailsPerArea.message.textContent = "No autofails found per area for selected period.";
                reportSections.autofailsPerArea.message.classList.remove('hidden');
                reportSections.autofailAreaTable.classList.add('hidden');
            } else {
                for (const area in autofailAreaCounts) {
                    const row = reportSections.autofailsPerArea.tableBody.insertRow();
                    row.insertCell().textContent = area;
                    row.insertCell().textContent = autofailAreaCounts[area];
                }
                reportSections.autofailsPerArea.message.classList.add('hidden');
                reportSections.autofailsPerArea.table.classList.remove('hidden');
            }
            createOrUpdateChart('autofailsPerArea', 'bar', labels, data, 'Autofails Per Autofail Area', 'Autofail Area', 'Autofail Count', 'rgba(251, 191, 36, 0.7)'); // Yellow/Amber
        }


        // --- INITIALIZATION ---
        function initializeReportsPage() {
            // Set default month/year for filters
            reportMonthSelect.value = reportMonth;
            reportYearInput.value = reportYear;

            // Show reports content (it's hidden by default via CSS)
            reportsContent.style.display = 'block';

            // Show initial messages for all report sections and hide tables/charts
            Object.values(reportSections).forEach(section => {
                section.message.classList.remove('hidden');
                section.table.classList.add('hidden');
                section.spinner.classList.add('hidden'); // Initially hide spinner
                if (section.chartCanvas) section.chartCanvas.classList.add('hidden');
                if (section.chartMessage) section.chartMessage.classList.remove('hidden');
            });
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Reports DOM fully loaded and parsed.");

            // Authenticate (re-used from index.html logic)
            const isLoggedIn = sessionStorage.getItem('loggedIn');
            if (isLoggedIn === 'true') {
                loginPage.style.display = 'none';
                mainNav.style.display = 'flex';
                initializeReportsPage(); // Initialize reports-specific UI
                // Firebase auth state will be confirmed by firebaseAuthReady event
            } else {
                loginPage.style.display = 'flex';
                mainNav.style.display = 'none';
                reportsContent.style.display = 'none'; // Keep reports hidden until logged in
            }

            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                loginMessage.classList.add('hidden');

                const CORRECT_USERNAME = 'Supervisor';
                const CORRECT_PASSWORD = 'Supervisor';

                if (usernameInput.value === CORRECT_USERNAME && passwordInput.value === CORRECT_PASSWORD) {
                    sessionStorage.setItem('loggedIn', 'true');
                    loginPage.style.display = 'none';
                    mainNav.style.display = 'flex';
                    initializeReportsPage(); // Initialize reports-specific UI after login
                    // Firebase auth state will be confirmed by firebaseAuthReady event
                } else {
                    loginMessage.textContent = 'Invalid Username or Password. Please try again.';
                    loginMessage.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'index.html'; // Redirect to index/login
            });

            generateReportBtn.addEventListener('click', generateReport);

            // Set current month and year as defaults
            const now = new Date();
            reportMonthSelect.value = now.getMonth() + 1; // getMonth() is 0-indexed
            reportYearInput.value = now.getFullYear();
        });

        // Listen for Firebase Auth readiness
        document.addEventListener('firebaseAuthReady', () => {
            // When auth is ready, if logged in, generate initial report
            if (sessionStorage.getItem('loggedIn') === 'true') {
                generateReport(); // Generate report automatically after auth if already logged in
            }
        });

    </script>
</body>
</html>
