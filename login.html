<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Assessment Form - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Base styles */
        body {
            font-family: 'Garamond', serif;
            background-color: #f0f2f5; /* Lighter gray background */
            color: #1f2937;
            margin: 0;
            padding-top: 48px; /* Space for fixed header */
            padding-left: 125px; /* Space for fixed sidebar */
        }

        /* --- Layout & Navigation --- */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background-color: #000080; /* Navy Blue */
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.125rem;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 1rem;
        }
        .top-header img {
            height: 40px;
            width: auto;
        }

        .main-nav {
            width: 125px;
            background-color: #000080; /* Navy Blue */
            color: white;
            padding: 1rem 0;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-top: 56px; /* Align below header */
        }
        .sidebar ul { list-style: none; margin: 0; padding: 0; flex-grow: 1; }
        .sidebar ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.75rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #f57c00; /* ICEA Orange for active/hover */
        }
        .logout-button {
            background-color: #f57c00;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin: 1rem auto;
            width: calc(100% - 2rem);
            font-size: 0.75rem;
        }
        .logout-button:hover { background-color: #e65100; }

        /* --- Content Containers --- */
        .content-container {
            padding: 1.5rem;
            min-height: calc(100vh - 48px);
        }
        .page-content {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .page-header {
            background-color: #000080;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-header h1 { font-size: 1.5rem; font-weight: 700; }

        /* --- Form Aesthetics --- */
        .form-section {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .form-section:last-child { border-bottom: none; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .form-field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #000080;
            box-shadow: 0 0 0 3px rgba(0, 0, 128, 0.2);
        }
        .form-input[readonly] {
            background-color: #f3f4f6;
        }

        /* Question Section Styling */
        .question-section-header {
            background-color: #f0f2f5;
            color: #000080;
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        .question-grid-header {
            display: grid;
            grid-template-columns: 6fr 2fr 1fr 1fr 3fr;
            gap: 0.5rem;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            color: #6b7280;
            font-size: 0.8rem;
            text-align: center;
        }
        .question-grid-header > div:first-child { text-align: left; }
        .question-row {
            display: grid;
            grid-template-columns: 6fr 2fr 1fr 1fr 3fr;
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .question-row:last-child { border-bottom: none; }
        .question-row:hover { background-color: #f9fafb; }

        /* Score Displays */
        .score-card {
            background-color: #f0f2f5;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .score-card-title {
            font-size: 0.8rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }
        .score-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: #000080;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .btn-primary { background-color: #000080; color: white; }
        .btn-primary:hover { background-color: #000050; }
        .btn-secondary { background-color: #f57c00; color: white; }
        .btn-secondary:hover { background-color: #e65100; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-info { background-color: #0ea5e9; color: white; }
        .btn-info:hover { background-color: #0284c7; }


        /* Modal & Message Box */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1050;
        }
        .modal-box {
            background-color: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;
            max-width: 450px; width: 90%;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #000080;
            border-radius: 50%; width: 32px; height: 32px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Database Table */
        .db-table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        .db-table {
            width: 100%;
            border-collapse: collapse;
        }
        .db-table th, .db-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
        }
        .db-table th {
            background-color: #f9fafb;
            position: sticky;
            top: 0;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- TOP HEADER -->
    <header class="top-header">
        <span>ICEA LION QUALITY EVALUATION AND MONITORING</span>
        <img id="header-logo" src="https://placehold.co/120x40/000080/FFFFFF?text=Logo" alt="Company Logo">
    </header>

    <!-- SIDE NAVIGATION -->
    <nav class="main-nav" id="mainNav" style="display: none;">
        <div class="sidebar">
            <ul id="sidebar-menu">
                <!-- Navigation items will be dynamically rendered here by JavaScript -->
            </ul>
            <button id="logoutBtn" class="logout-button">Logout</button>
        </div>
    </nav>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-[2000] hidden" style="padding-left: 0;">
        <div class="w-full max-w-sm mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="px-6 py-4" style="background-color: #000080; color: white;">
                <h2 class="text-3xl font-bold text-center">QMS Login</h2>
            </div>
            <form id="loginForm" class="px-6 py-8 space-y-4">
                <div>
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="username" placeholder="you@example.com" class="form-input">
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="password" placeholder="••••••••" class="form-input">
                </div>
                <button type="button" id="loginButton" class="w-full btn btn-primary">Login</button>
                <div id="loginMessage" class="text-red-500 text-center text-sm h-4"></div>
                <div class="text-center text-sm">
                    <a href="#" id="forgotPasswordLink" class="font-medium text-blue-600 hover:underline">Forgot Password?</a>
                </div>
                <div class="text-center text-sm text-gray-600">
                    Don't have an account? 
                    <a href="signup.html" class="font-medium text-blue-600 hover:underline">Sign Up</a>
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <main class="content-container hidden">
        <!-- EVALUATION FORM PAGE -->
        <div id="auditFormContent" class="page-content hidden">
            <div class="page-header">
                <h1>Quality Assessment Form</h1>
                <img id="audit-form-logo" src="https://placehold.co/120x40/000080/FFFFFF?text=Logo" alt="Logo" class="h-10">
            </div>

            <!-- Top Section -->
            <div class="form-section">
                <div class="form-grid">
                    <div class="form-field"><label for="contact-id">Contact ID</label><input type="text" id="contact-id" name="Contact ID" class="form-input" required></div>
                    <div class="form-field"><label for="client-name">Client Name</label><input type="text" id="client-name" name="Client Name" class="form-input" required></div>
                    <div class="form-field"><label for="cer-name">CER Name</label><select id="cer-name" name="CER Name" class="form-input" required><option value="">Select CER</option></select></div>
                    <div class="form-field"><label for="cer-email">CER Email</label><input type="email" id="cer-email" name="CER Email" class="form-input" readonly></div>
                    <div class="form-field"><label for="cer-role">CER Role</label><select id="cer-role" name="CER Role" class="form-input" required><option value="">Select Role</option></select></div>
                    <div class="form-field"><label for="call-date-time">Call Date and Time</label><input type="datetime-local" id="call-date-time" name="Call Date and Time" class="form-input" required></div>
                    <div class="form-field"><label for="reviewer-name">Reviewer's Name</label><input type="text" id="reviewer-name" name="Reviewer's Name" class="form-input" readonly></div>
                    <div class="form-field"><label for="review-date">Evaluation Date</label><input type="date" id="review-date" name="Evaluation Date" class="form-input" required></div>
                    <div class="form-field"><label for="duration">Call Duration (HH:MM:SS)</label><input type="text" id="duration" name="Call Duration" class="form-input" placeholder="e.g., 00:05:30"></div>
                    <div class="form-field"><label for="autofail-type">Auto Fail Type</label><select id="autofail-type" name="Auto Fail Type" class="form-input"><option value="">Select Autofail Type</option></select></div>
                    <div id="autofailDescriptionContainer" class="form-field col-span-full hidden">
                        <label for="autofail-description">Autofail Reason</label>
                        <textarea id="autofail-description" name="Autofail Description" rows="2" class="form-input" placeholder="Provide mandatory details for the autofail"></textarea>
                    </div>
                </div>
            </div>

            <!-- Score Display Section -->
            <div class="form-section">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="score-card"><div class="score-card-title">Overall Score</div><div id="overall-score-display" class="score-card-value">0%</div></div>
                    <div class="score-card"><div class="score-card-title">Business & Compliance Accuracy</div><div id="business-compliance-accuracy" class="score-card-value">0%</div></div>
                </div>
            </div>

            <!-- Questions Sections -->
            <form id="assessment-form">
                <div id="questions-root-container">
                    <!-- Dynamic question sections will be inserted here -->
                </div>
            </form>
            
            <!-- Last 3 Evaluations Section -->
            <div class="form-section">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Last 3 Evaluations for Selected CER</h2>
                <div class="db-table-container">
                    <table class="db-table">
                        <thead>
                            <tr>
                                <th>Eval Date</th>
                                <th>Client Name</th>
                                <th>Score</th>
                                <th>Reviewer</th>
                            </tr>
                        </thead>
                        <tbody id="lastEvaluationsTableBody">
                           <tr><td colspan="4" class="text-center text-gray-500 py-4">Select a CER to see their history.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- Final Actions -->
            <div class="p-6 flex flex-wrap justify-between items-center gap-4">
                <img src="https://placehold.co/150x50/FFFFFF/000080?text=ICEA+LION" alt="ICEALION Logo" class="h-12">
                <div class="flex flex-wrap gap-4">
                    <button type="button" id="saveDataBtn" class="btn btn-primary"><i class="fas fa-save"></i> Save Data</button>
                    <button type="button" id="shareBtn" class="btn btn-secondary"><i class="fas fa-share-alt"></i> Share</button>
                    <button type="button" id="shareEmailBtn" class="btn btn-success"><i class="fas fa-envelope"></i> Share via Email</button>
                </div>
            </div>
        </div>

        <!-- SHARE PAGE -->
        <div id="shareContent" class="page-content hidden">
             <div class="page-header"><h1>Share Evaluation</h1></div>
             <div class="form-section">
                <p class="text-sm text-gray-600 mb-4">This form will send an email with the evaluation details and a PDF attachment link. A backend service is required to process the email queue.</p>
                <div class="form-grid">
                    <div class="form-field"><label for="share-email-to">To (CER Email)</label><input type="email" id="share-email-to" class="form-input" readonly></div>
                    <div class="form-field"><label for="share-email-from">From (Your Name)</label><input type="text" id="share-email-from" class="form-input" readonly></div>
                </div>
                <div class="form-field mt-4"><label for="share-email-subject">Subject</label><input type="text" id="share-email-subject" class="form-input"></div>
                <div class="form-field mt-4"><label for="share-email-body">Email Body</label><textarea id="share-email-body" rows="8" class="form-input"></textarea></div>
                <div class="mt-6 text-right">
                    <button id="sendShareEmailBtn" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send Email</button>
                </div>
             </div>
        </div>

        <!-- DATABASE PAGE -->
        <div id="databaseContent" class="page-content hidden">
            <div class="page-header"><h1>Database Records</h1></div>
             <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="form-field flex-grow mr-4">
                        <label for="db-search">Search Records</label>
                        <input type="text" id="db-search" class="form-input" placeholder="Search by Client Name, CER Name, Contact ID...">
                    </div>
                     <button id="deleteSelectedRecordsBtn" class="btn btn-danger" disabled><i class="fas fa-trash"></i> Delete Selected</button>
                </div>
                <div class="db-table-container">
                    <table class="db-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllRecordsCheckbox"></th>
                                <th>Eval Date</th>
                                <th>CER Name</th>
                                <th>Client Name</th>
                                <th>Score</th>
                                <th>Reviewer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            <!-- Records will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 pt-6 border-t">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Webhook Management</h2>
                     <div class="flex gap-4 mb-4">
                        <input type="url" id="newWebhookUrlInput" class="form-input flex-grow" placeholder="https://your-webhook-url.com">
                        <button id="addWebhookBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button>
                     </div>
                     <div id="webhookList" class="space-y-2">
                        <p class="text-gray-500">No webhooks configured.</p>
                     </div>
                </div>
             </div>
        </div>
        <!-- OTHER PAGES (Dashboard, etc.) -->

    </main>

    <!-- MESSAGE BOX / MODAL -->
    <div id="messageBoxOverlay" class="modal-overlay hidden">
        <div class="modal-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle" class="text-xl font-bold mb-2 text-blue-800"></h3>
            <p id="messageBoxContent" class="text-gray-600 mb-6"></p>
            <button id="messageBoxCloseBtn" class="btn btn-primary">OK</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.appspot.com",
            messagingSenderId: "820082472004",
            appId: "1:820082472004:web:8caddf941e1b5b667faf81"
        };
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Firestore Collection Paths ---
        const USERS_PROFILE_COLLECTION_PATH = `artifacts/${appId}/users`;
        const ROLES_COLLECTION_PATH = `artifacts/${appId}/public/data/roles`;
        const QUESTIONS_CONFIG_DOC_REF = doc(db, `artifacts/${appId}/public/data/questions`, 'question_configurations');
        const DROPDOWN_DATA_DOC_REF = doc(db, `artifacts/${appId}/public/data/dropdown_options`, 'general_options');
        const EVALUATION_RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/evaluation_records`;
        const WEBHOOKS_COLLECTION_PATH = `artifacts/${appId}/public/data/webhooks`;
        const MAIL_COLLECTION_PATH = `artifacts/${appId}/public/data/mail`;

        // --- Global State ---
        let currentUserRole = null;
        let loggedInUserName = "User";
        let cerNameEmailsMap = {};
        let allRolesQuestions = {};
        let allRecords = []; // Cache for all records for filtering

        // --- TABS CONFIGURATION ---
        const TABS_CONFIG = {
            'home': { id: null, el: null, href: 'home.html', icon: 'fa-home', label: 'Home'},
            'dashboard': { id: 'dashboardContent', el: null, href: 'Dashboard.html', icon: 'fa-chart-bar', label: 'Dashboard' },
            'evaluationForm': { id: 'auditFormContent', el: document.getElementById('auditFormContent'), href: '#', icon: 'fa-file-alt', label: 'Evaluation Form' },
            'myEvaluations': { id: 'myEvaluationsContent', el: null, href: 'myEvaluations.html', icon: 'fa-user-check', label: 'My Evaluations' },
            'nps': { id: null, el: null, href: 'nps.html', icon: 'fa-comment-alt', label: 'NPS'},
            'autofails': { id: null, el: null, href: 'autofails.html', icon: 'fa-exclamation-triangle', label: 'Autofails'},
            'database': { id: 'databaseContent', el: document.getElementById('databaseContent'), href: '#', icon: 'fa-database', label: 'Database' },
            'images': { id: null, el: null, href: 'images.html', icon: 'fa-image', label: 'Images'},
            'users': { id: 'usersContent', el: null, href: 'users.html', icon: 'fa-users', label: 'Users' },
            'admin': { id: 'adminContent', el: null, href: 'admin.html', icon: 'fa-user-cog', label: 'Admin' },
            'share': { id: 'shareContent', el: document.getElementById('shareContent'), href: '#', icon: 'fa-share-alt', label: 'Share' }
        };

        // --- AUTHENTICATION & INITIALIZATION ---
        onAuthStateChanged(auth, async (user) => {
            const loginPage = document.getElementById('loginPage');
            const mainNav = document.getElementById('mainNav');
            const contentContainer = document.querySelector('.content-container');

            if (user) {
                // User is signed in
                const userProfileDocRef = doc(db, USERS_PROFILE_COLLECTION_PATH, user.uid);
                const userDocSnap = await getDoc(userProfileDocRef);
                if (userDocSnap.exists()) {
                    currentUserRole = userDocSnap.data().role || 'Agent';
                    loggedInUserName = userDocSnap.data().name || user.email;
                } else {
                    currentUserRole = 'Agent'; // Default role
                    loggedInUserName = user.email;
                }
                document.getElementById('reviewer-name').value = loggedInUserName;
                await fetchRolePermissionsAndRenderNav(currentUserRole);
                
                loginPage.classList.add('hidden');
                mainNav.style.display = 'flex';
                contentContainer.classList.remove('hidden');
                
                initializeAppDisplay();
            } else {
                // User is signed out
                loginPage.classList.remove('hidden');
                mainNav.style.display = 'none';
                contentContainer.classList.add('hidden');
            }
        });

        function initializeAppDisplay() {
            fetchInitialData();
            listenForRecords();
            listenForWebhooks();
            showTab('evaluationForm');
        }

        async function fetchRolePermissionsAndRenderNav(role) {
            const roleDocRef = doc(db, ROLES_COLLECTION_PATH, role);
            const roleDocSnap = await getDoc(roleDocRef);
            const permissions = roleDocSnap.exists() ? roleDocSnap.data().permissions : {};

            const sidebarMenu = document.getElementById('sidebar-menu');
            sidebarMenu.innerHTML = '';

            for (const key in TABS_CONFIG) {
                if (permissions[key] && permissions[key] !== 'none') {
                    const tab = TABS_CONFIG[key];
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${tab.href}" id="${key}Tab" data-tabkey="${key}"><i class="fas ${tab.icon}"></i> ${tab.label}</a>`;
                    sidebarMenu.appendChild(li);
                }
            }
            // Add event listeners to newly created tabs
            document.querySelectorAll('#sidebar-menu a').forEach(tabLink => {
                if(tabLink.getAttribute('href') === '#') {
                    tabLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showTab(e.currentTarget.dataset.tabkey);
                    });
                }
            });
        }

        // --- UI & TAB MANAGEMENT ---
        function showTab(tabKey) {
            Object.values(TABS_CONFIG).forEach(tab => {
                if (tab.el) tab.el.classList.add('hidden');
            });
            document.querySelectorAll('#sidebar-menu a').forEach(a => a.classList.remove('active'));

            if (TABS_CONFIG[tabKey] && TABS_CONFIG[tabKey].el) {
                TABS_CONFIG[tabKey].el.classList.remove('hidden');
                document.getElementById(`${tabKey}Tab`)?.classList.add('active');
            }
        }

        function showMessageBox(title, message, showSpinner = false, showClose = true) {
            const overlay = document.getElementById('messageBoxOverlay');
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxContent').innerHTML = message; // Use innerHTML to allow for formatted content
            document.getElementById('messageBoxSpinner').classList.toggle('hidden', !showSpinner);
            document.getElementById('messageBoxCloseBtn').classList.toggle('hidden', !showClose);
            overlay.classList.remove('hidden');
        }

        function hideMessageBox() {
            document.getElementById('messageBoxOverlay').classList.add('hidden');
        }

        // --- DATA FETCHING ---
        async function fetchInitialData() {
            // Fetch dropdowns
            const dropdownSnap = await getDoc(DROPDOWN_DATA_DOC_REF);
            if (dropdownSnap.exists()) {
                const data = dropdownSnap.data();
                populateDropdown('cer-role', data.cerRoles);
                populateDropdown('autofail-type', data.autofailTypes);
            }
            // Fetch users for CER Name dropdown
            onSnapshot(collection(db, USERS_PROFILE_COLLECTION_PATH), (snapshot) => {
                const users = snapshot.docs.map(doc => ({ name: doc.data().name, email: doc.data().email }));
                cerNameEmailsMap = users.reduce((acc, user) => {
                    acc[user.name] = user.email;
                    return acc;
                }, {});
                populateDropdown('cer-name', users.map(u => u.name));
            });
            // Fetch questions
            const questionsSnap = await getDoc(QUESTIONS_CONFIG_DOC_REF);
            if (questionsSnap.exists()) {
                allRolesQuestions = questionsSnap.data();
                renderQuestionsForRole(document.getElementById('cer-role').value);
            }
        }

        function populateDropdown(elementId, options) {
            const select = document.getElementById(elementId);
            if (!select || !Array.isArray(options)) return;
            const currentValue = select.value;
            select.innerHTML = `<option value="">Select...</option>`;
            options.forEach(opt => {
                select.innerHTML += `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`;
            });
        }

        // --- FORM LOGIC & CALCULATION ---
        function renderQuestionsForRole(role) {
            const container = document.getElementById('questions-root-container');
            container.innerHTML = '';
            const roleQuestions = allRolesQuestions[role] || {};

            for (const sectionTitle in roleQuestions) {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `<div class="question-section-header">${sectionTitle}</div>`;

                const header = document.createElement('div');
                header.className = 'question-grid-header';
                header.innerHTML = `<div>Description</div><div>Rating</div><div>Weight</div><div>Points</div><div>Remarks</div>`;
                sectionDiv.appendChild(header);

                roleQuestions[sectionTitle].forEach(q => {
                    const row = document.createElement('div');
                    row.className = 'question-row';
                    row.innerHTML = `
                        <div>${q.desc}</div>
                        <div><select name="${q.desc} (Rating)" class="form-input rating-select" data-weightage="${q.weightage}" data-autofail="${q.autofail || false}">
                            <option value="">Select</option><option value="Yes">Yes</option><option value="No">No</option><option value="N/A">N/A</option>
                        </select></div>
                        <div class="text-center font-semibold">${q.weightage}</div>
                        <div><input type="number" name="${q.desc} (Points)" class="form-input text-center points-input" value="0" readonly></div>
                        <div><textarea name="${q.desc} (Remarks)" rows="1" class="form-input"></textarea></div>
                    `;
                    sectionDiv.appendChild(row);
                });
                container.appendChild(sectionDiv);
            }
            document.querySelectorAll('.rating-select').forEach(el => el.addEventListener('change', calculateScore));
            calculateScore(); // Initial calculation
        }

        function calculateScore() {
            const overallScoreDisplay = document.getElementById('overall-score-display');
            const businessComplianceAccuracyDisplay = document.getElementById('business-compliance-accuracy');
            const autofailTypeSelect = document.getElementById('autofail-type');

            let currentTotalPoints = 0;
            let currentMaxPossiblePoints = 0;
            let complianceCurrentPoints = 0;
            let complianceMaxPoints = 0;

            const autofailTypeSelected = autofailTypeSelect && autofailTypeSelect.value !== '';
            let autofailQuestionTriggered = false;

            const allRatingSelects = document.querySelectorAll('.rating-select');

            allRatingSelects.forEach(selectElement => {
                const rowDiv = selectElement.closest('.question-row');
                if (!rowDiv) return;

                const pointsElement = rowDiv.querySelector('.points-input');
                const weightage = parseFloat(selectElement.dataset.weightage);
                const isAutofailQuestion = selectElement.dataset.autofail === 'true';
                const rating = selectElement.value;
                let pointsForThisQuestion = 0;

                if (rating === 'Yes') {
                    pointsForThisQuestion = weightage;
                } else if (rating === 'No') {
                    pointsForThisQuestion = 0;
                    if (isAutofailQuestion) {
                        autofailQuestionTriggered = true;
                    }
                } else if (rating === 'N/A') {
                    pointsForThisQuestion = 0; // N/A gives 0 points but also doesn't count towards max
                }

                pointsElement.value = (rating === 'N/A' || rating === '') ? '' : pointsForThisQuestion;

                if (rating !== '' && rating !== 'N/A') { // Only count towards max points if an option is selected and it's not N/A
                    currentMaxPossiblePoints += weightage;
                    currentTotalPoints += pointsForThisQuestion;
                }
            
                // Check if it belongs to the compliance section for the second score
                const sectionHeader = rowDiv.parentElement.querySelector('.question-section-header');
                if (sectionHeader && sectionHeader.textContent.toUpperCase().includes('COMPLIANCE')) {
                    if (rating !== '' && rating !== 'N/A') {
                        complianceMaxPoints += weightage;
                        complianceCurrentPoints += pointsForThisQuestion;
                    }
                }
            });

            let finalOverallPercentage = 0;
            if (currentMaxPossiblePoints > 0) {
                finalOverallPercentage = ((currentTotalPoints / currentMaxPossiblePoints) * 100);
            }

            if (autofailQuestionTriggered || autofailTypeSelected) {
                finalOverallPercentage = 0;
            }
            
            overallScoreDisplay.textContent = `${Math.round(finalOverallPercentage)}%`;

            let businessCompliancePct = 0;
            if (complianceMaxPoints > 0) {
                businessCompliancePct = ((complianceCurrentPoints / complianceMaxPoints) * 100);
            }
            businessComplianceAccuracyDisplay.textContent = `${Math.round(businessCompliancePct)}%`;
        }


        function validateForm() {
            const requiredFields = ['contact-id', 'client-name', 'cer-name', 'cer-role', 'call-date-time', 'review-date'];
            for (const id of requiredFields) {
                const el = document.getElementById(id);
                // Find the label associated with the input
                const label = document.querySelector(`label[for='${id}']`);
                const labelText = label ? label.textContent : id;
                if (!el.value) {
                    showMessageBox("Validation Error", `Please fill the "${labelText}" field.`);
                    return false;
                }
            }
            // Autofail reason validation
            if (document.getElementById('autofail-type').value && !document.getElementById('autofail-description').value) {
                showMessageBox("Validation Error", "Autofail Reason is mandatory when an Autofail Type is selected.");
                return false;
            }
            return true;
        }

        function collectFormData() {
            if (!validateForm()) return null;
            const formData = {};
            const inputs = document.querySelectorAll('#auditFormContent input, #auditFormContent select, #auditFormContent textarea');
            inputs.forEach(input => {
                if (input.name) formData[input.name] = input.value;
            });
            formData['Overall Score'] = document.getElementById('overall-score-display').textContent;
            formData['Business & Compliance Accuracy'] = document.getElementById('business-compliance-accuracy').textContent;
            return formData;
        }

        // --- PDF & SHARING LOGIC ---
        async function generatePdfAsBlob() {
            const formContent = document.getElementById('auditFormContent');
            showMessageBox("Generating PDF...", "Please wait while the document is being created.", true, false);
            const canvas = await html2canvas(formContent, { scale: 2, logging: false, useCORS: true });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            hideMessageBox();
            return pdf.output('blob');
        }

        async function handleShare(viaEmail = false) {
            const formData = collectFormData();
            if (!formData) return;

            showMessageBox("Processing...", "Generating and uploading PDF. Please wait.", true, false);

            try {
                const pdfBlob = await generatePdfAsBlob();
                const cerName = formData['CER Name'];
                const evalDate = formData['Evaluation Date'];
                const fileName = `Evaluation Form - ${cerName} - ${evalDate}.pdf`;
                
                const storageRef = ref(storage, `evaluations/${fileName}`);
                await uploadBytes(storageRef, pdfBlob);
                const downloadURL = await getDownloadURL(storageRef);

                hideMessageBox();

                if (viaEmail) {
                    const subject = `Evaluation Report for ${cerName} on ${evalDate}`;
                    const body = `Dear ${cerName},\n\nPlease find your evaluation report attached.\n\nDownload Link: ${downloadURL}\n\nBest regards,\n${loggedInUserName}`;
                    window.location.href = `mailto:${formData['CER Email']}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                } else {
                    // Pre-populate share tab and switch to it
                    document.getElementById('share-email-to').value = formData['CER Email'];
                    document.getElementById('share-email-from').value = loggedInUserName;
                    document.getElementById('share-email-subject').value = `Evaluation Report for ${cerName} on ${evalDate}`;
                    document.getElementById('share-email-body').value = `Dear ${cerName},\n\nPlease find your evaluation report attached.\n\nDownload Link: ${downloadURL}\n\nBest regards,\n${loggedInUserName}`;
                    showTab('share');
                }
            } catch (error) {
                console.error("Sharing failed:", error);
                showMessageBox("Error", `Failed to generate or share the PDF: ${error.message}`);
            }
        }
        
        async function sendEmailFromShareTab() {
            const to = document.getElementById('share-email-to').value;
            const subject = document.getElementById('share-email-subject').value;
            const html = document.getElementById('share-email-body').value.replace(/\n/g, '<br>');

            if (!to || !subject || !html) {
                showMessageBox("Error", "Please fill all fields before sending.");
                return;
            }
            
            showMessageBox("Sending...", "Adding email to the send queue.", true, false);

            try {
                // This adds the email to a "mail" collection. A backend Cloud Function
                // is required to listen to this collection and send the actual email.
                await addDoc(collection(db, MAIL_COLLECTION_PATH), {
                    to: to.split(','), // Allow multiple recipients
                    message: {
                        subject: subject,
                        html: html,
                    },
                });
                showMessageBox("Success!", "Email has been queued for sending.");
            } catch (error) {
                console.error("Failed to queue email:", error);
                showMessageBox("Error", `Failed to queue email: ${error.message}`);
            }
        }

        // --- DATABASE VIEW LOGIC ---
        function listenForRecords() {
            const q = query(collection(db, EVALUATION_RECORDS_COLLECTION_PATH), orderBy("submittedAt", "desc"));
            onSnapshot(q, (snapshot) => {
                allRecords = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderRecordsTable(allRecords);
            });
        }

        function renderRecordsTable(records) {
            const tableBody = document.getElementById('recordsTableBody');
            tableBody.innerHTML = '';
            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-4">No records found.</td></tr>`;
                return;
            }

            records.forEach(record => {
                const evalDate = record.submittedAt?.toDate ? record.submittedAt.toDate().toLocaleDateString() : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="record-checkbox" data-id="${record.id}"></td>
                    <td>${evalDate}</td>
                    <td>${record['CER Name'] || 'N/A'}</td>
                    <td>${record['Client Name'] || 'N/A'}</td>
                    <td>${record['Overall Score'] || 'N/A'}</td>
                    <td>${record.reviewedBy || 'N/A'}</td>
                    <td class="flex gap-2">
                        <button class="btn btn-sm btn-info view-record-btn" data-id="${record.id}"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-success download-pdf-btn" data-url="${record.pdfUrl || ''}" ${!record.pdfUrl ? 'disabled' : ''}><i class="fas fa-file-pdf"></i></button>
                        <button class="btn btn-sm btn-danger delete-record-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Add event listeners to new buttons
            document.querySelectorAll('.view-record-btn').forEach(btn => btn.addEventListener('click', (e) => viewRecordDetails(e.currentTarget.dataset.id)));
            document.querySelectorAll('.download-pdf-btn').forEach(btn => btn.addEventListener('click', (e) => window.open(e.currentTarget.dataset.url, '_blank')));
            document.querySelectorAll('.delete-record-btn').forEach(btn => btn.addEventListener('click', (e) => deleteRecord(e.currentTarget.dataset.id)));
            document.querySelectorAll('.record-checkbox').forEach(cb => cb.addEventListener('change', updateDeleteButtonState));
        }
        
        function viewRecordDetails(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;
            let detailsHtml = '<pre class="text-left whitespace-pre-wrap text-sm bg-gray-100 p-4 rounded">';
            for(const [key, value] of Object.entries(record)) {
                let displayValue = value;
                if(value?.toDate) {
                    displayValue = value.toDate().toLocaleString();
                } else if (typeof value === 'object' && value !== null) {
                    displayValue = JSON.stringify(value, null, 2);
                }
                detailsHtml += `<strong>${key}:</strong> ${displayValue}\n`;
            }
            detailsHtml += '</pre>';
            showMessageBox("Record Details", detailsHtml);
        }

        async function deleteRecord(recordId) {
            if (confirm("Are you sure you want to delete this record permanently?")) {
                try {
                    await deleteDoc(doc(db, EVALUATION_RECORDS_COLLECTION_PATH, recordId));
                    showMessageBox("Success", "Record deleted successfully.");
                } catch (error) {
                    console.error("Error deleting record:", error);
                    showMessageBox("Error", `Failed to delete record: ${error.message}`);
                }
            }
        }
        
        async function deleteSelectedRecords() {
            const selectedIds = Array.from(document.querySelectorAll('.record-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) {
                showMessageBox("No Selection", "Please select records to delete.");
                return;
            }
            if (confirm(`Are you sure you want to delete ${selectedIds.length} records?`)) {
                showMessageBox("Deleting...", "Deleting selected records...", true, false);
                try {
                    const batch = writeBatch(db);
                    selectedIds.forEach(id => {
                        batch.delete(doc(db, EVALUATION_RECORDS_COLLECTION_PATH, id));
                    });
                    await batch.commit();
                    showMessageBox("Success", `${selectedIds.length} records deleted successfully.`);
                } catch(error) {
                    console.error("Error deleting records:", error);
                    showMessageBox("Error", `Failed to delete records: ${error.message}`);
                }
            }
        }

        function updateDeleteButtonState() {
            const selectedCount = document.querySelectorAll('.record-checkbox:checked').length;
            document.getElementById('deleteSelectedRecordsBtn').disabled = selectedCount === 0;
        }

        async function fetchLastThreeEvaluations(cerName) {
            const tableBody = document.getElementById('lastEvaluationsTableBody');
            if (!cerName) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">Select a CER to see their history.</td></tr>`;
                return;
            }
            const q = query(collection(db, EVALUATION_RECORDS_COLLECTION_PATH), where("CER Name", "==", cerName), orderBy("submittedAt", "desc"), limit(3));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">No evaluations found for ${cerName}.</td></tr>`;
                } else {
                    tableBody.innerHTML = '';
                    snapshot.forEach(doc => {
                        const record = doc.data();
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${record.submittedAt?.toDate().toLocaleDateString() || 'N/A'}</td>
                            <td>${record['Client Name'] || 'N/A'}</td>
                            <td>${record['Overall Score'] || 'N/A'}</td>
                            <td>${record.reviewedBy || 'N/A'}</td>
                        `;
                    });
                }
            });
        }
        
        // --- WEBHOOK LOGIC ---
        function listenForWebhooks() {
            onSnapshot(collection(db, WEBHOOKS_COLLECTION_PATH), (snapshot) => {
                const webhooks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderWebhookList(webhooks);
            });
        }

        function renderWebhookList(webhooks) {
            const container = document.getElementById('webhookList');
            container.innerHTML = '';
            if (webhooks.length === 0) {
                container.innerHTML = `<p class="text-gray-500">No webhooks configured.</p>`;
                return;
            }
            webhooks.forEach(hook => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                div.innerHTML = `
                    <span class="text-sm truncate">${hook.url}</span>
                    <button class="btn btn-sm btn-danger delete-webhook-btn" data-id="${hook.id}"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(div);
            });
            document.querySelectorAll('.delete-webhook-btn').forEach(btn => btn.addEventListener('click', deleteWebhook));
        }

        async function addWebhook() {
            const input = document.getElementById('newWebhookUrlInput');
            const url = input.value.trim();
            if (url) {
                try {
                    await addDoc(collection(db, WEBHOOKS_COLLECTION_PATH), { url });
                    input.value = '';
                } catch (error) {
                    showMessageBox("Error", `Could not add webhook: ${error.message}`);
                }
            }
        }

        async function deleteWebhook(e) {
            const hookId = e.currentTarget.dataset.id;
            if (confirm("Delete this webhook?")) {
                await deleteDoc(doc(db, WEBHOOKS_COLLECTION_PATH, hookId));
            }
        }


        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginButton = document.getElementById('loginButton');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');

            if (loginButton) {
                loginButton.addEventListener('click', async () => {
                    const email = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const loginMessage = document.getElementById('loginMessage');
                    loginMessage.textContent = '';

                    if (!email || !password) {
                        loginMessage.textContent = 'Please enter both email and password.';
                        return;
                    }

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // onAuthStateChanged will handle hiding login and showing the main app
                    } catch (error) {
                        console.error("Login failed:", error);
                        loginMessage.textContent = "Login failed. Please check your credentials.";
                    }
                });
            }
            
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('username').value;
                    if (!email) {
                        showMessageBox("Input Required", "Please enter your email address in the email field to reset your password.");
                        return;
                    }
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showMessageBox("Check Your Email", `A password reset link has been sent to ${email}.`);
                    } catch (error) {
                        console.error("Password reset failed:", error);
                        showMessageBox("Error", `Could not send password reset email: ${error.message}`);
                    }
                });
            }


            document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
            document.getElementById('messageBoxCloseBtn').addEventListener('click', hideMessageBox);

            // Form Listeners
            document.getElementById('cer-role').addEventListener('change', (e) => renderQuestionsForRole(e.target.value));
            document.getElementById('cer-name').addEventListener('change', (e) => {
                const selectedName = e.target.value;
                document.getElementById('cer-email').value = cerNameEmailsMap[selectedName] || '';
                fetchLastThreeEvaluations(selectedName);
            });
            document.getElementById('autofail-type').addEventListener('change', (e) => {
                document.getElementById('autofailDescriptionContainer').classList.toggle('hidden', !e.target.value);
            });
            document.getElementById('review-date').valueAsDate = new Date();

            // DB Listeners
            document.getElementById('db-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredRecords = allRecords.filter(r => 
                    r['Client Name']?.toLowerCase().includes(searchTerm) ||
                    r['CER Name']?.toLowerCase().includes(searchTerm) ||
                    r['Contact ID']?.toLowerCase().includes(searchTerm)
                );
                renderRecordsTable(filteredRecords);
            });
            document.getElementById('selectAllRecordsCheckbox').addEventListener('change', (e) => {
                document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateDeleteButtonState();
            });
            document.getElementById('deleteSelectedRecordsBtn').addEventListener('click', deleteSelectedRecords);
            document.getElementById('addWebhookBtn').addEventListener('click', addWebhook);


            // Action Button Listeners
            document.getElementById('saveDataBtn').addEventListener('click', async () => {
                const formData = collectFormData();
                if (formData) {
                    showMessageBox("Saving...", "Generating PDF and saving data...", true, false);
                    try {
                        const pdfBlob = await generatePdfAsBlob();
                        const cerName = formData['CER Name'];
                        const evalDate = formData['Evaluation Date'];
                        const fileName = `Evaluation Form - ${cerName} - ${evalDate}-${Date.now()}.pdf`;
                        const storageRef = ref(storage, `evaluations/${fileName}`);
                        await uploadBytes(storageRef, pdfBlob);
                        const downloadURL = await getDownloadURL(storageRef);

                        await addDoc(collection(db, EVALUATION_RECORDS_COLLECTION_PATH), { 
                            ...formData, 
                            submittedAt: new Date(), 
                            reviewedBy: loggedInUserName,
                            pdfUrl: downloadURL
                        });
                        showMessageBox("Success", "Data and PDF report saved successfully.");
                    } catch (error) {
                        console.error("Save failed:", error);
                        showMessageBox("Error", `Failed to save data: ${error.message}`);
                    }
                }
            });
            document.getElementById('shareBtn').addEventListener('click', () => handleShare(false));
            document.getElementById('shareEmailBtn').addEventListener('click', () => handleShare(true));
            document.getElementById('sendShareEmailBtn').addEventListener('click', sendEmailFromShareTab);
        });

    </script>
</body>
</html>
