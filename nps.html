<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPS Feedback - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles - Copied from index.html for consistency */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            /* Start hidden to prevent flicker */
            visibility: hidden; 
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }
        body.loaded {
            visibility: visible;
            opacity: 1;
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles */
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Section Headers */
        .section-header-bg {
            background-color: #1a73e8;
            color: white;
        }
        /* Icon backgrounds for questions */
        .icon-bg-orange { background-color: #f57c00; }
        .icon-bg-blue { background-color: #2196f3; }
        .icon-bg-green { background-color: #4caf50; }
        .icon-bg-yellow { background-color: #ffc107; }

        /* Form Row Styling (zebra striping) */
        .form-row-light { background-color: #f9fafb; }
        .form-row-dark { background-color: #edf2f7; }

        /* Adjustments for question descriptions, weightage, and points */
        .question-description {
            font-size: 12px;
            font-weight: 600;
        }

        .weightage-display {
            font-size: 12px;
            font-weight: 600;
        }

        /* ADJUSTED STYLES FOR INPUTS AND SELECTS TO REQUESTED FIXED SIZE */
        .form-grid-input {
            padding: 2px;
            font-size: 0.875rem;
            width: 2.3cm;
            height: 0.9cm;
            min-height: 0.9cm;
            box-sizing: border-box;
            overflow: hidden;
        }

        .points-input {
            font-size: 0.875rem;
            padding: 2px;
            width: 2.3cm;
            height: 0.9cm;
            min-height: 0.9cm;
            box-sizing: border-box;
            text-align: center;
            overflow: hidden;
        }

        .rating-select {
            font-size: 0.875rem;
            padding: 2px;
            width: 2.3cm;
            height: 0.9cm;
            min-height: 0.9cm;
            box-sizing: border-box;
            text-align-last: center;
            overflow: hidden;
        }

        /* Remarks textarea size and wrapping */
        .remarks-textarea {
            resize: vertical;
            min-height: 48px;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 0.5rem;
            font-size: 0.875rem;
            box-sizing: border-box;
        }

        /* Styles for top section field labels */
        .top-field-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        /* Specific adjustment for the overall score displays if they seem too small */
        #overall-score-display,
        #business-compliance-accuracy,
        #nps-overall-score-display { /* Added NPS score display */
            font-size: 1.6rem;
        }

        /* Small adjustment for table headers for better alignment with smaller fonts */
        #npsTableContainer th, #npsTableContainer td,
        #npsEvaluationModalContent .nps-summary-table th, 
        #npsEvaluationModalContent .nps-summary-table td { /* Added for new table */
            border: 1px solid #e5e7eb;
            padding: 0.7rem;
            font-size: 0.8rem;
        }

        /* NEW TOP HEADER - Copied from index.html for consistency */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background-color: #800080;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Navigation styles - Copied from index.html for consistency */
        .main-nav {
            width: 125px;
            background-color: #800080;
            color: white;
            padding: 1rem 0;
            height: calc(100vh - 48px);
            position: fixed;
            top: 48px;
            left: 0;
            z-index: 100;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .main-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.75rem 0.5rem;
            display: block;
            border-radius: 0;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            text-align: center;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #6a006a;
        }

        .logout-button {
            background-color: #f57c00;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin: 1rem auto;
            width: calc(100% - 2rem);
            font-size: 0.75rem;
        }
        .logout-button:hover {
            background-color: #e65100;
        }

        /* Adjust main content containers to account for the sidebar width AND new top header height */
        #npsFeedbackContent.container.mx-auto {
            margin-left: 125px;
            margin-top: 48px;
            width: calc(100% - 125px);
            min-height: calc(100vh - 48px);
            max-width: none;
            border-radius: 0;
        }
        
        /* Specific styles for modal/message box - Copied for consistency */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8;
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NPS Table specific styles */
        #npsTableContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #npsTableContainer th, #npsTableContainer td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
        }
        #npsTableContainer th {
            background-color: #eff6ff;
            font-weight: 600;
            color: #1f2937;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #npsTableContainer tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        #npsTableContainer tbody tr:hover {
            background-color: #f3f4f6;
        }
        #npsTableContainer .review-btn, .share-nps-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin-right: 0.25rem;
        }
        #npsTableContainer .review-btn {
            background-color: #2196f3; /* blue */
            color: white;
        }
        #npsTableContainer .review-btn:hover {
            background-color: #1976d2;
        }
        #npsTableContainer .share-nps-btn {
            background-color: #f57c00; /* orange */
            color: white;
        }
        #npsTableContainer .share-nps-btn:hover {
            background-color: #e65100;
        }

        /* Status colors */
        .status-completed { background-color: #dcfce7; color: #16a34a; font-weight: 600; } /* green-100, green-600 */
        .status-pending { background-color: #fffbeb; color: #f59e0b; font-weight: 600; } /* yellow-100, yellow-600 */
        .status-overdue { background-color: #fee2e2; color: #dc2626; font-weight: 600; } /* red-100, red-600 */
        .status-default { background-color: #e5e7eb; color: #4b5563; } /* gray-200, gray-700 */

        /* Agent Handled editable cell */
        .editable-cell {
            cursor: pointer;
            border: 1px solid transparent;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .editable-cell:hover {
            background-color: #f0f0f0;
            border-color: #ccc;
        }
        .editable-cell.editing {
            background-color: white;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        /* Styles for the new NPS Evaluation Modal */
        #npsEvaluationModalContent {
            max-height: 70vh; /* Make the content area scrollable */
            overflow-y: auto;
            padding-bottom: 0; /* Adjust padding to make space for sticky footer-like buttons */
        }
        #npsEvaluationModalContent .p-6.grid { /* Adjust top form fields spacing */
            padding-bottom: 0; 
        }
        #npsEvaluationModalContent .section-header-bg { /* Adjust section header spacing */
            margin-top: 1.5rem;
            margin-bottom: 0;
        }
        #npsEvaluationModalContent .p-4 { /* Adjust section content spacing */
            padding-top: 1rem;
        }
        #npsEvaluationModalContent .p-6.flex.justify-end.space-x-4 { /* Buttons are at the very bottom */
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb; /* Add a subtle separator */
            background-color: white; /* Ensure buttons have a solid background */
            position: sticky; /* Make buttons sticky at the bottom if content scrolls */
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05); /* Subtle shadow above buttons */
        }

        /* Table styles within the modal */
        #npsSummaryTable {
            width: calc(100% - 3rem); /* Adjust width for padding on sides */
            margin: 1.5rem auto; /* Center table with some margin */
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
        }
        #npsSummaryTable th, #npsSummaryTable td {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
            text-align: left;
        }
        #npsSummaryTable th {
            background-color: #f0f9ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937;
        }
        #npsSummaryTable tbody tr:nth-child(odd) {
            background-color: #f9fafb; /* Light gray for odd rows */
        }
        #npsSummaryTable tbody tr:hover {
            background-color: #f3f4f6; /* Lighter gray on hover */
        }

    </style>
</head>
<body>
    <div class="top-header">
        ICEA LION QUALITY EVALUATION AND MONITORING
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <nav class="main-nav" id="mainNav">
        <div class="sidebar">
            <ul>
                <li><a href="index.html" id="auditFormTab"><i class="fas fa-file-alt"></i> Evaluation Form</a></li>
                <li><a href="index.html#database" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
                <li><a href="reports.html" id="reportsTab"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="autofails.html" id="autofailsTab"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
                <li><a href="index.html#shareResponse" id="shareResponseTab"><i class="fas fa-share-square"></i> Share Response</a></li>
                <li><a href="#" id="npsFeedbackTab" class="active"><i class="fas fa-comments"></i> NPS Feedback</a></li> 
                <li><a href="users.html" id="usersTab"><i class="fas fa-users"></i> Users</a></li>
                <li><a href="admin.html" id="adminTab"><i class="fas fa-user-cog"></i> Admin</a></li>
            </ul>
            <button id="logoutBtn" class="logout-button">Logout</button>
        </div>
    </nav>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-5xl mt-8 mb-8" id="npsFeedbackContent">
        <div class="icealion-blue p-4 text-xl font-semibold text-center">
            NPS Feedback Module
        </div>
        <div class="p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">NPS Records from Google Sheet</h2>
            <div id="npsTableContainer" class="overflow-x-auto max-h-[70vh]">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th>Customer Contact ID</th>
                            <th>Positive Feedback</th>
                            <th>Area of Improvement</th>
                            <th>NPS Rating</th>
                            <th>Agent Handled</th>
                            <th>Status</th>
                            <th>Review Score</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="npsRecordsTableBody">
                        <tr><td colspan="8" class="text-center py-4 text-gray-500">Loading NPS records...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="npsEvaluationModalOverlay" class="message-box-overlay hidden">
        <div class="message-box max-w-2xl">
            <h3 id="npsEvaluationModalTitle">NPS Evaluation Form</h3>
            <div id="npsEvaluationModalContent" class="text-left">
                <form id="nps-evaluation-form">
                    <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="nps-contact-id" class="block top-field-label">Contact ID</label>
                            <input type="text" id="nps-contact-id" name="NPS Contact ID" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-grid-input" readonly>
                        </div>
                        <div>
                            <label for="nps-agent-handled" class="block top-field-label">Agent Handled</label>
                            <input type="text" id="nps-agent-handled" name="NPS Agent Handled" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-grid-input" readonly>
                        </div>
                        <div>
                            <label for="nps-review-date" class="block top-field-label">Evaluation Date</label>
                            <input type="date" id="nps-review-date" name="NPS Evaluation Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-grid-input" required>
                        </div>
                        <div>
                            <label for="nps-reviewer-name" class="block top-field-label">Reviewer's Name</label>
                            <select id="nps-reviewer-name" name="NPS Reviewer's Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-grid-input" required>
                                <option value="">Select Reviewer</option>
                            </select>
                        </div>
                         <div>
                            <label for="nps-autofail-type" class="block top-field-label">Auto Fail Type</label>
                            <select id="nps-autofail-type" name="NPS Auto Fail Type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-grid-input">
                                <option value="">Select Autofail Type</option>
                            </select>
                        </div>
                        <div id="npsAutofailDescriptionContainer" class="hidden">
                            <label for="nps-autofail-description" class="block top-field-label">Autofail Description</label>
                            <textarea id="nps-autofail-description" name="NPS Autofail Description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm remarks-textarea" placeholder="Provide details about the autofail" oninput="autoExpandTextarea(this)"></textarea>
                        </div>
                    </div>

                    <div class="p-4 rounded-lg shadow-sm flex flex-col items-center justify-center space-y-2 bg-gray-50 mx-6 mb-4">
                        <div class="text-sm font-medium text-gray-600">Scores:</div>
                        <div class="flex justify-around w-full gap-2">
                            <div class="flex-1 text-center bg-gray-50 p-2 rounded-md">
                                <div class="text-xs font-medium text-gray-600 mb-1">Overall Score</div>
                                <div class="text-xl font-bold text-blue-600" id="nps-overall-score-display">0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 px-6">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Original NPS Feedback</h4>
                        <table id="npsSummaryTable" class="min-w-full">
                            <thead>
                                <tr>
                                    <th>NPS Rating</th>
                                    <th>Positive Feedback</th>
                                    <th>Area of Improvement</th>
                                </tr>
                            </thead>
                            <tbody id="npsSummaryTableBody">
                                <tr><td colspan="3" class="text-center py-2 text-gray-500">Loading feedback...</td></tr>
                            </tbody>
                        </table>
                    </div>


                    <div class="mt-4">
                        <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2">
                            <i class="fas fa-question-circle tile-icon"></i> NPS Evaluation Questions
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-12 gap-2 text-sm font-medium text-gray-700 mb-2">
                                <div class="col-span-6 question-description">Description</div>
                                <div class="col-span-2 text-center">Rating</div>
                                <div class="col-span-1 text-center">Weight</div>
                                <div class="col-span-1 text-center">Pnts</div>
                                <div class="col-span-2">Remarks</div>
                            </div>
                            <div id="npsQuestionsContainer">
                                </div>
                        </div>
                    </div>

                    <div class="p-6 flex justify-end space-x-4">
                        <button type="button" id="npsSaveAndPdfBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                            Save & Convert to PDF
                        </button>
                        <button type="button" id="npsShareBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                            Share
                        </button>
                        <button type="button" id="npsCloseModalBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                            Close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, where, orderBy, limit, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, writeBatch } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
          authDomain: "icea-lion-qa.firebaseapp.com",
          projectId: "icea-lion-qa",
          storageBucket: "icea-lion-qa.firebasestorage.app",
          messagingSenderId: "820082472004",
          appId: "1:820082472004:web:8caddf941e1b5b6dfaf811",
          measurementId: "G-1RJJTT3QET"
        };

        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;
        const initialAuthToken = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== null) ? __initial_auth_token : null;

        // Initialize Firebase App and Services ONCE at the top level of the module
        let appInstance;
        if (!getApps().length) {
            appInstance = initializeApp(firebaseConfig);
        } else {
            appInstance = getApp();
        }
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);

        // Define Firebase Collection Paths
        const NPS_RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/nps_records`; // For Google Sheet data synced to Firestore
        const NPS_EVALUATIONS_COLLECTION_PATH = `artifacts/${appId}/public/data/nps_evaluations`; // For NPS evaluation forms (new collection)
        const DROPDOWN_DATA_COLLECTION_PATH = `artifacts/${appId}/public/data/dropdown_options`;
        const USERS_PROFILE_COLLECTION_PATH = `artifacts/${appId}/users`;

        // --- GLOBAL DATA STORES & STATE VARIABLES ---
        let allNpsRecordsFromFirestore = []; // Stores NPS records synced from Google Sheet
        let allNpsEvaluations = []; // Stores completed NPS evaluation forms
        let dropdownOptions = {
            'reviewerNames': [], 
            'autofailTypes': []
        };
        let cerNameEmailsMap = {}; 

        let currentUserId = null;
        let currentUserRole = null;
        let loggedInUserName = "Quality Evaluation Team";
        let loggedInUserEmail = "anonymous";

        let currentNpsRecordBeingEvaluated = null; // Stores the NPS record data for the current evaluation modal

        // Questions for the NPS Evaluation Form (from Email role, first 14 questions)
        const npsEvaluationQuestions = {
            "NPS EVALUATION": [
                { desc: "Did the CER provide proper branding and personalize the email?", weightage: 5, autofail: false, hasNA: true },
                { desc: "Did the CER demonstrate confidence and business etiquette althroughout the interaction?", weightage: 7, autofail: false, hasNA: true },
                { desc: "Did the CER express a sincere acknowledgement/empathy statement when applicable?", weightage: 7, autofail: false, hasNA: true },
                { desc: "Did the CER convey his/her thoughts in an understandable clear and concise manner?", weightage: 6, autofail: false, hasNA: true },
                { desc: "Did the CER keep the customer informed?", weightage: 5, autofail: false, hasNA: true },
                { desc: "Did the CER call to ask effective probing questions to ensure accurate diagnosis?", weightage: 9, autofail: false, hasNA: true },
                { desc: "Did the CER do proper research and check all related tools required?", weightage: 7, autofail: false, hasNA: true },
                { desc: "Did the CER show ownership and respond within the set turnaround time?(8 hours)", weightage: 6, autofail: false, hasNA: true },
                { desc: "Was the CER able to position all possible options to the customer?", weightage: 13, autofail: false, hasNA: true },
                { desc: "Did the CER avoid risk behavior? (Call avoidance/ZTP)", weightage: 8, autofail: false, hasNA: true },
                { desc: "Did the CER log ticket information correctly?", weightage: 6, autofail: false, hasNA: true },
                { desc: "Did the CER properly authenticate the writer?", weightage: 8, autofail: false, hasNA: true },
                { desc: "Did the CER provide complete and accurate information?(Customer education)", weightage: 9, autofail: false, hasNA: true },
                { desc: "Did the CER identify an opportunity to upsell/cross sell a product?", weightage: 5, autofail: false, hasNA: true }
            ]
        };

        let unsubscribeNpsRecords = null;
        let unsubscribeNpsEvaluations = null;
        let unsubscribeDropdowns = null;

        // --- Utility Functions ---
        window.autoExpandTextarea = function(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        };

        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxSpinner = document.getElementById('messageBoxSpinner');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxContent = document.getElementById('messageBoxContent');
            const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

            messageBoxTitle.textContent = title;
            if (typeof message === 'string' && message.startsWith('<pre>')) {
                messageBoxContent.innerHTML = message;
                messageBoxContent.classList.add('message-box-content-pre');
            } else {
                messageBoxContent.textContent = message;
                messageBoxContent.classList.remove('message-box-content-pre');
            }

            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            if (isError) {
                messageBoxTitle.style.color = '#dc2626';
            } else {
                messageBoxTitle.style.color = '#1a73e8';
            }

            messageBoxCloseBtn.onclick = null;  
            if (showCloseButton) {
                messageBoxCloseBtn.onclick = () => {
                    messageBoxOverlay.classList.add('hidden');
                    if (onClose) onClose();
                };
            }
        }

        function hideMessageBox() {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            messageBoxOverlay.classList.add('hidden');
        }

        // --- CSV Parsing Functions ---
        /**
         * Parses CSV text into an array of objects.
         */
        function parseCsv(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length === 0) return [];

            // Handle potential empty last line or blank lines
            const nonEmptyLines = lines.filter(line => line.trim() !== '');

            if (nonEmptyLines.length === 0) return [];

            const headers = parseCsvLine(nonEmptyLines[0]).map(h => h.trim());
            const data = [];

            for (let i = 1; i < nonEmptyLines.length; i++) {
                const values = parseCsvLine(nonEmptyLines[i]);
                if (values.length === headers.length) { // Ensure row has same number of columns as headers
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                } else {
                    console.warn(`Skipping row ${i+1} due to column count mismatch. Expected ${headers.length}, got ${values.length}. Row: ${nonEmptyLines[i]}`);
                }
            }
            return data;
        }

        /**
         * Helper to parse a single CSV line, handling commas within quoted fields.
         */
        function parseCsvLine(line) {
            const result = [];
            let inQuote = false;
            let currentField = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    // Handle escaped quotes within a quoted field (e.g., "abc""def")
                    if (inQuote && line[i + 1] === '"') {
                        currentField += '"';
                        i++; // Skip the next quote
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    result.push(currentField);
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField); // Add the last field
            return result.map(field => field.trim().replace(/^"|"$/g, '')); // Trim and remove outer quotes
        }


        /**
         * Fetches NPS records directly from the published Google Sheet CSV and syncs with Firestore.
         * IMPORTANT: This method may face CORS issues depending on browser and hosting environment.
         */
        async function fetchAndSyncNpsRecords() {
            // This is the direct CSV URL you provided.
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQCPENshkMrKwLf39IbhCUUsm1OFYxgZ4zeXa0IWfSnMUxlEyuUH0pDjl-XFBsdatVXyAS5Fpu5EUbv/pub?gid=149380162&single=true&output=csv'; 

            if (!csvUrl.startsWith('https://docs.google.com/spreadsheets/d/e/')) {
                showMessageBox("Configuration Error", "The published CSV URL is not a valid Google Sheets published URL. Please verify.", true, false, true);
                return;
            }

            showMessageBox("Loading NPS Data", "Fetching records directly from published Google Sheet...", false, true, false);

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}. This often indicates a CORS issue.`);
                }
                const csvText = await response.text();
                const parsedData = parseCsv(csvText);

                await syncGoogleSheetDataToFirestore(parsedData);
                hideMessageBox(); 
            } catch (error) {
                console.error("Error fetching or syncing Google Sheet CSV data:", error);
                let errorMessage = `Failed to load NPS data: ${error.message}.`;
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMessage += "\n\nThis is highly likely a CORS (Cross-Origin Resource Sharing) issue. Browsers often block direct CSV fetching from Google Sheets for security. The recommended solution is to use a Google Apps Script Web App as a proxy.";
                } else {
                    errorMessage += "\n\nPlease check the published URL and ensure your sheet's first row has exact matching headers.";
                }
                showMessageBox("Error", errorMessage, true, false, true);
            }
        }
        
        /**
         * Syncs Google Sheet data (now as parsed objects from CSV) to Firestore, creating new records or updating existing ones.
         */
        async function syncGoogleSheetDataToFirestore(sheetData) {
            if (!db || !currentUserId) {
                console.error("Database not ready for sync. Skipping.");
                return;
            }

            const npsRecordsColRef = collection(db, NPS_RECORDS_COLLECTION_PATH);
            const batch = writeBatch(db); 

            if (!Array.isArray(sheetData)) { 
                console.error("Expected sheetData to be an array but received:", sheetData);
                showMessageBox("Data Format Error", "Received invalid data from published CSV. Expected an array of records.", true, false, true);
                return;
            }

            for (const row of sheetData) {
                const contactId = row['Customer Contact ID']; 
                if (!contactId) {
                    console.warn("Skipping row due to missing 'Customer Contact ID':", row);
                    continue;
                }

                const q = query(npsRecordsColRef, where('Customer Contact ID', '==', contactId));
                const querySnapshot = await getDocs(q);

                const recordData = {
                    'Customer Contact ID': row['Customer Contact ID'] || '', 
                    'Positive Feedback': row['Positive Feedback'] || '', 
                    'Area of Improvement': row['Area of Improvement'] || '', 
                    'NPS Rating': row['NPS Rating'] || '', 
                    'Agent Handled': row['Agent Handled'] || 'Unassigned', 
                    'Status': row['Status'] || 'Pending', 
                    'Review Score': row['Review Score'] || 'N/A', 
                    'lastUpdated': new Date() 
                };

                if (querySnapshot.empty) {
                    recordData.receivedDate = new Date(); 
                    const newDocRef = doc(npsRecordsColRef); 
                    batch.set(newDocRef, recordData);
                } else {
                    querySnapshot.forEach(document => {
                        const existingData = document.data();
                        let needsUpdate = false;

                        // Only update if source data (CSV) differs for these key fields
                        if (existingData['Positive Feedback'] !== recordData['Positive Feedback'] ||
                            existingData['Area of Improvement'] !== recordData['Area of Improvement'] ||
                            existingData['NPS Rating'] !== recordData['NPS Rating']) {
                            needsUpdate = true;
                        }

                        // Update Agent Handled only if it's currently 'Unassigned' in Firestore
                        // AND the CSV provides a new (non-empty) value.
                        // OR if it's different and non-empty in CSV.
                        if (existingData['Agent Handled'] === 'Unassigned' && recordData['Agent Handled'] !== 'Unassigned') {
                            needsUpdate = true;
                        } else if (existingData['Agent Handled'] !== recordData['Agent Handled'] && recordData['Agent Handled'] !== '') {
                             needsUpdate = true;
                        }

                        // Status and Review Score are managed by the app, usually not updated from CSV sync directly
                        // unless you explicitly want the CSV to override them.
                        // For this sync, we assume they are managed by app evaluations.

                        if (needsUpdate) {
                            batch.update(document.ref, recordData);
                        }
                    });
                }
            }
            await batch.commit();
            console.log("Google Sheet data sync batch committed.");
        }

        /**
         * Listens to real-time updates from NPS records in Firestore and renders the table.
         */
        async function fetchNpsRecordsFromFirestore() {
            const npsRecordsTableBody = document.getElementById('npsRecordsTableBody');
            npsRecordsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Loading NPS records from Firestore...</td></tr>`;

            if (!db || !currentUserId) {
                console.warn("Firestore not ready or user not authenticated. Cannot fetch NPS records.");
                npsRecordsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Authentication required to load NPS records.</td></tr>`;
                return;
            }

            if (unsubscribeNpsRecords) {
                unsubscribeNpsRecords(); 
            }

            try {
                const npsRecordsColRef = collection(db, NPS_RECORDS_COLLECTION_PATH);
                const q = query(npsRecordsColRef, orderBy('receivedDate', 'desc')); 

                unsubscribeNpsRecords = onSnapshot(q, (snapshot) => {
                    allNpsRecordsFromFirestore = []; 
                    const today = new Date();
                    snapshot.forEach(doc => {
                        const record = { id: doc.id, ...doc.data() };
                        
                        if (record.Status === 'Pending' && record.receivedDate) {
                            const receivedDate = typeof record.receivedDate.toDate === 'function' ? record.receivedDate.toDate() : new Date(record.receivedDate);
                            if (!isNaN(receivedDate.getTime())) {
                                const sevenDaysInMillis = 7 * 24 * 60 * 60 * 1000;
                                if ((today.getTime() - receivedDate.getTime()) > sevenDaysInMillis) {
                                    record.Status = 'Overdue';
                                    updateDoc(doc(db, NPS_RECORDS_COLLECTION_PATH, record.id), { Status: 'Overdue', lastUpdated: new Date() }).catch(e => console.error("Error updating NPS status to Overdue:", e));
                                }
                            }
                        }
                        allNpsRecordsFromFirestore.push(record);
                    });
                    renderNpsRecordsTable(allNpsRecordsFromFirestore);
                }, (error) => {
                    console.error("Error listening to NPS records from Firestore:", error);
                    npsRecordsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Error fetching live NPS data: ${error.message}</td></tr>`;
                    showMessageBox("Error Loading NPS", `Could not load live NPS data: ${error.message}`, true, false, true);
                });
            } catch (e) {
                console.error("Failed to set up onSnapshot for NPS records:", e);
                npsRecordsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Initialization Error: ${e.message}</td></tr>`;
            }
        }


        /**
         * Renders the NPS records table.
         * @param {Array<Object>} records - Array of NPS record objects.
         */
        function renderNpsRecordsTable(records) {
            const npsRecordsTableBody = document.getElementById('npsRecordsTableBody');
            npsRecordsTableBody.innerHTML = ''; 

            if (records.length === 0) {
                npsRecordsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">No NPS records found.</td></tr>`;
                return;
            }

            records.forEach(record => {
                const row = npsRecordsTableBody.insertRow();
                let statusClass = 'status-default';
                if (record.Status === 'Completed') {
                    statusClass = 'status-completed';
                } else if (record.Status === 'Pending') {
                    statusClass = 'status-pending';
                } else if (record.Status === 'Overdue') {
                    statusClass = 'status-overdue';
                }

                row.innerHTML = `
                    <td class="py-2 px-4">${record['Customer Contact ID'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['Positive Feedback'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['Area of Improvement'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['NPS Rating'] || 'N/A'}</td>
                    <td class="py-2 px-4 editable-cell" data-field="Agent Handled" data-id="${record.id}">${record['Agent Handled'] || 'Unassigned'}</td>
                    <td class="py-2 px-4">
                        <select class="nps-status-select ${statusClass}" data-id="${record.id}" data-original-status="${record.Status}">
                            <option value="Pending" ${record.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Completed" ${record.Status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Overdue" ${record.Status === 'Overdue' ? 'selected' : ''}>Overdue</option>
                        </select>
                    </td>
                    <td class="py-2 px-4">${record['Review Score'] || 'N/A'}</td>
                    <td class="py-2 px-4 whitespace-nowrap">
                        <button class="review-btn" data-id="${record.id}">Review</button>
                        <button class="share-nps-btn" data-id="${record.id}">Share</button>
                    </td>
                `;
            });

            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', enableInlineEdit);
            });
            document.querySelectorAll('.nps-status-select').forEach(select => {
                select.addEventListener('change', updateNpsRecordStatus);
            });
            document.querySelectorAll('.review-btn').forEach(button => {
                button.addEventListener('click', (e) => openNpsEvaluationModal(e.target.dataset.id));
            });
            document.querySelectorAll('.share-nps-btn').forEach(button => {
                button.addEventListener('click', (e) => shareNpsEvaluation(e.target.dataset.id));
            });
        }

        /**
         * Enables inline editing for Agent Handled field.
         */
        function enableInlineEdit(event) {
            const cell = event.target;
            if (cell.classList.contains('editing')) return;

            const originalText = cell.textContent.trim();
            const recordId = cell.dataset.id;
            const field = cell.dataset.field; 

            cell.innerHTML = `<input type="text" value="${originalText}" class="w-full p-1 border rounded-md text-sm">`;
            const input = cell.querySelector('input');
            input.focus();
            input.select(); 

            cell.classList.add('editing');

            const saveChanges = async () => {
                const newText = input.value.trim();
                cell.textContent = newText; 
                cell.classList.remove('editing');

                if (newText !== originalText) {
                    try {
                        const docRef = doc(db, NPS_RECORDS_COLLECTION_PATH, recordId);
                        await updateDoc(docRef, { [field]: newText, lastUpdated: new Date() });
                        showMessageBox("Update Success", `${field} updated successfully!`, false, false, true);
                    } catch (e) {
                        console.error("Error updating field:", e);
                        showMessageBox("Update Failed", `Failed to update ${field}: ${e.message}`, true, false, true);
                        cell.textContent = originalText; 
                    }
                }
            };

            input.addEventListener('blur', saveChanges);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    input.blur(); 
                }
            });
        }

        /**
         * Updates the status of an NPS record in Firestore.
         */
        async function updateNpsRecordStatus(event) {
            const select = event.target;
            const recordId = select.dataset.id;
            const newStatus = select.value;
            const originalStatus = select.dataset.originalStatus; 

            try {
                const docRef = doc(db, NPS_RECORDS_COLLECTION_PATH, recordId);
                await updateDoc(docRef, { Status: newStatus, lastUpdated: new Date() });
                select.dataset.originalStatus = newStatus;
                
                select.classList.remove('status-completed', 'status-pending', 'status-overdue', 'status-default');
                if (newStatus === 'Completed') {
                    select.classList.add('status-completed');
                } else if (newStatus === 'Pending') {
                    select.classList.add('status-pending');
                } else if (newStatus === 'Overdue') {
                    select.classList.add('status-overdue');
                } else {
                    select.classList.add('status-default');
                }
                
                showMessageBox("Status Updated", `Record status changed to ${newStatus}.`, false, false, true);
            } catch (e) {
                console.error("Error updating NPS record status:", e);
                showMessageBox("Update Failed", `Failed to update status: ${e.message}`, true, false, true);
                select.value = originalStatus; 
            }
        }

        /**
         * Opens the NPS evaluation modal and populates it.
         */
        function openNpsEvaluationModal(npsRecordId) {
            const modalOverlay = document.getElementById('npsEvaluationModalOverlay');
            const npsEvaluationForm = document.getElementById('nps-evaluation-form');
            const npsContactIdInput = document.getElementById('nps-contact-id');
            const npsAgentHandledInput = document.getElementById('nps-agent-handled');
            const npsReviewDateInput = document.getElementById('nps-review-date');
            const npsReviewerNameSelect = document.getElementById('nps-reviewer-name');
            const npsAutofailTypeSelect = document.getElementById('nps-autofail-type');
            const npsAutofailDescriptionContainer = document.getElementById('npsAutofailDescriptionContainer');
            const npsAutofailDescriptionInput = document.getElementById('nps-autofail-description');
            // New elements for NPS Summary Table
            const npsSummaryTableBody = document.getElementById('npsSummaryTableBody');


            const record = allNpsRecordsFromFirestore.find(r => r.id === npsRecordId);
            if (!record) {
                showMessageBox("Error", "NPS record not found for evaluation.", true, false, true);
                return;
            }
            currentNpsRecordBeingEvaluated = record; 

            // Populate top fields
            npsContactIdInput.value = record['Customer Contact ID'] || '';
            npsAgentHandledInput.value = record['Agent Handled'] || '';
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            npsReviewDateInput.value = `${year}-${month}-${day}`;

            populateSelect(npsReviewerNameSelect, dropdownOptions.reviewerNames, 'reviewerNames');
            populateSelect(npsAutofailTypeSelect, dropdownOptions.autofailTypes, 'autofailTypes');

            // Populate NPS Summary Table
            npsSummaryTableBody.innerHTML = `
                <tr>
                    <td>${record['NPS Rating'] || 'N/A'}</td>
                    <td>${record['Positive Feedback'] || 'N/A'}</td>
                    <td>${record['Area of Improvement'] || 'N/A'}</td>
                </tr>
            `;

            renderNpsEvaluationQuestions(); // Renders the evaluation questions

            npsAutofailTypeSelect.value = '';
            npsAutofailDescriptionInput.value = '';
            npsAutofailDescriptionContainer.classList.add('hidden');
            npsAutofailDescriptionInput.removeAttribute('required');

            modalOverlay.classList.remove('hidden');
        }

        function closeNpsEvaluationModal() {
            document.getElementById('npsEvaluationModalOverlay').classList.add('hidden');
            document.getElementById('nps-evaluation-form').reset(); 
            currentNpsRecordBeingEvaluated = null; 
            calculateNpsEvaluationScore();
        }

        /**
         * Renders the specific questions for NPS evaluation form.
         */
        function renderNpsEvaluationQuestions() {
            const npsQuestionsContainer = document.getElementById('npsQuestionsContainer');
            npsQuestionsContainer.innerHTML = ''; 

            const questions = npsEvaluationQuestions["NPS EVALUATION"];
            let questionNumber = 1;

            questions.forEach(q => {
                const rowDiv = document.createElement('div');
                rowDiv.className = `grid grid-cols-12 gap-2 py-2 items-center rounded-md mb-2 p-2 ${questionNumber % 2 === 1 ? 'form-row-light' : 'form-row-dark'}`;

                let iconColorClass;
                const iconIndex = (questionNumber - 1) % 4;
                if (iconIndex === 0) iconColorClass = 'icon-bg-orange';
                else if (iconIndex === 1) iconColorClass = 'icon-bg-blue';
                else if (iconIndex === 2) iconColorClass = 'icon-bg-green';
                else iconColorClass = 'icon-bg-yellow';

                rowDiv.innerHTML = `
                    <div class="col-span-6 flex items-center gap-2 question-description">
                        <span class="${iconColorClass} rounded-full p-1 text-white text-xs inline-flex items-center justify-center w-6 h-6">${questionNumber}</span>
                        ${q.desc}
                    </div>
                    <div class="col-span-2">
                        <select name="${q.desc} (Rating)" class="w-full rounded-md border-gray-300 shadow-sm p-1 text-center border rating-select" ${q.autofail ? 'data-autofail-question="true"' : ''} data-has-na="${q.hasNA}">
                            <option value="">Select Rating</option>
                            <option value="Yes" selected>Yes</option>
                            <option value="No">No</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </div>
                    <div class="col-span-1 text-center weightage-display" data-weightage="${q.weightage}">${q.weightage}</div>
                    <div class="col-span-1 text-center">
                        <input type="number" name="${q.desc} (Points)" class="w-full text-center p-1 border rounded-md points-input" value="0" readonly placeholder="0">
                    </div>
                    <div class="col-span-2">
                        <textarea name="${q.desc} (Remarks)" rows="1" class="w-full rounded-md border-gray-300 shadow-sm p-1 border remarks-textarea" oninput="autoExpandTextarea(this)"></textarea>
                    </div>
                `;
                npsQuestionsContainer.appendChild(rowDiv);

                const newSelect = rowDiv.querySelector('.rating-select');
                if (newSelect) {
                    newSelect.addEventListener('change', calculateNpsEvaluationScore);
                }
                questionNumber++;
            });
            calculateNpsEvaluationScore(); 
            document.querySelectorAll('#npsQuestionsContainer .remarks-textarea').forEach(textarea => {
                autoExpandTextarea(textarea);
            });
        }

        /**
         * Calculates the score for the NPS evaluation form.
         */
        function calculateNpsEvaluationScore() {
            const overallScoreDisplay = document.getElementById('nps-overall-score-display');
            const autofailTypeSelect = document.getElementById('nps-autofail-type');

            let currentTotalPoints = 0;
            let currentMaxPossiblePoints = 0;
            let autofailQuestionTriggered = false;
            let autofailTypeSelected = (autofailTypeSelect && autofailTypeSelect.value !== '');

            const allRatingSelects = document.querySelectorAll('#nps-evaluation-form .rating-select');

            allRatingSelects.forEach(selectElement => {
                const rowDiv = selectElement.closest('.grid.grid-cols-12.gap-2.py-2');
                if (!rowDiv) return;

                const pointsElement = rowDiv.querySelector('.points-input');
                const weightageDisplay = rowDiv.querySelector('.weightage-display');
                const isAutofailQuestion = selectElement.hasAttribute('data-autofail-question');
                
                if (!pointsElement || !weightageDisplay) {
                    console.warn(`Missing associated elements for select: ${selectElement.name}`);
                    return;
                }

                const rating = selectElement.value;
                const weightage = parseFloat(weightageDisplay.dataset.weightage);
                let pointsForThisQuestion = 0;

                pointsElement.style.backgroundColor = '#e9ecef';
                pointsElement.style.color = '#555';

                if (rating === 'Yes' || rating === 'N/A') {
                    pointsForThisQuestion = weightage;
                    pointsElement.readOnly = false;
                    pointsElement.style.backgroundColor = '#fff';
                } else if (rating === 'No') {
                    pointsForThisQuestion = 0;
                    pointsElement.readOnly = true;

                    if (isAutofailQuestion) {
                        pointsElement.style.backgroundColor = '#fca5a5';
                        pointsElement.style.color = '#dc2626';
                        autofailQuestionTriggered = true;
                    } else {
                        pointsElement.style.backgroundColor = '#e0e0e0';
                    }
                } else { // Handle empty selection ("Select Rating")
                    pointsForThisQuestion = 0;
                    pointsElement.readOnly = true;
                    pointsElement.style.backgroundColor = '#e9ecef';
                }

                pointsElement.value = pointsForThisQuestion;
                currentTotalPoints += pointsForThisQuestion;

                if (rating !== '') { 
                    currentMaxPossiblePoints += weightage;
                }
            });

            let overallPercentage = 0;
            if (autofailQuestionTriggered || autofailTypeSelected) {
                overallPercentage = 0;
            } else {
                if (currentMaxPossiblePoints > 0) {
                    overallPercentage = ((currentTotalPoints / currentMaxPossiblePoints) * 100).toFixed(0);
                } else {
                    overallPercentage = 0;
                }
            }
            overallScoreDisplay.textContent = `${overallPercentage}%`;
        }

        /**
         * Saves the NPS evaluation form data to Firestore.
         */
        async function saveNpsEvaluation() {
            const npsEvaluationForm = document.getElementById('nps-evaluation-form');
            if (!currentNpsRecordBeingEvaluated) {
                showMessageBox("Error", "No NPS record selected for evaluation.", true, false, true);
                return;
            }

            const npsContactId = document.getElementById('nps-contact-id').value.trim();
            const npsAgentHandled = document.getElementById('nps-agent-handled').value.trim();
            const npsReviewDate = document.getElementById('nps-review-date').value;
            const npsReviewerName = document.getElementById('nps-reviewer-name').value;
            const npsAutofailType = document.getElementById('nps-autofail-type').value;
            const npsAutofailDescription = document.getElementById('nps-autofail-description').value.trim();
            const npsOverallScore = document.getElementById('nps-overall-score-display').textContent;

            if (!npsReviewerName || !npsReviewDate) {
                showMessageBox("Validation Error", "Please fill in all required fields in the evaluation form.", true, false, true);
                return;
            }
            if (npsAutofailType && !npsAutofailDescription) {
                showMessageBox("Validation Error", "Please provide a description for the selected Autofail Type.", true, false, true);
                document.getElementById('nps-autofail-description').style.borderColor = 'red';
                return;
            } else {
                document.getElementById('nps-autofail-description').style.borderColor = '';
            }

            const evaluationData = {
                'Original NPS Record ID': currentNpsRecordBeingEvaluated.id, 
                'Customer Contact ID': npsContactId,
                'Agent Handled': npsAgentHandled,
                'Evaluation Date': npsReviewDate,
                'Reviewer\'s Name': npsReviewerName,
                'Auto Fail Type': npsAutofailType,
                'Autofail Description': npsAutofailDescription,
                'NPS Evaluation Score': npsOverallScore,
                'Evaluated By User ID': currentUserId,
                'Evaluated By User Email': loggedInUserEmail,
                'submittedAt': new Date()
            };

            const allRatingSelects = npsEvaluationForm.querySelectorAll('.rating-select');
            allRatingSelects.forEach(selectElement => {
                const questionDesc = selectElement.name.replace(' (Rating)', '');
                const rating = selectElement.value;
                const remarksInput = selectElement.closest('.grid').querySelector('.remarks-textarea');
                const pointsInput = selectElement.closest('.grid').querySelector('.points-input');
                const weightageDisplay = selectElement.closest('.grid').querySelector('.weightage-display');
                
                evaluationData[`${questionDesc} (Rating)`] = rating;
                evaluationData[`${questionDesc} (Points)`] = pointsInput ? pointsInput.value : '';
                evaluationData[`${questionDesc} (Remarks)`] = remarksInput ? remarksInput.value : '';
                evaluationData[`${questionDesc} (Weightage)`] = weightageDisplay ? weightageDisplay.dataset.weightage : '';
            });

            showMessageBox("Saving Evaluation", "Saving NPS evaluation...", false, true, false);

            try {
                const docRef = await addDoc(collection(db, NPS_EVALUATIONS_COLLECTION_PATH), evaluationData);
                console.log("NPS Evaluation saved with ID:", docRef.id);

                const originalNpsDocRef = doc(db, NPS_RECORDS_COLLECTION_PATH, currentNpsRecordBeingEvaluated.id);
                await updateDoc(originalNpsDocRef, {
                    'Status': 'Completed', 
                    'Review Score': npsOverallScore, 
                    'lastUpdated': new Date() 
                });
                console.log("Original NPS record updated to 'Completed' with score.");

                showMessageBox("Success", "NPS Evaluation saved and original record updated!", false, false, true, closeNpsEvaluationModal);

            } catch (e) {
                console.error("Error saving NPS evaluation:", e);
                showMessageBox("Save Failed", `Failed to save NPS evaluation: ${e.message}`, true, false, true);
            }
        }

        /**
         * Handles the PDF generation and sharing for NPS evaluations.
         */
        async function handleNpsPdfAndShare() {
             if (!currentNpsRecordBeingEvaluated) {
                showMessageBox("Error", "No NPS evaluation selected to generate PDF.", true, false, true);
                return;
            }

            showMessageBox("Generating PDF", "Please wait, generating PDF document for NPS evaluation...", false, true, false);

            try {
                const npsEvaluationModalContentDiv = document.getElementById('npsEvaluationModalContent');
                // Temporarily hide buttons for PDF capture
                const buttonsContainer = npsEvaluationModalContentDiv.querySelector('.p-6.flex.justify-end.space-x-4');
                let originalButtonsDisplay = '';
                if (buttonsContainer) {
                    originalButtonsDisplay = buttonsContainer.style.display;
                    buttonsContainer.style.display = 'none';
                }

                // Capture only the modal content
                const canvas = await html2canvas(npsEvaluationModalContentDiv, {
                    scale: 2, // Higher scale for better quality
                    useCORS: true,
                    logging: false,
                    // These options might help with capturing scrollable content correctly
                    windowWidth: npsEvaluationModalContentDiv.scrollWidth,
                    windowHeight: npsEvaluationModalContentDiv.scrollHeight,
                    x: npsEvaluationModalContentDiv.scrollLeft,
                    y: npsEvaluationModalContentDiv.scrollTop,
                    scrollX: 0, // Important: Reset scroll position to capture from top-left
                    scrollY: 0, // Important: Reset scroll position to capture from top-left
                });
                const imgData = canvas.toDataURL('image/jpeg', 0.8);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - pageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const pdfFileName = `NPS_Evaluation_${currentNpsRecordBeingEvaluated['Customer Contact ID'] || 'Record'}_${new Date().toLocaleDateString('en-CA')}.pdf`; 
                pdf.save(pdfFileName);

                // Revert button display
                if (buttonsContainer) {
                    buttonsContainer.style.display = originalButtonsDisplay;
                }
                
                const subject = `NPS Evaluation Feedback - ${currentNpsRecordBeingEvaluated['Customer Contact ID'] || 'N/A'}`;
                const body = `Dear Team,\n\nPlease find the NPS evaluation attached for Contact ID: ${currentNpsRecordBeingEvaluated['Customer Contact ID'] || 'N/A'}.\n\n(IMPORTANT: The PDF document "${pdfFileName}" has been downloaded to your device. Please attach it manually to this email before sending.)\n\nKind Regards,\n${loggedInUserName}`;
                
                window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

                hideMessageBox();
                showMessageBox("PDF Downloaded & Email Opened", `The PDF "${pdfFileName}" has been downloaded. Your email client should open shortly. Please remember to manually attach the downloaded PDF.`, false, false, true);

            } catch (error) {
                console.error("Error generating NPS PDF or preparing for sharing:", error);
                hideMessageBox();
                showMessageBox("Action Failed", `Could not generate NPS PDF or prepare for sharing: ${error.message}. Please try again.`, true, false, true);
            }
        }

        // Placeholder for share functionality - you can expand this
        function shareNpsEvaluation(npsRecordId) {
            const record = allNpsRecordsFromFirestore.find(r => r.id === npsRecordId);
            if (!record) {
                showMessageBox("Error", "NPS record not found for sharing.", true, false, true);
                return;
            }
            showMessageBox("Share NPS Record", `Would initiate sharing for NPS Record ID: ${record['Customer Contact ID']}. (Implementation needed)`, false, false, true);
        }

        // Helper to populate a single select element (copied from index.html for consistency)
        const populateSelect = (selectElement, optionsArray, type) => {
            const currentSelectedValue = selectElement.value; 
            let defaultOptionText = 'Select ' + (type === 'cerNames' ? 'CER' : type.replace('Names', '').replace('Types', '').replace('Roles', ''));
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            
            if (Array.isArray(optionsArray)) {
                optionsArray.forEach(option => {
                    const value = (type === 'cerNames' && typeof option === 'object' && option.name) ? option.name : option;
                    const optionElement = document.createElement('option');
                    optionElement.value = value;
                    optionElement.textContent = value;
                    selectElement.appendChild(optionElement);
                });
            } else {
                console.warn(`Dropdown options for ${type} is not an array:`, optionsArray);
            }

            if (Array.from(selectElement.options).some(opt => opt.value === currentSelectedValue)) {
                selectElement.value = currentSelectedValue;
            } else {
                selectElement.value = ''; 
            }
        };

        // Function to fetch and populate dropdown options from Firestore 
        async function fetchDropdownOptionsData() {
            if (!db) {
                console.warn("Firestore not ready for fetching dropdowns.");
                return;
            }
            if (!DROPDOWN_DATA_COLLECTION_PATH) {
                console.error("Dropdowns collection path is not defined.");
                return;
            }

            const dropdownDocRef = doc(db, DROPDOWN_DATA_COLLECTION_PATH, 'general_options');

            if (unsubscribeDropdowns) {
                unsubscribeDropdowns(); 
            }

            unsubscribeDropdowns = onSnapshot(dropdownDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    dropdownOptions.reviewerNames = data.reviewerNames || [];
                    dropdownOptions.autofailTypes = data.autofailTypes || [];

                    console.log("Dropdown data updated from Firestore:", dropdownOptions);
                } else {
                    console.warn("Dropdown options document does not exist.");
                    dropdownOptions = { reviewerNames: [], autofailTypes: [] }; 
                }
                 
                const npsReviewerNameSelect = document.getElementById('nps-reviewer-name');
                const npsAutofailTypeSelect = document.getElementById('nps-autofail-type');
                populateSelect(npsReviewerNameSelect, dropdownOptions.reviewerNames, 'reviewerNames');
                populateSelect(npsAutofailTypeSelect, dropdownOptions.autofailTypes, 'autofailTypes');
            }, (error) => {
                console.error("Error listening to dropdown data:", error);
            });
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("NPS DOM fully loaded and parsed. Script starting.");

            document.querySelectorAll('.main-nav ul li a').forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    if (href === '#' || href.startsWith('index.html#')) {
                        e.preventDefault();
                        if (href === '#') { 
                            console.log("Already on NPS page.");
                        } else { 
                            window.location.href = href;
                        }
                    } else { 
                        // Let default behavior happen (browser navigates to the new page)
                    }
                });
            });

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    sessionStorage.removeItem('loggedIn');
                    if (unsubscribeNpsRecords) unsubscribeNpsRecords();
                    if (unsubscribeNpsEvaluations) unsubscribeNpsEvaluations();
                    if (unsubscribeDropdowns) unsubscribeDropdowns();
                    await signOut(auth);
                    window.location.href = 'index.html'; 
                });
            }

            const npsFeedbackTab = document.getElementById('npsFeedbackTab');
            if (npsFeedbackTab) {
                npsFeedbackTab.classList.add('active');
            }

            const npsCloseModalBtn = document.getElementById('npsCloseModalBtn');
            if (npsCloseModalBtn) {
                npsCloseModalBtn.addEventListener('click', closeNpsEvaluationModal);
            }
            const npsSaveAndPdfBtn = document.getElementById('npsSaveAndPdfBtn');
            if (npsSaveAndPdfBtn) {
                npsSaveAndPdfBtn.addEventListener('click', saveNpsEvaluation); 
            }
            const npsShareBtn = document.getElementById('npsShareBtn');
            if (npsShareBtn) {
                 npsShareBtn.addEventListener('click', handleNpsPdfAndShare); 
            }

            const npsAutofailTypeSelect = document.getElementById('nps-autofail-type');
            const npsAutofailDescriptionContainer = document.getElementById('npsAutofailDescriptionContainer');
            const npsAutofailDescriptionInput = document.getElementById('nps-autofail-description');
            if (npsAutofailTypeSelect) {
                npsAutofailTypeSelect.addEventListener('change', () => {
                    if (npsAutofailTypeSelect.value !== '') {
                        npsAutofailDescriptionContainer.classList.remove('hidden');
                        npsAutofailDescriptionInput.setAttribute('required', 'required');
                    } else {
                        npsAutofailDescriptionContainer.classList.add('hidden');
                        npsAutofailDescriptionInput.value = '';
                        npsAutofailDescriptionInput.removeAttribute('required');
                    }
                    calculateNpsEvaluationScore(); 
                });
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    const isLoggedInFromSession = sessionStorage.getItem('loggedIn');

                    if (isLoggedInFromSession === 'true') {
                        console.log("NPS Page: User is logged in, proceeding with data fetches.");
                        await fetchDropdownOptionsData();
                        await fetchAndSyncNpsRecords(); // This will use the CSV URL
                        await fetchNpsRecordsFromFirestore(); 
                        document.body.classList.add('loaded'); 
                    } else {
                        console.warn("NPS Page: Firebase user detected but session invalid. Redirecting to login.");
                        await signOut(auth);
                        window.location.href = 'index.html';
                    }
                } else {
                    console.log("NPS Page: No user logged in. Attempting anonymous sign-in for public data access.");
                    try {
                        await signInAnonymously(auth);
                        currentUserId = auth.currentUser.uid;
                        console.log("NPS Page: Signed in anonymously. Fetching dropdowns and NPS records.");
                        await fetchDropdownOptionsData();
                        await fetchNpsRecordsFromFirestore(); 
                        await fetchAndSyncNpsRecords(); 
                        document.body.classList.add('loaded'); 
                    } catch (anonError) {
                        console.error("NPS Page: Anonymous sign-in failed. Redirecting to login.", anonError);
                        window.location.href = 'index.html';
                    }
                }
            });
        });
    </script>
</body>
</html>
