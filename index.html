<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICEA LION GROUP - Evaluation Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* bg-gray-100 */
            font-size: 14px; /* Base body font size */
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles */
        .error-message {
            color: #dc2626; /* red-700 */
            font-size: 13px; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }

        /* Navigation styles */
        .main-nav {
            width: 100%;
            background-color: #0d47a1; /* Updated: Dark blue */
            color: white;
            padding: 0.8rem 1.5rem; /* Slightly reduced padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed; /* Make nav sticky */
            top: 0;
            left: 0;
            z-index: 50; /* Ensure it's above content */
        }
        .main-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }
        .main-nav ul li {
            margin-right: 1rem; /* Reduced margin */
        }
        .main-nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.4rem 0.8rem; /* Reduced padding */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.3s ease;
            font-size: 14px; /* Nav link font size */
        }
        .main-nav ul li a:hover,
        .main-nav ul li a.active {
            background-color: #f7b32d; /* Updated: Yellow for hover/active */
        }
        .logout-button {
            background-color: #f57c00; /* icealion-orange */
            color: white;
            padding: 0.4rem 0.8rem; /* Reduced padding */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            font-size: 14px; /* Button font size */
        }
        .logout-button:hover {
            background-color: #e65100; /* darker orange */
        }

        /* Main content container */
        .main-container {
            width: 100%;
            max-width: 960px; /* Max width for content */
            padding: 2rem;
            margin-top: 70px; /* Space for fixed nav */
            flex-grow: 1; /* Allow content to grow */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Login page specific styles */
        .login-container {
            /* Keep original login-container styles as they position it centrally */
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem 1rem;
            z-index: 10;
        }

        /* Common card styles */
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        /* Evaluation Form specific styles */
        .evaluation-form-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem;
            text-align: center;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151; /* gray-700 */
            margin-bottom: 0.25rem;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            font-family: Garamond, serif; /* Apply Garamond */
        }
        .form-group input[type="radio"],
        .form-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .radio-group label, .checkbox-group label {
            display: inline-flex;
            align-items: center;
            margin-right: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            background-color: #1a73e8; /* icealion-blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .submit-btn:hover {
            background-color: #0d47a1; /* darker blue */
        }
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Section headers */
        .section-header {
            background-color: #e0f2f7; /* Light blue background */
            padding: 0.75rem 1.5rem;
            border-left: 5px solid #1a73e8; /* Blue border */
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
        }
        .section-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a73e8;
        }

        /* Scoring and Total section */
        .scoring-section {
            background-color: #f0f4f8; /* Very light blue/gray */
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .scoring-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #374151;
        }
        .scoring-item span:first-child {
            flex-grow: 1;
        }
        .scoring-item span:last-child {
            font-weight: 700;
            color: #1a73e8; /* Blue for scores */
        }
        .total-score {
            border-top: 2px solid #a7d9ef; /* Lighter blue border */
            padding-top: 1rem;
            margin-top: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-score span:last-child {
            color: #f57c00; /* Orange for total */
        }

        /* Message Box styles */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8;
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* DataTables Custom Styles (minimal, usually via CDN) */
        .dataTables_wrapper {
            margin-top: 1.5rem;
        }
        .dataTables_filter label input {
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
            font-size: 0.875rem;
        }
        table.dataTable thead th {
            background-color: #eff6ff;
            color: #1f2937;
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            font-size: 0.875rem;
        }
        table.dataTable tbody td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        table.dataTable tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        table.dataTable tbody tr:hover {
            background-color: #f3f4f6;
        }
        .dataTables_paginate .paginate_button {
            padding: 0.5em 0.8em;
            margin: 0 0.2em;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background-color: #f9fafb;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .dataTables_paginate .paginate_button.current,
        .dataTables_paginate .paginate_button:hover {
            background-color: #1a73e8;
            color: white !important;
            border-color: #1a73e8;
        }
        .dataTables_length, .dataTables_info {
            font-size: 0.875rem;
            color: #4b5563;
        }
        .dt-buttons {
            margin-bottom: 1rem;
        }
        .dt-buttons .dt-button {
            background-color: #10b981; /* Green-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .dt-buttons .dt-button:hover {
            background-color: #059669; /* Green-600 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <div class="login-container absolute inset-0 flex items-center justify-center p-4 md:p-8 z-10" id="loginPage">
        <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-md">
            <div class="icealion-blue p-6 rounded-t-lg text-center">
                <h1 class="text-2xl font-semibold">ICEALION GROUP Login</h1>
            </div>

            <form id="loginForm" class="p-8 space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="email" id="username" name="username"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your email">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your password">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Login
                </button>
                <button type="button" id="forgotPasswordBtn" class="w-full text-blue-600 hover:text-blue-800 text-sm font-medium mt-2 text-center">
                    Forgot Password?
                </button>
                <div id="loginMessage" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <nav class="main-nav" id="mainNav" style="display: none;">
        <ul>
            <li><a href="#" id="evaluationFormTab" class="active"><i class="fas fa-file-alt"></i> Evaluation Form</a></li>
            <li><a href="#" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
            <li><a href="#" id="reportsTab"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="#" id="autofailsTab"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
            <li id="adminTabNav"><a href="admin.html" id="adminTab"><i class="fas fa-user-cog"></i> Admin</a></li>
        </ul>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </nav>

    <div class="main-container" id="mainContent" style="display: none;">
        <section id="evaluationFormSection" class="w-full max-w-2xl card" style="display: none;">
            <div class="icealion-blue p-4 text-xl font-semibold text-center rounded-t-lg">
                Evaluation Form
            </div>
            <form id="evaluationForm" class="p-6">
                <div class="section-header">
                    <h3>Caller Details</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="callerName">Caller Name:</label>
                        <input type="text" id="callerName" name="callerName" required>
                    </div>
                    <div class="form-group">
                        <label for="policyNumber">Policy/Claim Number:</label>
                        <input type="text" id="policyNumber" name="policyNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="contactNumber">Contact Number:</label>
                        <input type="text" id="contactNumber" name="contactNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="evaluationDate">Evaluation Date:</label>
                        <input type="date" id="evaluationDate" name="evaluationDate" required>
                    </div>
                </div>

                <div class="section-header mt-6">
                    <h3>CER Details</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="cerName">CER Name:</label>
                        <select id="cerName" name="cerName" required>
                            <option value="">Select CER Name</option>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="cerRole">CER Role:</label>
                        <select id="cerRole" name="cerRole" required>
                            <option value="">Select CER Role</option>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="reviewerName">Reviewer Name:</label>
                        <select id="reviewerName" name="reviewerName" required>
                            <option value="">Select Reviewer Name</option>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="callType">Call Type:</label>
                        <select id="callType" name="callType" required>
                            <option value="">Select Call Type</option>
                            <option value="Inbound">Inbound</option>
                            <option value="Outbound">Outbound</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="callTime">Call Time (HH:MM):</label>
                        <input type="time" id="callTime" name="callTime" required>
                    </div>
                    <div class="form-group">
                        <label for="duration">Call Duration (MM:SS):</label>
                        <input type="text" id="duration" name="duration" placeholder="e.g., 05:30" pattern="[0-5][0-9]:[0-5][0-9]" required>
                    </div>
                </div>

                <div id="dynamicQuestionsContainer">
                    </div>

                <div class="section-header mt-6">
                    <h3>Autofail</h3>
                </div>
                <div class="form-group">
                    <label>Autofail Occurred?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="autofailOccurred" value="Yes"> Yes</label>
                        <label><input type="radio" name="autofailOccurred" value="No" checked> No</label>
                    </div>
                </div>
                <div id="autofailDetails" class="form-group" style="display: none;">
                    <label for="autofailType">Autofail Type:</label>
                    <select id="autofailType" name="autofailType">
                        <option value="">Select Autofail Type</option>
                        </select>
                    <label for="autofailReason" class="mt-2">Reason for Autofail:</label>
                    <textarea id="autofailReason" name="autofailReason" rows="3" class="mt-1"></textarea>
                </div>

                <div class="section-header mt-6">
                    <h3>General Comments</h3>
                </div>
                <div class="form-group">
                    <label for="generalComments">Overall Comments:</label>
                    <textarea id="generalComments" name="generalComments" rows="4"></textarea>
                </div>

                <div class="scoring-section">
                    <div class="scoring-item">
                        <span>Total Score:</span>
                        <span id="totalScoreDisplay">0</span>
                    </div>
                </div>

                <button type="submit" id="submitEvaluation" class="submit-btn mt-6">Submit Evaluation</button>
                <div id="evaluationMessage" class="error-message hidden"></div>
            </form>
        </section>

        <section id="databaseSection" class="w-full card" style="display: none;">
            <div class="icealion-blue p-4 text-xl font-semibold text-center rounded-t-lg">
                Evaluation Database
            </div>
            <div class="p-6">
                <table id="evaluationTable" class="display w-full">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Caller Name</th>
                            <th>CER Name</th>
                            <th>Policy No.</th>
                            <th>Reviewer</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </section>

        <section id="reportsSection" class="w-full card" style="display: none;">
            <div class="icealion-blue p-4 text-xl font-semibold text-center rounded-t-lg">
                Reports
            </div>
            <div class="p-6">
                <p>Content for Reports will go here.</p>
                <canvas id="scoreDistributionChart"></canvas>
            </div>
        </section>

        <section id="autofailsSection" class="w-full card" style="display: none;">
            <div class="icealion-blue p-4 text-xl font-semibold text-center rounded-t-lg">
                Autofails
            </div>
            <div class="p-6">
                <p>Content for Autofails will go here.</p>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, deleteUser, signOut, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, setDoc, getDoc, FieldValue, serverTimestamp, arrayUnion, arrayRemove, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // --- Your Web App's Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.firebasestorage.app",
            messagingSenderId: "820082472004",
            appId: "1:820082472004:web:8caddf941e1b5b661d76c94e",
            measurementId: "G-1RJJTT3QET"
        };

        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.firebaseApp = initializeApp(firebaseConfig);
        window.auth = getAuth(window.firebaseApp);
        window.db = getFirestore(window.firebaseApp);

        // Expose necessary Firebase Auth functions globally
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.deleteUser = deleteUser;
        window.sendPasswordResetEmail = sendPasswordResetEmail;

        // Expose ALL necessary Firestore functions globally
        window.fsCollection = collection;
        window.fsAddDoc = addDoc;
        window.fsGetDocs = getDocs;
        window.fsDeleteDoc = deleteDoc;
        window.fsDoc = doc;
        window.fsUpdateDoc = updateDoc;
        window.fsSetDoc = setDoc;
        window.fsGetDoc = getDoc;
        window.fsFieldValue = FieldValue;
        window.fsServerTimestamp = serverTimestamp;
        window.fsArrayUnion = arrayUnion;
        window.fsArrayRemove = arrayRemove;
        window.signOut = signOut;
        window.fsQuery = query; // Expose query for DataTables
        window.fsOrderBy = orderBy; // Expose orderBy for DataTables
        window.fsLimit = limit; // Expose limit for DataTables


        window.currentUserId = null;
        window.currentUserRole = null;
        window.isAuthReady = false;

        // Function to check and handle session timeout
        function checkSessionTimeout() {
            const lastActivity = localStorage.getItem('lastActivity');
            const loginTime = localStorage.getItem('loginTime');
            if (lastActivity && loginTime) {
                const now = new Date().getTime();
                const eightHours = 8 * 60 * 60 * 1000;

                if ((now - parseInt(lastActivity) > eightHours) || (now - parseInt(loginTime) > eightHours)) {
                    console.log("Session expired. Logging out.");
                    localStorage.removeItem('lastActivity');
                    localStorage.removeItem('loginTime');
                    sessionStorage.removeItem('loggedIn');
                    return true;
                }
            }
            return false;
        }
        window.checkSessionTimeout = checkSessionTimeout;

        // Update last activity on user interaction
        function updateLastActivity() {
            localStorage.setItem('lastActivity', new Date().getTime().toString());
        }
        window.updateLastActivity = updateLastActivity;

        // Listen for user activity
        document.addEventListener('mousemove', window.updateLastActivity);
        document.addEventListener('keydown', window.updateLastActivity);
        document.addEventListener('click', window.updateLastActivity);


        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                if (window.checkSessionTimeout()) {
                    await signOut(window.auth);
                    return;
                }

                window.currentUserId = user.uid;
                console.log("Firebase Auth State Changed: User logged in:", user.uid);

                const userDocRef = window.fsDoc(window.db, `artifacts/${appId}/users/${user.uid}`);
                const userDocSnap = await window.fsGetDoc(userDocRef);

                if (userDocSnap.exists()) {
                    window.currentUserRole = userDocSnap.data().role;
                    console.log("User role fetched:", window.currentUserRole);
                } else {
                    window.currentUserRole = 'Guest';
                    console.log("User profile not found in Firestore, defaulting to Guest. This might be a new user or a demo user.");
                }
                window.updateLastActivity();

            } else {
                console.log("Firebase Auth State Changed: No user logged in.");
                window.currentUserId = null;
                window.currentUserRole = null;
                sessionStorage.removeItem('loggedIn');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('loginTime');
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
        });

        // Define collection paths
        window.USERS_COLLECTION_PATH_PREFIX = `artifacts/${appId}/users`;
        window.DROPDOWN_OPTIONS_COLLECTION_PATH = `artifacts/${appId}/public/data/dropdown_options`;
        window.EVALUATIONS_COLLECTION_PATH = `artifacts/${appId}/public/data/evaluation_records`; // For evaluation data

    </script>
    <script>
        // --- GLOBAL DATA STORES ---
        let dropdownOptions = {}; // Stores dynamically fetched dropdown options
        let evaluationDataTable = null; // To hold the DataTables instance

        // --- UI ELEMENTS ---
        const loginPage = document.getElementById('loginPage');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');

        const mainNav = document.getElementById('mainNav');
        const evaluationFormTab = document.getElementById('evaluationFormTab');
        const databaseTab = document.getElementById('databaseTab');
        const reportsTab = document.getElementById('reportsTab');
        const autofailsTab = document.getElementById('autofailsTab');
        const adminTabNav = document.getElementById('adminTabNav');
        const logoutBtn = document.getElementById('logoutBtn');

        const mainContent = document.getElementById('mainContent');
        const evaluationFormSection = document.getElementById('evaluationFormSection');
        const databaseSection = document.getElementById('databaseSection');
        const reportsSection = document.getElementById('reportsSection');
        const autofailsSection = document.getElementById('autofailsSection');

        // Form elements specific to evaluation form
        const evaluationForm = document.getElementById('evaluationForm');
        const submitEvaluationBtn = document.getElementById('submitEvaluation');
        const evaluationMessage = document.getElementById('evaluationMessage');
        const cerNameSelect = document.getElementById('cerName');
        const cerRoleSelect = document.getElementById('cerRole');
        const reviewerNameSelect = document.getElementById('reviewerName');
        const autofailOccurredRadios = document.querySelectorAll('input[name="autofailOccurred"]');
        const autofailDetailsDiv = document.getElementById('autofailDetails');
        const autofailTypeSelect = document.getElementById('autofailType');
        const dynamicQuestionsContainer = document.getElementById('dynamicQuestionsContainer');
        const totalScoreDisplay = document.getElementById('totalScoreDisplay');


        // Message Box elements
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxSpinner = document.getElementById('messageBoxSpinner');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');


        // --- MESSAGE BOX FUNCTIONS ---
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            if (isError) {
                messageBoxTitle.style.color = '#dc2626';
            } else {
                messageBoxTitle.style.color = '#1a73e8';
            }

            messageBoxCloseBtn.onclick = null; // Clear previous handlers
            if (showCloseButton) {
                messageBoxCloseBtn.onclick = () => {
                    messageBoxOverlay.classList.add('hidden');
                    if (onClose) onClose();
                };
            }
        }

        function hideMessageBox() {
            messageBoxOverlay.classList.add('hidden');
        }

        // --- NAVIGATION FUNCTIONS ---
        function showTab(tabId) {
            // Hide all content sections first
            evaluationFormSection.style.display = 'none';
            databaseSection.style.display = 'none';
            reportsSection.style.display = 'none';
            autofailsSection.style.display = 'none';

            // Remove active class from all nav links
            document.querySelectorAll('.main-nav ul li a').forEach(link => {
                link.classList.remove('active');
            });

            // Show the selected section and set active class
            switch (tabId) {
                case 'evaluationForm':
                    evaluationFormSection.style.display = 'block';
                    evaluationFormTab.classList.add('active');
                    break;
                case 'database':
                    databaseSection.style.display = 'block';
                    databaseTab.classList.add('active');
                    if (window.currentUserRole === 'Admin') { // Only fetch for Admin for now, or adapt for Supervisor if needed
                         // Delay DataTables initialization until tab is visible and DOM elements are ready
                         setTimeout(() => {
                            initializeDataTable();
                         }, 0);
                    }
                    break;
                case 'reports':
                    reportsSection.style.display = 'block';
                    reportsTab.classList.add('active');
                    break;
                case 'autofails':
                    autofailsSection.style.display = 'block';
                    autofailsTab.classList.add('active');
                    break;
            }
        }

        function updateNavigationVisibility() {
            const userRole = window.currentUserRole;
            const isLoggedIn = sessionStorage.getItem('loggedIn') === 'true';

            evaluationFormTab.parentElement.style.display = 'none';
            databaseTab.parentElement.style.display = 'none';
            reportsTab.parentElement.style.display = 'none';
            autofailsTab.parentElement.style.display = 'none';
            adminTabNav.style.display = 'none';

            if (isLoggedIn && userRole) {
                if (userRole === 'CER') {
                    evaluationFormTab.parentElement.style.display = 'inline-block';
                    reportsTab.parentElement.style.display = 'inline-block';
                } else if (userRole === 'Supervisor') {
                    evaluationFormTab.parentElement.style.display = 'inline-block';
                    reportsTab.parentElement.style.display = 'inline-block';
                    autofailsTab.parentElement.style.display = 'inline-block';
                } else if (userRole === 'Admin') {
                    evaluationFormTab.parentElement.style.display = 'inline-block';
                    databaseTab.parentElement.style.display = 'inline-block';
                    reportsTab.parentElement.style.display = 'inline-block';
                    autofailsTab.parentElement.style.display = 'inline-block';
                    adminTabNav.style.display = 'inline-block';
                }
            }
        }

        // --- DROPDOWN MANAGEMENT (from admin.html, adapted for fetching only) ---
        async function fetchDropdownOptions(docId) {
            if (!window.db || !window.DROPDOWN_OPTIONS_COLLECTION_PATH) {
                console.warn(`Firestore not ready or DROPDOWN_OPTIONS_COLLECTION_PATH not defined for ${docId}.`);
                return [];
            }
            try {
                const docRef = window.fsDoc(window.db, `${window.DROPDOWN_OPTIONS_COLLECTION_PATH}/${docId}`);
                const docSnap = await window.fsGetDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().options || [];
                }
                return [];
            } catch (error) {
                console.error(`Error fetching dropdown options for ${docId}:`, error);
                return [];
            }
        }

        async function populateDropdown(selectElement, docId) {
            const options = await fetchDropdownOptions(docId);
            selectElement.innerHTML = `<option value="">Select ${selectElement.name.replace(/([A-Z])/g, ' $1').trim()}</option>`; // Reset and add placeholder
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            dropdownOptions[docId] = options; // Store globally for other uses if needed
        }

        async function initializeDropdownsForForm() {
            await populateDropdown(cerNameSelect, 'cerNames');
            await populateDropdown(cerRoleSelect, 'cerRoles');
            await populateDropdown(reviewerNameSelect, 'reviewerNames');
            await populateDropdown(autofailTypeSelect, 'autofailTypes');
        }

        // --- DYNAMIC EVALUATION QUESTIONS ---
        // Placeholder for your actual questions structure from Firestore or static data
        // This is a sample structure. Adapt it to your actual Firestore document structure.
        const SAMPLE_QUESTIONS = {
            "Leadership": [
                { id: "Q1", question: "Demonstrates strong leadership?", type: "radio", options: ["Yes", "No", "N/A"], score: { "Yes": 10, "No": 0, "N/A": 0 } },
                { id: "Q2", question: "Provides clear guidance?", type: "radio", options: ["Yes", "No"], score: { "Yes": 5, "No": 0 } }
            ],
            "Communication": [
                { id: "Q3", question: "Communicates effectively with team?", type: "radio", options: ["Excellent", "Good", "Fair", "Poor"], score: { "Excellent": 10, "Good": 7, "Fair": 3, "Poor": 0 } },
                { id: "Q4", question: "Handles customer inquiries politely?", type: "checkbox", options: ["Yes"], score: { "Yes": 5 } } // Checkbox often for pass/fail or single point
            ],
            "Technical Skills": [
                { id: "Q5", question: "Proficient in using tools?", type: "radio", options: ["Yes", "No"], score: { "Yes": 10, "No": 0 } },
                { id: "Q6", question: "Resolves complex issues?", type: "textarea", score: null } // Textarea for comments, no direct score
            ]
        };

        // NEW: renderQuestionsForRole function
        async function renderQuestionsForRole(role) {
            dynamicQuestionsContainer.innerHTML = ''; // Clear previous questions

            // In a real application, you might fetch specific questions based on the role from Firestore
            // For this example, we'll use a static SAMPLE_QUESTIONS object.
            // You might have a Firestore collection like `evaluation_questions` where each document
            // represents a section (e.g., 'Leadership', 'Communication') and contains an array of questions.

            let questionsToRender = {};
            if (role === 'CER' || role === 'Supervisor' || role === 'Admin') { // Example: all roles see same form for now
                questionsToRender = SAMPLE_QUESTIONS;
            }
            // Add more specific logic here if different roles see different questions
            // Example: if (role === 'Supervisor') { questionsToRender = { ...SAMPLE_QUESTIONS, ...SUPERVISOR_ONLY_QUESTIONS }; }

            for (const sectionTitle in questionsToRender) {
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header mt-6';
                sectionHeader.innerHTML = `<h3>${sectionTitle}</h3>`;
                dynamicQuestionsContainer.appendChild(sectionHeader);

                questionsToRender[sectionTitle].forEach(questionData => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';

                    if (questionData.type === 'radio' && questionData.options) {
                        formGroup.innerHTML = `
                            <label>${questionData.question}</label>
                            <div class="radio-group flex flex-wrap">
                                ${questionData.options.map(opt => `
                                    <label class="mr-4"><input type="radio" name="question_${questionData.id}" value="${opt}" required> ${opt}</label>
                                `).join('')}
                            </div>
                        `;
                    } else if (questionData.type === 'checkbox' && questionData.options) {
                        formGroup.innerHTML = `
                            <label>${questionData.question}</label>
                            <div class="checkbox-group flex flex-wrap">
                                ${questionData.options.map(opt => `
                                    <label class="mr-4"><input type="checkbox" name="question_${questionData.id}" value="${opt}"> ${opt}</label>
                                `).join('')}
                            </div>
                        `;
                    } else if (questionData.type === 'textarea') {
                        formGroup.innerHTML = `
                            <label for="question_${questionData.id}">${questionData.question}</label>
                            <textarea id="question_${questionData.id}" name="question_${questionData.id}" rows="3"></textarea>
                        `;
                    }
                    // Add more question types (text, number, select) as needed

                    dynamicQuestionsContainer.appendChild(formGroup);
                });
            }
        }

        // --- EVALUATION FORM LOGIC ---
        function initializeEvaluationForm() {
            console.log("Initializing evaluation form.");

            // Populate static dropdowns (if any) or dynamic ones
            initializeDropdownsForForm();

            // Render dynamic questions based on the current user's role
            // This is the call that was causing the ReferenceError
            if (window.currentUserRole) {
                renderQuestionsForRole(window.currentUserRole);
            } else {
                console.warn("User role not yet available for rendering questions.");
                // Potentially re-try after a short delay or show a loading message
            }

            // Autofail logic
            autofailOccurredRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'Yes') {
                        autofailDetailsDiv.style.display = 'block';
                        autofailTypeSelect.setAttribute('required', 'required'); // Make required
                    } else {
                        autofailDetailsDiv.style.display = 'none';
                        autofailTypeSelect.removeAttribute('required'); // Remove required
                        autofailTypeSelect.value = ''; // Clear selection
                        document.getElementById('autofailReason').value = ''; // Clear reason
                    }
                });
            });

            // Initial state for autofail
            if (document.querySelector('input[name="autofailOccurred"]:checked').value === 'Yes') {
                autofailDetailsDiv.style.display = 'block';
                autofailTypeSelect.setAttribute('required', 'required');
            } else {
                autofailDetailsDiv.style.display = 'none';
                autofailTypeSelect.removeAttribute('required');
            }

            evaluationForm.addEventListener('change', calculateTotalScore); // Recalculate on any form change

            // Set initial evaluation date to today
            const evaluationDateInput = document.getElementById('evaluationDate');
            evaluationDateInput.valueAsDate = new Date();

            // Set initial call time to current time
            const callTimeInput = document.getElementById('callTime');
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            callTimeInput.value = `${hours}:${minutes}`;

             // Initial score calculation
             calculateTotalScore();
        }

        function calculateTotalScore() {
            let totalScore = 0;
            const formData = new FormData(evaluationForm);

            // Iterate over form data and score based on SAMPLE_QUESTIONS
            for (const sectionTitle in SAMPLE_QUESTIONS) {
                SAMPLE_QUESTIONS[sectionTitle].forEach(questionData => {
                    const questionId = `question_${questionData.id}`;
                    if (questionData.score && formData.has(questionId)) {
                        if (questionData.type === 'radio') {
                            const selectedOption = formData.get(questionId);
                            if (questionData.score[selectedOption] !== undefined) {
                                totalScore += questionData.score[selectedOption];
                            }
                        } else if (questionData.type === 'checkbox') {
                            // Checkboxes can have multiple values, or just one if it's a single "Yes"
                            const checkedValue = formData.get(questionId); // For single checkbox, this gets value if checked
                            if (checkedValue && questionData.score[checkedValue] !== undefined) {
                                totalScore += questionData.score[checkedValue];
                            }
                        }
                    }
                });
            }
            totalScoreDisplay.textContent = totalScore;
            return totalScore;
        }

        evaluationForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            evaluationMessage.classList.add('hidden');
            submitEvaluationBtn.disabled = true;

            const formElements = event.target.elements;
            const formData = {};
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name) {
                    if (element.type === 'radio' || element.type === 'checkbox') {
                        if (element.checked) {
                            if (formData[element.name]) {
                                // If it's an array for multiple checkboxes
                                if (!Array.isArray(formData[element.name])) {
                                    formData[element.name] = [formData[element.name]];
                                }
                                formData[element.name].push(element.value);
                            } else {
                                formData[element.name] = element.value;
                            }
                        }
                    } else if (element.tagName === 'SELECT') {
                        formData[element.name] = element.value;
                    } else if (element.value.trim() !== '') {
                        formData[element.name] = element.value.trim();
                    }
                }
            }

            const totalScore = calculateTotalScore();
            formData.totalScore = totalScore;
            formData.submittedBy = window.currentUserId;
            formData.submittedByEmail = window.auth.currentUser.email; // Store email for easier reference
            formData.submittedAt = window.fsServerTimestamp();

            // Handle autofail status
            if (formData.autofailOccurred === 'Yes') {
                formData.status = 'Autofail';
            } else {
                formData.status = 'Completed'; // Or 'Passed', depending on your definition
            }


            showMessageBox("Submitting Evaluation", "Saving your evaluation...", false, true, false);

            try {
                await window.fsAddDoc(window.fsCollection(window.db, window.EVALUATIONS_COLLECTION_PATH), formData);
                showMessageBox("Success", "Evaluation submitted successfully!", false, false, true, () => {
                    evaluationForm.reset(); // Clear form
                    initializeEvaluationForm(); // Re-initialize to reset dynamic elements/scores
                    submitEvaluationBtn.disabled = false;
                });
            } catch (error) {
                console.error("Error submitting evaluation:", error);
                evaluationMessage.textContent = `Error: ${error.message}`;
                evaluationMessage.classList.remove('hidden');
                showMessageBox("Submission Failed", `Failed to submit evaluation: ${error.message}`, true, false, true);
                submitEvaluationBtn.disabled = false;
            }
        });

        // --- DATABASE SECTION (DataTables) ---
        async function initializeDataTable() {
            if (evaluationDataTable) {
                evaluationDataTable.destroy(); // Destroy existing instance if any
            }

            const tableBody = document.getElementById('evaluationTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Loading evaluation data...</td></tr>';

            try {
                const evaluationsColRef = window.fsCollection(window.db, window.EVALUATIONS_COLLECTION_PATH);
                const q = window.fsQuery(evaluationsColRef, window.fsOrderBy('submittedAt', 'desc')); // Order by latest

                const querySnapshot = await window.fsGetDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    const record = doc.data();
                    data.push([
                        record.evaluationDate || 'N/A',
                        record.callerName || 'N/A',
                        record.cerName || 'N/A',
                        record.policyNumber || 'N/A',
                        record.reviewerName || 'N/A',
                        record.totalScore !== undefined ? record.totalScore : 'N/A',
                        record.status || 'N/A',
                        `<button class="view-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-md text-xs" data-id="${doc.id}">View</button>
                         <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded-md text-xs ml-1" data-id="${doc.id}">Edit</button>
                         <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-md text-xs ml-1" data-id="${doc.id}">Delete</button>`
                    ]);
                });

                evaluationDataTable = $('#evaluationTable').DataTable({
                    data: data,
                    destroy: true, // Allow re-initialization
                    paging: true,
                    searching: true,
                    info: true,
                    responsive: true,
                    dom: 'lBfrtip', // Layout: Length, Buttons, Filter, Table, Info, Pagination
                    buttons: [
                        'copy', 'excel', 'csv', 'pdf', 'print'
                    ]
                });

                // Attach event listeners for action buttons
                $('#evaluationTable tbody').on('click', '.view-btn', function() {
                    const id = $(this).data('id');
                    viewEvaluation(id);
                });
                $('#evaluationTable tbody').on('click', '.edit-btn', function() {
                    const id = $(this).data('id');
                    editEvaluation(id);
                });
                $('#evaluationTable tbody').on('click', '.delete-btn', function() {
                    const id = $(this).data('id');
                    deleteEvaluation(id);
                });

            } catch (error) {
                console.error("Error loading evaluation data:", error);
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Error loading data: ${error.message}</td></tr>`;
                showMessageBox("Data Load Error", `Failed to load evaluation data: ${error.message}`, true, false, true);
            }
        }

        async function viewEvaluation(docId) {
            showMessageBox("Loading Evaluation", "Fetching evaluation details...", false, true, false);
            try {
                const docRef = window.fsDoc(window.db, `${window.EVALUATIONS_COLLECTION_PATH}/${docId}`);
                const docSnap = await window.fsGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let detailsHtml = `
                        <p><strong>Caller Name:</strong> ${data.callerName || 'N/A'}</p>
                        <p><strong>Policy/Claim Number:</strong> ${data.policyNumber || 'N/A'}</p>
                        <p><strong>Contact Number:</strong> ${data.contactNumber || 'N/A'}</p>
                        <p><strong>Evaluation Date:</strong> ${data.evaluationDate || 'N/A'}</p>
                        <p><strong>CER Name:</strong> ${data.cerName || 'N/A'}</p>
                        <p><strong>CER Role:</strong> ${data.cerRole || 'N/A'}</p>
                        <p><strong>Reviewer Name:</strong> ${data.reviewerName || 'N/A'}</p>
                        <p><strong>Call Type:</strong> ${data.callType || 'N/A'}</p>
                        <p><strong>Call Time:</strong> ${data.callTime || 'N/A'}</p>
                        <p><strong>Call Duration:</strong> ${data.duration || 'N/A'}</p>
                        <p><strong>Autofail Occurred:</strong> ${data.autofailOccurred || 'No'}</p>
                    `;
                    if (data.autofailOccurred === 'Yes') {
                        detailsHtml += `<p><strong>Autofail Type:</strong> ${data.autofailType || 'N/A'}</p>`;
                        detailsHtml += `<p><strong>Autofail Reason:</strong> ${data.autofailReason || 'N/A'}</p>`;
                    }

                    detailsHtml += `<p><strong>General Comments:</strong> ${data.generalComments || 'N/A'}</p>`;
                    detailsHtml += `<p><strong>Total Score:</strong> ${data.totalScore !== undefined ? data.totalScore : 'N/A'}</p>`;
                    detailsHtml += `<p><strong>Status:</strong> ${data.status || 'N/A'}</p>`;
                    detailsHtml += `<p><strong>Submitted By:</strong> ${data.submittedByEmail || 'N/A'}</p>`;
                    detailsHtml += `<p><strong>Submitted At:</strong> ${data.submittedAt ? new Date(data.submittedAt.toDate()).toLocaleString() : 'N/A'}</p>`;

                    // Add dynamic questions if needed
                    for (const sectionTitle in SAMPLE_QUESTIONS) {
                        SAMPLE_QUESTIONS[sectionTitle].forEach(questionData => {
                            const questionName = `question_${questionData.id}`;
                            if (data[questionName]) {
                                detailsHtml += `<p><strong>${questionData.question}:</strong> ${Array.isArray(data[questionName]) ? data[questionName].join(', ') : data[questionName]}</p>`;
                            }
                        });
                    }


                    showMessageBox("Evaluation Details", detailsHtml, false, false, true);
                    messageBoxContent.style.textAlign = 'left'; // Align text left for details
                } else {
                    showMessageBox("Error", "Evaluation record not found.", true, false, true);
                }
            } catch (error) {
                console.error("Error viewing evaluation:", error);
                showMessageBox("View Error", `Failed to view evaluation: ${error.message}`, true, false, true);
            }
        }

        async function editEvaluation(docId) {
            if (window.currentUserRole !== 'Admin') {
                showMessageBox("Unauthorized", "Only Admins can edit evaluations.", true, false, true);
                return;
            }
            showMessageBox("Not Implemented", "Edit functionality is not yet implemented.", false, false, true);
            // TODO: Implement actual edit logic:
            // 1. Fetch the document by docId
            // 2. Populate the evaluationForm with fetched data
            // 3. Change submit button to "Update" and add an "Cancel Edit" button
            // 4. On update, use fsUpdateDoc instead of fsAddDoc
        }

        async function deleteEvaluation(docId) {
            if (window.currentUserRole !== 'Admin') {
                showMessageBox("Unauthorized", "Only Admins can delete evaluations.", true, false, true);
                return;
            }

            const originalMessageBoxContentHTML = messageBoxContent.innerHTML; // Store original
            showMessageBox("Confirm Deletion", "Are you sure you want to delete this evaluation record? This cannot be undone.", true, false, false);

            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Delete';
            confirmBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md mr-2';
            confirmBtn.onclick = async () => {
                hideMessageBox();
                showMessageBox("Deleting Record", "Deleting evaluation record...", false, true, false);
                try {
                    const docRef = window.fsDoc(window.db, `${window.EVALUATIONS_COLLECTION_PATH}/${docId}`);
                    await window.fsDeleteDoc(docRef);
                    showMessageBox("Success", "Evaluation record deleted successfully!", false, false, true, initializeDataTable); // Refresh table
                } catch (error) {
                    console.error("Error deleting evaluation:", error);
                    showMessageBox("Delete Failed", `Failed to delete record: ${error.message}`, true, false, true);
                } finally {
                    messageBoxContent.innerHTML = originalMessageBoxContentHTML; // Restore content
                    messageBoxCloseBtn.onclick = () => { hideMessageBox(); }; // Restore handler
                }
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md';
            cancelBtn.onclick = () => {
                hideMessageBox();
                messageBoxContent.innerHTML = originalMessageBoxContentHTML; // Restore content
                messageBoxCloseBtn.onclick = () => { hideMessageBox(); }; // Restore handler
            };

            messageBoxContent.innerHTML = ''; // Clear existing content
            messageBoxContent.appendChild(confirmBtn);
            messageBoxContent.appendChild(cancelBtn);
            messageBoxCloseBtn.onclick = () => { hideMessageBox(); messageBoxContent.innerHTML = originalMessageBoxContentHTML; };
        }


        // --- LOGIN/LOGOUT ---
        async function handleLogin(event) {
            event.preventDefault();
            loginMessage.classList.add('hidden');

            const email = usernameInput.value.trim();
            const pass = passwordInput.value.trim();

            if (!email || !pass) {
                loginMessage.textContent = "Please enter both email and password.";
                loginMessage.classList.remove('hidden');
                return;
            }

            showMessageBox("Logging In", "Authenticating...", false, true, false);
            try {
                const userCredential = await window.signInWithEmailAndPassword(window.auth, email, pass);
                const user = userCredential.user;

                const userDocRef = window.fsDoc(window.db, `${window.USERS_COLLECTION_PATH_PREFIX}/${user.uid}`);
                const userDocSnap = await window.fsGetDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    console.log(`Creating Firestore profile for new user ${user.email}`);
                    await window.fsSetDoc(userDocRef, {
                        email: user.email,
                        role: 'CER', // Default role for newly signed-up users
                        createdAt: window.fsServerTimestamp()
                    });
                    window.currentUserRole = 'CER';
                } else {
                    window.currentUserRole = userDocSnap.data().role;
                }

                sessionStorage.setItem('loggedIn', 'true');
                localStorage.setItem('loginTime', new Date().getTime().toString());
                window.updateLastActivity();
                hideMessageBox();
                window.location.reload(); // Reload to apply role-based access immediately
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = 'Login failed. Invalid credentials.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No user found with this email. Please register or check your email.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format.';
                }
                showMessageBox("Login Failed", errorMessage, true, false, true);
                loginMessage.textContent = errorMessage;
                loginMessage.classList.remove('hidden');
            }
        }

        async function handlePasswordReset() {
            const email = usernameInput.value.trim();
            if (!email) {
                showMessageBox("Password Reset Failed", "Please enter your email address in the username field.", true, false, true);
                return;
            }

            showMessageBox("Sending Reset Email", `Sending password reset link to ${email}...`, false, true, false);
            try {
                await window.sendPasswordResetEmail(window.auth, email);
                showMessageBox("Email Sent", `A password reset link has been sent to ${email}. Please check your inbox.`, false, false, true);
            } catch (error) {
                console.error("Error sending password reset email:", error);
                let errorMessage = "Failed to send password reset email.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No user found with this email. Please check the email address or create an account.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "The email address is not valid.";
                }
                showMessageBox("Password Reset Failed", errorMessage, true, false, true);
            }
        }

        async function handleLogout() {
            sessionStorage.removeItem('loggedIn');
            localStorage.removeItem('lastActivity');
            localStorage.removeItem('loginTime');
            try {
                await window.signOut(window.auth);
                console.log("Signed out from Firebase.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
            window.location.href = 'index.html'; // Redirect to login page (this page)
        }


        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded and parsed. Main script starting.");

            if (window.checkSessionTimeout()) {
                window.location.reload(); // Force reload to show login
                return;
            }

            const isLoggedIn = sessionStorage.getItem('loggedIn');

            // Attach Login Form listeners
            loginForm.addEventListener('submit', handleLogin);
            forgotPasswordBtn.addEventListener('click', handlePasswordReset);

            // Attach Logout button listener
            logoutBtn.addEventListener('click', handleLogout);

            // Attach Navigation Tab listeners
            evaluationFormTab.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('evaluationForm');
            });
            databaseTab.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('database');
            });
            reportsTab.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('reports');
            });
            autofailsTab.addEventListener('click', (e) => {
                e.preventDefault();
                showTab('autofails');
            });

            // Autofail radio button event listener (moved from initializeEvaluationForm to DOMContentLoaded)
            autofailOccurredRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'Yes') {
                        autofailDetailsDiv.style.display = 'block';
                        autofailTypeSelect.setAttribute('required', 'required');
                    } else {
                        autofailDetailsDiv.style.display = 'none';
                        autofailTypeSelect.removeAttribute('required');
                        autofailTypeSelect.value = '';
                        document.getElementById('autofailReason').value = '';
                    }
                });
            });


            console.log("Waiting for firebaseAuthReady event (or DOMContentLoaded if it's already ready)...");
            // Listen for Firebase Auth readiness (from module script)
            document.addEventListener('firebaseAuthReady', () => {
                console.log("Firebase Auth is ready. Current User ID:", window.currentUserId, "Role:", window.currentUserRole);

                if (sessionStorage.getItem('loggedIn') === 'true' && window.currentUserId) {
                    loginPage.style.display = 'none';
                    mainNav.style.display = 'flex';
                    mainContent.style.display = 'flex'; // Display the main content wrapper

                    updateNavigationVisibility(); // Show/hide tabs based on role
                    showTab('evaluationForm'); // Default to evaluation form if logged in

                    // Initialize the evaluation form (populate dropdowns, render questions etc.)
                    initializeEvaluationForm();

                } else {
                    loginPage.style.display = 'flex';
                    mainNav.style.display = 'none';
                    mainContent.style.display = 'none'; // Hide the main content wrapper
                }
            });

            // If Firebase Auth is already ready (e.g., page reloaded and user still authenticated),
            // manually dispatch the event to trigger the logic.
            if (window.isAuthReady) {
                document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
            }
        });

        // Initialize DataTables related script (needs jQuery and DataTables libs)
        // You'll need to include jQuery and DataTables from CDNs in your HTML head:
        // <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        // <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
        // <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
        // <script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
        // <script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
        // <script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>
        // Add more buttons scripts as needed (e.g., JSZip for Excel, pdfmake for PDF)
        // <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        // <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
        // <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    </script>
</body>
</html>
