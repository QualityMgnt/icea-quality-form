<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            display: flex;
            align-items: flex-start;
            min-height: 100vh;
        }

        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background-color: #800080;
            color: white;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            font-size: 1.125rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 1rem;
        }
        .top-header .logo {
            height: 40px;
            width: auto;
            margin-right: 1rem;
        }
        .top-header .title-text {
            flex-grow: 1;
            text-align: center;
            margin-right: 40px;
        }
        .main-nav {
            width: 125px;
            background-color: #800080;
            color: white;
            padding: 1rem 0;
            height: calc(100vh - 48px);
            position: fixed;
            top: 48px;
            left: 0;
            z-index: 100;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .sidebar ul {
            list-style: none;
            margin: 0;
            padding: 0;
            flex-grow: 1;
        }
        .sidebar ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.75rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #6a006a;
        }
        .sidebar ul li a .fas {
            font-size: 1.2rem;
            position: relative;
        }
        .notification-bell::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background-color: red;
            border-radius: 50%;
            display: block;
        }
        .logout-button {
            background-color: #f57c00;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin: 1rem auto;
            width: calc(100% - 2rem);
            font-size: 0.75rem;
        }
        .logout-button:hover {
            background-color: #e65100;
        }
        .main-content {
            margin-left: 125px;
            margin-top: 48px;
            width: calc(100% - 125px);
            padding: 1.5rem;
            min-height: calc(100vh - 48px);
            box-sizing: border-box;
            overflow-y: auto;
        }
        .tab-content.hidden {
            display: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>
    
    <div id="messageBoxOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96 max-w-lg">
            <div id="messageBoxSpinner" class="spinner hidden mx-auto mb-4"></div>
            <h3 id="messageBoxTitle" class="text-xl font-semibold mb-4 text-center"></h3>
            <p id="messageBoxContent" class="text-gray-700 mb-4 text-center"></p>
            <div class="flex justify-center space-x-2">
                <button id="messageBoxCloseBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md">Close</button>
            </div>
        </div>
    </div>

    <div id="loginPage" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <div class="flex justify-center mb-4">
                <img id="login-logo" src="https://placehold.co/150x50/e5e7eb/6b7280?text=Logo" alt="Company Logo" class="h-12 w-auto">
            </div>
            <h2 class="text-2xl font-bold mb-6 text-center">ICEA LION Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="username" name="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <p id="loginMessage" class="text-red-500 text-xs italic mb-4 hidden"></p>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Login</button>
                </div>
                <p class="text-center text-sm mt-4">
                    Don't have an account? <a href="signup.html" class="text-blue-500 hover:underline">Sign Up</a>
                </p>
            </form>
        </div>
    </div>

    <div id="appContent" class="hidden w-full">
        <header class="top-header">
            <img id="header-logo" src="https://placehold.co/40x40/e5e7eb/6b7280?text=Logo" alt="Company Logo" class="logo">
            <div class="title-text">ICEA LION QUALITY EVALUATION AND MONITORING</div>
        </header>
        <nav class="main-nav" id="mainNav">
            <div class="sidebar">
                <ul id="sidebar-menu">
                    <li><a href="#auditForm" id="auditFormTab" class="active"><i class="fas fa-file-alt"></i> Evaluation Form</a></li>
                    <li><a href="#myEvaluations" id="myEvaluationsTab"><i class="fas fa-user-check"></i> My Evaluations</a></li>
                    <li id="database-nav-item"><a href="#database" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
                    <li id="reports-nav-item"><a href="#reports" id="reportsTab"><i class="fas fa-chart-bar"></i> Reports</a></li>
                    <li id="autofails-nav-item"><a href="#autofails" id="autofailsTab"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
                    <li><a href="#images" id="imagesTab"><i class="fas fa-image"></i> Images</a></li>
                    <li id="users-nav-item"><a href="#users" id="usersTab"><i class="fas fa-users"></i> Users</a></li>
                    <li id="admin-nav-item"><a href="#admin" id="adminTab"><i class="fas fa-user-cog"></i> Admin</a></li>
                </ul>
                <button id="logoutBtn" class="logout-button">Logout</button>
            </div>
        </nav>
    
        <main class="main-content">
            <section id="auditFormContent" class="tab-content">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Contact Center Quality Assessment Form</h2>
                <form id="assessment-form" class="bg-white p-8 rounded-lg shadow-lg mb-8">
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 border-b pb-8">
                        <h3 class="col-span-full text-2xl font-semibold mb-4 text-gray-700">Basic Information</h3>
                        <div>
                            <label for="contact-id" class="block text-gray-700 text-sm font-bold mb-2">Contact ID:</label>
                            <input type="text" id="contact-id" name="Contact ID" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-name" class="block text-gray-700 text-sm font-bold mb-2">Client Name:</label>
                            <input type="text" id="client-name" name="Client Name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="cer-name" class="block text-gray-700 text-sm font-bold mb-2">CER Name:</label>
                            <input type="text" id="cer-name" name="CER Name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="reviewer-name" class="block text-gray-700 text-sm font-bold mb-2">Reviewer's Name:</label>
                            <input type="text" id="reviewer-name" name="Reviewer's Name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200" readonly>
                        </div>
                        <div>
                            <label for="cer-role" class="block text-gray-700 text-sm font-bold mb-2">CER Role:</label>
                            <select id="cer-role" name="CER Role" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                <option value="">Select Role</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="submit" id="submitFormToDBBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md flex items-center">
                            <i class="fas fa-database mr-2"></i> Submit to Database
                        </button>
                    </div>
                </form>
            </section>
            
            <section id="myEvaluationsContent" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">My Evaluations</h2>

                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                        Evaluations I Have Done
                        <span id="evaluationsDoneBell" class="ml-2 relative hidden">
                            <i class="fas fa-bell text-yellow-500"></i>
                            <span class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full animate-ping"></span>
                        </span>
                    </h3>
                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left">Date</th>
                                    <th class="py-3 px-6 text-left">Contact ID</th>
                                    <th class="py-3 px-6 text-left">CER Name</th>
                                    <th class="py-3 px-6 text-left">Score</th>
                                </tr>
                            </thead>
                            <tbody id="evaluationsDoneTableBody">
                                <tr><td colspan="4" class="text-center py-4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                        My QA Audit Scores
                        <span id="myAuditScoresBell" class="ml-2 relative hidden">
                            <i class="fas fa-bell text-yellow-500"></i>
                            <span class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full animate-ping"></span>
                        </span>
                    </h3>
                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left">Date</th>
                                    <th class="py-3 px-6 text-left">Reviewer</th>
                                    <th class="py-3 px-6 text-left">Contact ID</th>
                                    <th class="py-3 px-6 text-left">Score</th>
                                </tr>
                            </thead>
                            <tbody id="myQaScoresTableBody">
                                <tr><td colspan="4" class="text-center py-4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">My Performance</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <canvas id="myAverageScoreChart"></canvas>
                        </div>
                        <div>
                            <canvas id="myAutofailCountChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="databaseContent" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Evaluation Records</h2>
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left">Date</th>
                                    <th class="py-3 px-6 text-left">Contact ID</th>
                                    <th class="py-3 px-6 text-left">Client Name</th>
                                    <th class="py-3 px-6 text-left">CER Name</th>
                                    <th class="py-3 px-6 text-left">Reviewer</th>
                                    <th class="py-3 px-6 text-left">Score</th>
                                </tr>
                            </thead>
                            <tbody id="allEvaluationsTableBody">
                                <tr><td colspan="6" class="text-center py-4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="imagesContent" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Images Management</h2>
                <div class="bg-white p-8 rounded-lg shadow-lg mb-8 flex flex-col items-center">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">Upload Company Logo</h3>
                    <div class="mb-4 w-full max-w-md">
                        <label for="logo-upload" class="block text-gray-700 text-sm font-bold mb-2">Select an image file:</label>
                        <input type="file" id="logo-upload" accept="image/*" class="w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                            file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100" />
                    </div>
                    <div class="border p-4 rounded-md w-full max-w-md text-center">
                        <p class="text-gray-500 mb-2">Logo Preview</p>
                        <img id="logo-preview" src="https://placehold.co/150x50/e5e7eb/6b7280?text=Logo" alt="Company Logo" class="mx-auto max-h-24 hidden">
                    </div>
                </div>
            </section>
            
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module">
        import { getAuth, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, where, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const { auth, db, appId, fs, showMessageBox, hideMessageBox, currentUserId, currentUserRole, currentUserName } = window.firebase;

        // --- DOM Elements ---
        const loginPage = document.getElementById('loginPage');
        const loginForm = document.getElementById('loginForm');
        const appContent = document.getElementById('appContent');
        const loginMessage = document.getElementById('loginMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const mainNav = document.getElementById('mainNav');

        const auditFormContent = document.getElementById('auditFormContent');
        const myEvaluationsContent = document.getElementById('myEvaluationsContent');
        const databaseContent = document.getElementById('databaseContent');
        const imagesContent = document.getElementById('imagesContent');

        const auditFormTab = document.getElementById('auditFormTab');
        const myEvaluationsTab = document.getElementById('myEvaluationsTab');
        const databaseTab = document.getElementById('databaseTab');
        const reportsTab = document.getElementById('reportsTab');
        const autofailsTab = document.getElementById('autofailsTab');
        const imagesTab = document.getElementById('imagesTab');
        const usersTab = document.getElementById('usersTab');
        const adminTab = document.getElementById('adminTab');

        const reviewerNameInput = document.getElementById('reviewer-name');
        const cerRoleSelect = document.getElementById('cer-role');
        const assessmentForm = document.getElementById('assessment-form');

        const evaluationsDoneTableBody = document.getElementById('evaluationsDoneTableBody');
        const myQaScoresTableBody = document.getElementById('myQaScoresTableBody');
        const allEvaluationsTableBody = document.getElementById('allEvaluationsTableBody');

        const headerLogo = document.getElementById('header-logo');
        const loginLogo = document.getElementById('login-logo');
        const logoUploadInput = document.getElementById('logo-upload');
        const logoPreview = document.getElementById('logo-preview');

        // --- Chart Instances ---
        let myAverageScoreChartInstance = null;
        let myAutofailCountChartInstance = null;

        // --- Functions ---
        
        async function fetchCerRoles() {
            const dropdownDocRef = fs.doc(db, `artifacts/${appId}/public/data/dropdown_options`, 'general_options');
            const docSnap = await fs.getDoc(dropdownDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                return data.cerRoles || [];
            }
            return [];
        }
        
        function populateCerRolesDropdown(roles) {
            cerRoleSelect.innerHTML = '<option value="">Select Role</option>';
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                cerRoleSelect.appendChild(option);
            });
        }

        function setReviewerName() {
            if (reviewerNameInput && window.currentUserName) {
                reviewerNameInput.value = window.currentUserName;
            }
        }

        // --- Tab Management ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('#sidebar-menu a').forEach(link => link.classList.remove('active'));

            document.getElementById(tabId + 'Content').classList.remove('hidden');
            document.getElementById(tabId + 'Tab').classList.add('active');
        }

        async function loadMyEvaluationsData() {
            const myEvaluations = await fetchMyEvaluations();
            renderEvaluationsTable(evaluationsDoneTableBody, myEvaluations.done);
            renderEvaluationsTable(myQaScoresTableBody, myEvaluations.scores);
            renderMyCharts(myEvaluations.scores);
        }

        async function loadDatabaseData() {
            const allRecords = await fetchAllEvaluations();
            renderEvaluationsTable(allEvaluationsTableBody, allRecords);
        }
        
        function loadImagesTab() {
            const savedLogo = localStorage.getItem('companyLogo');
            if (savedLogo) {
                logoPreview.src = savedLogo;
                logoPreview.classList.remove('hidden');
            } else {
                logoPreview.classList.add('hidden');
            }
        }

        function loadAllPageData() {
            setReviewerName();
            const currentTab = document.querySelector('#sidebar-menu a.active').id.replace('Tab', '');
            if (currentTab === 'myEvaluations') {
                loadMyEvaluationsData();
            } else if (currentTab === 'database') {
                loadDatabaseData();
            } else if (currentTab === 'images') {
                loadImagesTab();
            }
        }

        // --- Data Fetching ---
        async function fetchAllEvaluations() {
            const recordsCol = collection(db, `artifacts/${appId}/public/data/evaluation_records`);
            const q = query(recordsCol, orderBy('submittedAt', 'desc'));
            const querySnapshot = await getDocs(q);
            return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function fetchMyEvaluations() {
            const recordsCol = collection(db, `artifacts/${appId}/public/data/evaluation_records`);
            const doneQuery = query(recordsCol, where('Reviewer Name', '==', window.currentUserName), orderBy('submittedAt', 'desc'));
            const scoresQuery = query(recordsCol, where('CER Name', '==', window.currentUserName), orderBy('submittedAt', 'desc'));

            const [doneSnapshot, scoresSnapshot] = await Promise.all([getDocs(doneQuery), getDocs(scoresQuery)]);

            const doneEvaluations = doneSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const myScores = scoresSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            return { done: doneEvaluations, scores: myScores };
        }

        // --- Table Rendering ---
        function renderEvaluationsTable(tableBodyElement, records) {
            tableBodyElement.innerHTML = '';
            if (records.length === 0) {
                tableBodyElement.innerHTML = `<tr><td colspan="4" class="text-center py-4">No records found.</td></tr>`;
                return;
            }
            records.forEach(record => {
                const row = tableBodyElement.insertRow();
                const score = record['Overall Score'] || 'N/A';
                const date = record.submittedAt ? new Date(record.submittedAt.toDate()).toLocaleDateString() : 'N/A';
                const reviewerName = record['Reviewer\'s Name'] || 'N/A';
                const cerName = record['CER Name'] || 'N/A';

                if (tableBodyElement.id === 'evaluationsDoneTableBody') {
                    row.innerHTML = `
                        <td class="py-2 px-4">${date}</td>
                        <td class="py-2 px-4">${record['Contact ID'] || 'N/A'}</td>
                        <td class="py-2 px-4">${cerName}</td>
                        <td class="py-2 px-4">${score}</td>
                    `;
                } else if (tableBodyElement.id === 'myQaScoresTableBody') {
                    row.innerHTML = `
                        <td class="py-2 px-4">${date}</td>
                        <td class="py-2 px-4">${reviewerName}</td>
                        <td class="py-2 px-4">${record['Contact ID'] || 'N/A'}</td>
                        <td class="py-2 px-4">${score}</td>
                    `;
                } else if (tableBodyElement.id === 'allEvaluationsTableBody') {
                    row.innerHTML = `
                        <td class="py-2 px-4">${date}</td>
                        <td class="py-2 px-4">${record['Contact ID'] || 'N/A'}</td>
                        <td class="py-2 px-4">${record['Client Name'] || 'N/A'}</td>
                        <td class="py-2 px-4">${cerName}</td>
                        <td class="py-2 px-4">${reviewerName}</td>
                        <td class="py-2 px-4">${score}</td>
                    `;
                }
            });
        }

        // --- Chart Rendering ---
        function renderMyCharts(records) {
            if (myAverageScoreChartInstance) myAverageScoreChartInstance.destroy();
            if (myAutofailCountChartInstance) myAutofailCountChartInstance.destroy();

            const monthlyScores = {};
            const autofailCounts = {};

            records.forEach(record => {
                const date = record.submittedAt.toDate();
                const month = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
                const score = parseFloat(record['Overall Score'].replace('%', '')) || 0;
                const autofailType = record['Autofail Type'] || 'None';

                if (!monthlyScores[month]) monthlyScores[month] = { total: 0, count: 0 };
                monthlyScores[month].total += score;
                monthlyScores[month].count++;

                if (!autofailCounts[month]) autofailCounts[month] = {};
                autofailCounts[month][autofailType] = (autofailCounts[month][autofailType] || 0) + 1;
            });
            
            // Average Score Chart
            const sortedMonths = Object.keys(monthlyScores).sort();
            const averageScores = sortedMonths.map(month => (monthlyScores[month].total / monthlyScores[month].count).toFixed(2));
            const scoreCtx = document.getElementById('myAverageScoreChart').getContext('2d');
            myAverageScoreChartInstance = new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'My Average Score',
                        data: averageScores,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'My Average QA Score Per Month' } }
                }
            });

            // Autofail Count Chart
            const autofailLabels = [...new Set(Object.values(autofailCounts).flatMap(Object.keys))];
            const autofailDatasets = autofailLabels.map(label => {
                return {
                    label: label,
                    data: sortedMonths.map(month => autofailCounts[month][label] || 0),
                    backgroundColor: `hsla(${Math.random() * 360}, 70%, 50%, 0.6)`,
                    borderColor: `hsla(${Math.random() * 360}, 70%, 50%, 1)`,
                    borderWidth: 1
                };
            });
            const autofailCtx = document.getElementById('myAutofailCountChart').getContext('2d');
            myAutofailCountChartInstance = new Chart(autofailCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: autofailDatasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    },
                    plugins: { title: { display: true, text: 'Count of Autofail Areas Per Month' } }
                }
            });
        }

        // --- Image Upload Logic ---
        function loadLogo() {
            const logo = localStorage.getItem('companyLogo');
            if (logo) {
                if (headerLogo) headerLogo.src = logo;
                if (loginLogo) loginLogo.src = logo;
                if (logoPreview) {
                    logoPreview.src = logo;
                    logoPreview.classList.remove('hidden');
                }
            }
        }
        
        logoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const logoUrl = event.target.result;
                    localStorage.setItem('companyLogo', logoUrl);
                    loadLogo();
                    showMessageBox('Success', 'Logo uploaded successfully!');
                };
                reader.readAsDataURL(file);
            }
        });
        
        function updateNavBasedOnRole(role) {
            const navItems = {
                'database-nav-item': ['admin'],
                'reports-nav-item': ['admin'],
                'autofails-nav-item': ['admin'],
                'users-nav-item': ['admin'],
                'admin-nav-item': ['admin']
            };

            document.querySelectorAll('#sidebar-menu li').forEach(item => {
                const itemId = item.id;
                if (navItems[itemId]) {
                    if (navItems[itemId].includes(role)) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                }
            });
        }

        function checkUserRoleAndRender() {
            const role = window.currentUserRole;
            const isLoggedIn = !!window.currentUserId;
        
            if (isLoggedIn && role) {
                loginPage.classList.add('hidden');
                appContent.classList.remove('hidden');
                loadLogo();
                setReviewerName();
                updateNavBasedOnRole(role);
                loadAllPageData();

                // Set initial active tab based on hash or default
                const urlHash = window.location.hash.substring(1);
                const defaultTab = 'auditForm';
                const validTabs = ['auditForm', 'myEvaluations', 'database', 'reports', 'autofails', 'images', 'users', 'admin'];
                if (urlHash && validTabs.includes(urlHash) && !document.getElementById(urlHash + '-nav-item')?.classList.contains('hidden')) {
                    switchTab(urlHash);
                } else {
                    switchTab(defaultTab);
                }

            } else {
                loginPage.classList.remove('hidden');
                appContent.classList.add('hidden');
                loadLogo();
            }
        }

        // --- Notification Bell Logic ---
        function setupNotificationListeners() {
            if (window.currentUserName) {
                const recordsCol = collection(db, `artifacts/${appId}/public/data/evaluation_records`);
                const q = query(recordsCol, where('CER Name', '==', window.currentUserName), orderBy('submittedAt', 'desc'));
                
                fs.onSnapshot(q, (snapshot) => {
                    const myAudits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const hasUnread = myAudits.some(audit => !audit.readByAgent);
                    
                    const bell = document.getElementById('myAuditScoresBell');
                    if (bell) {
                        bell.classList.toggle('hidden', !hasUnread);
                    }
                });
            }
        }
        
        // --- Event Listeners ---
        document.addEventListener('firebaseAuthReady', () => {
            checkUserRoleAndRender();
            if (window.currentUserRole) {
                setupNotificationListeners();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.username.value;
            const password = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginMessage.textContent = 'Invalid email or password.';
                loginMessage.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            checkUserRoleAndRender();
        });

        auditFormTab.addEventListener('click', () => switchTab('auditForm'));
        myEvaluationsTab.addEventListener('click', () => {
            switchTab('myEvaluations');
            loadMyEvaluationsData();
        });
        databaseTab.addEventListener('click', () => {
            switchTab('database');
            loadDatabaseData();
        });
        imagesTab.addEventListener('click', () => {
            switchTab('images');
            loadImagesTab();
        });

        // --- Form Submission ---
        assessmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessageBox('Submitting...', 'Saving evaluation to the database.', false, true, false);

            const formData = {
                'Contact ID': document.getElementById('contact-id').value,
                'Client Name': document.getElementById('client-name').value,
                'CER Name': document.getElementById('cer-name').value,
                'Reviewer\'s Name': document.getElementById('reviewer-name').value,
                'CER Role': document.getElementById('cer-role').value,
                'Overall Score': '100%',
                'Autofail Type': 'None',
                submittedAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/evaluation_records`), formData);
                showMessageBox('Success', 'Evaluation submitted successfully!', false, false, true, () => {
                    assessmentForm.reset();
                    setReviewerName();
                });
            } catch (e) {
                showMessageBox('Error', `Failed to submit evaluation: ${e.message}`, true, false, true);
            }
        });

        window.addEventListener('load', async () => {
            const cerRoles = await fetchCerRoles();
            populateCerRolesDropdown(cerRoles);
        });
    </script>
</body>
</html>
