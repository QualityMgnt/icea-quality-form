document.addEventListener('DOMContentLoaded', function() {
    // --- Constants ---
    const CORRECT_USERNAME = 'Supervisor'; // REMOVE OR SECURE THIS IN PRODUCTION!
    const CORRECT_PASSWORD = 'Supervisor'; // REMOVE OR SECURE THIS IN PRODUCTION!

    const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzyoP_9ToCETeFW1tox8UfuLlv7rXTN1liwV_MxahnMhBxGpj6UuoEQ/exec'; // Ensure this URL is correct and accessible

    // PDF Constants
    const PDF_IMG_SCALE = 2;
    const PDF_IMG_QUALITY = 0.8; // JPEG quality
    const PDF_A4_WIDTH_MM = 210;
    const PDF_A4_HEIGHT_MM = 297;

    // --- DOM Element References ---
    // Login elements
    const loginPage = document.getElementById('loginPage');
    const loginForm = document.getElementById('loginForm');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');

    // Main form content container
    const mainFormContent = document.getElementById('mainFormContent');

    // Navigation and Logout
    const mainNav = document.getElementById('mainNav');
    const logoutBtn = document.getElementById('logoutBtn');

    // Basic Info Fields
    const contactIdInput = document.getElementById('contact-id');
    const clientNameInput = document.getElementById('client-name');
    const cerNameSelect = document.getElementById('cer-name');
    const cerRoleSelect = document.getElementById('cer-role');
    const callDateTimeInput = document.getElementById('call-date-time');
    const reviewerNameSelect = document.getElementById('reviewer-name');
    const otherReviewerNameInput = document.getElementById('other-reviewer-name');
    const autofailTypeSelect = document.getElementById('autofail-type');
    const evaluationDateInput = document.getElementById('review-date');
    const durationInput = document.getElementById('duration');

    // Score displays
    const overallScoreDisplay = document.getElementById('overall-score-display');
    const businessComplianceAccuracyDisplay = document.getElementById('business-compliance-accuracy');
    const totalPtsPercentageDisplay = document.getElementById('total-pts-percentage');
    const availablePtsDisplay = document.getElementById('available-pts-display');
    const overallFinalPercentageDisplay = document.getElementById('overall-final-percentage-display');

    // Form buttons (main form)
    const submitFormBtn = document.getElementById('submitFormBtn');
    const printEmailBtn = document.getElementById('print-email-btn');
    const saveResetBtn = document.getElementById('save-reset-btn');

    // Error message elements for basic info fields
    const contactIdError = document.getElementById('contact-id-error');
    const clientNameError = document.getElementById('client-name-error');
    const cerNameError = document.getElementById('cer-name-error');
    const cerRoleError = document.getElementById('cer-role-error');
    const callDateTimeError = document.getElementById('call-date-time-error');
    const reviewerNameError = document.getElementById('reviewer-name-error');
    const reviewDateError = document.getElementById('review-date-error');


    // --- Global State for Calculation (consider encapsulating if app grows) ---
    let currentTotalPoints = 0;
    let currentMaxPossiblePoints = 0;
    let currentBusinessComplianceAccuracy = 0;
    let isAutofailTriggered = false;

    // --- Question Data Definitions ---
    const ALL_QUESTION_SETS = {
        'Outbound Sales': [
            { description: 'Did the CER provide proper branding and personalize the call?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette althroughout the call session?', weightage: 8, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 8, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Was the CER able to build rapport?', weightage: 8, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER\'s focus solely on the Customer?', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER demonstrate strong Product Knowledge?', weightage: 10, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER document all action items & follow-up? (Autofail)', weightage: 6, autofail: true, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to sell to the customer?', weightage: 10, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log call information correctly? (Data capture)', weightage: 10, autofail: true, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER adhere to Company Policies & Procedures?(Autofail)', weightage: 5, autofail: true, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER Comply with industry and legal requirements?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Was the CER able to identify and opportunity for Upselling & Cross-Selling?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'Onboarding outbound': [
            { description: 'Did the CER provide proper branding and personalize the call?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette althroughout the call session?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Was the CER able to build rapport?', weightage: 8, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 5, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER do proper research and check all related tools required?', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER demonstrate strong Product and Process Knowledge?', weightage: 10, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to meet the call objective? (FCR)', weightage: 10, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER document all action items & follow-up?', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log call information correctly?', weightage: 10, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER adhere to Company Policies & Procedures?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER Comply with industry and legal requirements?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Was the CER able to identify and opportunity for Upselling & Cross-Selling?', weightage: 7, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'Social Media': [
            { description: 'Did the CER provide proper branding and personalize the Interaction?', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette althroughout the interaction session?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER keep the customer informed?(TAT, dead air)', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 9, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER do proper research and check all related tools required?(Due diligence)', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER show ownership and respond within the set turnaround time? (10 mins)', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 13, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER avoid risk behavior? (interaction avoidance/ZTP)', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log ticket information correctly?(Data capture)', weightage: 6, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER properly authenticate the customer?(KYC)', weightage: 8, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER provide complete and accurate information?(Customer education)', weightage: 10, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'Live Chat': [
            { description: 'Did the CER provide proper branding and personalize the conversation?', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette althroughout the conversation session?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER keep the customer informed?(Dead Air-Average Response Time 1 min, TAT, )', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 9, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER do proper research and check all related tools required?', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER show ownership and respond within the set turnaround time? (10 Secs)', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 13, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER avoid risk behavior? (conversation avoidance/ZTP)', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log ticket information correctly?(Data Capture)', weightage: 6, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER properly authenticate the customer?(KYC)', weightage: 8, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER provide complete and accurate information?(Customer education)', weightage: 9, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'Inbound': [
            { description: 'Did the CER provide proper branding and personalize the call?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette althroughout the call session?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 8, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 4, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER keep the caller informed?(Dead air/Hold/TAT)', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER do proper research and check all related tools required? (fact finding)', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER show ownership and actively listen?', weightage: 9, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 10, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER avoid risk behavior? (Call avoidance/ZTP)', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log call information correctly?(Data capture)', weightage: 10, autofail: true, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER properly authenticate the caller?(KYC)', weightage: 6, autofail: true, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER provide complete and accurate information? (Customer education)', weightage: 9, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'Email': [
            { description: 'Did the CER provide proper branding and personalize the email?', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette althroughout the interaction?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER keep the customer informed?', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER call to ask effective probing questions to ensure accurate diagnosis?', weightage: 9, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER do proper research and check all related tools required?', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER show ownership and respond within the set turnaround time?(8 hours)', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to position all possible options to the customer?', weightage: 13, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER avoid risk behavior? (Call avoidance/ZTP)', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log ticket information correctly?', weightage: 6, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER properly authenticate the writer?', weightage: 8, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER provide complete and accurate information?(Customer education)', weightage: 9, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'Digital troubleshooting': [
            { description: 'Did the Agent provide proper branding and personalize the call?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent demonstrate confidence and business etiquette althroughout the call session?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent convey his/her thoughts in an understandable clear and concise manner?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent keep the caller informed?', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent ask effective probing questions to ensure accurate diagnosis?', weightage: 5.5, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the Agent do proper research and check all related tools required?', weightage: 11, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the Agent show ownership and actively listen?', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the Agent able to position all possible options to the customer?', weightage: 10.5, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the agent avoid risk behavior? (Call avoidance/ZTP)', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the Agent log call information correctly?', weightage: 7, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the Agent properly authenticate the caller?', weightage: 8, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the Agent provide complete and accurate information?', weightage: 9, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the Agent identify an opportunity to upsell/cross sell a product?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'SMS': [
            { description: 'Did the CER provide proper branding and personalize the conversation?', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette all throughout the conversation session?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER keep the customer informed?(Dead air, TAT)', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 9, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER do proper research and check all related tools required?(fact finding)', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER show ownership and respond within the set turnaround time?(5 mins)', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 13, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER avoid risk behavior? (conversation avoidance/ZTP)', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log ticket information correctly?(Data capture)', weightage: 6, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER properly authenticate the customer?(KYC)', weightage: 8, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER provide complete and accurate information? (Customer education)', weightage: 9, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'NPS outbound': [
            { description: 'Did the Agent provide proper branding and personalize the call?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent demonstrate confidence and business etiquette althroughout the call session?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent convey his/her thoughts in an understandable clear and concise manner?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent keep the caller informed?', weightage: 5, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the Agent ask effective probing questions to ensure accurate diagnosis?', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the Agent do proper research and check all related tools required?', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the Agent show ownership and actively listen?', weightage: 6, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the Agent able to position all possible options to the customer? Create a ticket where necessary', weightage: 11, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the agent avoid risk behavior? (Call avoidance/ZTP)', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the Agent log call information correctly?', weightage: 7, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the Agent confirm the feedback from the customer and put it verbatim on the survey form?', weightage: 10, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the Agent provide complete and accurate information?', weightage: 9, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the Agent identify an opportunity to upsell/cross sell a product?', weightage: 5, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ],
        'Reviewed case handling': [
            { description: 'Did the CER provide proper branding and personalize the call?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER demonstrate confidence and business etiquette althroughout the call session?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 7, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Was the CER able to build rapport?', weightage: 6, autofail: false, category: 'CUSTOMER EXPERIENCE' },
            { description: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER do proper research and check all related tools required?', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER show ownership and actively listen?', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER document all action items & follow-up? (Autofail)', weightage: 10, autofail: true, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Was the CER able to sell to the customer?', weightage: 7, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Capture precise details of the resolution', weightage: 8, autofail: false, category: 'PROBLEM SOLVING SKILLS' },
            { description: 'Did the CER log call information correctly? (Data capture)', weightage: 7, autofail: true, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER adhere to Company Policies & Procedures?(Autofail)', weightage: 10, autofail: true, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' },
            { description: 'Did the CER Comply with industry and legal requirements?', weightage: 9, autofail: false, category: 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY' }
        ]
    };

    // Map of generic question IDs (q1-q14) to their HTML elements
    const questionElements = [];
    for (let i = 1; i <= 14; i++) {
        const row = document.querySelector(`[data-question-id="q${i}"]`);
        if (row) {
            questionElements.push({
                id: `q${i}`,
                descriptionTextElement: row.querySelector('.description-text'),
                weightDisplayElement: row.querySelector('.weight-display'),
                ratingSelectElement: row.querySelector(`.question-rating-select`),
                pointsInputElement: row.querySelector(`.question-points-input`),
                remarksTextareaElement: row.querySelector(`.question-remarks-textarea`)
            });
        }
    }

    // --- Utility Functions ---

    /**
     * Shows a message to the user.
     * @param {string} message - The message to display.
     * @param {string} type - 'success' or 'error' for styling.
     */
    function showNotification(message, type) {
        // A simple alert for now. In a real app, replace with a toast notification library.
        if (type === 'success') {
            alert('Success: ' + message);
        } else {
            alert('Error: ' + message);
        }
    }

    /**
     * Calculates and updates all scores based on current selections.
     */
    const calculateScore = () => {
        currentTotalPoints = 0;
        currentMaxPossiblePoints = 0;
        let complianceCurrentPoints = 0;
        let complianceMaxPoints = 0;
        isAutofailTriggered = false;

        const selectedRole = cerRoleSelect.value || 'Reviewed case handling';
        const questionsForRole = ALL_QUESTION_SETS[selectedRole] || ALL_QUESTION_SETS['Reviewed case handling'];

        questionElements.forEach((item, index) => {
            const ratingSelect = item.ratingSelectElement;
            const pointsInput = item.pointsInputElement;
            const questionData = questionsForRole[index];

            // If a question doesn't exist for the current role (e.g., less than 14 questions), skip.
            if (!questionData) {
                pointsInput.value = 0;
                pointsInput.readOnly = true;
                pointsInput.style.backgroundColor = '#e9ecef';
                pointsInput.style.color = '#555';
                return;
            }

            const weightage = questionData.weightage;
            const rating = ratingSelect.value;
            let currentPoints = 0;

            // Reset background and text color
            pointsInput.style.backgroundColor = '#e9ecef'; // Default readonly background
            pointsInput.style.color = '#555'; // Default text color

            if (rating === 'Yes') {
                currentPoints = weightage;
                pointsInput.readOnly = false;
                pointsInput.style.backgroundColor = '#fff'; // White for editable
            } else if (rating === 'No') {
                currentPoints = 0;
                pointsInput.readOnly = true;

                if (questionData.autofail) {
                    pointsInput.style.backgroundColor = '#fca5a5'; // Red background
                    pointsInput.style.color = '#dc2626'; // Darker red text
                    isAutofailTriggered = true;
                } else {
                    pointsInput.style.backgroundColor = '#e0e0e0'; // Grey out background for non-autofail 'No'
                }
            } else { // 'None' or empty
                currentPoints = 0;
                pointsInput.readOnly = true;
                pointsInput.style.backgroundColor = '#e9ecef'; // Default readonly background
            }

            pointsInput.value = currentPoints; // Update individual points input

            currentTotalPoints += currentPoints;
            currentMaxPossiblePoints += weightage;

            // Calculate Business & Compliance Accuracy
            if (questionData.category === 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY') {
                if (rating === 'Yes') {
                    complianceCurrentPoints += weightage;
                }
                // Only add to complianceMaxPoints if the question was answered (Yes or No)
                if (rating === 'Yes' || rating === 'No') {
                    complianceMaxPoints += weightage;
                }
            }
        });

        let overallPercentage = 0;
        if (isAutofailTriggered) {
            overallPercentage = 0;
        } else {
            if (currentMaxPossiblePoints > 0) {
                overallPercentage = ((currentTotalPoints / currentMaxPossiblePoints) * 100).toFixed(0);
            }
        }

        overallScoreDisplay.textContent = `${overallPercentage}%`;
        totalPtsPercentageDisplay.textContent = `${overallPercentage}%`;
        availablePtsDisplay.textContent = `${currentMaxPossiblePoints}%`;
        overallFinalPercentageDisplay.textContent = `${overallPercentage}%`;

        let businessCompliancePct = 0;
        if (complianceMaxPoints > 0) {
            businessCompliancePct = ((complianceCurrentPoints / complianceMaxPoints) * 100).toFixed(0);
        }
        businessComplianceAccuracyDisplay.textContent = `${businessCompliancePct}%`;
        currentBusinessComplianceAccuracy = businessCompliancePct;
    };

    /**
     * Updates form questions based on the selected CER role.
     * @param {string} role - The selected CER role.
     */
    const updateFormQuestions = (role) => {
        const questionsForRole = ALL_QUESTION_SETS[role] || ALL_QUESTION_SETS['Reviewed case handling'];

        questionElements.forEach((elements, index) => {
            const questionData = questionsForRole[index];
            const rowElement = elements.descriptionTextElement.closest('[data-question-id]');

            if (questionData) {
                // Show the row if it was hidden
                if (rowElement) rowElement.style.display = 'grid';

                elements.descriptionTextElement.textContent = questionData.description;
                elements.weightDisplayElement.textContent = questionData.weightage;
                elements.weightDisplayElement.dataset.weightage = questionData.weightage;

                // Reset rating, points, and remarks
                elements.ratingSelectElement.value = ''; // Set to empty string for "None"
                elements.pointsInputElement.value = 0;
                elements.pointsInputElement.readOnly = true;
                elements.pointsInputElement.style.backgroundColor = '#e9ecef';
                elements.pointsInputElement.style.color = '#555';
                elements.remarksTextareaElement.value = '';

                if (questionData.autofail) {
                    elements.ratingSelectElement.setAttribute('data-autofail-question', 'true');
                } else {
                    elements.ratingSelectElement.removeAttribute('data-autofail-question');
                }
            } else {
                // Hide any excess questions if a role has fewer than 14
                if (rowElement) rowElement.style.display = 'none';

                elements.descriptionTextElement.textContent = '';
                elements.weightDisplayElement.textContent = '';
                elements.weightDisplayElement.dataset.weightage = '0';
                elements.ratingSelectElement.value = '';
                elements.pointsInputElement.value = 0;
                elements.remarksTextareaElement.value = '';
                elements.ratingSelectElement.removeAttribute('data-autofail-question');
            }
        });
        calculateScore(); // Recalculate scores after updating questions
    };

    /**
     * Resets all form fields and scores to their initial state.
     */
    function resetForm() {
        contactIdInput.value = '';
        clientNameInput.value = '';
        cerNameSelect.value = '';
        cerRoleSelect.value = ''; // Reset CER Role to trigger default questions
        callDateTimeInput.value = '';
        reviewerNameSelect.value = '';
        otherReviewerNameInput.classList.add('hidden');
        otherReviewerNameInput.value = '';
        otherReviewerNameInput.removeAttribute('required');
        autofailTypeSelect.value = '';
        evaluationDateInput.valueAsDate = new Date(); // Set to today
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Adjust for local timezone offset
        callDateTimeInput.value = now.toISOString().slice(0, 16); // Set to current local date and time
        durationInput.value = '';

        // Clear validation borders and error messages
        document.querySelectorAll('.text-red-500:not(.hidden)').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.form-grid-input[style*="border-color"]').forEach(input => input.style.borderColor = '');

        // Re-initialize questions for the default role
        updateFormQuestions(cerRoleSelect.value || 'Reviewed case handling');
    }

    /**
     * Performs client-side validation for required fields.
     * @returns {boolean} True if all required fields are filled, false otherwise.
     */
    function validateForm() {
        const requiredInputs = document.querySelectorAll('#mainFormContent [required]:not(.hidden)');
        let allRequiredFilled = true;
        let firstInvalidInput = null;

        // Clear previous error messages and borders
        document.querySelectorAll('.text-red-500:not(.hidden)').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('[required][style*="border-color"]').forEach(input => input.style.borderColor = '');

        for (const input of requiredInputs) {
            // Trim value for text inputs, check for empty string for selects
            if (input.type === 'text' || input.type === 'datetime-local' || input.type === 'date') {
                if (input.value.trim() === '') {
                    allRequiredFilled = false;
                    input.style.borderColor = 'red';
                    const errorElement = document.getElementById(`${input.id}-error`);
                    if (errorElement) errorElement.classList.remove('hidden');
                    if (!firstInvalidInput) firstInvalidInput = input;
                }
            } else if (input.tagName === 'SELECT') {
                if (input.value === '') {
                    allRequiredFilled = false;
                    input.style.borderColor = 'red';
                    const errorElement = document.getElementById(`${input.id}-error`);
                    if (errorElement) errorElement.classList.remove('hidden');
                    if (!firstInvalidInput) firstInvalidInput = input;
                }
            }
        }

        // Validate "Other" reviewer name if selected
        if (reviewerNameSelect.value === 'Other' && otherReviewerNameInput.value.trim() === '') {
            allRequiredFilled = false;
            otherReviewerNameInput.style.borderColor = 'red';
            reviewerNameError.classList.remove('hidden'); // Use the same reviewer name error element
            if (!firstInvalidInput) firstInvalidInput = otherReviewerNameInput;
        }


        // Additionally, ensure all question ratings are answered.
        questionElements.forEach(item => {
            if (item.ratingSelectElement.value === '') {
                allRequiredFilled = false;
                item.ratingSelectElement.style.borderColor = 'red';
                // No specific error message for each rating, but this will highlight
                if (!firstInvalidInput) firstInvalidInput = item.ratingSelectElement;
            } else {
                item.ratingSelectElement.style.borderColor = ''; // Clear border if valid
            }
        });

        if (!allRequiredFilled && firstInvalidInput) {
            firstInvalidInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalidInput.focus();
        }

        return allRequiredFilled;
    }

    // --- Initialization ---

    /**
     * Initializes the form by setting default values and event listeners.
     */
    function initializeFormOnLoad() {
        // Add event listeners to all question rating selects
        questionElements.forEach(item => {
            item.ratingSelectElement.addEventListener('change', calculateScore);
            // Optional: Add input listener for points if they become manually editable (currently readonly unless 'Yes')
            // item.pointsInputElement.addEventListener('input', calculateScore);
        });

        // Set default date to today and current time for call date/time
        evaluationDateInput.valueAsDate = new Date();
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        callDateTimeInput.value = now.toISOString().slice(0, 16);

        // Make PDF & Email and Submit/Reset buttons visible by default (if login successful)
        if (submitFormBtn) submitFormBtn.classList.remove('hidden');
        if (printEmailBtn) printEmailBtn.classList.remove('hidden');
        if (saveResetBtn) saveResetBtn.classList.remove('hidden');

        // Initial load of questions based on default or selected role
        updateFormQuestions(cerRoleSelect.value || 'Reviewed case handling');
    }

    // --- Event Listeners ---

    // Login Form Submission
    loginForm.addEventListener('submit', function(event) {
        event.preventDefault();
        loginMessage.classList.add('hidden'); // Hide any previous login messages

        const enteredUsername = usernameInput.value;
        const enteredPassword = passwordInput.value;

        if (enteredUsername === CORRECT_USERNAME && enteredPassword === CORRECT_PASSWORD) {
            sessionStorage.setItem('loggedIn', 'true');
            loginPage.style.display = 'none';
            mainFormContent.style.display = 'block';
            mainNav.style.display = 'flex';
            initializeFormOnLoad();
        } else {
            loginMessage.textContent = 'Invalid username or password.';
            loginMessage.classList.remove('hidden');
        }
    });

    // Logout Functionality
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            sessionStorage.removeItem('loggedIn');
            // Redirect to login page or hide form and show login
            window.location.href = 'index.html';
        });
    }

    // Toggle 'Other' reviewer name input visibility
    reviewerNameSelect.addEventListener('change', () => {
        if (reviewerNameSelect.value === 'Other') {
            otherReviewerNameInput.classList.remove('hidden');
            otherReviewerNameInput.setAttribute('required', 'required');
            reviewerNameError.classList.add('hidden'); // Hide select-specific error if "Other" is chosen
        } else {
            otherReviewerNameInput.classList.add('hidden');
            otherReviewerNameInput.value = '';
            otherReviewerNameInput.removeAttribute('required');
            otherReviewerNameInput.style.borderColor = ''; // Clear border if it was red
        }
    });

    // Event listener for CER Role change to update questions
    cerRoleSelect.addEventListener('change', (event) => {
        updateFormQuestions(event.target.value);
    });

    // Reset button functionality
    if (saveResetBtn) {
        saveResetBtn.addEventListener('click', function(event) {
            event.preventDefault();
            resetForm();
        });
    }

    // Submit button functionality
    if (submitFormBtn) {
        submitFormBtn.addEventListener('click', async function(event) {
            event.preventDefault();

            if (!validateForm()) {
                showNotification('Please fill out all highlighted required fields.', 'error');
                return;
            }

            // Collect data for submission
            const formDataForSubmission = {
                action: 'submitForm',
                "CER Name": cerNameSelect.value,
                "Reviewer's Name": reviewerNameSelect.value === 'Other' ? otherReviewerNameInput.value : reviewerNameSelect.value,
                "Contact ID": contactIdInput.value,
                "Client Name": clientNameInput.value,
                "Call Date and Time": callDateTimeInput.value,
                "CER Roles": cerRoleSelect.value,
                "Evaluation Date": evaluationDateInput.value,
                "Duration": durationInput.value,
                "Autofail Type": autofailTypeSelect.value,
            };

            // Dynamically add question data
            const selectedRole = cerRoleSelect.value || 'Reviewed case handling';
            const questionsForCurrentRole = ALL_QUESTION_SETS[selectedRole] || ALL_QUESTION_SETS['Reviewed case handling'];

            questionElements.forEach((item, index) => {
                const questionData = questionsForCurrentRole[index];
                if (questionData) {
                    formDataForSubmission[questionData.description] = item.ratingSelectElement.value;
                    formDataForSubmission[`${questionData.description} - Remarks`] = item.remarksTextareaElement.value;
                    formDataForSubmission[`${questionData.description} - Points`] = parseFloat(item.pointsInputElement.value);
                    formDataForSubmission[`${questionData.description} - Weightage`] = questionData.weightage;
                }
            });

            formDataForSubmission["Business & Compliance Accuracy"] = businessComplianceAccuracyDisplay.textContent;
            formDataForSubmission["Overall Score"] = overallScoreDisplay.textContent;
            formDataForSubmission["Total Pts."] = currentTotalPoints;
            formDataForSubmission["Available Pts."] = currentMaxPossiblePoints;
            formDataForSubmission["Final Score"] = overallFinalPercentageDisplay.textContent;

            // Handle potential autofail on submission
            if (isAutofailTriggered) {
                // You might want to handle this differently, e.g., show a specific warning
                // before submitting or set the overall score to 0 on the sheet as well.
                // Current logic sets overallPercentage to 0, which is good.
            }

            // Disable buttons and show loading state
            submitFormBtn.textContent = 'Submitting...';
            submitFormBtn.disabled = true;
            if (saveResetBtn) saveResetBtn.disabled = true;
            if (printEmailBtn) printEmailBtn.disabled = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // Ensure your Apps Script allows CORS
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formDataForSubmission)
                });

                const responseData = await response.json();

                if (response.ok && responseData.status === 'SUCCESS') {
                    showNotification('Form data submitted successfully! The form will now reset.', 'success');
                    resetForm();
                } else {
                    const errorMessage = responseData.message || 'Unknown error occurred.';
                    showNotification(`Failed to submit form data: ${errorMessage}`, 'error');
                    console.error('Apps Script Error:', responseData.message || responseData);
                }

            } catch (error) {
                console.error('Error submitting form data (network/fetch error):', error);
                showNotification('Failed to submit form data. Please check your internet connection and try again.', 'error');
            } finally {
                // Re-enable buttons and restore text
                submitFormBtn.textContent = 'Submit';
                submitFormBtn.disabled = false;
                if (saveResetBtn) saveResetBtn.disabled = false;
                if (printEmailBtn) printEmailBtn.disabled = false;
            }
        });
    }


    // PDF & Email Button functionality
    printEmailBtn.addEventListener('click', async () => {
        const element = document.getElementById('mainFormContent');
        if (!element) {
            showNotification('Could not find the form to generate PDF. Please try again.', 'error');
            return;
        }

        // Temporarily hide elements for cleaner PDF.
        const elementsToHide = [mainNav, submitFormBtn, printEmailBtn, saveResetBtn].filter(Boolean); // Filter out nulls
        const originalDisplays = [];

        elementsToHide.forEach(el => {
            originalDisplays.push({ el: el, display: el.style.display });
            el.style.display = 'none';
        });

        // Ensure all error messages are hidden before PDF generation
        document.querySelectorAll('.text-red-500:not(.hidden)').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.form-grid-input[style*="border-color"]').forEach(input => input.style.borderColor = '');


        try {
            const canvas = await html2canvas(element, {
                scale: PDF_IMG_SCALE,
                useCORS: true,
                logging: false, // Set to true for debugging html2canvas issues
                // Add a small delay to ensure any layout changes are rendered
                // (Though not strictly necessary with display:none)
                // foreignObjectRendering: true // Might help with complex CSS, but can introduce issues
            });

            const imgData = canvas.toDataURL('image/jpeg', PDF_IMG_QUALITY);
            const imgWidth = PDF_A4_WIDTH_MM;
            const pageHeight = PDF_A4_HEIGHT_MM;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            let position = 0;
            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
            heightLeft -= pageHeight;

            while (heightLeft > -1) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pageHeight;
            }

            // Generate a more specific filename
            const contactIdForPdf = contactIdInput.value || 'UnknownContact';
            const cerNameForPdf = cerNameSelect.value.replace(/\s+/g, '_') || 'UnknownCER'; // Replace spaces for filename
            const reviewDateForPdf = evaluationDateInput.value || 'UnknownDate';
            pdf.save(`QA_Form_${contactIdForPdf}_${cerNameForPdf}_${reviewDateForPdf}.pdf`);

            // Prepare email details
            const cerNameVal = cerNameSelect.value;
            const evaluationDateVal = evaluationDateInput.value;
            const overallScoreVal = overallFinalPercentageDisplay.textContent;
            const contactIdVal = contactIdInput.value;
            const reviewerNameVal = reviewerNameSelect.value === 'Other' ? otherReviewerNameInput.value : reviewerNameSelect.value;

            const emailBody = `Dear ${cerNameVal},\n\nPlease find attached your Quality Assessment Form for Contact ID: ${contactIdVal}.\n\nEvaluation Date: ${evaluationDateVal}\nReviewer: ${reviewerNameVal}\nOverall Score: ${overallScoreVal}\nBusiness & Compliance Accuracy: ${businessComplianceAccuracyDisplay.textContent}\n\nRemarks:\n${questionElements.map(q => {
                const qData = (ALL_QUESTION_SETS[cerRoleSelect.value] || ALL_QUESTION_SETS['Reviewed case handling'])[questionElements.indexOf(q)];
                if (qData && q.remarksTextareaElement.value.trim() !== '') {
                    return `- ${qData.description}: ${q.remarksTextareaElement.value.trim()}`;
                }
                return '';
            }).filter(Boolean).join('\n')}\n\nRegards,\nICEALION Group`;

            const subject = `Quality Assessment Report - Contact ID: ${contactIdVal || 'N/A'} - CER: ${cerNameVal || 'N/A'}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;

            window.location.href = mailtoLink;
            showNotification('PDF generated and downloaded. Please attach the PDF manually to your email client.', 'success');

        } catch (error) {
            console.error("Critical Error during PDF generation or mailto attempt:", error);
            showNotification("Failed to generate PDF or open email client. Please check your browser console for details.", 'error');
        } finally {
            // Always restore original display styles after operation
            originalDisplays.forEach(({ el, display }) => {
                if (el) el.style.display = display;
            });
        }
    });

    // Check for login state on page load and initialize form accordingly
    const isLoggedIn = sessionStorage.getItem('loggedIn');
    if (isLoggedIn === 'true') {
        loginPage.style.display = 'none';
        mainFormContent.style.display = 'block';
        mainNav.style.display = 'flex';
        initializeFormOnLoad();
    } else {
        loginPage.style.display = 'flex';
        mainFormContent.style.display = 'none';
        mainNav.style.display = 'none';
    }
});
