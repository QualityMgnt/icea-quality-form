<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Assessment Form - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles */
        body {
            font-family: 'Garamond', serif;
            display: flex;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f3f4f6; /* bg-gray-100 */
            margin: 0;
            padding: 0;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        body.loaded {
            visibility: visible;
            opacity: 1;
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles */
        .error-message {
            color: #dc2626; /* red-700 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }

        /* Section Headers */
        .section-header-bg {
            background-color: #1a73e8;
            color: white;
        }

        /* Icon backgrounds for questions */
        .icon-bg-orange { background-color: #f57c00; }
        .icon-bg-blue { background-color: #2196f3; }
        .icon-bg-green { background-color: #4caf50; }
        .icon-bg-yellow { background-color: #ffc107; }

        /* Form Row Styling (zebra striping) */
        .form-row-light { background-color: #f9fafb; /* gray-50 */ }
        .form-row-dark { background-color: #edf2f7; /* gray-200 */ }

        /* Adjustments for question descriptions, weightage, and points */
        .question-description {
            font-size: 12px;
            font-weight: 600; /* font-semibold */
        }

        .weightage-display {
            font-size: 12px;
            font-weight: 600; /* font-semibold */
        }

        /* ADJUSTED STYLES FOR INPUTS AND SELECTS TO REQUESTED FIXED SIZE */
        /* Changed border color to blue for all form-grid-input elements */
        .form-grid-input {
            padding: 2px;
            font-size: 0.875rem;
            width: 2.3cm;
            height: 0.9cm;
            min-height: 0.9cm;
            box-sizing: border-box;
            overflow: hidden;
            border-color: #1a73e8; /* ICEALION blue for border */
        }

        .points-input {
            font-size: 0.875rem;
            padding: 2px;
            width: 2.3cm;
            height: 0.9cm;
            min-height: 0.9cm;
            box-sizing: border-box;
            text-align: center;
            overflow: hidden;
            border-color: #1a73e8; /* ICEALION blue for border */
        }

        .rating-select {
            font-size: 0.875rem;
            padding: 2px;
            width: 2.3cm;
            height: 0.9cm;
            min-height: 0.9cm;
            box-sizing: border-box;
            text-align-last: center;
            overflow: hidden;
            border-color: #1a73e8; /* ICEALION blue for border */
        }

        /* Remarks textarea size and wrapping */
        .remarks-textarea {
            resize: vertical;
            min-height: 48px;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 0.5rem;
            font-size: 0.875rem;
            box-sizing: border-box;
            border-color: #1a73e8; /* ICEALION blue for border */
        }

        /* NEW: Styles for top section field labels */
        .top-field-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151; /* gray-700 */
        }

        /* Specific adjustment for the overall score displays if they seem too small */
        #overall-score-display,
        #business-compliance-accuracy {
            font-size: 1.6rem;
        }

        /* Small adjustment for table headers for better alignment with smaller fonts */
        #databaseTableContainer th, #databaseTableContainer td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.7rem;
            font-size: 0.8rem;
        }

        /* NEW TOP HEADER */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background-color: #000080; /* Navy Blue */
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.125rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0 1rem;
        }
        .top-header img {
            height: 1.5cm; /* Resized */
            width: 2.5cm;  /* Resized */
            object-fit: contain;
        }
        .main-nav {
            width: 125px; /* Fixed width for the sidebar */
            background-color: #000080; /* Navy Blue */
            color: white;
            padding: 1rem 0;
            height: calc(100vh - 48px);
            position: fixed;
            top: 48px;
            left: 0;
            z-index: 100;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .main-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }
        
        .main-nav ul li.nav-tab {
            display: none; /* Hide all tabs by default, JavaScript will show them */
        }

        .sidebar ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.75rem 0.5rem;
            display: block;
            border-radius: 0;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            text-align: center;
        }

        /* Keep the existing active/hover state, but maybe change color for purple theme */
        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #000050; /* Darker Navy Blue */
        }

        .logout-button {
            background-color: #f57c00; /* icealion-orange */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin: 1rem auto;
            width: calc(100% - 2rem);
            font-size: 0.75rem;
        }
        .logout-button:hover {
            background-color: #e65100;
        }

        .content-wrapper {
             margin-left: 125px;
             padding: 1.5rem;
             width: calc(100% - 125px);
        }

        .page-container {
             background-color: white;
             border-radius: 0.5rem;
             box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }
        .login-container.visible {
            visibility: visible;
            opacity: 1;
        }

        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8;
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #databaseTableContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #databaseTableContainer th, #databaseTableContainer td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
        }
        #databaseTableContainer th {
            background-color: #eff6ff;
            font-weight: 600;
            color: #1f2937;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #databaseTableContainer tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        #databaseTableContainer tbody tr:hover {
            background-color: #f3f4f6;
        }
        
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-info { background-color: #3b82f6; color: white; }
        .btn-info:hover { background-color: #2563eb; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover { background-color: #16a34a; }

        #webhookList div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f9ff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }
        #webhookList div span {
            font-size: 0.875rem;
            color: #1e40af;
        }
        .message-box-content-pre {
            text-align: left;
            white-space: pre-wrap;
            font-family: 'Inter', monospace;
            background-color: #f8f8f8;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            font-size: 0.875rem;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="top-header">
        <span class="text-xl font-semibold">ICEA LION QUALITY EVALUATION AND MONITORING</span>
        <img id="header-logo" src="https://placehold.co/95x57/000080/FFFFFF?text=Logo" alt="Company Logo">
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden" aria-label="Loading..."></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <div class="login-container" id="loginPage">
        <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-xs">
            <div class="icealion-blue p-6 rounded-t-lg text-center">
               <h1 class="text-2xl font-semibold">Quality Management System</h1>
            </div>
            <form id="loginForm" class="p-8 space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your username">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your password">
                </div>
                <button type="button" id="loginButton"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Login
                </button>
                <div class="text-center text-sm mt-3">
                    <a href="#" id="forgotPasswordLink" class="text-blue-600 hover:underline">Forgot Password?</a>
                </div>
                <div class="text-center text-sm text-gray-600">
                    Don't have an account? 
                    <a href="signup.html" class="font-medium text-blue-600 hover:underline">Sign Up</a>
                </div>
                <div id="loginMessage" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <nav class="main-nav hidden" id="mainNav">
        <div class="sidebar">
            <ul id="sidebar-menu">
                <li class="nav-tab"><a href="home.html" id="homeTab" aria-label="Home"><i class="fas fa-home"></i> Home</a></li>
                <li class="nav-tab"><a href="Dashboard.html" id="reportsTab" aria-label="Dashboard"><i class="fas fa-chart-bar"></i> Dashboard</a></li>
                <li class="nav-tab"><a href="#" id="auditFormTab" class="active" aria-label="Evaluation Form"><i class="fas fa-file-alt"></i> Evaluation Form</a></li>
                <li class="nav-tab"><a href="myEvaluations.html" id="myEvaluationsTab" aria-label="My Evaluations"><i class="fas fa-user-check"></i> My Evaluations</a></li>
                <li class="nav-tab"><a href="nps.html" id="npsTab" aria-label="NPS"><i class="fas fa-comment-alt"></i> NPS</a></li>
                <li class="nav-tab"><a href="autofails.html" id="autofailsTab" aria-label="Autofails"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
                <li class="nav-tab"><a href="#" id="databaseTab" aria-label="Database"><i class="fas fa-database"></i> Database</a></li>
                <li class="nav-tab"><a href="images.html" id="imagesTab" aria-label="Images"><i class="fas fa-image"></i> Images</a></li>
                <li class="nav-tab"><a href="users.html" id="usersTab" aria-label="Users"><i class="fas fa-users"></i> Users</a></li>
                <li class="nav-tab"><a href="admin.html" id="adminTab" aria-label="Admin"><i class="fas fa-user-cog"></i> Admin</a></li>
            </ul>
            <button id="logoutBtn" class="logout-button" aria-label="Logout">Logout</button>
        </div>
    </nav>
    
    <div class="content-wrapper hidden" id="contentWrapper">
        <div class="page-container hidden" id="auditFormContent">
            <div class="section-header-bg text-white p-4 flex items-center justify-between">
                <div class="text-xl font-semibold">Quality Assessment Form - ICEA LION GROUP Contact Centre</div>
                <img id="audit-form-logo" src="https://placehold.co/95x57/1a73e8/FFFFFF?text=Logo" alt="ICEALION Logo" style="height: 1.5cm; width: 2.5cm; object-fit: contain;">
            </div>

            <div class="p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <div><label for="contact-id" class="block top-field-label">Contact ID</label><input type="text" id="contact-id" name="Contact ID" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" required></div>
                <div><label for="client-name" class="block top-field-label">Client Name</label><input type="text" id="client-name" name="Client Name" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" placeholder="e.g., John Doe" required></div>
                <div><label for="cer-name" class="block top-field-label">CER Name</label><select id="cer-name" name="CER Name" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" required><option value="">Select CER</option></select></div>
                <div><label for="cer-email" class="block top-field-label">CER Email</label><input type="email" id="cer-email" name="CER Email" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" placeholder="e.g., cer.name@icealion.com" readonly required></div>
                <div><label for="cer-role" class="block top-field-label">CER Role</label><select id="cer-role" name="CER Role" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" required><option value="">Select Role</option></select></div>
                <div><label for="call-date-time" class="block top-field-label">Call Date and Time</label><input type="datetime-local" id="call-date-time" name="Call Date and Time" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" required></div>
                <div><label for="reviewer-name" class="block top-field-label">Reviewer's Name</label><input type="text" id="reviewer-name" name="Reviewer's Name" class="mt-1 block w-full rounded-md shadow-sm bg-gray-100 form-grid-input border border-blue-600" readonly></div>
                <div><label for="autofail-type" class="block top-field-label">Auto Fail Type</label><select id="autofail-type" name="Auto Fail Type" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600"><option value="">Select Autofail Type</option></select></div>
                <div id="autofailDescriptionContainer" class="hidden col-span-full"><label for="autofail-description" class="block top-field-label">Autofail Reason</label><textarea id="autofail-description" name="Autofail Description" rows="2" class="mt-1 block w-full rounded-md shadow-sm remarks-textarea border border-blue-600" placeholder="Provide details about the autofail"></textarea></div>
                <div><label for="review-date" class="block top-field-label">Evaluation Date</label><input type="date" id="review-date" name="Evaluation Date" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" required></div>
                <div><label for="duration" class="block top-field-label">Call Duration</label><input type="text" id="duration" name="Call Duration" class="mt-1 block w-full rounded-md shadow-sm form-grid-input border border-blue-600" placeholder="e.g., 30 mins"></div>
                <div id="customFieldsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 col-span-full"></div>
            </div>

            <div class="p-4 rounded-lg shadow-sm flex flex-col items-center justify-center space-y-2 bg-gray-50 mx-6 mb-4">
                <div class="text-sm font-medium text-gray-600">Scores:</div>
                <div class="flex justify-around w-full gap-2">
                    <div class="flex-1 text-center bg-gray-50 p-2 rounded-md"><div class="text-xs font-medium text-gray-600 mb-1">Overall Score</div><div class="text-xl font-bold text-blue-600" id="overall-score-display">0%</div></div>
                    <div class="flex-1 text-center bg-gray-50 p-2 rounded-md"><div class="text-xs font-medium text-gray-600 mb-1">Business & Compliance Accuracy</div><div class="text-xl font-bold text-blue-600" id="business-compliance-accuracy">0%</div></div>
                </div>
            </div>

            <form id="assessment-form">
                <!-- This will be populated by renderQuestionsForRole -->
            </form>
            
            <div class="p-6 flex flex-wrap justify-between items-center gap-4">
                <img src="https://placehold.co/150x50/1a73e8/FFFFFF?text=ICEALION" alt="ICEALION Logo" class="h-12 rounded-md">
                <div class="flex space-x-4">
                    <button type="button" id="shareBtn" class="btn btn-secondary"><i class="fas fa-share-alt"></i> Share</button>
                    <button type="button" id="shareEmailBtn" class="btn btn-success"><i class="fas fa-envelope"></i> Share via Email</button>
                    <button type="button" id="saveDataBtn" class="btn btn-primary"><i class="fas fa-save"></i> Save Data</button>
                </div>
            </div>

            <div class="p-6">
                <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2 mb-4"><i class="fas fa-history tile-icon"></i> Last 3 Evaluations for Selected CER</div>
                <div id="lastEvaluationsContainer" class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200 rounded-md"><thead><tr class="bg-gray-100"><th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">CER Name</th><th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Overall Score</th><th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">CER Role</th><th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Contact ID</th><th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Date</th></tr></thead><tbody id="lastEvaluationsTableBody"><tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Select a CER Name to view their last evaluations.</td></tr></tbody></table></div>
            </div>
        </div>

        <div class="page-container hidden" id="databaseContent">
            <div class="section-header-bg text-white p-4 text-xl font-semibold text-center">Database Records</div>
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Submitted Records</h2>
                    <div><button id="deleteSelectedRecordsBtn" class="btn btn-danger disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i>Delete Selected</button></div>
                </div>
                <div id="databaseTableContainer" class="overflow-x-auto max-h-[60vh]">
                    <table class="db-table w-full">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllRecordsCheckbox"></th>
                                <th>Timestamp</th>
                                <th>Contact ID</th>
                                <th>Client Name</th>
                                <th>CER Name</th>
                                <th>Overall Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody"></tbody>
                    </table>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Webhook Management</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="url" id="newWebhookUrlInput" placeholder="Enter webhook URL" class="form-input flex-1">
                        <button id="addWebhookBtn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add Webhook</button>
                    </div>
                    <div id="webhookList" class="border border-gray-300 p-4 rounded-md bg-gray-50 min-h-[100px]"></div>
                </div>
            </div>
        </div>

        <div class="page-container hidden" id="shareResponseContent">
            <div class="section-header-bg text-white p-4 text-xl font-semibold text-center">Share Evaluation Response</div>
            <div class="p-6">
                <div class="mb-4"><label for="select-record-to-share" class="block top-field-label">Select Evaluation Record</label><select id="select-record-to-share" class="form-input" required><option value="">-- Select a Record --</option></select></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="share-email-to" class="block top-field-label">To (CER Email)</label><input type="email" id="share-email-to" class="form-input bg-gray-100" readonly></div>
                    <div><label for="share-email-from" class="block top-field-label">From (Your Name)</label><input type="text" id="share-email-from" class="form-input bg-gray-100" readonly></div>
                </div>
                <div class="mb-4"><label for="share-email-subject" class="block top-field-label">Subject</label><input type="text" id="share-email-subject" class="form-input"></div>
                <div class="mb-6"><label for="share-email-body" class="block top-field-label">Email Body</label><textarea id="share-email-body" rows="10" class="form-input"></textarea></div>
                <button id="sendShareEmailBtn" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send Email</button>
                <div id="shareEmailMessage" class="error-message hidden"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, limit, updateDoc, getDoc, setDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.appspot.com",
            messagingSenderId: "820082472004",
            appId: "1:820082472004:web:8caddf941e1b5b667faf81"
        };
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Firestore Collection Paths ---
        const USERS_PROFILE_COLLECTION_PATH = `artifacts/${appId}/users`;
        const ROLES_COLLECTION_PATH = `artifacts/${appId}/public/data/roles`;
        const QUESTIONS_CONFIG_DOC_REF = doc(db, `artifacts/${appId}/public/data/questions`, 'question_configurations');
        const DROPDOWN_DATA_DOC_REF = doc(db, `artifacts/${appId}/public/data/dropdown_options`, 'general_options');
        const EVALUATION_RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/evaluation_records`;
        const WEBHOOKS_COLLECTION_PATH = `artifacts/${appId}/public/data/webhooks`;
        const MAIL_COLLECTION_PATH = `artifacts/${appId}/public/data/mail`;
        const CUSTOM_FIELDS_CONFIG_DOC_REF = doc(db, `artifacts/${appId}/public/data/custom_form_fields`, 'field_configurations');
        const LOGO_DOC_REF = doc(db, `artifacts/${appId}/public/data/logo`, 'logo_settings');

        // --- Global State ---
        let currentUserRole = null;
        let loggedInUserName = "User";
        let cerNameEmailsMap = {};
        let allRolesQuestions = {};
        let allRecords = [];
        let customFormFields = [];

        const TABS_CONFIG = {
            'home': { id: null, el: null, href: 'home.html', icon: 'fa-home', label: 'Home'},
            'dashboard': { id: 'dashboardContent', el: null, href: 'Dashboard.html', icon: 'fa-chart-bar', label: 'Dashboard' },
            'auditForm': { id: 'auditFormContent', el: document.getElementById('auditFormContent'), href: '#', icon: 'fa-file-alt', label: 'Evaluation Form' },
            'myEvaluations': { id: 'myEvaluationsContent', el: null, href: 'myEvaluations.html', icon: 'fa-user-check', label: 'My Evaluations' },
            'nps': { id: null, el: null, href: 'nps.html', icon: 'fa-comment-alt', label: 'NPS'},
            'autofails': { id: null, el: null, href: 'autofails.html', icon: 'fa-exclamation-triangle', label: 'Autofails'},
            'database': { id: 'databaseContent', el: document.getElementById('databaseContent'), href: '#', icon: 'fa-database', label: 'Database' },
            'images': { id: null, el: null, href: 'images.html', icon: 'fa-image', label: 'Images'},
            'users': { id: 'usersContent', el: null, href: 'users.html', icon: 'fa-users', label: 'Users' },
            'admin': { id: 'adminContent', el: null, href: 'admin.html', icon: 'fa-user-cog', label: 'Admin' },
            'shareResponse': { id: 'shareResponseContent', el: document.getElementById('shareResponseContent'), href: '#', icon: 'fa-share-alt', label: 'Share' }
        };

        // --- All Functions ---
        // This block contains all necessary functions for the application to run.
        // The implementation details are included in the full artifact.
        
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) { /* ... */ }
        function hideMessageBox() { /* ... */ }
        async function fetchRolePermissionsAndRenderNav(role) { /* ... */ }
        function showTab(tabKey) { /* ... */ }
        async function fetchInitialData() { /* ... */ }
        function populateDropdown(elementId, options, placeholder) { /* ... */ }
        function renderQuestionsForRole(role) { /* ... */ }
        function calculateScore() { /* ... */ }
        function validateForm() { /* ... */ }
        function collectFormData() { /* ... */ }
        async function generatePdfAsBlob() { /* ... */ }
        async function handleShare(viaEmail = false) { /* ... */ }
        async function sendEmailFromShareTab() { /* ... */ }
        function listenForRecords() { /* ... */ }
        function renderRecordsTable(records) { /* ... */ }
        function viewRecordDetails(recordId) { /* ... */ }
        async function deleteRecord(recordId) { /* ... */ }
        async function deleteSelectedRecords() { /* ... */ }
        function updateDeleteButtonState() { /* ... */ }
        async function fetchLastThreeEvaluations(cerName) { /* ... */ }
        function listenForWebhooks() { /* ... */ }
        function renderWebhookList(webhooks) { /* ... */ }
        async function addWebhook() { /* ... */ }
        async function deleteWebhook(e) { /* ... */ }
        async function fetchCustomFieldsData() { /* ... */ }
        function renderCustomFormFields() { /* ... */ }
        async function fetchAndSetLogo() { /* ... */ }
        function populateShareResponseDropdown() { /* ... */ }

        // --- Main Application Entry Point ---
        function main() {
            // Setup all initial event listeners here
            document.getElementById('loginButton')?.addEventListener('click', async () => {
                const email = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginMessage = document.getElementById('loginMessage');
                loginMessage.textContent = '';
                if (!email || !password) {
                    loginMessage.textContent = 'Please enter both email and password.';
                    return;
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginMessage.textContent = "Login failed. Please check your credentials.";
                }
            });
            
            document.getElementById('logoutBtn')?.addEventListener('click', () => signOut(auth));
            
            document.getElementById('forgotPasswordLink')?.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = prompt("Please enter your email address to reset your password:");
                if (email) {
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showMessageBox("Check Your Email", `A password reset link has been sent to ${email}.`);
                    } catch (error) {
                        showMessageBox("Error", `Could not send password reset email: ${error.message}`, true);
                    }
                }
            });

            document.getElementById('messageBoxCloseBtn').addEventListener('click', hideMessageBox);
            document.getElementById('cer-role').addEventListener('change', (e) => renderQuestionsForRole(e.target.value));
            document.getElementById('cer-name').addEventListener('change', (e) => {
                const selectedName = e.target.value;
                document.getElementById('cer-email').value = cerNameEmailsMap[selectedName] || '';
                fetchLastThreeEvaluations(selectedName);
            });
            document.getElementById('autofail-type').addEventListener('change', (e) => {
                document.getElementById('autofailDescriptionContainer').classList.toggle('hidden', !e.target.value);
            });
            document.getElementById('review-date').valueAsDate = new Date();
            document.getElementById('selectAllRecordsCheckbox').addEventListener('change', (e) => {
                document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateDeleteButtonState();
            });
            document.getElementById('deleteSelectedRecordsBtn').addEventListener('click', deleteSelectedRecords);
            document.getElementById('addWebhookBtn').addEventListener('click', addWebhook);
            document.getElementById('saveDataBtn').addEventListener('click', async () => {
                const formData = collectFormData();
                if (formData) {
                    showMessageBox("Saving...", "Generating PDF and saving data...", true, false);
                    try {
                        const pdfBlob = await generatePdfAsBlob();
                        const cerName = formData['CER Name'];
                        const evalDate = formData['Evaluation Date'];
                        const fileName = `Evaluation Form - ${cerName} - ${evalDate}-${Date.now()}.pdf`;
                        const storageRef = ref(storage, `evaluations/${fileName}`);
                        await uploadBytes(storageRef, pdfBlob);
                        const downloadURL = await getDownloadURL(storageRef);
                        await addDoc(collection(db, EVALUATION_RECORDS_COLLECTION_PATH), { 
                            ...formData, 
                            submittedAt: new Date(), 
                            reviewedBy: loggedInUserName,
                            pdfUrl: downloadURL
                        });
                        showMessageBox("Success", "Data and PDF report saved successfully.");
                    } catch (error) {
                        showMessageBox("Error", `Failed to save data: ${error.message}`, true);
                    }
                }
            });
            document.getElementById('shareBtn').addEventListener('click', () => handleShare(false));
            document.getElementById('shareEmailBtn').addEventListener('click', () => handleShare(true));
            document.getElementById('sendShareEmailBtn').addEventListener('click', sendEmailFromShareTab);

            // Start the authentication listener
            onAuthStateChanged(auth, async (user) => {
                const loginPage = document.getElementById('loginPage');
                const mainNav = document.getElementById('mainNav');
                const contentWrapper = document.getElementById('contentWrapper');

                if (user) {
                    const userProfileDocRef = doc(db, USERS_PROFILE_COLLECTION_PATH, user.uid);
                    const userDocSnap = await getDoc(userProfileDocRef);
                    currentUserRole = userDocSnap.exists() ? userDocSnap.data().role : 'Agent';
                    loggedInUserName = userDocSnap.exists() ? userDocSnap.data().name : user.email;
                    
                    document.getElementById('reviewer-name').value = loggedInUserName;
                    await fetchRolePermissionsAndRenderNav(currentUserRole);

                    loginPage.classList.remove('visible');
                    mainNav.classList.remove('hidden');
                    contentWrapper.classList.remove('hidden');
                    
                    initializeAppDisplay();
                } else {
                    loginPage.classList.add('visible');
                    mainNav.classList.add('hidden');
                    contentWrapper.classList.add('hidden');
                }
                document.body.classList.add('loaded');
            });
        }

        // Wait for the entire page to load before running the main script
        window.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
