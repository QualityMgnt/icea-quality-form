<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICEA LION QA Audit Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 10vh;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles */
        .error-message {
            color: #dc2626; /* red-700 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }

        /* Section Headers */
        .section-header-bg {
            background-color: #1a73e8;
            color: white;
        }
        /* Icon backgrounds for questions */
        .icon-bg-orange { background-color: #f57c00; }
        .icon-bg-blue { background-color: #2196f3; }
        .icon-bg-green { background-color: #4caf50; }
        .icon-bg-yellow { background-color: #ffc107; }

        /* Form Row Styling (zebra striping) */
        .form-row-light { background-color: #f9fafb; /* gray-50 */ }
        .form-row-dark { background-color: #edf2f7; /* gray-200 */ }

        /* General input styling for consistency (Other fields: size 11, not bold) */
        /* Increased padding and height for textboxes and dropdowns */
        .form-grid-input,
        .rating-select,
        .points-input {
            padding: 10px; /* Increased padding */
            font-size: 0.6875rem; /* Equivalent to 11px (0.6875 * 16 = 11) */
            font-weight: normal; /* Not bold */
            min-height: 40px; /* Increased minimum height for single-line inputs/selects */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        /* Field Labels: Size 11 and Bold */
        .block.text-sm.font-medium.text-gray-700 {
            font-size: 0.6875rem; /* Equivalent to 11px */
            font-weight: bold;
        }

        /* Weightage: Size 11 and Bold */
        .weightage-display {
            font-size: 0.6875rem; /* Equivalent to 11px */
            font-weight: bold;
        }

        /* Question Description Text: Size 11 and Bold */
        .question-description-text {
            font-size: 0.6875rem; /* Equivalent to 11px */
            font-weight: bold;
        }

        /* Style for temporary display elements during PDF capture */
        .pdf-display-value {
            font-size: 0.6875rem; /* Match general input font size (11px) */
            padding: 10px; /* Match increased padding */
            display: block; /* Ensure it takes full width of its container */
            color: #333; /* Darker text for readability */
            background-color: #fff;
            border: 1px solid #e2e8f0; /* Light gray border */
            border-radius: 0.375rem; /* Rounded corners */
            min-height: 40px; /* Match new input/select min-height */
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            white-space: pre-wrap; /* For textareas and wrapping text */
            word-wrap: break-word;
            overflow-wrap: break-word; /* Ensure long words break */
            font-weight: normal; /* Ensure not bold for the displayed value */
            display: none; /* Keep hidden by default, visible during PDF capture */
        }

        /* Navigation styles */
        .main-nav {
            width: 100%;
            background-color: #0d47a1; /* Updated: Dark blue */
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .main-nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .main-nav ul li {
            margin-right: 1.5rem;
            /* Ensure all list items are visible */
            display: inline-block !important; /* Force display for all roles */
        }
        .main-nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.3s ease;
        }
        .main-nav ul li a:hover,
        .main-nav ul li a.active {
            background-color: #f7b32d; /* Updated: Yellow for hover/active */
        }
        /* Removed .logout-button styles as button is removed */

        /* Specific styles for modal/message box */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8; /* icealion-blue */
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8; /* icealion-blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Database Table specific styles */
        #databaseTableContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #databaseTableContainer th, #databaseTableContainer td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        #databaseTableContainer th {
            background-color: #eff6ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #databaseTableContainer tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        #databaseTableContainer tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        #databaseTableContainer td.actions {
            white-space: nowrap; /* Prevent buttons from wrapping */
        }
        #databaseTableContainer .delete-record-btn,
        .view-record-btn, .email-record-btn, .download-record-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin-right: 0.25rem; /* Space between buttons */
        }
        #databaseTableContainer .delete-record-btn {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        #databaseTableContainer .delete-record-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
        .view-record-btn {
            background-color: #2196f3; /* blue */
            color: white;
        }
        .view-record-btn:hover {
            background-color: #1976d2; /* darker blue */
        }
        .email-record-btn {
            background-color: #f57c00; /* orange */
            color: white;
        }
        .email-record-btn:hover {
            background-color: #e65100; /* darker orange */
        }
        .download-record-btn {
            background-color: #4caf50; /* green */
            color: white;
        }
        .download-record-btn:hover {
            background-color: #388e3c; /* darker green */
        }
        /* Style for webhook list */
        #webhookList div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f9ff; /* blue-50 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }
        #webhookList div span {
            font-size: 0.875rem;
            color: #1e40af; /* blue-800 */
        }
        /* Specific styles for message box content to allow pre-formatted text */
        .message-box-content-pre {
            text-align: left;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            font-family: 'Inter', monospace; /* Use a monospace font for data display */
            background-color: #f8f8f8;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 70vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid #e0e0e0;
            font-size: 0.875rem;
        }

        /* Specific style for remarks textarea to allow wrapping and auto-expand */
        .remarks-textarea {
            white-space: pre-wrap; /* Allows text to wrap and preserves spaces/line breaks */
            word-wrap: break-word; /* Breaks long words that don't fit */
            overflow-wrap: break-word; /* Ensures long words break to prevent overflow */
            resize: vertical; /* Allow vertical resizing only */
            overflow: hidden; /* Hide scrollbar initially */
            min-height: 40px; /* Matched with other inputs for consistency */
            padding: 10px; /* Matched with other inputs for consistency */
            font-size: 0.6875rem; /* Matched with other inputs for consistency */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        /* Styles for the new Monthly Evaluation Statistics Table */
        #monthlyStatsContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #monthlyStatsContainer th, #monthlyStatsContainer td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.75rem;
            text-align: center; /* Center align for counts */
            font-size: 0.875rem; /* text-sm */
        }
        #monthlyStatsContainer th {
            background-color: #eff6ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #monthlyStatsContainer tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        #monthlyStatsContainer tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* Conditional background colors for Total column */
        .total-red {
            background-color: #fca5a5; /* red-300 */
            color: #dc2626; /* red-700 */
            font-weight: bold;
        }
        .total-green {
            background-color: #a7f3d0; /* green-300 */
            color: #065f46; /* green-700 */
            font-weight: bold;
        }
        /* Removed login/access denied section styles */
        #accessSection { display: none; }
    </style>
</head>
<body>
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md hidden">OK</button>
            <div id="messageBoxConfirmButtons" class="flex justify-center space-x-4 hidden">
                <button id="messageBoxConfirmYesBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">Yes</button>
                <button id="messageBoxConfirmNoBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md">No</button>
            </div>
        </div>
    </div>

    <nav class="main-nav" id="mainNav">
        <ul>
            <li><a href="#" id="evaluationFormTab" class="active"><i class="fas fa-file-alt"></i> Evaluation Form</a></li>
            <li><a href="#" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
            <li><a href="reports.html" id="reportsTab"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="autofails.html" id="autofailsTab"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
            <li id="adminTabNav"><a href="admin.html" id="adminTab"><i class="fas fa-user-cog"></i> Admin</a></li>
        </ul>
        </nav>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-4xl mt-8 mb-8" id="evaluationFormContent" style="display: none;">
        <div class="icealion-blue p-4 flex items-center justify-between">
            <div class="text-xl font-semibold">Quality Assessment Form - ICEALION GROUP Contact Centre</div>
            <img src="https://placehold.co/120x40/1a73e8/FFFFFF?text=ICEALION" alt="ICEALION Logo" class="h-10 rounded-md">
        </div>

        <div class="p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            <div>
                <label for="contact-id" class="block text-sm font-medium text-gray-700">Contact ID</label>
                <input type="text" id="contact-id" name="Contact ID" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                <input type="text" id="client-name" name="Client Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="cer-name" class="block text-sm font-medium text-gray-700">CER Name</label>
                <select id="cer-name" name="CER Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
                    <option value="">Loading CER Names...</option>
                </select>
            </div>
                        <div>
                <label for="cer-email" class="block text-sm font-medium text-gray-700">CER Email</label>
                <input type="email" id="cer-email" name="CER Email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" readonly>
            </div>
            <div>
                <label for="cer-role" class="block text-sm font-medium text-gray-700">CER Role</label>
                <select id="cer-role" name="CER Role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
                    <option value="">Loading CER Roles...</option>
                </select>
            </div>
            <div>
                <label for="call-date-time" class="block text-sm font-medium text-gray-700">Call Date and Time</label>
                <input type="datetime-local" id="call-date-time" name="Call Date and Time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="reviewer-name" class="block text-sm font-medium text-gray-700">Reviewer's Name</label>
                <select id="reviewer-name" name="Reviewer's Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
                    <option value="">Loading Reviewer Names...</option>
                </select>
            </div>
            <div>
                <label for="autofail-type" class="block text-sm font-medium text-gray-700">Auto Fail Type</label>
                <select id="autofail-type" name="Auto Fail Type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input">
                    <option value="">Loading Autofail Types...</option>
                </select>
            </div>
            <div id="autofailDescriptionContainer" class="hidden">
                <label for="autofail-description" class="block text-sm font-medium text-gray-700">Autofail Description</label>
                <textarea id="autofail-description" name="Autofail Description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input remarks-textarea" placeholder="Provide details about the autofail"></textarea>
            </div>
            <div>
                <label for="review-date" class="block text-sm font-medium text-gray-700">Evaluation Date</label>
                <input type="date" id="review-date" name="Evaluation Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="duration" class="block text-sm font-medium text-gray-700">Call Duration</label>
                <input type="text" id="duration" name="Call Duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" placeholder="e.g., 30 mins">
            </div>
        </div>

        <div class="p-4 rounded-lg shadow-sm flex flex-col items-center justify-center space-y-2 bg-gray-50 mx-6 mb-4">
            <div class="text-sm font-medium text-gray-600">Scores:</div>
            <div class="flex justify-around w-full gap-2">
                <div class="flex-1 text-center bg-gray-50 p-2 rounded-md">
                    <div class="text-xs font-medium text-gray-600 mb-1">Overall Score</div>
                    <div class="text-xl font-bold text-blue-600" id="overall-score-display">0%</div>
                </div>
                <div class="flex-1 text-center bg-gray-50 p-2 rounded-md">
                    <div class="text-xs font-medium text-gray-600 mb-1">Business & Compliance Accuracy</div>
                    <div class="text-xl font-bold text-blue-600" id="business-compliance-accuracy">0%</div>
                </div>
            </div>
        </div>
        <form id="assessment-form">
            <div class="mt-4">
                <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2">
                    <i class="fas fa-user tile-icon"></i> CUSTOMER EXPERIENCE
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-12 gap-2 text-sm font-medium text-gray-700 mb-2">
                        <div class="col-span-6">Description</div>
                        <div class="col-span-2 text-center">Rating</div>
                        <div class="col-span-1 text-center">Weight</div>
                        <div class="col-span-1 text-center">Pnts</div>
                        <div class="col-span-2">Remarks</div>
                    </div>
                    <div id="cxQuestionsContainer">
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2">
                    <i class="fas fa-lightbulb tile-icon"></i> PROBLEM SOLVING SKILLS
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-12 gap-2 text-sm font-medium text-gray-700 mb-2">
                        <div class="col-span-6">Description</div>
                        <div class="col-span-2 text-center">Rating</div>
                        <div class="col-span-1 text-center">Weight</div>
                        <div class="col-span-1 text-center">Pnts</div>
                        <div class="col-span-2">Remarks</div>
                    </div>
                    <div id="psQuestionsContainer">
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2">
                    <i class="fas fa-check-circle tile-icon"></i> COMPLIANCE AND BUSINESS CRITICAL ACCURACY
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-12 gap-2 text-sm font-medium text-gray-700 mb-2">
                        <div class="col-span-6">Description</div>
                        <div class="col-span-2 text-center">Rating</div>
                        <div class="col-span-1 text-center">Weight</div>
                        <div class="col-span-1 text-center">Pnts</div>
                        <div class="col-span-2">Remarks</div>
                    </div>
                    <div id="caQuestionsContainer">
                    </div>
                </div>
            </div>
        </form>

        <div class="p-6 flex flex-col items-end">
                <table class="score-summary-table w-full md:w-1/2 lg:w-1/3 text-right text-sm border-collapse border border-blue-500">
                    <tbody>
                        <tr class="border-b border-blue-500">
                            <td class="text-left font-medium p-2 border border-blue-500">Total Pts.</td>
                            <td class="text-right text-gray-500 p-2 border border-blue-500" id="total-pts-percentage">0%</td>
                            </tr>
                        <tr class="border-b border-blue-500">
                            <td class="text-left font-medium p-2 border border-blue-500">Available Pts.</td>
                            <td class="text-right text-gray-500 p-2 border border-blue-500">100%</td>
                        </tr>
                        <tr>
                            <td class="text-left font-bold icealion-orange-text p-2 border border-blue-500">Overall Score</td>
                            <td class="text-right font-bold icealion-orange-text p-2 border border-blue-500" id="overall-final-percentage-display">0%</td>
                        </tr>
                    </tbody>
                </table>
                <div class="flex items-center justify-between w-full mt-4">
                    <img src="https://placehold.co/120x40/1a73e8/FFFFFF?text=ICEALION" alt="ICEALION Logo" class="h-10 rounded-md">
                    <div class="flex space-x-4">
                        <button type="button" id="print-email-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                            PDF & Email
                        </button>
                        <button type="submit" id="submitFormToDBBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                            Submit
                        </button>
                    </div>
                </div>
        </div>

        <div class="p-6">
            <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2 mb-4">
                <i class="fas fa-history tile-icon"></i> Last 3 Evaluations for Selected CER
            </div>
            <div id="lastEvaluationsContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">CER Name</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Overall Score</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">CER Role</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Contact ID</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Date</th>
                        </tr>
                    </thead>
                    <tbody id="lastEvaluationsTableBody">
                        <tr>
                            <td colspan="5" class="py-4 px-4 text-center text-gray-500">Select a CER Name to view their last evaluations.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-4xl mt-8 mb-8" id="monthlyStatsContainer" style="display: none;">
        <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2 mb-4">
            <i class="fas fa-chart-line tile-icon"></i> This Month Evaluation Statistics
        </div>
        <div class="p-6 overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-md">
                <thead>
                    <tr id="monthlyStatsHeader" class="bg-gray-100">
                        </tr>
                </thead>
                <tbody id="monthlyStatsTableBody">
                    <tr>
                        <td colspan="5" class="py-4 px-4 text-center text-gray-500">Loading monthly statistics...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-5xl mt-8 mb-8" id="databaseContent" style="display: none;">
        <div class="icealion-blue p-4 text-xl font-semibold text-center">
            Database Records
        </div>
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Submitted Records</h2>
                <div>
                    <button id="deleteSelectedRecordsBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-trash-alt mr-2"></i>Delete Selected
                    </button>
                </div>
            </div>

            <div id="databaseTableContainer" class="overflow-x-auto max-h-[60vh]">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="w-12"><input type="checkbox" id="selectAllRecordsCheckbox"></th>
                            <th class="w-24">Timestamp</th>
                            <th>Contact ID</th>
                            <th>Client Name</th>
                            <th>CER Name</th>
                            <th>Overall Score</th>
                            <th class="w-24">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-4 text-gray-500">No records found. Submit a form to see data here.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Webhook Management</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Add webhook URLs below. When new records are created, data will be sent to these webhooks.
                    **Note:** Sending data to external webhooks will depend on their server's CORS policy.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="url" id="newWebhookUrlInput" placeholder="Enter webhook URL (e.g., https://example.com/webhook)"
                            class="flex-1 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border form-grid-input">
                    <button id="addWebhookBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-plus mr-2"></i>Add Webhook
                    </button>
                </div>
                <div id="webhookList" class="border border-gray-300 p-4 rounded-md bg-gray-50 min-h-[100px]">
                    <p class="text-sm text-gray-500 text-center">No webhooks added yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        // Removed Firebase Auth imports
        // import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            deleteDoc,
            doc,
            onSnapshot,
            query,
            where,
            orderBy,
            limit,
            setDoc,
            getDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
        import html2pdf from 'https://cdn.skypack.dev/html2pdf';

        // Hardcoded Firebase Configuration for GitHub/local hosting
        // IMPORTANT: For production with sensitive data, use environment variables or a backend.
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs", // Your provided API key
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.appspot.com",
            messagingSenderId: "36737517178",
            appId: "1:36737517178:web:b1d8302061f5f2a11b6194",
            measurementId: "G-85662K43G5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM elements
        const cerNameSelect = document.getElementById('cer-name');
        const cerEmailInput = document.getElementById('cer-email');
        const reviewerNameSelect = document.getElementById('reviewer-name');
        const cerRoleSelect = document.getElementById('cer-role');
        const autofailTypeSelect = document.getElementById('autofail-type');
        const autofailDescriptionContainer = document.getElementById('autofailDescriptionContainer');
        const overallScoreDisplay = document.getElementById('overall-score-display');
        const businessComplianceAccuracyDisplay = document.getElementById('business-compliance-accuracy');
        const totalPtsPercentageDisplay = document.getElementById('total-pts-percentage');
        const overallFinalPercentageDisplay = document.getElementById('overall-final-percentage-display');
        const cxQuestionsContainer = document.getElementById('cxQuestionsContainer');
        const psQuestionsContainer = document.getElementById('psQuestionsContainer');
        const caQuestionsContainer = document.getElementById('caQuestionsContainer');
        const assessmentForm = document.getElementById('assessment-form');
        const submitFormToDBBtn = document.getElementById('submitFormToDBBtn');
        const printEmailBtn = document.getElementById('print-email-btn');
        const lastEvaluationsTableBody = document.getElementById('lastEvaluationsTableBody');
        const monthlyStatsTableBody = document.getElementById('monthlyStatsTableBody');
        const monthlyStatsHeader = document.getElementById('monthlyStatsHeader');
        const databaseTableBody = document.getElementById('recordsTableBody');
        const selectAllRecordsCheckbox = document.getElementById('selectAllRecordsCheckbox');
        const deleteSelectedRecordsBtn = document.getElementById('deleteSelectedRecordsBtn');

        // Modal/Message Box Elements
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxSpinner = document.getElementById('messageBoxSpinner');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');
        const messageBoxConfirmButtons = document.getElementById('messageBoxConfirmButtons');
        const messageBoxConfirmYesBtn = document.getElementById('messageBoxConfirmYesBtn');
        const messageBoxConfirmNoBtn = document.getElementById('messageBoxConfirmNoBtn');

        // Navigation Tabs
        const evaluationFormTab = document.getElementById('evaluationFormTab');
        const databaseTab = document.getElementById('databaseTab');
        const evaluationFormContent = document.getElementById('evaluationFormContent');
        const databaseContent = document.getElementById('databaseContent');
        const monthlyStatsContainer = document.getElementById('monthlyStatsContainer');
        const adminTabNav = document.getElementById('adminTabNav');
        
        // Webhook elements
        const newWebhookUrlInput = document.getElementById('newWebhookUrlInput');
        const addWebhookBtn = document.getElementById('addWebhookBtn');
        const webhookList = document.getElementById('webhookList');
        
        // Local storage keys
        const CER_NAMES_KEY = 'cerNames';
        const ROLES_KEY = 'cerRoles';
        const REVIEWERS_KEY = 'reviewers';
        const AUTOFAIL_TYPES_KEY = 'autofailTypes';
        const QUESTIONS_KEY = 'evaluationQuestions';
        const WEBHOOK_URLS_KEY = 'webhookUrls';
        
        // In-memory data caches
        let cerNamesCache = [];
        let reviewersCache = [];
        let rolesCache = [];
        let autofailTypesCache = [];
        let evaluationQuestions = { cx: [], ps: [], ca: [] };
        let allRecords = {}; // Cache for all records by ID
        
        // PDF variables
        let pdfContent;

        // --- Modal Functions ---
        function showMessage(title, content, type = 'alert', onConfirm = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.innerHTML = content;
            messageBoxOverlay.classList.remove('hidden');

            if (type === 'loading') {
                messageBoxSpinner.classList.remove('hidden');
                messageBoxCloseBtn.classList.add('hidden');
                messageBoxConfirmButtons.classList.add('hidden');
            } else if (type === 'confirm') {
                messageBoxSpinner.classList.add('hidden');
                messageBoxCloseBtn.classList.add('hidden');
                messageBoxConfirmButtons.classList.remove('hidden');
                messageBoxConfirmYesBtn.onclick = () => {
                    hideMessageBox();
                    if (onConfirm) onConfirm(true);
                };
                messageBoxConfirmNoBtn.onclick = () => {
                    hideMessageBox();
                    if (onConfirm) onConfirm(false);
                };
            } else {
                messageBoxSpinner.classList.add('hidden');
                messageBoxCloseBtn.classList.remove('hidden');
                messageBoxConfirmButtons.classList.add('hidden');
            }
        }

        function hideMessageBox() {
            messageBoxOverlay.classList.add('hidden');
            messageBoxContent.innerHTML = '';
        }

        messageBoxCloseBtn.addEventListener('click', hideMessageBox);

        // --- Data Fetching and Caching from Firebase ---

        async function fetchAndCacheCollection(collectionName, selectElement, valueField = 'name') {
            try {
                const querySnapshot = await getDocs(collection(db, collectionName));
                const data = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Cache data in a local variable
                switch (collectionName) {
                    case 'cer_names':
                        cerNamesCache = data;
                        break;
                    case 'cer_roles':
                        rolesCache = data;
                        break;
                    case 'reviewers':
                        reviewersCache = data;
                        break;
                    case 'autofail_types':
                        autofailTypesCache = data;
                        break;
                }

                // Populate the select element
                if (selectElement) {
                    selectElement.innerHTML = '<option value="">Select...</option>';
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueField];
                        option.textContent = item[valueField];
                        selectElement.appendChild(option);
                    });
                }

                console.log(`Fetched and cached ${collectionName}:`, data);
                return data;
            } catch (e) {
                console.error(`Error fetching ${collectionName}: `, e);
                showMessage('Error', `Failed to load ${collectionName.replace('_', ' ')}. Please check your connection.`);
                return [];
            }
        }
        
        async function fetchAndRenderQuestions() {
            try {
                const qSnapshot = await getDocs(collection(db, 'evaluation_questions'));
                if (qSnapshot.empty) {
                    console.warn("No evaluation questions found in Firestore.");
                    return;
                }
                
                evaluationQuestions = { cx: [], ps: [], ca: [] }; // Reset cache
                qSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (evaluationQuestions[data.category]) {
                        evaluationQuestions[data.category].push({ id: doc.id, ...data });
                    }
                });
                
                renderQuestions(evaluationQuestions.cx, cxQuestionsContainer, 'cx');
                renderQuestions(evaluationQuestions.ps, psQuestionsContainer, 'ps');
                renderQuestions(evaluationQuestions.ca, caQuestionsContainer, 'ca');

                console.log("Evaluation questions fetched and rendered:", evaluationQuestions);
            } catch (e) {
                console.error("Error fetching evaluation questions:", e);
                showMessage('Error', 'Failed to load evaluation questions. Please contact support.');
            }
        }
        
        // --- Rendering Functions ---
        function renderQuestions(questions, container, category) {
            if (!container) return;
            container.innerHTML = '';
            questions.forEach((q, index) => {
                const rowClass = index % 2 === 0 ? 'form-row-light' : 'form-row-dark';
                const questionId = `${category}-${q.id}`;
                
                const row = document.createElement('div');
                row.className = `grid grid-cols-12 gap-2 p-2 items-center rounded-md ${rowClass}`;
                row.innerHTML = `
                    <div class="col-span-6 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs icon-bg-blue">Q${index + 1}</div>
                        <div class="question-description-text">${q.description}</div>
                    </div>
                    <div class="col-span-2">
                        <select name="rating" data-weight="${q.weightage}" data-category="${category}" data-question-id="${questionId}"
                            class="w-full border rounded-md p-1 text-center bg-white rating-select">
                            <option value="N/A">N/A</option>
                            <option value="100">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                    <div class="col-span-1 text-center weightage-display">${q.weightage}%</div>
                    <div class="col-span-1">
                        <input type="text" name="points" value="0" readonly
                            class="w-full border rounded-md p-1 text-center bg-gray-200 points-input">
                    </div>
                    <div class="col-span-2">
                        <textarea name="remarks" rows="1" placeholder="Remarks" data-question-id="${questionId}"
                            class="w-full border rounded-md p-1 remarks-textarea"></textarea>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Attach event listeners after rendering
            container.querySelectorAll('.rating-select').forEach(select => {
                select.addEventListener('change', calculateScores);
            });
            container.querySelectorAll('.remarks-textarea').forEach(textarea => {
                textarea.addEventListener('input', autoExpandTextarea);
            });
        }
        
        // --- Score Calculation ---
        function calculateScores() {
            let totalWeightedPoints = 0;
            let totalPossiblePoints = 0;
            let totalCACheckedPoints = 0;
            let totalCAPossiblePoints = 0;
            let isAutofail = autofailTypeSelect.value !== "";
            
            document.querySelectorAll('.rating-select').forEach(select => {
                const weight = parseInt(select.dataset.weight, 10);
                const rating = select.value;
                const category = select.dataset.category;
                const pointsInput = select.closest('.grid').querySelector('.points-input');
                
                let points = 0;
                
                if (rating !== 'N/A') {
                    totalPossiblePoints += weight;
                    if (category === 'ca') {
                        totalCAPossiblePoints += weight;
                    }
                    
                    if (rating === '100') {
                        points = weight;
                        if (category === 'ca') {
                            totalCACheckedPoints += weight;
                        }
                    }
                }
                
                pointsInput.value = points;
                totalWeightedPoints += points;
            });
            
            // Check if all questions have been answered before calculating the score
            const allQuestionsCount = evaluationQuestions.cx.length + evaluationQuestions.ps.length + evaluationQuestions.ca.length;
            const answeredQuestionsCount = document.querySelectorAll('.rating-select').length;
            
            // Calculate Overall Score
            let overallScore = 0;
            if (totalPossiblePoints > 0) {
                overallScore = (totalWeightedPoints / totalPossiblePoints) * 100;
            }
            
            // Calculate Business & Compliance Accuracy Score
            let caScore = 0;
            if (totalCAPossiblePoints > 0) {
                caScore = (totalCACheckedPoints / totalCAPossiblePoints) * 100;
            }
            
            // Apply Autofail logic
            if (isAutofail) {
                overallScore = 0;
            }
            
            overallScoreDisplay.textContent = `${overallScore.toFixed(0)}%`;
            overallFinalPercentageDisplay.textContent = `${overallScore.toFixed(0)}%`;
            totalPtsPercentageDisplay.textContent = `${totalWeightedPoints.toFixed(0)}%`;
            businessComplianceAccuracyDisplay.textContent = `${caScore.toFixed(0)}%`;
        }
        
        // --- Event Listeners for Form and UI ---
        
        // Auto-expand textarea
        function autoExpandTextarea(e) {
            const textarea = e.target;
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        // Autofail dropdown change listener
        autofailTypeSelect.addEventListener('change', () => {
            if (autofailTypeSelect.value !== '') {
                autofailDescriptionContainer.classList.remove('hidden');
                // Force score to 0 on autofail
                overallScoreDisplay.textContent = '0%';
                overallFinalPercentageDisplay.textContent = '0%';
            } else {
                autofailDescriptionContainer.classList.add('hidden');
                // Recalculate score if autofail is removed
                calculateScores();
            }
        });
        
        // Handle CER Name selection to populate CER Role and Last Evaluations
        cerNameSelect.addEventListener('change', async (e) => {
            const selectedCerName = e.target.value;
            lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Loading last evaluations...</td></tr>';
            
            // Find the selected CER's data in the cache
            const selectedCer = cerNamesCache.find(cer => cer.name === selectedCerName);
            
            if (selectedCer) {
                // Populate CER Role
                cerRoleSelect.value = selectedCer.role || '';
                // Populate CER Email
                cerEmailInput.value = selectedCer.email || '';
                await fetchAndRenderLastEvaluations(selectedCerName);
            } else {
                cerRoleSelect.value = '';
                cerEmailInput.value = '';
                lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Select a CER Name to view their last evaluations.</td></tr>';
            }
        });
        
        async function fetchAndRenderLastEvaluations(cerName) {
            try {
                const q = query(
                    collection(db, 'evaluation_records'),
                    where('cerName', '==', cerName),
                    orderBy('timestamp', 'desc'),
                    limit(3)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No past evaluations found for this CER.</td></tr>';
                    return;
                }
                
                lastEvaluationsTableBody.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.reviewDate ? data.reviewDate : new Date(data.timestamp).toLocaleDateString();
                    
                    const row = `
                        <tr class="text-xs">
                            <td class="py-2 px-4 border-b">${data.cerName}</td>
                            <td class="py-2 px-4 border-b font-semibold">${data.overallScore}%</td>
                            <td class="py-2 px-4 border-b">${data.cerRole}</td>
                            <td class="py-2 px-4 border-b">${data.contactId}</td>
                            <td class="py-2 px-4 border-b">${date}</td>
                        </tr>
                    `;
                    lastEvaluationsTableBody.innerHTML += row;
                });
            } catch (e) {
                console.error("Error fetching last evaluations:", e);
                lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Failed to load data.</td></tr>';
            }
        }
        
        // --- Form Submission and Data Handling ---
        
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Basic form validation
            const requiredFields = ['contact-id', 'client-name', 'cer-name', 'cer-role', 'call-date-time', 'reviewer-name', 'review-date'];
            let isValid = true;
            requiredFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (!input.value) {
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input.classList.remove('border-red-500');
                }
            });
            
            if (!isValid) {
                showMessage('Validation Error', 'Please fill in all required fields (marked with red).');
                return;
            }
            
            showMessage('Submitting...', 'Please wait, your evaluation is being saved...', 'loading');
            
            const formData = new FormData(assessmentForm);
            const data = {
                timestamp: new Date().toISOString(),
                overallScore: parseFloat(overallFinalPercentageDisplay.textContent),
                businessComplianceAccuracy: parseFloat(businessComplianceAccuracyDisplay.textContent),
                totalPoints: parseFloat(totalPtsPercentageDisplay.textContent),
                autofailType: autofailTypeSelect.value,
                autofailDescription: document.getElementById('autofail-description').value,
                // Capture the form header fields
                contactId: formData.get('Contact ID'),
                clientName: formData.get('Client Name'),
                cerName: formData.get('CER Name'),
                cerEmail: formData.get('CER Email'),
                cerRole: formData.get('CER Role'),
                callDateTime: formData.get('Call Date and Time'),
                reviewerName: formData.get('Reviewer\'s Name'),
                reviewDate: formData.get('Evaluation Date'),
                callDuration: formData.get('Call Duration'),
                questions: {}
            };
            
            // Capture question data
            document.querySelectorAll('.rating-select').forEach(select => {
                const questionRow = select.closest('.grid');
                const questionId = select.dataset.questionId;
                const description = questionRow.querySelector('.question-description-text').textContent;
                const rating = select.value;
                const weight = parseInt(select.dataset.weight, 10);
                const points = parseFloat(questionRow.querySelector('.points-input').value);
                const remarks = questionRow.querySelector('.remarks-textarea').value;
                const category = select.dataset.category;
                
                if (!data.questions[category]) {
                    data.questions[category] = [];
                }
                
                data.questions[category].push({
                    id: questionId,
                    description: description,
                    rating: rating,
                    weight: weight,
                    points: points,
                    remarks: remarks
                });
            });
            
            try {
                // Add a new document with a generated ID
                const docRef = await addDoc(collection(db, "evaluation_records"), data);
                console.log("Document written with ID: ", docRef.id);
                
                // Send data to webhooks
                await sendToWebhooks(data);
                
                // Show success message and clear form
                showMessage('Success!', 'Evaluation submitted successfully!');
                assessmentForm.reset();
                calculateScores(); // Reset scores display
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('Error', 'Failed to submit evaluation. Please try again.');
            }
        }
        
        assessmentForm.addEventListener('submit', handleSubmit);
        submitFormToDBBtn.addEventListener('click', handleSubmit);

        // --- PDF Generation ---
        
        // Helper function to convert form inputs to display-only divs for PDF
        function prepareForPdf() {
            const elements = document.querySelectorAll('.form-grid-input, .rating-select, .points-input, .remarks-textarea');
            
            elements.forEach(el => {
                let value = el.value;
                if (el.tagName === 'SELECT' && el.options.length > 0) {
                    value = el.options[el.selectedIndex].text;
                }
                
                const displayDiv = document.createElement('div');
                displayDiv.className = 'pdf-display-value';
                displayDiv.textContent = value || 'N/A';
                
                el.parentNode.insertBefore(displayDiv, el);
                el.style.display = 'none'; // Hide the original input
                displayDiv.style.display = 'block'; // Show the new div
            });
            
            // Replace live score displays with static values
            const scoreDisplays = [overallScoreDisplay, businessComplianceAccuracyDisplay, totalPtsPercentageDisplay, overallFinalPercentageDisplay];
            scoreDisplays.forEach(el => {
                el.setAttribute('data-original-text', el.textContent);
                el.textContent = el.textContent; // Set the current value as a static text
            });
        }

        // Helper function to restore the form after PDF generation
        function restoreForm() {
            document.querySelectorAll('.pdf-display-value').forEach(div => {
                const originalInput = div.nextElementSibling;
                originalInput.style.display = ''; // Restore original input display
                div.remove(); // Remove the display div
            });

            // Restore live score displays
            const scoreDisplays = [overallScoreDisplay, businessComplianceAccuracyDisplay, totalPtsPercentageDisplay, overallFinalPercentageDisplay];
            scoreDisplays.forEach(el => {
                const originalText = el.getAttribute('data-original-text');
                if (originalText) {
                    el.textContent = originalText;
                    el.removeAttribute('data-original-text');
                }
            });
        }

        printEmailBtn.addEventListener('click', () => {
            const cerEmail = document.getElementById('cer-email').value;
            if (!cerEmail) {
                showMessage('Error', 'Please select a CER Name to automatically populate the email address before generating the PDF.');
                return;
            }

            const overallScore = parseFloat(overallFinalPercentageDisplay.textContent);
            const threshold = 80;
            
            if (overallScore < threshold) {
                showMessage(
                    'Score Below Threshold',
                    `The overall score is ${overallScore.toFixed(0)}%, which is below the 80% threshold. Do you still want to generate and send the PDF?`,
                    'confirm',
                    (confirmed) => {
                        if (confirmed) {
                            generatePdfAndEmail(cerEmail);
                        }
                    }
                );
            } else {
                generatePdfAndEmail(cerEmail);
            }
        });

        function generatePdfAndEmail(cerEmail) {
            showMessage('Generating PDF...', 'Please wait while the PDF is being created.', 'loading');
            
            // Prepare the form for PDF export
            prepareForPdf();
            
            const element = document.getElementById('evaluationFormContent');
            
            // Use html2pdf to generate the PDF
            html2pdf().from(element).set({
                margin: 1,
                filename: `QA_Evaluation_${document.getElementById('contact-id').value}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            }).toPdf().get('pdf').then(function (pdf) {
                // Store the PDF object
                pdfContent = pdf.output('blob');
                
                // Immediately restore the form display
                restoreForm();
                hideMessageBox();
                
                // Ask the user if they want to email the PDF
                showMessage(
                    'PDF Ready',
                    `The PDF has been generated successfully. Do you want to email it to **${cerEmail}**?`,
                    'confirm',
                    (confirmed) => {
                        if (confirmed) {
                            emailPdf(cerEmail);
                        } else {
                            pdf.save(`QA_Evaluation_${document.getElementById('contact-id').value}.pdf`);
                        }
                    }
                );
            }).catch(error => {
                console.error('Error generating PDF:', error);
                showMessage('Error', 'Failed to generate PDF. Please try again.');
                restoreForm();
            });
        }

        function emailPdf(emailAddress) {
            // Check if a PDF has been generated
            if (!pdfContent) {
                showMessage('Error', 'No PDF to email. Please generate it first.');
                return;
            }
            
            const subject = `QA Evaluation for Contact ID: ${document.getElementById('contact-id').value}`;
            const body = `Dear ${document.getElementById('cer-name').value},\n\nPlease find attached your Quality Assessment evaluation form for contact ID ${document.getElementById('contact-id').value}.\n\nReviewer: ${document.getElementById('reviewer-name').value}\nDate: ${document.getElementById('review-date').value}\nOverall Score: ${overallFinalPercentageDisplay.textContent}\n\nBest regards,\nICEA LION QA Team`;
            
            const mailtoUrl = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // This will open the user's default email client
            window.location.href = mailtoUrl;
            
            // Note: Attaching a file is not possible directly with mailto: links for security reasons.
            // The user will need to manually attach the downloaded PDF.
            showMessage('Email Client Opened', 'Your email client has been opened. Please attach the downloaded PDF to the email and send it.');
        }
        
        // --- Database Tab Functions ---
        
        let recordsListener = null; // Variable to hold the listener
        
        function setupRealtimeRecordsListener() {
            // Detach previous listener if it exists
            if (recordsListener) {
                recordsListener(); // Call the unsubscribe function
                console.log("Detached previous realtime listener.");
            }
            
            const q = query(collection(db, 'evaluation_records'), orderBy('timestamp', 'desc'));
            
            recordsListener = onSnapshot(q, (querySnapshot) => {
                allRecords = {}; // Reset cache
                databaseTableBody.innerHTML = ''; // Clear table
                
                if (querySnapshot.empty) {
                    databaseTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">No records found. Submit a form to see data here.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    const record = { id: doc.id, ...doc.data() };
                    allRecords[doc.id] = record; // Cache the record
                    
                    const date = record.timestamp ? new Date(record.timestamp).toLocaleString() : 'N/A';
                    
                    const row = `
                        <tr class="hover:bg-gray-50 text-xs">
                            <td class="py-2 px-4 border-b"><input type="checkbox" data-record-id="${record.id}" class="record-checkbox"></td>
                            <td class="py-2 px-4 border-b">${date}</td>
                            <td class="py-2 px-4 border-b">${record.contactId || 'N/A'}</td>
                            <td class="py-2 px-4 border-b">${record.clientName || 'N/A'}</td>
                            <td class="py-2 px-4 border-b">${record.cerName || 'N/A'}</td>
                            <td class="py-2 px-4 border-b font-bold">${record.overallScore !== undefined ? record.overallScore + '%' : 'N/A'}</td>
                            <td class="py-2 px-4 border-b actions">
                                <button class="view-record-btn" data-id="${record.id}"><i class="fas fa-eye"></i></button>
                                <button class="email-record-btn" data-id="${record.id}"><i class="fas fa-envelope"></i></button>
                                <button class="download-record-btn" data-id="${record.id}"><i class="fas fa-download"></i></button>
                                <button class="delete-record-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    databaseTableBody.innerHTML += row;
                });
                
                // Add event listeners to the new buttons
                addRecordActionListeners();
                
                // Reset select all checkbox and delete button state
                selectAllRecordsCheckbox.checked = false;
                deleteSelectedRecordsBtn.disabled = true;
            });
        }
        
        function addRecordActionListeners() {
            document.querySelectorAll('.view-record-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.id;
                    viewRecord(recordId);
                });
            });

            document.querySelectorAll('.email-record-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.id;
                    emailRecord(recordId);
                });
            });

            document.querySelectorAll('.download-record-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.id;
                    downloadRecord(recordId);
                });
            });

            document.querySelectorAll('.delete-record-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.dataset.id;
                    confirmDeleteRecord(recordId);
                });
            });
            
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteSelectedButtonState);
            });
        }
        
        selectAllRecordsCheckbox.addEventListener('change', () => {
            const isChecked = selectAllRecordsCheckbox.checked;
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateDeleteSelectedButtonState();
        });
        
        deleteSelectedRecordsBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.record-checkbox:checked'))
                .map(cb => cb.dataset.recordId);
            
            if (selectedIds.length > 0) {
                confirmDeleteRecord(selectedIds);
            }
        });
        
        function updateDeleteSelectedButtonState() {
            const selectedCount = document.querySelectorAll('.record-checkbox:checked').length;
            deleteSelectedRecordsBtn.disabled = selectedCount === 0;
        }

        function viewRecord(recordId) {
            const record = allRecords[recordId];
            if (!record) {
                showMessage('Error', 'Record not found.');
                return;
            }
            
            // Format the data for display in the modal
            let content = `<div class="message-box-content-pre">`;
            content += `<strong>Contact ID:</strong> ${record.contactId || 'N/A'}\n`;
            content += `<strong>Client Name:</strong> ${record.clientName || 'N/A'}\n`;
            content += `<strong>CER Name:</strong> ${record.cerName || 'N/A'}\n`;
            content += `<strong>CER Email:</strong> ${record.cerEmail || 'N/A'}\n`;
            content += `<strong>CER Role:</strong> ${record.cerRole || 'N/A'}\n`;
            content += `<strong>Call Date:</strong> ${record.callDateTime ? new Date(record.callDateTime).toLocaleString() : 'N/A'}\n`;
            content += `<strong>Reviewer:</strong> ${record.reviewerName || 'N/A'}\n`;
            content += `<strong>Evaluation Date:</strong> ${record.reviewDate || 'N/A'}\n`;
            content += `<strong>Call Duration:</strong> ${record.callDuration || 'N/A'}\n\n`;
            
            content += `<strong>Overall Score:</strong> ${record.overallScore !== undefined ? record.overallScore + '%' : 'N/A'}\n`;
            content += `<strong>Business & Compliance Accuracy:</strong> ${record.businessComplianceAccuracy !== undefined ? record.businessComplianceAccuracy + '%' : 'N/A'}\n`;
            content += `<strong>Autofail Type:</strong> ${record.autofailType || 'None'}\n`;
            if (record.autofailDescription) {
                content += `<strong>Autofail Description:</strong> ${record.autofailDescription}\n`;
            }
            
            content += `\n--- QUESTIONS ---\n\n`;
            
            // Dynamically add questions
            if (record.questions) {
                for (const category in record.questions) {
                    content += `\n<strong>${category.toUpperCase()} CATEGORY:</strong>\n`;
                    record.questions[category].forEach(q => {
                        content += `\n- <strong>${q.description}:</strong>\n`;
                        content += `  Rating: ${q.rating}, Points: ${q.points}/${q.weight}\n`;
                        if (q.remarks) {
                            content += `  Remarks: ${q.remarks}\n`;
                        }
                    });
                }
            }
            
            content += `</div>`;
            showMessage(`Record Details (ID: ${record.id})`, content);
        }
        
        function emailRecord(recordId) {
            const record = allRecords[recordId];
            if (!record) {
                showMessage('Error', 'Record not found.');
                return;
            }
            
            const emailAddress = record.cerEmail;
            if (!emailAddress) {
                showMessage('Error', 'No email address found for this CER. Please add one in the admin panel.');
                return;
            }
            
            const subject = `QA Evaluation Summary for Contact ID: ${record.contactId}`;
            let body = `Dear ${record.cerName},\n\nHere is a summary of your recent Quality Assessment for Contact ID: ${record.contactId}.\n\n`;
            body += `Overall Score: ${record.overallScore !== undefined ? record.overallScore + '%' : 'N/A'}\n`;
            body += `Evaluation Date: ${record.reviewDate || 'N/A'}\n`;
            body += `Reviewer: ${record.reviewerName || 'N/A'}\n\n`;
            
            body += `Breakdown:\n`;
            if (record.questions) {
                for (const category in record.questions) {
                    body += `--- ${category.toUpperCase()} ---\n`;
                    record.questions[category].forEach(q => {
                        body += `- ${q.description}: ${q.rating} (${q.points}/${q.weight} points)\n`;
                        if (q.remarks) {
                            body += `  Remarks: ${q.remarks}\n`;
                        }
                    });
                }
            }
            body += `\nBest regards,\nICEA LION QA Team`;
            
            const mailtoUrl = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
        }

        function downloadRecord(recordId) {
            const record = allRecords[recordId];
            if (!record) {
                showMessage('Error', 'Record not found.');
                return;
            }
            
            // Create a JSON blob from the record data
            const blob = new Blob([JSON.stringify(record, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create a link element to trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = `QA_Record_${record.contactId}_${record.id}.json`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function confirmDeleteRecord(recordIds) {
            const idsToDelete = Array.isArray(recordIds) ? recordIds : [recordIds];
            const isBulk = idsToDelete.length > 1;
            
            const title = isBulk ? `Delete ${idsToDelete.length} Records` : 'Delete Record';
            const content = isBulk 
                ? `Are you sure you want to delete the selected ${idsToDelete.length} records? This action cannot be undone.`
                : 'Are you sure you want to delete this record? This action cannot be undone.';
            
            showMessage(title, content, 'confirm', (confirmed) => {
                if (confirmed) {
                    deleteRecords(idsToDelete);
                }
            });
        }
        
        async function deleteRecords(recordIds) {
            showMessage('Deleting...', 'Deleting selected records...', 'loading');
            try {
                const deletePromises = recordIds.map(id => deleteDoc(doc(db, 'evaluation_records', id)));
                await Promise.all(deletePromises);
                
                hideMessageBox();
                showMessage('Success', `Successfully deleted ${recordIds.length} record(s).`);
                
                // The realtime listener will automatically update the table, no need to re-render manually
            } catch (error) {
                console.error('Error deleting records:', error);
                showMessage('Error', 'Failed to delete records. Please try again.');
            }
        }
        
        // --- Webhook Functions ---
        
        async function fetchWebhooks() {
            try {
                const docRef = doc(db, 'settings', WEBHOOK_URLS_KEY);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().urls || [];
                } else {
                    return [];
                }
            } catch (e) {
                console.error("Error fetching webhooks: ", e);
                return [];
            }
        }

        async function saveWebhooks(urls) {
            try {
                const docRef = doc(db, 'settings', WEBHOOK_URLS_KEY);
                await setDoc(docRef, { urls: urls });
                console.log("Webhooks saved successfully.");
            } catch (e) {
                console.error("Error saving webhooks: ", e);
                showMessage('Error', 'Failed to save webhook URL. Please try again.');
            }
        }
        
        async function renderWebhooks() {
            const urls = await fetchWebhooks();
            webhookList.innerHTML = '';
            if (urls.length === 0) {
                webhookList.innerHTML = '<p class="text-sm text-gray-500 text-center">No webhooks added yet.</p>';
                return;
            }
            urls.forEach(url => {
                const webhookDiv = document.createElement('div');
                webhookDiv.innerHTML = `
                    <span>${url}</span>
                    <button class="text-red-600 hover:text-red-800" data-url="${url}"><i class="fas fa-times"></i></button>
                `;
                webhookList.appendChild(webhookDiv);
            });
            
            webhookList.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const urlToRemove = e.currentTarget.dataset.url;
                    const urls = await fetchWebhooks();
                    const updatedUrls = urls.filter(url => url !== urlToRemove);
                    await saveWebhooks(updatedUrls);
                    renderWebhooks();
                });
            });
        }
        
        addWebhookBtn.addEventListener('click', async () => {
            const newUrl = newWebhookUrlInput.value;
            if (newUrl && newUrl.startsWith('http')) {
                const urls = await fetchWebhooks();
                if (!urls.includes(newUrl)) {
                    urls.push(newUrl);
                    await saveWebhooks(urls);
                    newWebhookUrlInput.value = '';
                    renderWebhooks();
                    showMessage('Success', 'Webhook added successfully.');
                } else {
                    showMessage('Error', 'This webhook URL already exists.');
                }
            } else {
                showMessage('Error', 'Please enter a valid URL starting with http:// or https://');
            }
        });

        async function sendToWebhooks(data) {
            const urls = await fetchWebhooks();
            if (urls.length === 0) {
                console.log("No webhooks configured to send data.");
                return;
            }
            
            const payload = JSON.stringify(data);
            
            urls.forEach(url => {
                fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', // Use 'no-cors' to avoid CORS errors on the client side
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: payload,
                }).then(() => {
                    console.log(`Payload sent to webhook: ${url}`);
                }).catch(error => {
                    console.error(`Failed to send payload to webhook ${url}:`, error);
                });
            });
        }
        
        // --- Monthly Stats Functions ---
        
        async function fetchAndRenderMonthlyStats() {
            try {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
                
                const q = query(
                    collection(db, 'evaluation_records'),
                    where('timestamp', '>=', firstDayOfMonth.toISOString()),
                    where('timestamp', '<=', lastDayOfMonth.toISOString())
                );
                
                const querySnapshot = await getDocs(q);
                
                const stats = {};
                let totalEvaluations = 0;
                
                querySnapshot.forEach(doc => {
                    const record = doc.data();
                    const cerName = record.cerName || 'Unassigned';
                    const overallScore = record.overallScore !== undefined ? record.overallScore : 0;
                    
                    if (!stats[cerName]) {
                        stats[cerName] = { count: 0, totalScore: 0, autofails: 0, passes: 0 };
                    }
                    
                    stats[cerName].count++;
                    stats[cerName].totalScore += overallScore;
                    totalEvaluations++;
                    
                    if (record.autofailType && record.autofailType !== '') {
                        stats[cerName].autofails++;
                    } else if (overallScore >= 80) { // Assuming 80% is the passing threshold
                        stats[cerName].passes++;
                    }
                });
                
                // Render the table header
                monthlyStatsHeader.innerHTML = `
                    <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">CER Name</th>
                    <th class="py-2 px-4 border-b text-sm font-medium text-gray-600">Avg. Score</th>
                    <th class="py-2 px-4 border-b text-sm font-medium text-gray-600">Passes</th>
                    <th class="py-2 px-4 border-b text-sm font-medium text-gray-600">Autofails</th>
                    <th class="py-2 px-4 border-b text-sm font-medium text-gray-600">Total</th>
                `;
                
                monthlyStatsTableBody.innerHTML = '';
                if (Object.keys(stats).length === 0) {
                    monthlyStatsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No evaluations this month.</td></tr>';
                } else {
                    for (const cerName in stats) {
                        const cerStats = stats[cerName];
                        const avgScore = (cerStats.totalScore / cerStats.count).toFixed(1);
                        const totalClass = avgScore < 80 ? 'total-red' : 'total-green';
                        
                        const row = `
                            <tr class="text-xs">
                                <td class="py-2 px-4 border-b text-left font-medium">${cerName}</td>
                                <td class="py-2 px-4 border-b">${avgScore}%</td>
                                <td class="py-2 px-4 border-b">${cerStats.passes}</td>
                                <td class="py-2 px-4 border-b">${cerStats.autofails}</td>
                                <td class="py-2 px-4 border-b ${totalClass}">${cerStats.count}</td>
                            </tr>
                        `;
                        monthlyStatsTableBody.innerHTML += row;
                    }
                }
            } catch (e) {
                console.error("Error fetching monthly stats:", e);
                monthlyStatsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Failed to load statistics.</td></tr>';
            }
        }
        
        // --- Tab Navigation ---
        
        function showTab(tabId) {
            // Hide all content containers
            document.querySelectorAll('.container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.main-nav ul li a').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show the selected container and activate the tab
            if (tabId === 'evaluationFormContent') {
                evaluationFormContent.style.display = 'block';
                evaluationFormTab.classList.add('active');
                monthlyStatsContainer.style.display = 'block'; // Always show stats on form tab
            } else if (tabId === 'databaseContent') {
                databaseContent.style.display = 'block';
                databaseTab.classList.add('active');
                setupRealtimeRecordsListener(); // Start listener when tab is active
                renderWebhooks(); // Render webhooks list
            }
        }
        
        evaluationFormTab.addEventListener('click', (e) => {
            e.preventDefault();
            showTab('evaluationFormContent');
        });
        
        databaseTab.addEventListener('click', (e) => {
            e.preventDefault();
            showTab('databaseContent');
        });
        
        // Initial data load and view setup
        async function initialize() {
            // Fetch and populate all dropdowns and questions
            await fetchAndCacheCollection('cer_names', cerNameSelect, 'name');
            await fetchAndCacheCollection('cer_roles', cerRoleSelect);
            await fetchAndCacheCollection('reviewers', reviewerNameSelect);
            await fetchAndCacheCollection('autofail_types', autofailTypeSelect);
            await fetchAndRenderQuestions();
            await fetchAndRenderMonthlyStats();
            
            // Show the evaluation form by default
            showTab('evaluationFormContent');
            
            // Set today's date for the review date field
            document.getElementById('review-date').valueAsDate = new Date();
            
            // Calculate initial scores
            calculateScores();
        }
        
        // Run initialization when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
