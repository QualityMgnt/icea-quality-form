<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICEA LION QA Audit Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles */
        .error-message {
            color: #dc2626; /* red-700 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }

        /* Section Headers */
        .section-header-bg {
            background-color: #1a73e8;
            color: white;
        }
        /* Icon backgrounds for questions */
        .icon-bg-orange { background-color: #f57c00; }
        .icon-bg-blue { background-color: #2196f3; }
        .icon-bg-green { background-color: #4caf50; }
        .icon-bg-yellow { background-color: #ffc107; }

        /* Form Row Styling (zebra striping) */
        .form-row-light { background-color: #f9fafb; /* gray-50 */ }
        .form-row-dark { background-color: #edf2f7; /* gray-200 */ }

        /* General input styling for consistency (Other fields: size 11, not bold) */
        /* Increased padding and height for textboxes and dropdowns */
        .form-grid-input,
        .rating-select,
        .points-input {
            padding: 10px; /* Increased padding */
            font-size: 0.6875rem; /* Equivalent to 11px (0.6875 * 16 = 11) */
            font-weight: normal; /* Not bold */
            min-height: 40px; /* Increased minimum height for single-line inputs/selects */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        /* Field Labels: Size 11 and Bold */
        .block.text-sm.font-medium.text-gray-700 {
            font-size: 0.6875rem; /* Equivalent to 11px */
            font-weight: bold;
        }

        /* Weightage: Size 11 and Bold */
        .weightage-display {
            font-size: 0.6875rem; /* Equivalent to 11px */
            font-weight: bold;
        }

        /* Question Description Text: Size 11 and Bold */
        .question-description-text {
            font-size: 0.6875rem; /* Equivalent to 11px */
            font-weight: bold;
        }

        /* Style for temporary display elements during PDF capture */
        .pdf-display-value {
            font-size: 0.6875rem; /* Match general input font size (11px) */
            padding: 10px; /* Match increased padding */
            display: block; /* Ensure it takes full width of its container */
            color: #333; /* Darker text for readability */
            background-color: #fff;
            border: 1px solid #e2e8f0; /* Light gray border */
            border-radius: 0.375rem; /* Rounded corners */
            min-height: 40px; /* Match new input/select min-height */
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            white-space: pre-wrap; /* For textareas and wrapping text */
            word-wrap: break-word;
            overflow-wrap: break-word; /* Ensure long words break */
            font-weight: normal; /* Ensure not bold for the displayed value */
            display: none; /* Keep hidden by default, visible during PDF capture */
        }

        /* Navigation styles */
        .main-nav {
            width: 100%;
            background-color: #0d47a1; /* Updated: Dark blue */
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .main-nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .main-nav ul li {
            margin-right: 1.5rem;
        }
        .main-nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.3s ease;
        }
        .main-nav ul li a:hover,
        .main-nav ul li a.active {
            background-color: #f7b32d; /* Updated: Yellow for hover/active */
        }
        .logout-button {
            background-color: #f57c00; /* icealion-orange */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background-color: #e65100; /* darker orange */
        }

        /* Specific styles for modal/message box */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8; /* icealion-blue */
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8; /* icealion-blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Database Table specific styles */
        #databaseTableContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #databaseTableContainer th, #databaseTableContainer td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        #databaseTableContainer th {
            background-color: #eff6ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            position: sticky; /* Keep headers visible on scroll */
            top: 0;
            z-index: 10;
        }
        #databaseTableContainer tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        #databaseTableContainer tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        #databaseTableContainer td.actions {
            white-space: nowrap; /* Prevent buttons from wrapping */
        }
        #databaseTableContainer .delete-record-btn,
        .view-record-btn, .email-record-btn, .download-record-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin-right: 0.25rem; /* Space between buttons */
        }
        #databaseTableContainer .delete-record-btn {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        #databaseTableContainer .delete-record-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
        .view-record-btn {
            background-color: #2196f3; /* blue */
            color: white;
        }
        .view-record-btn:hover {
            background-color: #1976d2; /* darker blue */
        }
        .email-record-btn {
            background-color: #f57c00; /* orange */
            color: white;
        }
        .email-record-btn:hover {
            background-color: #e65100; /* darker orange */
        }
        .download-record-btn {
            background-color: #4caf50; /* green */
            color: white;
        }
        .download-record-btn:hover {
            background-color: #388e3c; /* darker green */
        }
        /* Style for webhook list */
        #webhookList div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f9ff; /* blue-50 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }
        #webhookList div span {
            font-size: 0.875rem;
            color: #1e40af; /* blue-800 */
        }
        /* Specific styles for message box content to allow pre-formatted text */
        .message-box-content-pre {
            text-align: left;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            font-family: 'Inter', monospace; /* Use a monospace font for data display */
            background-color: #f8f8f8;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 70vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid #e0e0e0;
            font-size: 0.875rem;
        }

        /* Specific style for remarks textarea to allow wrapping and auto-expand */
        .remarks-textarea {
            white-space: pre-wrap; /* Allows text to wrap and preserves spaces/line breaks */
            word-wrap: break-word; /* Breaks long words that don't fit */
            overflow-wrap: break-word; /* Ensures long words break to prevent overflow */
            resize: vertical; /* Allow vertical resizing only */
            overflow: hidden; /* Hide scrollbar initially */
            min-height: 40px; /* Matched with other inputs for consistency */
            padding: 10px; /* Matched with other inputs for consistency */
            font-size: 0.6875rem; /* Matched with other inputs for consistency */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        /* Styles for the new Monthly Evaluation Statistics Table */
        #monthlyStatsContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #monthlyStatsContainer th, #monthlyStatsContainer td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.75rem;
            text-align: center; /* Center align for counts */
            font-size: 0.875rem; /* text-sm */
        }
        #monthlyStatsContainer th {
            background-color: #eff6ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #monthlyStatsContainer tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        #monthlyStatsContainer tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* Conditional background colors for Total column */
        .total-red {
            background-color: #fca5a5; /* red-300 */
            color: #dc2626; /* red-700 */
            font-weight: bold;
        }
        .total-green {
            background-color: #a7f3d0; /* green-300 */
            color: #065f46; /* green-700 */
            font-weight: bold;
        }
        /* Styles for the login/access denied section */
        #accessSection {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Make it full height of the viewport */
            width: 100%;
            position: fixed; /* Fix its position to cover everything */
            top: 0;
            left: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            z-index: 1000; /* Ensure it's on top */
        }
        #accessBox {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        #accessBox h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #1f2937; /* gray-800 */
        }
        #accessBox button {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <div id="accessSection" class="hidden">
        <div id="accessBox">
            <h2 id="accessTitle">Login to ICEA LION QA Audit</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 text-left">Email:</label>
                    <input type="email" id="loginEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 text-left">Password:</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div id="loginError" class="error-message hidden"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Login</button>
            </form>
            <p class="mt-4 text-center text-sm text-gray-600">
                <a href="#" id="forgotPasswordLink" class="text-blue-600 hover:underline">Forgot Password?</a>
            </p>
        </div>
    </div>

    <nav class="main-nav" id="mainNav" style="display: none;">
        <ul>
            <li><a href="#" id="evaluationFormTab" class="active"><i class="fas fa-file-alt"></i> Evaluation Form</a></li>
            <li><a href="#" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
            <li><a href="reports.html" id="reportsTab"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="autofails.html" id="autofailsTab"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
            <li id="adminTabNav" style="display: none;"><a href="admin.html" id="adminTab"><i class="fas fa-user-cog"></i> Admin</a></li>
        </ul>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </nav>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-4xl mt-8 mb-8" id="evaluationFormContent" style="display: none;">
        <div class="icealion-blue p-4 flex items-center justify-between">
            <div class="text-xl font-semibold">Quality Assessment Form - ICEALION GROUP Contact Centre</div>
            <img src="assets/images/icealion_logo.png" alt="ICEALION Logo" class="h-10">
        </div>

        <div class="p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            <div>
                <label for="contact-id" class="block text-sm font-medium text-gray-700">Contact ID</label>
                <input type="text" id="contact-id" name="Contact ID" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                <input type="text" id="client-name" name="Client Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="cer-name" class="block text-sm font-medium text-gray-700">CER Name</label>
                <select id="cer-name" name="CER Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
                    <option value="">Loading CER Names...</option>
                </select>
            </div>
            <div>
                <label for="cer-role" class="block text-sm font-medium text-gray-700">CER Role</label>
                <select id="cer-role" name="CER Role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
                    <option value="">Loading CER Roles...</option>
                </select>
            </div>
            <div>
                <label for="call-date-time" class="block text-sm font-medium text-gray-700">Call Date and Time</label>
                <input type="datetime-local" id="call-date-time" name="Call Date and Time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="reviewer-name" class="block text-sm font-medium text-gray-700">Reviewer's Name</label>
                <select id="reviewer-name" name="Reviewer's Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
                    <option value="">Loading Reviewer Names...</option>
                </select>
                <input type="text" id="other-reviewer-name" name="Other Reviewer Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input hidden" placeholder="Enter Reviewer Name">
            </div>
            <div>
                <label for="autofail-type" class="block text-sm font-medium text-gray-700">Auto Fail Type</label>
                <select id="autofail-type" name="Auto Fail Type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input">
                    <option value="">Loading Autofail Types...</option>
                </select>
            </div>
            <div id="autofailDescriptionContainer" class="hidden">
                <label for="autofail-description" class="block text-sm font-medium text-gray-700">Autofail Description</label>
                <textarea id="autofail-description" name="Autofail Description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input remarks-textarea" placeholder="Provide details about the autofail"></textarea>
            </div>
            <div>
                <label for="review-date" class="block text-sm font-medium text-gray-700">Evaluation Date</label>
                <input type="date" id="review-date" name="Evaluation Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" required>
            </div>
            <div>
                <label for="duration" class="block text-sm font-medium text-gray-700">Call Duration</label>
                <input type="text" id="duration" name="Call Duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border form-grid-input" placeholder="e.g., 30 mins">
            </div>
        </div>

        <div class="p-4 rounded-lg shadow-sm flex flex-col items-center justify-center space-y-2 bg-gray-50 mx-6 mb-4">
            <div class="text-sm font-medium text-gray-600">Scores:</div>
            <div class="flex justify-around w-full gap-2">
                <div class="flex-1 text-center bg-gray-50 p-2 rounded-md">
                    <div class="text-xs font-medium text-gray-600 mb-1">Overall Score</div>
                    <div class="text-xl font-bold text-blue-600" id="overall-score-display">0%</div>
                </div>
                <div class="flex-1 text-center bg-gray-50 p-2 rounded-md">
                    <div class="text-xs font-medium text-gray-600 mb-1">Business & Compliance Accuracy</div>
                    <div class="text-xl font-bold text-blue-600" id="business-compliance-accuracy">0%</div>
                </div>
            </div>
        </div>
        <form id="assessment-form">
            <div class="mt-4">
                <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2">
                    <i class="fas fa-user tile-icon"></i> CUSTOMER EXPERIENCE
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-12 gap-2 text-sm font-medium text-gray-700 mb-2">
                        <div class="col-span-6">Description</div>
                        <div class="col-span-2 text-center">Rating</div>
                        <div class="col-span-1 text-center">Weight</div>
                        <div class="col-span-1 text-center">Pnts</div>
                        <div class="col-span-2">Remarks</div>
                    </div>
                    <div id="cxQuestionsContainer">
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2">
                    <i class="fas fa-lightbulb tile-icon"></i> PROBLEM SOLVING SKILLS
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-12 gap-2 text-sm font-medium text-gray-700 mb-2">
                        <div class="col-span-6">Description</div>
                        <div class="col-span-2 text-center">Rating</div>
                        <div class="col-span-1 text-center">Weight</div>
                        <div class="col-span-1 text-center">Pnts</div>
                        <div class="col-span-2">Remarks</div>
                    </div>
                    <div id="psQuestionsContainer">
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2">
                    <i class="fas fa-check-circle tile-icon"></i> COMPLIANCE AND BUSINESS CRITICAL ACCURACY
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-12 gap-2 text-sm font-medium text-gray-700 mb-2">
                        <div class="col-span-6">Description</div>
                        <div class="col-span-2 text-center">Rating</div>
                        <div class="col-span-1 text-center">Weight</div>
                        <div class="col-span-1 text-center">Pnts</div>
                        <div class="col-span-2">Remarks</div>
                    </div>
                    <div id="caQuestionsContainer">
                    </div>
                </div>
            </div>
        </form>

        <div class="p-6 flex flex-col items-end">
                <table class="score-summary-table w-full md:w-1/2 lg:w-1/3 text-right text-sm border-collapse border border-blue-500">
                    <tbody>
                        <tr class="border-b border-blue-500">
                            <td class="text-left font-medium p-2 border border-blue-500">Total Pts.</td>
                            <td class="text-right text-gray-500 p-2 border border-blue-500" id="total-pts-percentage">0%</td>
                        </tr>
                        <tr class="border-b border-blue-500">
                            <td class="text-left font-medium p-2 border border-blue-500">Available Pts.</td>
                            <td class="text-right text-gray-500 p-2 border border-blue-500">100%</td>
                        </tr>
                        <tr>
                            <td class="text-left font-bold icealion-orange-text p-2 border border-blue-500">Overall Score</td>
                            <td class="text-right font-bold icealion-orange-text p-2 border border-blue-500" id="overall-final-percentage-display">0%</td>
                        </tr>
                    </tbody>
                </table>
                <div class="flex items-center justify-between w-full mt-4">
                    <img src="https://placehold.co/150x50/1a73e8/FFFFFF?text=ICEALION%0AGROUP" alt="ICEALION Logo" class="h-12 rounded-md">
                    <div class="flex space-x-4">
                        <button type="button" id="print-email-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                            PDF & Email
                        </button>
                        <button type="submit" id="submitFormToDBBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                            Submit
                        </button>
                    </div>
                </div>
            </div>

        <div class="p-6">
            <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2 mb-4">
                <i class="fas fa-history tile-icon"></i> Last 3 Evaluations for Selected CER
            </div>
            <div id="lastEvaluationsContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">CER Name</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Overall Score</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">CER Role</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Contact ID</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-medium text-gray-600">Date</th>
                        </tr>
                    </thead>
                    <tbody id="lastEvaluationsTableBody">
                        <tr>
                            <td colspan="5" class="py-4 px-4 text-center text-gray-500">Select a CER Name to view their last evaluations.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-4xl mt-8 mb-8" id="monthlyStatsContainer" style="display: none;">
        <div class="section-header-bg text-white p-3 font-semibold flex items-center gap-2 mb-4">
            <i class="fas fa-chart-line tile-icon"></i> This Month Evaluation Statistics
        </div>
        <div class="p-6 overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-md">
                <thead>
                    <tr id="monthlyStatsHeader" class="bg-gray-100">
                        </tr>
                </thead>
                <tbody id="monthlyStatsTableBody">
                    <tr>
                        <td colspan="5" class="py-4 px-4 text-center text-gray-500">Loading monthly statistics...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-5xl mt-8 mb-8" id="databaseContent" style="display: none;">
        <div class="icealion-blue p-4 text-xl font-semibold text-center">
            Database Records
        </div>
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Submitted Records</h2>
                <div>
                    <button id="deleteSelectedRecordsBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-trash-alt mr-2"></i>Delete Selected
                    </button>
                </div>
            </div>

            <div id="databaseTableContainer" class="overflow-x-auto max-h-[60vh]">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="w-12"><input type="checkbox" id="selectAllRecordsCheckbox"></th>
                            <th class="w-24">Timestamp</th>
                            <th>Contact ID</th>
                            <th>Client Name</th>
                            <th>CER Name</th>
                            <th>Overall Score</th>
                            <th class="w-24">Actions</th>
                            <th>View</th>
                            <th>Email</th>
                            <th>Download</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-4 text-gray-500">No records found. Submit a form to see data here.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Webhook Management</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Add webhook URLs below. When new records are created, data will be sent to these webhooks.
                    **Note:** Sending data to external webhooks will depend on their server's CORS policy.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="url" id="newWebhookUrlInput" placeholder="Enter webhook URL (e.g., https://example.com/webhook)"
                           class="flex-1 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border form-grid-input">
                    <button id="addWebhookBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-plus mr-2"></i>Add Webhook
                    </button>
                </div>
                <div id="webhookList" class="border border-gray-300 p-4 rounded-md bg-gray-50 min-h-[100px]">
                    <p class="text-sm text-gray-500 text-center">No webhooks added yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, where, orderBy, limit, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
          authDomain: "icea-lion-qa.firebaseapp.com",
          projectId: "icea-lion-qa",
          storageBucket: "icea-lion-qa.firebasestorage.app",
          messagingSenderId: "820082472004",
          appId: "1:820082472004:web:8caddf941e1b5b661d76c94e",
          measurementId: "G-1RJJTT3QET"
        };

        window.appId = firebaseConfig.appId;

        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);

        window.fsCollection = collection;
        window.fsOnSnapshot = onSnapshot;
        window.fsAddDoc = addDoc;
        window.fsDeleteDoc = deleteDoc;
        window.fsDoc = doc;
        window.fsQuery = query;
        window.fsWhere = where;
        window.fsOrderBy = orderBy;
        window.fsLimit = limit;
        window.getDocs = getDocs;
        window.fsSetDoc = setDoc;
        window.fsGetDoc = getDoc;
        window.signOut = signOut;

        window.currentUserId = null;
        window.currentUserRole = null;
        window.isAuthReady = false; // Flag to indicate Firebase auth state is resolved

        // --- DOM Elements for Login/Access Section ---
        const accessSection = document.getElementById('accessSection');
        const accessTitle = document.getElementById('accessTitle');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');

        // --- Message Box Functions (already present, ensuring consistency) ---
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxSpinner = document.getElementById('messageBoxSpinner');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxContent = document.getElementById('messageBoxContent');
            const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

            messageBoxTitle.textContent = title;
            if (typeof message === 'string' && message.startsWith('<pre>')) {
                messageBoxContent.innerHTML = message;
                messageBoxContent.classList.add('message-box-content-pre');
            } else {
                messageBoxContent.textContent = message;
                messageBoxContent.classList.remove('message-box-content-pre');
            }

            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            if (isError) {
                messageBoxTitle.style.color = '#dc2626';
            } else {
                messageBoxTitle.style.color = '#1a73e8';
            }

            messageBoxCloseBtn.onclick = () => {
                messageBoxOverlay.classList.add('hidden');
                if (onClose) onClose();
            };
        }

        function hideMessageBox() {
            document.getElementById('messageBoxOverlay').classList.add('hidden');
        }

        // --- Session Management (consistency check only) ---
        window.checkSessionTimeout = function() {
            const lastActivity = localStorage.getItem('lastActivity');
            const loginTime = localStorage.getItem('loginTime');
            if (lastActivity && loginTime) {
                const now = new Date().getTime();
                const eightHours = 8 * 60 * 60 * 1000;

                if ((now - parseInt(lastActivity) > eightHours) || (now - parseInt(loginTime) > eightHours)) {
                    console.log("Session expired. Logging out.");
                    localStorage.removeItem('lastActivity');
                    localStorage.removeItem('loginTime');
                    sessionStorage.removeItem('loggedIn');
                    return true;
                }
            }
            return false;
        };

        window.updateLastActivity = function() {
            localStorage.setItem('lastActivity', new Date().getTime().toString());
        };

        document.addEventListener('mousemove', window.updateLastActivity);
        document.addEventListener('keydown', window.updateLastActivity);
        document.addEventListener('click', window.updateLastActivity);

        // --- Main Authentication State Listener (Handles Initial Display and Role-based UI) ---
        onAuthStateChanged(window.auth, async (user) => {
            if (window.checkSessionTimeout()) {
                await signOut(window.auth); // Ensure Firebase session is cleared if timeout detected
                accessSection.classList.remove('hidden'); // Show login if session expired
                accessTitle.textContent = "Session Expired";
                loginError.textContent = "Your session has expired. Please log in again.";
                loginError.classList.remove('hidden');
                return;
            }

            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase Auth State Changed: User logged in:", user.uid);

                const userDocRef = window.fsDoc(window.db, `artifacts/${window.appId}/users/${user.uid}`);
                try {
                    const userDocSnap = await window.fsGetDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        window.currentUserRole = userDocSnap.data().role;
                        console.log("User role fetched:", window.currentUserRole);
                        window.updateLastActivity(); // Update activity on successful auth

                        // Hide login form and show main app content
                        accessSection.classList.add('hidden');
                        initializeApp(); // Initialize the main app UI based on role
                    } else {
                        // User authenticated but no profile found (unlikely if registered via admin)
                        console.warn(`User profile for ${user.email} not found in Firestore. Logging out.`);
                        await signOut(window.auth);
                        accessSection.classList.remove('hidden');
                        accessTitle.textContent = "Access Denied";
                        loginError.textContent = "Your user profile is incomplete. Please contact an administrator.";
                        loginError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching user role from Firestore:", error);
                    await signOut(window.auth);
                    accessSection.classList.remove('hidden');
                    accessTitle.textContent = "Login Error";
                    loginError.textContent = `Failed to retrieve user profile: ${error.message}. Please try again.`;
                    loginError.classList.remove('hidden');
                }
            } else {
                // No user logged in, show the login form
                console.log("Firebase Auth State Changed: No user logged in. Showing login form.");
                window.currentUserId = null;
                window.currentUserRole = null;
                sessionStorage.removeItem('loggedIn');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('loginTime');
                accessSection.classList.remove('hidden');
                accessTitle.textContent = "Login to ICEA LION QA Audit";
                loginError.classList.add('hidden'); // Hide any previous errors
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('firebaseAuthReady')); // Signal that auth state is resolved
        });


        // --- Login Form Submission ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const email = loginEmail.value;
            const password = loginPassword.value;

            showMessageBox("Logging In", "Please wait...", false, true, false);

            try {
                const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                const userDocRef = window.fsDoc(window.db, `artifacts/${window.appId}/users/${user.uid}`);
                const userDocSnap = await window.fsGetDoc(userDocRef);

                if (userDocSnap.exists()) {
                    window.currentUserRole = userDocSnap.data().role;
                    sessionStorage.setItem('loggedIn', 'true');
                    localStorage.setItem('loginTime', new Date().getTime().toString());

                    hideMessageBox();
                    // Successfully logged in, initialize app UI based on role
                    initializeApp(); // This will show relevant tabs and content
                } else {
                    await signOut(window.auth);
                    hideMessageBox();
                    loginError.textContent = "User profile incomplete. Please contact administrator.";
                    loginError.classList.remove('hidden');
                }

            } catch (error) {
                hideMessageBox();
                let errorMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid email or password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
            }
        });

        // --- Forgot Password Link Handler ---
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = loginEmail.value.trim();

            if (!email) {
                showMessageBox("Email Required", "Please enter your email in the email field above to reset your password.", true);
                return;
            }

            showMessageBox("Sending Reset Email", "Please wait...", false, true, false);

            try {
                await sendPasswordResetEmail(window.auth, email);
                hideMessageBox();
                showMessageBox(
                    "Password Reset",
                    `A password reset link has been sent to ${email}. Please check your inbox (and spam folder).`,
                    false, false, true
                );
            } catch (error) {
                hideMessageBox();
                let errorMessage = "Failed to send password reset email.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No user found with that email address. Please check the email.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "The email address is not valid.";
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                showMessageBox("Password Reset Failed", errorMessage, true, false, true);
            }
        });

    </script>
    <script>
        // --- GLOBAL DATA STORES (Repeated for clarity, but already defined in the module script scope for Firebase imports) ---
        // These can be considered part of the main script's global scope now.
        let allRecords = [];
        let allWebhooks = [];
        let dynamicDropdownOptions = {};

        window.unsubscribeRecords = null;
        window.unsubscribeWebhooks = null;

        let globalTotalPoints = 0;
        let globalMaxPossiblePoints = 0;
        let autofailTriggered = false;

        let complianceCurrentPoints = 0;
        let complianceMaxPoints = 0;

        const MIN_EVALUATIONS_FOR_GREEN = 10;

        // --- ALL QUESTION DATA BY CER ROLE (UNCHANGED) ---
        const allRolesQuestions = {
            '': { 'CUSTOMER EXPERIENCE': [], 'PROBLEM SOLVING SKILLS': [], 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [] },
            'Outbound Sales': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the CER provide proper branding and personalize the call?', weightage: 6, required: true },
                    { desc: 'Did the CER demonstrate confidence and business etiquette althroughout the call session?', weightage: 8, required: true },
                    { desc: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 6, required: true },
                    { desc: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 8, required: true },
                    { desc: 'Was the CER able to build rapport?', weightage: 8, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 6, required: true },
                    { desc: "Was the CER's focus solely on the Customer?", weightage: 7, required: true },
                    { desc: 'Did the CER demonstrate strong Product Knowledge?', weightage: 10, required: true },
                    { desc: 'Did the CER document all action items & follow-up? (Autofail)', weightage: 6, autofail: true, required: true },
                    { desc: 'Was the CER able to sell to the customer?', weightage: 10, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the CER log call information correctly? (Data capture)', weightage: 10, autofail: true, required: true },
                    { desc: 'Did the CER adhere to Company Policies & Procedures?(Autofail)', weightage: 5, autofail: true, required: true },
                    { desc: 'Did the CER Comply with industry and legal requirements?', weightage: 5, required: true },
                    { desc: 'Was the CER able to identify and opportunity for Upselling & Cross-Selling?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'Social Media': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the CER provide proper branding and personalize the Interaction?', weightage: 5, required: true },
                    { desc: 'Did the CER demonstrate confidence and business etiquette althroughout the interaction session?', weightage: 6, required: true },
                    { desc: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, required: true },
                    { desc: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 7, required: true },
                    { desc: 'Did the CER keep the customer informed?(TAT, dead air)', weightage: 5, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 9, required: true },
                    { desc: 'Did the CER do proper research and check all related tools required?(Due diligence)', weightage: 7, required: true },
                    { desc: 'Did the CER show ownership and respond within the set turnaround time? (10 mins)', weightage: 6, required: true },
                    { desc: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 13, autofail: true, required: true },
                    { desc: 'Did the CER avoid risk behavior? (interaction avoidance/ZTP)', weightage: 8, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the CER log ticket information correctly?(Data capture)', weightage: 6, autofail: true, required: true },
                    { desc: 'Did the CER properly authenticate the customer?(KYC)', weightage: 8, autofail: true, required: true },
                    { desc: 'Did the CER provide complete and accurate information?(Customer education)', weightage: 10, required: true },
                    { desc: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'Live Chat': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the CER provide proper branding and personalize the conversation?', weightage: 5, required: true },
                    { desc: 'Did the CER demonstrate confidence and business etiquette althroughout the conversation session?', weightage: 7, required: true },
                    { desc: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, required: true },
                    { desc: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, required: true },
                    { desc: 'Did the CER keep the customer informed?(Dead Air-Average Response Time 1 min, TAT, )', weightage: 5, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 9, required: true },
                    { desc: 'Did the CER do proper research and check all related tools required?', weightage: 7, required: true },
                    { desc: 'Did the CER show ownership and respond within the set turnaround time? (10 Secs)', weightage: 6, required: true },
                    { desc: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 13, autofail: true, required: true },
                    { desc: 'Did the CER avoid risk behavior? (conversation avoidance/ZTP)', weightage: 8, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the CER log ticket information correctly?(Data Capture)', weightage: 6, autofail: true, required: true },
                    { desc: 'Did the CER properly authenticate the customer?(KYC)', weightage: 8, autofail: true, required: true },
                    { desc: 'Did the CER provide complete and accurate information?(Customer education)', weightage: 9, required: true },
                    { desc: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'Inbound': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the CER provide proper branding and personalize the call?', weightage: 6, required: true },
                    { desc: 'Did the CER demonstrate confidence and business etiquette althroughout the call session?', weightage: 6, required: true },
                    { desc: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 8, required: true },
                    { desc: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 4, required: true },
                    { desc: 'Did the CER keep the caller informed?(Dead air/Hold/TAT)', weightage: 6, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 6, required: true },
                    { desc: 'Did the CER do proper research and check all related tools required? (fact finding)', weightage: 7, required: true },
                    { desc: 'Did the CER show ownership and actively listen?', weightage: 9, required: true },
                    { desc: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 10, autofail: true, required: true },
                    { desc: 'Did the CER avoid risk behavior? (Call avoidance/ZTP)', weightage: 7, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the CER log call information correctly?(Data capture)', weightage: 10, autofail: true, required: true },
                    { desc: 'Did the CER properly authenticate the caller?(KYC)', weightage: 6, autofail: true, required: true },
                    { desc: 'Did the CER provide complete and accurate information? (Customer education)', weightage: 9, required: true },
                    { desc: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'Email': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the CER provide proper branding and personalize the email?', weightage: 5, required: true },
                    { desc: 'Did the CER demonstrate confidence and business etiquette althroughout the interaction?', weightage: 7, required: true },
                    { desc: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, required: true },
                    { desc: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, required: true },
                    { desc: 'Did the CER keep the customer informed?', weightage: 5, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the CER call to ask effective probing questions to ensure accurate diagnosis?', weightage: 9, required: true },
                    { desc: 'Did the CER do proper research and check all related tools required?', weightage: 7, required: true },
                    { desc: 'Did the CER show ownership and respond within the set turnaround time?(8 hours)', weightage: 6, required: true },
                    { desc: 'Was the CER able to position all possible options to the customer?', weightage: 13, autofail: true, required: true },
                    { desc: 'Did the CER avoid risk behavior? (Call avoidance/ZTP)', weightage: 8, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the CER log ticket information correctly?', weightage: 6, autofail: true, required: true },
                    { desc: 'Did the CER properly authenticate the writer?', weightage: 8, autofail: true, required: true },
                    { desc: 'Did the CER provide complete and accurate information?(Customer education)', weightage: 9, required: true },
                    { desc: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'Digital troubleshooting': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the Agent provide proper branding and personalize the call?', weightage: 6, required: true },
                    { desc: 'Did the Agent demonstrate confidence and business etiquette althroughout the call session?', weightage: 6, required: true },
                    { desc: 'Did the Agent express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, required: true },
                    { desc: 'Did the Agent convey his/her thoughts in an understandable clear and concise manner?', weightage: 7, required: true },
                    { desc: 'Did the Agent keep the caller informed?', weightage: 5, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the Agent ask effective probing questions to ensure accurate diagnosis?', weightage: 5.5, required: true },
                    { desc: 'Did the Agent do proper research and check all related tools required?', weightage: 11, required: true },
                    { desc: 'Did the Agent show ownership and actively listen?', weightage: 6, required: true },
                    { desc: 'Was the Agent able to position all possible options to the customer?', weightage: 10.5, autofail: true, required: true },
                    { desc: 'Did the agent avoid risk behavior? (Call avoidance/ZTP)', weightage: 7, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the Agent log call information correctly?', weightage: 7, autofail: true, required: true },
                    { desc: 'Did the Agent properly authenticate the caller?', weightage: 8, autofail: true, required: true },
                    { desc: 'Did the Agent provide complete and accurate information?', weightage: 9, required: true },
                    { desc: 'Did the Agent identify an opportunity to upsell/cross sell a product?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'SMS': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the CER provide proper branding and personalize the conversation?', weightage: 5, required: true },
                    { desc: 'Did the CER demonstrate confidence and business etiquette all throughout the conversation session?', weightage: 7, required: true },
                    { desc: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, required: true },
                    { desc: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, required: true },
                    { desc: 'Did the CER keep the customer informed?(Dead air, TAT)', weightage: 5, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 9, required: true },
                    { desc: 'Did the CER do proper research and check all related tools required?(fact finding)', weightage: 7, required: true },
                    { desc: 'Did the CER show ownership and respond within the set turnaround time?(5 mins)', weightage: 6, required: true },
                    { desc: 'Was the CER able to position all possible options to the customer?(FCR)', weightage: 13, autofail: true, required: true },
                    { desc: 'Did the CER avoid risk behavior? (conversation avoidance/ZTP)', weightage: 8, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the CER log ticket information correctly?(Data capture)', weightage: 6, autofail: true, required: true },
                    { desc: 'Did the CER properly authenticate the customer?(KYC)', weightage: 8, autofail: true, required: true },
                    { desc: 'Did the CER provide complete and accurate information? (Customer education)', weightage: 9, required: true },
                    { desc: 'Did the CER identify an opportunity to upsell/cross sell a product?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'NPS outbound': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the Agent provide proper branding and personalize the call?', weightage: 6, required: true },
                    { desc: 'Did the Agent demonstrate confidence and business etiquette althroughout the call session?', weightage: 6, required: true },
                    { desc: 'Did the Agent express a sincere acknowledgement/empathy statement when applicable?', weightage: 7, required: true },
                    { desc: 'Did the Agent convey his/her thoughts in an understandable clear and concise manner?', weightage: 7, required: true },
                    { desc: 'Did the Agent keep the caller informed?', weightage: 5, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the Agent ask effective probing questions to ensure accurate diagnosis?', weightage: 8, required: true },
                    { desc: 'Did the Agent do proper research and check all related tools required?', weightage: 7, required: true },
                    { desc: 'Did the Agent show ownership and actively listen?', weightage: 6, required: true },
                    { desc: 'Was the Agent able to position all possible options to the customer? Create a ticket where necessary', weightage: 11, autofail: true, required: true },
                    { desc: 'Did the agent avoid risk behavior? (Call avoidance/ZTP)', weightage: 7, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the Agent log call information correctly?', weightage: 7, autofail: true, required: true },
                    { desc: 'Did the Agent confirm the feedback from the customer and put it vebatim on the survey form?', weightage: 10, autofail: true, required: true },
                    { desc: 'Did the Agent provide complete and accurate information?', weightage: 9, required: true },
                    { desc: 'Did the Agent identify an opportunity to upsell/cross sell a product?', weightage: 5, required: true, hasNA: true }
                ]
            },
            'Onboarding outbound': {
                'CUSTOMER EXPERIENCE': [
                    { desc: 'Did the CER provide proper branding and personalize the call?', weightage: 6, required: true },
                    { desc: 'Did the CER demonstrate confidence and business etiquette althroughout the call session?', weightage: 7, required: true },
                    { desc: 'Did the CER express a sincere acknowledgement/empathy statement when applicable?', weightage: 6, required: true },
                    { desc: 'Did the CER convey his/her thoughts in an understandable clear and concise manner?', weightage: 6, required: true },
                    { desc: 'Was the CER able to build rapport?', weightage: 8, required: true }
                ],
                'PROBLEM SOLVING SKILLS': [
                    { desc: 'Did the CER ask effective probing questions to ensure accurate diagnosis?', weightage: 5, required: true },
                    { desc: 'Did the CER do proper research and check all related tools required?', weightage: 7, required: true },
                    { desc: 'Did the CER demonstrate strong Product and Process Knowledge?', weightage: 10, required: true },
                    { desc: 'Was the CER able to meet the call objective? (FCR)', weightage: 10, autofail: true, required: true },
                    { desc: 'Did the CER document all action items & follow-up?', weightage: 8, required: true }
                ],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': [
                    { desc: 'Did the CER log call information correctly?', weightage: 10, autofail: true, required: true },
                    { desc: 'Did the CER adhere to Company Policies & Procedures?', weightage: 5, autofail: true, required: true },
                    { desc: 'Did the CER Comply with industry and legal requirements?', weightage: 5, required: true },
                    { desc: 'Was the CER able to identify and opportunity for Upselling & Cross-Selling?', weightage: 7, required: true, hasNA: true }
                ]
            },
            'Reviewed case handling': {
                'CUSTOMER EXPERIENCE': [],
                'PROBLEM SOLVING SKILLS': [],
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': []
            }
        };

        // Audit Form Calculations (functions unchanged)
        const calculateScore = () => {
            const cerRoleSelect = document.getElementById('cer-role');
            const overallScoreDisplay = document.getElementById('overall-score-display');
            const businessComplianceAccuracyDisplay = document.getElementById('business-compliance-accuracy');
            const totalPtsPercentageDisplay = document.getElementById('total-pts-percentage');
            const overallFinalPercentageDisplay = document.getElementById('overall-final-percentage-display');

            let globalTotalPoints = 0;
            let globalMaxPossiblePoints = 0;
            let autofailTriggered = false;

            let complianceCurrentPoints = 0;
            let complianceMaxPoints = 0;

            const allRatingSelects = document.querySelectorAll('.rating-select');

            allRatingSelects.forEach(selectElement => {
                const rowDiv = selectElement.closest('.grid.grid-cols-12.gap-2.py-2');
                if (!rowDiv) return;

                const pointsElement = rowDiv.querySelector('.points-input');
                const weightageDisplay = rowDiv.querySelector('.weightage-display');
                const isAutofailQuestion = selectElement.hasAttribute('data-autofail-question');
                const questionText = selectElement.name.replace(' (Rating)', '');
                const hasNA = selectElement.hasAttribute('data-has-na');

                if (!pointsElement || !weightageDisplay) {
                    console.warn(`Missing associated elements for select: ${selectElement.name}`);
                    return;
                }

                const rating = selectElement.value;
                const weightage = parseFloat(weightageDisplay.dataset.weightage);
                let currentPoints = 0;

                pointsElement.style.backgroundColor = '#e9ecef';
                pointsElement.style.color = '#555';

                if (rating === 'Yes' || (rating === 'N/A' && hasNA)) {
                    currentPoints = weightage;
                    pointsElement.readOnly = false;
                    pointsElement.style.backgroundColor = '#fff';
                } else if (rating === 'No') {
                    currentPoints = 0;
                    pointsElement.readOnly = true;

                    if (isAutofailQuestion) {
                        pointsElement.style.backgroundColor = '#fca5a5';
                        pointsElement.style.color = '#dc2626';
                        autofailTriggered = true;
                    } else {
                        pointsElement.style.backgroundColor = '#e0e0e0';
                    }
                } else {
                    currentPoints = 0;
                    pointsElement.readOnly = true;
                    pointsElement.style.backgroundColor = '#e9ecef';
                    pointsElement.style.color = '#555';
                }

                pointsElement.value = currentPoints;
                globalTotalPoints += currentPoints;
                globalMaxPossiblePoints += weightage;

                const currentRole = document.getElementById('cer-role').value; // Get current role dynamically
                if (currentRole && allRolesQuestions[currentRole] && allRolesQuestions[currentRole]['COMPLIANCE AND BUSINESS CRITICAL ACCURACY']) {
                    const complianceQuestions = allRolesQuestions[currentRole]['COMPLIANCE AND BUSINESS CRITICAL ACCURACY'].map(q => q.desc);
                    if (complianceQuestions.includes(questionText)) {
                        if (rating === 'Yes' || (rating === 'N/A' && hasNA)) {
                            complianceCurrentPoints += weightage;
                        }
                        if (rating === 'Yes' || rating === 'No' || (rating === 'N/A' && hasNA)) {
                               complianceMaxPoints += weightage;
                        }
                    }
                }
            });

            let overallPercentage = 0;
            if (autofailTriggered) {
                overallPercentage = 0;
            } else {
                if (globalMaxPossiblePoints > 0) {
                    overallPercentage = ((globalTotalPoints / globalMaxPossiblePoints) * 100).toFixed(0);
                } else {
                    overallPercentage = 0;
                }
            }

            overallScoreDisplay.textContent = `${overallPercentage}%`;
            totalPtsPercentageDisplay.textContent = `${overallPercentage}%`;
            overallFinalPercentageDisplay.textContent = `${overallPercentage}%`;

            let businessCompliancePct = 0;
            if (complianceMaxPoints > 0) {
                businessCompliancePct = ((complianceCurrentPoints / complianceMaxPoints) * 100).toFixed(0);
            } else {
                businessCompliancePct = 0;
            }
            businessComplianceAccuracyDisplay.textContent = `${businessCompliancePct}%`;

        };

        window.renderQuestionsForRole = function(role) {
            const cxQuestionsContainer = document.getElementById('cxQuestionsContainer');
            const psQuestionsContainer = document.getElementById('psQuestionsContainer');
            const caQuestionsContainer = document.getElementById('caQuestionsContainer');

            const questionContainers = {
                'CUSTOMER EXPERIENCE': cxQuestionsContainer,
                'PROBLEM SOLVING SKILLS': psQuestionsContainer,
                'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': caQuestionsContainer
            };

            console.log("Rendering questions for role:", role);

            for (const key in questionContainers) {
                if (questionContainers[key]) {
                    questionContainers[key].innerHTML = '';
                }
            }

            const roleQuestions = allRolesQuestions[role];

            if (!roleQuestions) {
                console.warn(`No questions defined for role: ${role}. Displaying empty sections.`);
                calculateScore();
                return;
            }

            let questionNumber = 1;

            for (const sectionTitle in roleQuestions) {
                const questions = roleQuestions[sectionTitle];
                const container = questionContainers[sectionTitle];

                if (!container) {
                    console.error(`Container not found for section: ${sectionTitle}`);
                    continue;
                }

                questions.forEach(q => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = `grid grid-cols-12 gap-2 py-2 items-center rounded-md mb-2 p-2 ${questionNumber % 2 === 1 ? 'form-row-light' : 'form-row-dark'}`;

                    let iconColorClass;
                    const iconIndex = (questionNumber - 1) % 4;
                    if (iconIndex === 0) iconColorClass = 'icon-bg-orange';
                    else if (iconIndex === 1) iconColorClass = 'icon-bg-blue';
                    else if (iconIndex === 2) iconColorClass = 'icon-bg-green';
                    else iconColorClass = 'icon-bg-yellow';

                    rowDiv.innerHTML = `
                        <div class="col-span-6 flex items-center gap-2">
                            <span class="${iconColorClass} rounded-full p-1 text-white text-xs inline-flex items-center justify-center w-6 h-6">${questionNumber}</span>
                            <span class="question-description-text">${q.desc}</span>
                        </div>
                        <div class="col-span-2">
                            <select name="${q.desc} (Rating)" class="w-full rounded-md border-gray-300 shadow-sm p-1 text-center border rating-select" ${q.autofail ? 'data-autofail-question="true"' : ''} ${q.required ? 'required' : ''} ${q.hasNA ? 'data-has-na="true"' : ''}>
                                <option value="Yes" selected>Yes</option>
                                <option value="No">No</option>
                                ${q.hasNA ? '<option value="N/A">N/A</option>' : ''}
                            </select>
                        </div>
                        <div class="col-span-1 text-center weightage-display" data-weightage="${q.weightage}">${q.weightage}</div>
                        <div class="col-span-1 text-center">
                            <input type="number" name="${q.desc} (Points)" class="w-full text-center p-1 border rounded-md points-input" value="0" readonly placeholder="0">
                        </div>
                        <div class="col-span-2">
                            <textarea name="${q.desc} (Remarks)" rows="1" class="w-full rounded-md border-gray-300 shadow-sm p-1 border remarks-textarea"></textarea>
                        </div>
                    `;
                    container.appendChild(rowDiv);

                    const newSelect = rowDiv.querySelector('.rating-select');
                    if (newSelect) {
                        newSelect.addEventListener('change', calculateScore);
                    }
                    const newTextarea = rowDiv.querySelector('.remarks-textarea');
                    if (newTextarea) {
                        newTextarea.addEventListener('input', autoExpandTextarea);
                    }
                    questionNumber++;
                });
            }
            calculateScore();
        };

        function autoExpandTextarea(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        window.resetFormFieldsButKeepRole = function() {
            const dynamicSelects = document.querySelectorAll('.rating-select');
            dynamicSelects.forEach(selectElement => {
                selectElement.value = 'Yes';
                selectElement.style.borderColor = '';

                const rowDiv = selectElement.closest('.grid.grid-cols-12.gap-2.py-2');
                if (rowDiv) {
                    const pointsElement = rowDiv.querySelector('.points-input');
                    const remarksElement = rowDiv.querySelector('.remarks-textarea');

                    if (pointsElement) {
                        pointsElement.value = 0;
                        pointsElement.readOnly = true;
                        pointsElement.style.backgroundColor = '#e9ecef';
                        pointsElement.style.color = '#555';
                    }
                    if (remarksElement) {
                        remarksElement.value = '';
                        remarksElement.style.height = '40px';
                    }
                }
            });
            calculateScore();
        };

        function initializeEvaluationForm() {
            const evaluationDateInput = document.getElementById('review-date');
            const callDateTimeInput = document.getElementById('call-date-time');
            const cerRoleSelect = document.getElementById('cer-role');
            const cerNameSelect = document.getElementById('cer-name');
            const autofailTypeSelect = document.getElementById('autofail-type');
            const autofailDescriptionContainer = document.getElementById('autofailDescriptionContainer');
            const autofailDescriptionInput = document.getElementById('autofail-description');

            evaluationDateInput.valueAsDate = new Date();
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            callDateTimeInput.value = now.toISOString().slice(0,16);

            cerNameSelect.innerHTML = '<option value="">Loading CER Names...</option>';
            cerRoleSelect.innerHTML = '<option value="">Loading CER Roles...</option>';
            document.getElementById('reviewer-name').innerHTML = '<option value="">Loading Reviewer Names...</option>';
            autofailTypeSelect.innerHTML = '<option value="">Loading Autofail Types...</option>';

            autofailDescriptionContainer.classList.add('hidden');
            autofailDescriptionInput.value = '';
            autofailDescriptionInput.removeAttribute('required');
            autofailDescriptionInput.style.height = 'auto';

            document.getElementById('reviewer-name').value = '';
            document.getElementById('other-reviewer-name').classList.add('hidden');
            document.getElementById('other-reviewer-name').value = '';
            document.getElementById('other-reviewer-name').removeAttribute('required');
            document.getElementById('other-reviewer-name').style.borderColor = '';

            const requiredInputs = document.querySelectorAll('.p-6.grid.grid-cols-1 input[required], .p-6.grid.grid-cols-1 select[required]');
            requiredInputs.forEach(input => {
                input.style.borderColor = '';
            });

            populateDropdownsFromCache();

            window.renderQuestionsForRole('');
            calculateScore();
            document.getElementById('lastEvaluationsTableBody').innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Select a CER Name to view their last evaluations.</td></tr>';
        }

        function resetForm() {
            const contactIdInput = document.getElementById('contact-id');
            const clientNameInput = document.getElementById('client-name');
            const cerNameSelect = document.getElementById('cer-name');
            const cerRoleSelect = document.getElementById('cer-role');
            const callDateTimeInput = document.getElementById('call-date-time');
            const evaluationDateInput = document.getElementById('review-date');
            const durationInput = document.getElementById('duration');
            const autofailTypeSelect = document.getElementById('autofail-type');
            const reviewerNameSelect = document.getElementById('reviewer-name');
            const otherReviewerNameInput = document.getElementById('other-reviewer-name');
            const autofailDescriptionContainer = document.getElementById('autofailDescriptionContainer');
            const autofailDescriptionInput = document.getElementById('autofail-description');

            console.log("Full form reset.");

            contactIdInput.value = '';
            clientNameInput.value = '';
            cerNameSelect.value = '';
            cerRoleSelect.value = '';

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            callDateTimeInput.value = now.toISOString().slice(0,16);
            evaluationDateInput.valueAsDate = new Date();

            durationInput.value = '';
            autofailTypeSelect.value = '';

            autofailDescriptionContainer.classList.add('hidden');
            autofailDescriptionInput.value = '';
            autofailDescriptionInput.removeAttribute('required');
            autofailDescriptionInput.style.height = 'auto';

            reviewerNameSelect.value = '';
            otherReviewerNameInput.classList.add('hidden');
            otherReviewerNameInput.value = '';
            otherReviewerNameInput.removeAttribute('required');
            otherReviewerNameInput.style.borderColor = '';

            const requiredInputs = document.querySelectorAll('.p-6.grid.grid-cols-1 input[required], .p-6.grid.grid-cols-1 select[required]');
            requiredInputs.forEach(input => {
                input.style.borderColor = '';
            });

            window.renderQuestionsForRole('');
            calculateScore();
            document.getElementById('lastEvaluationsTableBody').innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Select a CER Name to view their last evaluations.</td></tr>';
        }

        function validateAllMandatoryFields() {
            const topLevelInputs = document.querySelectorAll('#evaluationFormContent input[required]:not([type="hidden"]), #evaluationFormContent select[required]');
            let allFieldsValid = true;

            for (const input of topLevelInputs) {
                if (input.id === 'other-reviewer-name' && input.classList.contains('hidden')) {
                    input.style.borderColor = '';
                    continue;
                }

                if (input.value.trim() === '') {
                    input.style.borderColor = 'red';
                    allFieldsValid = false;
                } else {
                    input.style.borderColor = '';
                }
            }

            const autofailTypeSelect = document.getElementById('autofail-type');
            const autofailDescriptionInput = document.getElementById('autofail-description');
            const overallScoreDisplay = document.getElementById('overall-score-display');
            const overallScoreValue = parseFloat(overallScoreDisplay.textContent);

            if (autofailTypeSelect.value !== '' || overallScoreValue === 0) {
                autofailDescriptionInput.setAttribute('required', 'required');
                if (autofailDescriptionInput.value.trim() === '') {
                    autofailDescriptionInput.style.borderColor = 'red';
                    allFieldsValid = false;
                } else {
                    autofailDescriptionInput.style.borderColor = '';
                }
            } else {
                autofailDescriptionInput.removeAttribute('required');
                autofailDescriptionInput.style.borderColor = '';
            }

            const dynamicRatingSelects = document.querySelectorAll('.rating-select');
            for (const selectElement of dynamicRatingSelects) {
                if (selectElement.value === '') {
                    selectElement.style.borderColor = 'red';
                    allFieldsValid = false;
                } else {
                    selectElement.style.borderColor = '';
                }
            }

            const remarksTextareas = document.querySelectorAll('.remarks-textarea');
            remarksTextareas.forEach(textarea => {
                textarea.style.borderColor = '';
            });

            if (!allFieldsValid) {
                const firstInvalidField = document.querySelector('input[required][value=""], select[required][value=""], .rating-select[value=""][style*="border-color: red"], textarea[required][value=""]');
                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                }
            }
            return allFieldsValid;
        }

        async function fetchLastThreeEvaluations(cerName) {
            const lastEvaluationsTableBody = document.getElementById('lastEvaluationsTableBody');
            if (!window.db || !window.EVALUATION_RECORDS_COLLECTION_PATH) {
                console.error("Firestore not initialized or collection path not defined.");
                lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-red-500">Database not ready.</td></tr>';
                return;
            }

            lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Loading last evaluations...</td></tr>';

            try {
                const recordsColRef = window.fsCollection(window.db, window.EVALUATION_RECORDS_COLLECTION_PATH);
                const q = window.fsQuery(
                    recordsColRef,
                    window.fsWhere('CER Name', '==', cerName),
                    window.fsOrderBy('submittedAt', 'desc'),
                    window.fsLimit(3)
                );
                const querySnapshot = await window.getDocs(q);

                const evaluations = [];
                if (querySnapshot.empty) {
                    lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No past evaluations found for this CER.</td></tr>';
                } else {
                    querySnapshot.forEach(doc => {
                        evaluations.push(doc.data());
                    });
                    renderLastThreeEvaluationsTable(evaluations);
                }
            }
            catch (error) {
                console.error("Error fetching last 3 evaluations:", error);
                lastEvaluationsTableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-red-500">Error loading evaluations: ${error.message}</td></tr>`;
            }
        }

        function renderLastThreeEvaluationsTable(evaluations) {
            const lastEvaluationsTableBody = document.getElementById('lastEvaluationsTableBody');
            lastEvaluationsTableBody.innerHTML = '';

            if (evaluations.length === 0) {
                lastEvaluationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No past evaluations found for this CER.</td></tr>';
                return;
            }

            evaluations.forEach(evaluation => {
                const row = lastEvaluationsTableBody.insertRow();
                row.className = 'border-b border-gray-200';
                row.innerHTML = `
                    <td class="py-2 px-4">${evaluation['CER Name'] || 'N/A'}</td>
                    <td class="py-2 px-4">${evaluation['Overall Score'] || 'N/A'}</td>
                    <td class="py-2 px-4">${evaluation['CER Role'] || 'N/A'}</td>
                    <td class="py-2 px-4">${evaluation['Contact ID'] || 'N/A'}</td>
                    <td class="py-2 px-4">${evaluation.submittedAt ? new Date(evaluation.submittedAt).toLocaleDateString() : 'N/A'}</td>
                `;
            });
        }

        async function fetchAllDropdownOptions() {
            if (!window.db || !window.DROPDOWN_OPTIONS_COLLECTION_PATH) {
                console.warn("Firestore not ready or DROPDOWN_OPTIONS_COLLECTION_PATH not defined for fetching all dropdowns.");
                return;
            }
            try {
                const docSnap = await window.fsGetDoc(window.fsDoc(window.db, window.DROPDOWN_OPTIONS_COLLECTION_PATH, 'options'));
                if (docSnap.exists()) {
                    dynamicDropdownOptions = docSnap.data();
                } else {
                    console.log("No 'options' document found in dropdown_options collection.");
                    dynamicDropdownOptions = {};
                }
                console.log("All dynamic dropdown options fetched:", dynamicDropdownOptions);
                populateDropdownsFromCache();
            }
            catch (error) {
                console.error("Error fetching all dropdown options:", error);
            }
        }

        function populateDropdownsFromCache() {
            const cerNameSelect = document.getElementById('cer-name');
            const cerRoleSelect = document.getElementById('cer-role');
            const reviewerNameSelect = document.getElementById('reviewer-name');
            const autofailTypeSelect = document.getElementById('autofail-type');

            function populateSelect(selectElement, optionsArray, defaultText) {
                selectElement.innerHTML = `<option value="">${defaultText}</option>`;
                optionsArray.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
            }

            if (dynamicDropdownOptions.cerNames && dynamicDropdownOptions.cerNames.length > 0) {
                populateSelect(cerNameSelect, dynamicDropdownOptions.cerNames, 'Select CER');
            } else {
                cerNameSelect.innerHTML = '<option value="">No CER Names available</option>';
            }

            if (dynamicDropdownOptions.cerRoles && dynamicDropdownOptions.cerRoles.length > 0) {
                populateSelect(cerRoleSelect, dynamicDropdownOptions.cerRoles, 'Select Role');
            } else {
                cerRoleSelect.innerHTML = '<option value="">No CER Roles available</option>';
            }

            if (dynamicDropdownOptions.reviewerNames && dynamicDropdownOptions.reviewerNames.length > 0) {
                const reviewerOptions = [...dynamicDropdownOptions.reviewerNames];
                if (!reviewerOptions.includes('Other')) {
                    reviewerOptions.push('Other');
                }
                populateSelect(reviewerNameSelect, reviewerOptions, 'Select Reviewer');
            } else {
                populateSelect(reviewerNameSelect, ['Other'], 'Select Reviewer');
            }

            if (dynamicDropdownOptions.autofailTypes && dynamicDropdownOptions.autofailTypes.length > 0) {
                populateSelect(autofailTypeSelect, dynamicDropdownOptions.autofailTypes, 'Select Autofail Type');
            } else {
                autofailTypeSelect.innerHTML = '<option value="">No Autofail Types available</option>';
            }
        }

        async function fetchAndRenderMonthlyStats() {
            const monthlyStatsTableBody = document.getElementById('monthlyStatsTableBody');
            if (monthlyStatsTableBody) {
                monthlyStatsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Loading monthly statistics...</td></tr>';
            }

            if (Object.keys(dynamicDropdownOptions).length === 0 || !dynamicDropdownOptions.cerNames || !dynamicDropdownOptions.cerRoles) {
                await fetchAllDropdownOptions();
                if (Object.keys(dynamicDropdownOptions).length === 0 || !dynamicDropdownOptions.cerNames || !dynamicDropdownOptions.cerRoles) {
                    console.warn("CER Names or Roles still not loaded for monthly stats after fetch. Cannot render stats.");
                    if(monthlyStatsTableBody) {
                        monthlyStatsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Cannot load monthly statistics: Missing CER Names or Roles.</td></tr>';
                    }
                    return;
                }
            }

            const monthlyRecords = await fetchMonthlyEvaluationRecords();
            const processedData = processMonthlyEvaluationData(
                monthlyRecords,
                [...dynamicDropdownOptions.cerNames || []],
                [...dynamicDropdownOptions.cerRoles || []]
            );
            renderMonthlyStatsTable(processedData);
        }

        async function fetchMonthlyEvaluationRecords() {
            if (!window.db || !window.EVALUATION_RECORDS_COLLECTION_PATH) {
                console.error("Firestore not initialized or collection path not defined for monthly stats.");
                return [];
            }

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const thirtyDaysAgoISO = thirtyDaysAgo.toISOString();

            const recordsColRef = window.fsCollection(window.db, window.EVALUATION_RECORDS_COLLECTION_PATH);
            const q = window.fsQuery(
                recordsColRef,
                window.fsWhere('submittedAt', '>=', thirtyDaysAgoISO),
                window.fsOrderBy('submittedAt', 'desc')
            );

            try {
                const querySnapshot = await window.getDocs(q);
                const monthlyRecords = [];
                querySnapshot.forEach(doc => {
                    monthlyRecords.push(doc.data());
                });
                console.log(`Fetched ${monthlyRecords.length} records for monthly statistics.`);
                return monthlyRecords;
            } catch (error) {
                console.error("Error fetching monthly evaluation records:", error);
                return [];
            }
        }

        function processMonthlyEvaluationData(records, cerNames, cerRoles) {
            const dataMatrix = {};

            cerNames.forEach(name => {
                dataMatrix[name] = {};
                cerRoles.forEach(role => {
                    dataMatrix[name][role] = 0;
                });
                dataMatrix[name]['Total'] = 0;
            });

            records.forEach(record => {
                const cerName = record['CER Name'];
                const cerRole = record = record['CER Role'];

                if (dataMatrix[cerName]) {
                    if (dataMatrix[cerName][cerRole] !== undefined) {
                        dataMatrix[cerName][cerRole]++;
                    } else {
                        dataMatrix[cerName][cerRole] = 1;
                        if (!cerRoles.includes(cerRole)) {
                            cerRoles.push(cerRole);
                        }
                    }
                    dataMatrix[cerName]['Total']++;
                } else {
                    dataMatrix[cerName] = {};
                    cerRoles.forEach(role => {
                        dataMatrix[cerName][role] = 0;
                    });
                    dataMatrix[cerName][cerRole] = 1;
                    dataMatrix[cerName]['Total'] = 1;
                    cerNames.push(cerName);
                }
            });

            cerRoles.sort();
            cerNames.sort();

            const columnHeaders = ['CER Name', ...cerRoles, 'Total'];
            const rowLabels = cerNames;

            return { rowLabels, columnHeaders, dataMatrix };
        }

        function renderMonthlyStatsTable(data) {
            const monthlyStatsHeader = document.getElementById('monthlyStatsHeader');
            const monthlyStatsTableBody = document.getElementById('monthlyStatsTableBody');

            if (!monthlyStatsHeader || !monthlyStatsTableBody) {
                console.error("Monthly stats table elements not found during rendering.");
                return;
            }

            monthlyStatsHeader.innerHTML = '';
            monthlyStatsTableBody.innerHTML = '';

            data.columnHeaders.forEach(header => {
                const th = document.createElement('th');
                th.className = 'py-2 px-4 border-b text-center text-sm font-medium text-gray-600';
                th.textContent = header;
                if (header === 'CER Name') {
                    th.classList.remove('text-center');
                    th.classList.add('text-left');
                }
                monthlyStatsHeader.appendChild(th);
            });

            if (data.rowLabels.length === 0) {
                monthlyStatsTableBody.innerHTML = `<tr><td colspan="${data.columnHeaders.length}" class="py-4 px-4 text-center text-gray-500">No evaluation data for this month.</td></tr>`;
                return;
            }

            data.rowLabels.forEach(cerName => {
                const row = monthlyStatsTableBody.insertRow();
                row.className = 'border-b border-gray-200';

                const nameCell = row.insertCell();
                nameCell.className = 'py-2 px-4 text-left';
                nameCell.textContent = cerName;

                data.columnHeaders.slice(1, -1).forEach(role => {
                    const countCell = row.insertCell();
                    countCell.className = 'py-2 px-4 text-center';
                    countCell.textContent = (data.dataMatrix[cerName] && data.dataMatrix[cerName][role] !== undefined) ? data.dataMatrix[cerName][role] : 0;
                });

                const totalCell = row.insertCell();
                totalCell.className = 'py-2 px-4 text-center';
                const totalCount = (data.dataMatrix[cerName] && data.dataMatrix[cerName]['Total'] !== undefined) ? data.dataMatrix[cerName]['Total'] : 0;
                totalCell.textContent = totalCount;

                if (totalCount < MIN_EVALUATIONS_FOR_GREEN) {
                    totalCell.classList.add('total-red');
                } else {
                    totalCell.classList.add('total-green');
                }
            });
        }

        // Main Application UI Initialization Function
        function initializeApp() {
            const accessSection = document.getElementById('accessSection');
            const mainNav = document.getElementById('mainNav');
            const evaluationFormContent = document.getElementById('evaluationFormContent');
            const databaseContent = document.getElementById('databaseContent');
            const monthlyStatsContainer = document.getElementById('monthlyStatsContainer');
            const adminTabNav = document.getElementById('adminTabNav');

            console.log("Initializing main application UI based on role.");

            accessSection.classList.add('hidden'); // Hide the login/access section
            mainNav.style.display = 'flex'; // Show the navigation bar

            // Hide all main content areas initially
            evaluationFormContent.style.display = 'none';
            databaseContent.style.display = 'none';
            monthlyStatsContainer.style.display = 'none';

            // Set all nav tabs to hidden by default, then selectively show them
            document.getElementById('evaluationFormTab').parentElement.style.display = 'none';
            document.getElementById('databaseTab').parentElement.style.display = 'none';
            document.getElementById('reportsTab').parentElement.style.display = 'none';
            document.getElementById('autofailsTab').parentElement.style.display = 'none';
            adminTabNav.style.display = 'none';

            const userRole = window.currentUserRole;

            if (userRole === 'CER') {
                document.getElementById('evaluationFormTab').parentElement.style.display = 'inline-block';
                document.getElementById('reportsTab').parentElement.style.display = 'inline-block';
                showTab('evaluationForm'); // Default view
            } else if (userRole === 'Supervisor') {
                document.getElementById('evaluationFormTab').parentElement.style.display = 'inline-block';
                document.getElementById('reportsTab').parentElement.style.display = 'inline-block';
                document.getElementById('autofailsTab').parentElement.style.display = 'inline-block';
                showTab('evaluationForm'); // Default view
            } else if (userRole === 'Admin') {
                document.getElementById('evaluationFormTab').parentElement.style.display = 'inline-block';
                document.getElementById('databaseTab').parentElement.style.display = 'inline-block';
                document.getElementById('reportsTab').parentElement.style.display = 'inline-block';
                document.getElementById('autofailsTab').parentElement.style.display = 'inline-block';
                adminTabNav.style.display = 'inline-block'; // Show Admin tab
                showTab('evaluationForm'); // Default view
            } else {
                // If role is null, 'Guest', or unrecognized, redirect to login (this is handled by onAuthStateChanged as well)
                showMessageBox("Access Denied", "Your role is not recognized or you don't have sufficient privileges. Please contact an administrator.", true, false, true, () => {
                    window.location.href = 'index.html'; // Stay on index.html and show login
                });
                return; // Stop further execution if access denied
            }

            initializeEvaluationForm(); // Initialize form fields and questions
            // fetchAndRenderMonthlyStats() is called within showTab('evaluationForm')
            // or when the firebaseAuthReady event fires.
        }

        let tempPdfDisplayElements = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded and parsed. Main script starting.");

            // Check session timeout early
            if (window.checkSessionTimeout()) {
                // If session expired, the onAuthStateChanged listener will handle redirecting to login.
                // No need for immediate return here, let onAuthStateChanged flow.
                console.log("Session expired on DOMContentLoaded.");
            }

            // Get DOM elements for event listeners
            const logoutBtn = document.getElementById('logoutBtn');
            const evaluationFormTab = document.getElementById('evaluationFormTab');
            const databaseTab = document.getElementById('databaseTab');
            const reportsTab = document.getElementById('reportsTab');
            const autofailsTab = document.getElementById('autofailsTab');
            const adminTab = document.getElementById('adminTab');

            const submitFormToDBBtn = document.getElementById('submitFormToDBBtn');
            const printEmailBtn = document.getElementById('print-email-btn');

            const reviewerNameSelect = document.getElementById('reviewer-name');
            const otherReviewerNameInput = document.getElementById('other-reviewer-name');
            const cerRoleSelect = document.getElementById('cer-role');
            const cerNameSelect = document.getElementById('cer-name');
            const autofailTypeSelect = document.getElementById('autofail-type');
            const autofailDescriptionContainer = document.getElementById('autofailDescriptionContainer');
            const autofailDescriptionInput = document.getElementById('autofail-description');

            const selectAllRecordsCheckbox = document.getElementById('selectAllRecordsCheckbox');
            const deleteSelectedRecordsBtn = document.getElementById('deleteSelectedRecordsBtn');
            const addWebhookBtn = document.getElementById('addWebhookBtn');

            // --- Attach Event Listeners ---
            logoutBtn.addEventListener('click', async function() {
                sessionStorage.removeItem('loggedIn');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('loginTime');
                try {
                    await window.signOut(window.auth);
                    console.log("Signed out from Firebase.");
                } catch (error) {
                    console.error("Error signing out:", error);
                }
                // After logout, implicitly the onAuthStateChanged will detect no user and show login form
                // No explicit redirect needed here.
            });

            if (evaluationFormTab) {
                evaluationFormTab.addEventListener('click', (e) => { e.preventDefault(); showTab('evaluationForm'); });
            }
            if (databaseTab) {
                databaseTab.addEventListener('click', (e) => { e.preventDefault(); showTab('database'); });
            }
            if (reportsTab) {
                reportsTab.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'reports.html'; });
            }
            if (autofailsTab) {
                autofailsTab.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'autofails.html'; });
            }
            if (adminTab) { // This is the navigation to the admin.html page
                adminTab.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'admin.html'; });
            }

            if (selectAllRecordsCheckbox) {
                selectAllRecordsCheckbox.addEventListener('change', () => {
                    const isChecked = selectAllRecordsCheckbox.checked;
                    document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                    updateDeleteButtonState();
                });
            }
            if (deleteSelectedRecordsBtn) {
                deleteSelectedRecordsBtn.addEventListener('click', deleteSelectedRecords);
            }
            if (addWebhookBtn) {
                addWebhookBtn.addEventListener('click', addWebhook);
            }

            autofailTypeSelect.addEventListener('change', () => {
                if (autofailTypeSelect.value !== '') {
                    autofailDescriptionContainer.classList.remove('hidden');
                    autofailDescriptionInput.setAttribute('required', 'required');
                    autoExpandTextarea({ target: autofailDescriptionInput });
                } else {
                    autofailDescriptionContainer.classList.add('hidden');
                    autofailDescriptionInput.value = '';
                    autofailDescriptionInput.removeAttribute('required');
                    autofailDescriptionInput.style.height = 'auto';
                }
            });

            reviewerNameSelect.addEventListener('change', () => {
                if (reviewerNameSelect.value === 'Other') {
                    otherReviewerNameInput.classList.remove('hidden');
                    otherReviewerNameInput.setAttribute('required', 'required');
                } else {
                    otherReviewerNameInput.classList.add('hidden');
                    otherReviewerNameInput.value = '';
                    otherReviewerNameInput.removeAttribute('required');
                    otherReviewerNameInput.style.borderColor = '';
                }
            });

            cerRoleSelect.addEventListener('change', (event) => {
                const selectedRole = event.target.value;
                window.renderQuestionsForRole(selectedRole);
                window.resetFormFieldsButKeepRole();
            });

            cerNameSelect.addEventListener('change', (event) => {
                const selectedCerName = event.target.value;
                if (selectedCerName) {
                    fetchLastThreeEvaluations(selectedCerName);
                } else {
                    document.getElementById('lastEvaluationsTableBody').innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Select a CER Name to view their last evaluations.</td></tr>';
                }
            });

            submitFormToDBBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                if (!validateAllMandatoryFields()) {
                    showMessageBox("Validation Error", "Please fill out all mandatory fields before submitting.", true, false, true);
                    return;
                }
                const formDataForSubmission = {};
                const basicInfoInputs = document.querySelectorAll('.p-6.grid.grid-cols-1 input, .p-6.grid.grid-cols-1 select');
                basicInfoInputs.forEach(input => {
                    if (input.name) {
                        if (input.type === 'datetime-local' || input.type === 'date') {
                            formDataForSubmission[input.name] = input.value;
                        } else if (input.id === 'other-reviewer-name' && input.classList.contains('hidden')) {
                            return;
                        } else {
                            formDataForSubmission[input.name] = input.value.trim();
                        }
                    }
                });

                const overallScoreDisplay = document.getElementById('overall-score-display');
                const overallScoreValue = parseFloat(overallScoreDisplay.textContent);

                if (overallScoreValue === 0) {
                    if (!autofailTypeSelect.value.trim()) {
                        formDataForSubmission['Auto Fail Type'] = 'Auto-Scored Fail';
                        autofailTypeSelect.value = 'Auto-Scored Fail';
                    }
                    if (!autofailDescriptionInput.value.trim()) {
                        formDataForSubmission['Autofail Description'] = 'Automatically marked due to 0% overall score.';
                        autofailDescriptionInput.value = 'Automatically marked due to 0% overall score.';
                        autofailDescriptionContainer.classList.remove('hidden');
                        autofailDescriptionInput.setAttribute('required', 'required');
                    }
                } else {
                    formDataForSubmission['Auto Fail Type'] = autofailTypeSelect.value.trim();
                    formDataForSubmission['Autofail Description'] = autofailDescriptionInput.value.trim();
                }

                formDataForSubmission['Overall Score'] = overallScoreDisplay.textContent;
                formDataForSubmission['Business & Compliance Accuracy'] = document.getElementById('business-compliance-accuracy').textContent;
                formDataForSubmission['Total Pts.'] = globalTotalPoints;
                formDataForSubmission['Available Pts.'] = globalMaxPossiblePoints;
                formDataForSubmission['Final Score'] = overallScoreDisplay.textContent;

                const dynamicSelects = document.querySelectorAll('.rating-select');
                dynamicSelects.forEach(selectElement => {
                    const rowDiv = selectElement.closest('.grid.grid-cols-12.gap-2.py-2');
                    if (rowDiv) {
                        const pointsElement = rowDiv.querySelector('.points-input');
                        const remarksElement = rowDiv.querySelector('.remarks-textarea');
                        formDataForSubmission[selectElement.name] = selectElement.value;
                        if (pointsElement) {
                            formDataForSubmission[pointsElement.name] = pointsElement.value;
                        }
                        if (remarksElement) {
                            formDataForSubmission[remarksElement.name] = remarksElement.value.trim();
                        }
                    }
                });
                await addRecordToFirestore(formDataForSubmission);
            });

            printEmailBtn.addEventListener('click', async () => {
                if (!validateAllMandatoryFields()) {
                    showMessageBox("Validation Error", "Please fill out all mandatory fields before generating PDF and Email.", true, false, true);
                    return;
                }

                const auditFormContent = document.getElementById('evaluationFormContent');
                const monthlyStatsContainer = document.getElementById('monthlyStatsContainer');
                if (!auditFormContent || !monthlyStatsContainer) {
                    console.error('Error: Required containers not found for PDF generation.');
                    showMessageBox("Error", "Could not find all content to generate PDF. Please try again.", true, false, true);
                    return;
                }

                const mainNav = document.getElementById('mainNav');
                const printEmailBtn = document.getElementById('print-email-btn');
                const submitFormToDBBtn = document.getElementById('submitFormToDBBtn');

                const elementsToReplace = document.querySelectorAll('#evaluationFormContent input, #evaluationFormContent select, #evaluationFormContent textarea');
                tempPdfDisplayElements = [];

                elementsToReplace.forEach(originalElement => {
                    if (originalElement.type === 'hidden' || originalElement.classList.contains('hidden')) return;

                    const displayDiv = document.createElement('div');
                    displayDiv.classList.add('pdf-display-value');

                    let valueToDisplay = '';
                    if (originalElement.tagName === 'SELECT') {
                        valueToDisplay = originalElement.options[originalElement.selectedIndex]?.textContent || '';
                    } else if (originalElement.type === 'datetime-local') {
                        const dt = new Date(originalElement.value);
                        if (!isNaN(dt.getTime())) {
                            valueToDisplay = dt.toLocaleString(undefined, {
                                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                            });
                        } else {
                            valueToDisplay = originalElement.value;
                        }
                    } else if (originalElement.type === 'date') {
                        const d = new Date(originalElement.value);
                        if (!isNaN(d.getTime())) {
                            valueToDisplay = d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                        } else {
                            valueToDisplay = originalElement.value;
                        }
                    } else {
                        valueToDisplay = originalElement.value;
                    }

                    displayDiv.textContent = valueToDisplay;
                    const rect = originalElement.getBoundingClientRect();
                    displayDiv.style.width = rect.width + 'px';
                    displayDiv.style.height = rect.height + 'px';
                    displayDiv.style.lineHeight = 'normal';

                    originalElement.parentNode.insertBefore(displayDiv, originalElement.nextSibling);
                    tempPdfDisplayElements.push({ original: originalElement, display: displayDiv });
                    originalElement.style.display = 'none';
                });

                const elementsToHide = [mainNav, printEmailBtn, submitFormToDBBtn];
                const originalDisplays = [];
                elementsToHide.forEach(el => {
                    if (el) {
                        originalDisplays.push({ el: el, display: el.style.display });
                        el.style.display = 'none';
                    }
                });

                tempPdfDisplayElements.forEach(item => { item.display.style.display = 'block'; });

                try {
                    const formCanvas = await html2canvas(auditFormContent, { scale: 2, useCORS: true, logging: false });
                    const formImgData = formCanvas.toDataURL('image/jpeg', 0.9);

                    const statsCanvas = await html2canvas(monthlyStatsContainer, { scale: 2, useCORS: true, logging: false });
                    const statsImgData = statsCanvas.toDataURL('image/jpeg', 0.9);

                    const imgWidth = 210;
                    const pageHeight = 297;
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');

                    const formImgHeight = formCanvas.height * imgWidth / formCanvas.width;
                    let formHeightLeft = formImgHeight;
                    let formPosition = 0;
                    pdf.addImage(formImgData, 'JPEG', 0, formPosition, imgWidth, formImgHeight, undefined, 'FAST');
                    formHeightLeft -= pageHeight;
                    while (formHeightLeft > -1) {
                        formPosition = formHeightLeft - formImgHeight;
                        pdf.addPage();
                        pdf.addImage(formImgData, 'JPEG', 0, formPosition, imgWidth, formImgHeight, undefined, 'FAST');
                        formHeightLeft -= pageHeight;
                    }

                    pdf.addPage();
                    const statsImgHeight = statsCanvas.height * imgWidth / statsCanvas.width;
                    let statsHeightLeft = statsImgHeight;
                    let statsPosition = 0;
                    pdf.addImage(statsImgData, 'JPEG', 0, statsPosition, imgWidth, statsImgHeight, undefined, 'FAST');
                    statsHeightLeft -= pageHeight;
                    while (statsHeightLeft > -1) {
                        statsPosition = statsHeightLeft - statsImgHeight;
                        pdf.addPage();
                        pdf.addImage(statsImgData, 'JPEG', 0, statsPosition, imgWidth, statsImgHeight, undefined, 'FAST');
                        statsHeightLeft -= pageHeight;
                    }

                    const contactIdInput = document.getElementById('contact-id');
                    const cerNameSelect = document.getElementById('cer-name');
                    const evaluationDateInput = document.getElementById('review-date');
                    const overallFinalPercentageDisplay = document.getElementById('overall-final-percentage-display');

                    const contactIdForPdf = contactIdInput.value || 'N/A';
                    const cerNameForPdf = cerNameSelect.value || 'N/A';
                    const reviewDateForPdf = evaluationDateInput.value || 'N/A';

                    pdf.save(`QA_Form_${contactIdForPdf}_${cerNameForPdf}_${reviewDateForPdf}.pdf`);

                    const cerNameVal = cerNameSelect.value;
                    const contactIdVal = contactIdInput.value;
                    const evaluationDateVal = evaluationDateInput.value;
                    const overallScoreVal = overallFinalPercentageDisplay.textContent;
                    const reviewerNameVal = reviewerNameSelect.value === 'Other' ? otherReviewerNameInput.value : reviewerNameSelect.value;

                    const subject = `Quality Assessment Feedback - ${cerNameVal} - ${contactIdVal}`;
                    const body = `Dear ${cerNameVal},\n\n` +
                                        `I attached Quality Assurance Audit Feedback below is a summary:\n\n` +
                                        `Contact ID: ${contactIdVal}\n` +
                                        `CER Name: ${cerNameVal}\n` +
                                        `Overall Score: ${overallScoreVal}\n` +
                                        `Evaluation Date: ${evaluationDateVal}\n\n` +
                                        `For full details please go through the attached Quality Evaluation and Form and Sign off should be Kind Regards Quality Evaluation Team\n\n` +
                                        `Kind Regards,\nQuality Evaluation Team`;

                    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

                    try {
                        window.location.href = mailtoLink;
                        showMessageBox("PDF Generated & Email Prepared", "The PDF has been downloaded to your device. Your email client should open shortly with pre-filled subject and body. Please remember to **manually attach the generated PDF** before sending.", false, false, true);
                    } catch (e) {
                        console.error("Failed to open email client:", e);
                        showMessageBox("Email Failed", "Could not open email client. Please try again or copy the details manually.", true, false, true);
                    }
                } catch (error) {
                    console.error("Critical Error during PDF generation or mailto attempt:", error);
                    showMessageBox("PDF Error", `Failed to generate PDF or open email client: ${error.message}`, true, false, true);
                } finally {
                    tempPdfDisplayElements.forEach(item => { item.display.remove(); item.original.style.display = ''; });
                    tempPdfDisplayElements = [];
                    originalDisplays.forEach(({ el, display }) => { if (el) el.style.display = display; });
                }
            });

            // This ensures initializeApp is called only once Firebase auth state is ready
            // If Firebase is already ready on DOMContentLoaded, call it immediately.
            // Otherwise, it will be called by the 'firebaseAuthReady' event listener.
            if (window.isAuthReady) {
                initializeApp();
                // We don't call fetchRecordsAndWebhooks and fetchAndRenderMonthlyStats directly here anymore
                // because initializeApp and showTab('evaluationForm') handle it.
            } else {
                // If not ready, the onAuthStateChanged listener above will eventually call initializeApp.
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
