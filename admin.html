document.addEventListener('DOMContentLoaded', function() {
    // **IMPORTANT: REPLACE THIS WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL**
    // This URL should be consistent across all your HTML files.
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhmxq-pQ8NUpSNg-xAkJWRW_LEUKbw5NOzUunt-j4EO7QIEJnKjWRdclvNjYMXL2kJvg/exec';

    // --- DOM Element References ---
    const loginPage = document.getElementById('loginPage');
    const loginForm = document.getElementById('loginForm');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');

    const reportsContent = document.getElementById('reportsContent');
    const mainNav = document.getElementById('mainNav');
    const logoutBtn = document.getElementById('logoutBtn');

    const reportMonthSelect = document.getElementById('reportMonth');
    const reportYearSelect = document.getElementById('reportYear');
    const generateReportsBtn = document.getElementById('generateReportsBtn');

    const auditsPerAgentTableBody = document.querySelector('#auditsPerAgentTable tbody');
    const autofailsTableBody = document.querySelector('#autofailsTable tbody');
    const auditsPerQueueTableBody = document.querySelector('#auditsPerQueueTable tbody');
    const autofailsPerIndividualTableBody = document.querySelector('#autofailsPerIndividualTable tbody');

    const loadingMessages = document.querySelectorAll('.loading-message');
    const noDataMessages = document.querySelectorAll('.no-data-message'); // All no-data messages

    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];

    // --- Utility Functions ---

    /**
     * Displays a login-related error message.
     * @param {string} message - The message to display.
     */
    const showLoginErrorMessage = (message) => {
        loginMessage.textContent = message;
        loginMessage.classList.remove('hidden');
        // You might want to add a timeout here too, or a close button
    };

    /**
     * Hides the login error message.
     */
    const hideLoginErrorMessage = () => {
        loginMessage.classList.add('hidden');
        loginMessage.textContent = '';
    };

    /**
     * Populates the year dropdown with a range of years.
     */
    function populateYears() {
        const currentYear = new Date().getFullYear();
        // Show years from 5 years ago to 1 year in the future
        for (let i = currentYear - 5; i <= currentYear + 1; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            reportYearSelect.appendChild(option);
        }
        reportYearSelect.value = currentYear; // Default to current year
    }

    /**
     * Sets the default selected month in the dropdown to the current month.
     */
    function setDefaultMonth() {
        reportMonthSelect.value = new Date().getMonth() + 1; // Month is 0-indexed
    }

    /**
     * Shows all loading messages and clears table bodies.
     */
    function showLoadingIndicators() {
        loadingMessages.forEach(msg => msg.style.display = 'block');
        noDataMessages.forEach(msg => msg.style.display = 'none'); // Hide all no-data messages
        auditsPerAgentTableBody.innerHTML = '';
        autofailsTableBody.innerHTML = '';
        auditsPerQueueTableBody.innerHTML = '';
        autofailsPerIndividualTableBody.innerHTML = '';
    }

    /**
     * Hides all loading messages.
     */
    function hideLoadingIndicators() {
        loadingMessages.forEach(msg => msg.style.display = 'none');
    }

    /**
     * Shows the "no data" message for a specific report section.
     * @param {string} sectionIdPrefix - The ID prefix of the report section (e.g., 'auditsPerAgent').
     */
    function showNoDataMessage(sectionIdPrefix) {
        document.getElementById(sectionIdPrefix + 'NoData').style.display = 'block';
    }

    /**
     * Renders data into a given table body.
     * @param {HTMLTableSectionElement} tableBody - The tbody element to populate.
     * @param {Object} reportData - The data object for the table.
     * @param {string} sectionIdPrefix - The ID prefix for the report section's no-data message.
     */
    function renderTable(tableBody, reportData, sectionIdPrefix) {
        tableBody.innerHTML = ''; // Clear previous data

        if (!reportData || Object.keys(reportData).length === 0) {
            showNoDataMessage(sectionIdPrefix);
            return;
        }

        const sortedNames = Object.keys(reportData).sort();

        sortedNames.forEach(name => {
            const rowData = reportData[name];
            const tr = document.createElement('tr');
            tr.classList.add('hover:bg-gray-100', 'border-b', 'border-gray-200'); // Add hover and border

            const tdName = document.createElement('td');
            tdName.classList.add('px-6', 'py-3', 'whitespace-nowrap', 'font-medium', 'text-gray-900', 'text-left');
            tdName.textContent = name;
            tr.appendChild(tdName);

            let total = 0;
            for (let i = 1; i <= 12; i++) {
                const monthName = months[i - 1]; // Get month name (e.g., 'January')
                const count = rowData[monthName] || 0;
                const tdCount = document.createElement('td');
                tdCount.classList.add('px-6', 'py-3', 'whitespace-nowrap', 'text-gray-700', 'text-center');
                tdCount.textContent = count;
                tr.appendChild(tdCount);
                total += count;
            }

            const tdTotal = document.createElement('td');
            tdTotal.classList.add('px-6', 'py-3', 'whitespace-nowrap', 'font-bold', 'text-gray-900', 'text-center');
            tdTotal.textContent = total;
            tr.appendChild(tdTotal);
            tableBody.appendChild(tr);
        });
    }

    /**
     * Fetches and renders all reports for the selected month and year.
     */
    async function fetchAndRenderReports() {
        showLoadingIndicators();

        const selectedMonth = reportMonthSelect.value;
        const selectedYear = reportYearSelect.value;

        try {
            const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getReports&month=${selectedMonth}&year=${selectedYear}`, {
                method: 'GET',
                mode: 'cors'
            });

            if (!response.ok) {
                // If the response itself is not OK, log the status and throw
                console.error(`HTTP Error: ${response.status} - ${response.statusText}`);
                throw new Error(`Failed to fetch reports. Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            hideLoadingIndicators(); // Hide loading regardless of success/fail, before showing no data/tables

            if (data.status === 'SUCCESS' && data.reports) {
                renderTable(auditsPerAgentTableBody, data.reports.auditsPerAgent, 'auditsPerAgent');
                renderTable(autofailsTableBody, data.reports.autofails, 'autofails');
                renderTable(auditsPerQueueTableBody, data.reports.auditsPerQueue, 'auditsPerQueue');
                renderTable(autofailsPerIndividualTableBody, data.reports.autofailsPerIndividual, 'autofailsPerIndividual');
            } else {
                console.error('Error fetching reports data:', data.message || 'Unknown error');
                // Show "no data" for all sections if the overall fetch was successful but no reports data
                noDataMessages.forEach(msg => msg.style.display = 'block');
            }
        } catch (error) {
            console.error('Network or Apps Script execution error:', error);
            hideLoadingIndicators();
            // Show "no data" for all sections if there was a network/script error
            noDataMessages.forEach(msg => msg.style.display = 'block');
            showLoginErrorMessage(`Error loading reports: ${error.message}. Please try again.`); // Re-using login message area for general errors
        }
    }

    // --- Authentication Logic (copied from other pages, ideally centralized) ---
    // This section should ideally be in a shared `login.js` file and included on all pages.

    loginForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        hideLoginErrorMessage();

        const enteredUsername = usernameInput.value;
        const enteredPassword = passwordInput.value;

        try {
            const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=authenticate&username=${encodeURIComponent(enteredUsername)}&password=${encodeURIComponent(enteredPassword)}`);

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();

            if (data.status === 'SUCCESS' && data.authenticated) {
                sessionStorage.setItem('loggedIn', 'true');
                // If you had roles, you'd store them here too:
                // sessionStorage.setItem('userRole', data.role);
                // Instead of reload, directly transition UI and fetch data:
                loginPage.style.display = 'none';
                reportsContent.style.display = 'block';
                mainNav.style.display = 'flex';
                populateYears();
                setDefaultMonth();
                await fetchAndRenderReports(); // Fetch reports immediately after login
            } else {
                showLoginErrorMessage('Invalid username or password.');
            }
        } catch (error) {
            console.error('Authentication Error:', error);
            showLoginErrorMessage('An error occurred during login. Please try again. Check console for details.');
        }
    });

    // Logout functionality (consistent across all pages)
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            sessionStorage.removeItem('loggedIn');
            sessionStorage.removeItem('userRole'); // Clear role too if you implement it
            window.location.href = 'index.html'; // Redirect to login page
        });
    }

    // --- Initial Load ---
    // Check login status and initialize UI based on it.
    if (sessionStorage.getItem('loggedIn') === 'true') {
        loginPage.style.display = 'none';
        reportsContent.style.display = 'block';
        mainNav.style.display = 'flex';
        populateYears();
        setDefaultMonth();
        fetchAndRenderReports(); // Fetch reports on initial load if logged in
    } else {
        loginPage.style.display = 'flex';
        reportsContent.style.display = 'none';
        mainNav.style.display = 'none';
    }

    // --- Event Listeners ---
    generateReportsBtn.addEventListener('click', fetchAndRenderReports);
    // Optional: Add event listeners to month/year selects to auto-generate reports on change
    // reportMonthSelect.addEventListener('change', fetchAndRenderReports);
    // reportYearSelect.addEventListener('change', fetchAndRenderReports);
});
