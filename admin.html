<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ICEA LION GROUP</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            padding: 0;
        }

        /* Adjustments for admin container relative to body flow */
        body > .admin-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        /* Basic form/section styling for admin page */
        .admin-section {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
            width: 100%;
            max-width: 800px;
        }

        .admin-section h2 {
            color: #0d47a1;
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .form-group-admin {
            margin-bottom: 16px;
        }

        .form-group-admin label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #4a5568;
        }

        .form-group-admin input[type="text"],
        .form-group-admin input[type="password"],
        .form-group-admin select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group-admin input[type="text"]:focus,
        .form-group-admin input[type="password"]:focus,
        .form-group-admin select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        .admin-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 8px; /* Space from inputs */
        }

        .admin-btn-primary {
            background-color: #3182ce;
            color: white;
        }

        .admin-btn-primary:hover {
            background-color: #2b6cb0;
        }

        .admin-btn-danger {
            background-color: #e53e3e;
            color: white;
        }

        .admin-btn-danger:hover {
            background-color: #c53030;
        }

        .admin-message {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            text-align: center;
        }

        .admin-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .admin-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .current-items-list {
            list-style: disc;
            padding-left: 20px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding-top: 10px;
            padding-bottom: 10px;
            border-radius: 5px;
        }
        .current-items-list li {
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .current-items-list li:nth-child(even) {
            background-color: #f7fafc;
        }
        .current-items-list li button {
            margin-left: 10px;
            padding: 4px 8px;
            font-size: 0.8em;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">
    <!-- Navigation Menu -->
    <nav class="main-nav" id="mainNav">
        <ul>
            <li><a href="index.html"><i class="fas fa-file-alt"></i> Audit Form</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="admin.html" class="active"><i class="fas fa-cog"></i> Admin</a></li>
        </ul>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </nav>

    <!-- Login Page (re-used from index.html) -->
    <div class="login-container absolute inset-0 flex items-center justify-center p-4 md:p-8 z-10" id="loginPage" style="display: none;">
        <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-md">
            <div class="icealion-blue p-6 rounded-t-lg text-center">
                <h1 class="text-2xl font-semibold">ICEALION GROUP Login</h1>
            </div>

            <form id="loginForm" class="p-8 space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username" 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border" 
                           required placeholder="Enter your username">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border" 
                           required placeholder="Enter your password">
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Login
                </button>
                <div id="loginMessage" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <!-- Admin Content (Initially Hidden) -->
    <div class="admin-container w-full max-w-6xl p-4" id="adminContent" style="display: none;">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-8">Admin Panel</h1>

        <!-- Dropdown Management Section -->
        <div class="admin-section">
            <h2>Manage Form Dropdowns</h2>
            <div class="form-group-admin">
                <label for="dropdownTypeSelect">Select Dropdown:</label>
                <select id="dropdownTypeSelect" class="block w-full">
                    <option value="">Select a dropdown to manage</option>
                    <option value="cerNames">CER Names</option>
                    <option value="cerRoles">CER Roles</option>
                    <option value="reviewerNames">Reviewer Names</option>
                    <option value="autofailTypes">Autofail Types</option>
                </select>
            </div>

            <div class="form-group-admin" id="dropdownValueInputGroup" style="display: none;">
                <label for="dropdownValue">Current Values:</label>
                <ul id="currentDropdownItems" class="current-items-list">
                    <!-- Dynamic list of current items -->
                </ul>
                <input type="text" id="newDropdownValue" placeholder="Enter new value to add/remove">
                <button class="admin-btn admin-btn-primary" id="addDropdownValueBtn">Add Value</button>
                <button class="admin-btn admin-btn-danger" id="removeDropdownValueBtn">Remove Selected</button>
                <div id="dropdownMessage" class="admin-message hidden"></div>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="admin-section">
            <h2>User Management</h2>
            <div class="form-group-admin">
                <label for="newUsername">Username:</label>
                <input type="text" id="newUsername" placeholder="Enter new username">
            </div>
            <div class="form-group-admin">
                <label for="newPassword">Password:</label>
                <input type="password" id="newPassword" placeholder="Enter password">
            </div>
             <div class="form-group-admin">
                <label for="newUserRole">Role:</label>
                <select id="newUserRole" class="block w-full">
                    <option value="User">User</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <button class="admin-btn admin-btn-primary" id="createUserBtn">Create User</button>
            <div id="userMessage" class="admin-message hidden"></div>

            <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Existing Users:</h3>
            <ul id="existingUsersList" class="current-items-list">
                <!-- Dynamic list of users -->
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Admin DOM loaded. Script execution started."); 
            // **IMPORTANT: REPLACE THIS WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL**
            const googleAppsScriptURL = 'https://script.google.com/macros/s/AKfycbzhmxq-pQ8NUpSNg-xAkJWRW_LEUKbw5NOzUunt-j4EO7QIEJnKjWRdclvNjYMXL2kJvg/exec';

            // Login elements (shared with index.html)
            const loginPage = document.getElementById('loginPage');
            const loginForm = document.getElementById('loginForm');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginMessage = document.getElementById('loginMessage');

            // Admin Page elements
            const adminContent = document.getElementById('adminContent');
            const mainNav = document.getElementById('mainNav'); // Navigation bar
            const logoutBtn = document.getElementById('logoutBtn'); // Logout button

            // Dropdown management elements
            const dropdownTypeSelect = document.getElementById('dropdownTypeSelect');
            const dropdownValueInputGroup = document.getElementById('dropdownValueInputGroup');
            const currentDropdownItems = document.getElementById('currentDropdownItems');
            const newDropdownValueInput = document.getElementById('newDropdownValue');
            const addDropdownValueBtn = document.getElementById('addDropdownValueBtn');
            const removeDropdownValueBtn = document.getElementById('removeDropdownValueBtn');
            const dropdownMessage = document.getElementById('dropdownMessage');

            // User management elements
            const newUsernameInput = document.getElementById('newUsername');
            const newPasswordInput = document.getElementById('newPassword');
            const newUserRoleSelect = document.getElementById('newUserRole');
            const createUserBtn = document.getElementById('createUserBtn');
            const userMessage = document.getElementById('userMessage');
            const existingUsersList = document.getElementById('existingUsersList');

            // --- Utility Functions ---
            const showMessage = (element, message, type) => {
                element.textContent = message;
                element.classList.remove('hidden', 'success', 'error');
                element.classList.add(type);
                console.log(`Admin message: ${message} (${type})`);
                setTimeout(() => { element.classList.add('hidden'); }, 3000);
            };

            // --- Login/Authentication Logic ---
            const showLoginErrorMessage = (message) => {
                loginMessage.textContent = message;
                loginMessage.classList.remove('hidden');
            };

            const hideLoginErrorMessage = () => {
                loginMessage.classList.add('hidden');
                loginMessage.textContent = '';
            };

            // Authenticate user via Apps Script
            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                hideLoginErrorMessage();
                console.log("Login form submitted on admin.html.");

                const username = usernameInput.value;
                const password = passwordInput.value;

                fetch(`${googleAppsScriptURL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Auth response data:", data);
                        if (data.status === 'SUCCESS' && data.authenticated) {
                            sessionStorage.setItem('loggedIn', 'true');
                            window.location.reload(); 
                        } else {
                            showLoginErrorMessage('Invalid username or password.');
                        }
                    })
                    .catch(error => {
                        console.error('Authentication Error:', error);
                        showLoginErrorMessage('An error occurred during login. Please try again. Check console for details.');
                    });
            });

            // Initial check for login status on admin.html load
            console.log("Checking login status on admin.html load."); 
            const isLoggedIn = sessionStorage.getItem('loggedIn');
            if (isLoggedIn === 'true') {
                loginPage.style.display = 'none'; // Hide login page
                adminContent.style.display = 'block'; // Show admin content
                mainNav.style.display = 'flex'; // Show navigation
                fetchAndRenderUsers(); // Load users on admin page load
                console.log("Logged in: Displaying admin content."); 
            } else {
                loginPage.style.display = 'flex'; // Show login
                adminContent.style.display = 'none'; // Hide admin content
                mainNav.style.display = 'none'; // Hide navigation
                console.log("Not logged in: Displaying login page."); 
            }

            // Logout functionality
            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'index.html'; // Redirect to login page
            });


            // --- Dropdown Management Logic ---
            let currentSelectedDropdownType = ''; 

            if (dropdownTypeSelect) { // Added check to ensure element exists before adding listener
                dropdownTypeSelect.addEventListener('change', async function() {
                    console.log("Dropdown type select change event triggered."); 
                    currentSelectedDropdownType = this.value;
                    console.log(`Dropdown type selected: ${currentSelectedDropdownType}`);
                    currentDropdownItems.innerHTML = ''; // Clear previous list
                    dropdownValueInputGroup.style.display = 'none';
                    dropdownMessage.classList.add('hidden');

                    if (currentSelectedDropdownType) {
                        await fetchAndRenderDropdownOptions(currentSelectedDropdownType);
                        dropdownValueInputGroup.style.display = 'block';
                    }
                });
            } else {
                console.error("dropdownTypeSelect not found. Dropdown management may not work.");
            }


            async function fetchAndRenderDropdownOptions(type) {
                console.log(`Function fetchAndRenderDropdownOptions called for type: ${type}`); 
                currentDropdownItems.innerHTML = '<li>Loading...</li>';
                try {
                    const response = await fetch(`${googleAppsScriptURL}?action=getDropdownOptions&type=${type}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log("Dropdown options fetch response:", data);
                    
                    currentDropdownItems.innerHTML = ''; 

                    if (data.status === 'SUCCESS' && data.options) {
                        if (data.options.length === 0) {
                            currentDropdownItems.innerHTML = '<li>No items found.</li>';
                        } else {
                            data.options.forEach(item => {
                                const li = document.createElement('li');
                                li.textContent = item;
                                li.addEventListener('click', () => {
                                    li.classList.toggle('bg-blue-200'); 
                                });
                                currentDropdownItems.appendChild(li);
                            });
                        }
                    } else {
                        showMessage(dropdownMessage, `Error fetching options: ${data.message || 'Unknown error'}`, 'error');
                        currentDropdownItems.innerHTML = '<li>Failed to load items.</li>';
                    }
                } catch (error) {
                    console.error('Fetch dropdown options error:', error);
                    showMessage(dropdownMessage, 'Network error fetching options.', 'error');
                    currentDropdownItems.innerHTML = '<li>Network error.</li>';
                }
            }

            if (addDropdownValueBtn) { // Added check
                addDropdownValueBtn.addEventListener('click', async function() {
                    console.log("Add dropdown value button clicked."); 
                    const newValue = newDropdownValueInput.value.trim();
                    if (!currentSelectedDropdownType) {
                        showMessage(dropdownMessage, 'Please select a dropdown type first.', 'error');
                        return;
                    }
                    if (!newValue) {
                        showMessage(dropdownMessage, 'Value cannot be empty.', 'error');
                        return;
                    }
                    console.log(`Adding value '${newValue}' to dropdown '${currentSelectedDropdownType}'.`);

                    try {
                        const response = await fetch(googleAppsScriptURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'addDropdownOption', type: currentSelectedDropdownType, value: newValue })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        if (data.status === 'SUCCESS') {
                            showMessage(dropdownMessage, 'Value added successfully!', 'success');
                            newDropdownValueInput.value = '';
                            await fetchAndRenderDropdownOptions(currentSelectedDropdownType); 
                        } else {
                            showMessage(dropdownMessage, `Failed to add value: ${data.message}`, 'error');
                        }
                    } catch (error) {
                        console.error('Add dropdown value error:', error);
                        showMessage(dropdownMessage, 'Network error adding value.', 'error');
                    }
                });
            } else {
                console.error("addDropdownValueBtn not found. Add functionality may not work.");
            }


            if (removeDropdownValueBtn) { // Added check
                removeDropdownValueBtn.addEventListener('click', async function() {
                    console.log("Remove dropdown value button clicked."); 
                    const selectedItems = Array.from(currentDropdownItems.children)
                                            .filter(li => li.classList.contains('bg-blue-200'))
                                            .map(li => li.textContent.trim());

                    if (!currentSelectedDropdownType) {
                        showMessage(dropdownMessage, 'Please select a dropdown type first.', 'error');
                        return;
                    }
                    if (selectedItems.length === 0) {
                        showMessage(dropdownMessage, 'Please select at least one item to remove.', 'error');
                        return;
                    }
                    console.log(`Removing values ${JSON.stringify(selectedItems)} from dropdown '${currentSelectedDropdownType}'.`);

                    if (!confirm(`Are you sure you want to remove these ${selectedItems.length} item(s)?`)) {
                        return;
                    }

                    try {
                        const response = await fetch(googleAppsScriptURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'removeDropdownOption', type: currentSelectedDropdownType, values: selectedItems })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        if (data.status === 'SUCCESS') {
                            showMessage(dropdownMessage, 'Value(s) removed successfully!', 'success');
                            await fetchAndRenderDropdownOptions(currentSelectedDropdownType); 
                        } else {
                            showMessage(dropdownMessage, `Failed to remove value(s): ${data.message}`, 'error');
                        }
                    } catch (error) {
                        console.error('Remove dropdown value error:', error);
                        showMessage(dropdownMessage, 'Network error removing value(s).', 'error');
                    }
                });
            } else {
                console.error("removeDropdownValueBtn not found. Remove functionality may not work.");
            }


            // --- User Management Logic ---
            if (createUserBtn) { // Added check
                createUserBtn.addEventListener('click', async function() {
                    console.log("Create user button clicked."); 
                    const username = newUsernameInput.value.trim();
                    const password = newPasswordInput.value.trim();
                    const role = newUserRoleSelect.value;

                    if (!username || !password) {
                        showMessage(userMessage, 'Username and password cannot be empty.', 'error');
                        return;
                    }
                    console.log(`Creating user: ${username} with role ${role}`);

                    try {
                        const response = await fetch(googleAppsScriptURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'createUser', username: username, password: password, role: role })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        if (data.status === 'SUCCESS') {
                            showMessage(userMessage, 'User created successfully!', 'success');
                            newUsernameInput.value = '';
                            newPasswordInput.value = '';
                            newUserRoleSelect.value = 'User';
                            await fetchAndRenderUsers(); 
                        } else {
                            showMessage(userMessage, `Failed to create user: ${data.message}`, 'error');
                        }
                    } catch (error) {
                        console.error('Create user error:', error);
                        showMessage(userMessage, 'Network error creating user.', 'error');
                    }
                });
            } else {
                console.error("createUserBtn not found. User creation may not work.");
            }


            async function fetchAndRenderUsers() {
                console.log('Fetching all users for list.'); 
                existingUsersList.innerHTML = '<li>Loading users...</li>';
                try {
                    const response = await fetch(`${googleAppsScriptURL}?action=getUsers`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log("Users fetch response:", data);

                    existingUsersList.innerHTML = ''; 

                    if (data.status === 'SUCCESS' && data.users) {
                        if (data.users.length === 0) {
                            existingUsersList.innerHTML = '<li>No users found.</li>';
                        } else {
                            data.users.forEach(user => {
                                const li = document.createElement('li');
                                li.textContent = `${user.Username} (${user.Role})`;
                                li.dataset.username = user.Username; 
                                li.classList.add('flex', 'items-center', 'justify-between');

                                const removeBtn = document.createElement('button');
                                removeBtn.textContent = 'Remove';
                                removeBtn.classList.add('admin-btn', 'admin-btn-danger');
                                removeBtn.addEventListener('click', async () => {
                                    if (confirm(`Are you sure you want to remove user ${user.Username}?`)) {
                                        await removeUser(user.Username);
                                    }
                                });
                                li.appendChild(removeBtn);
                                existingUsersList.appendChild(li);
                            });
                        }
                    } else {
                        showMessage(userMessage, `Error fetching users: ${data.message || 'Unknown error'}`, 'error');
                        existingUsersList.innerHTML = '<li>Failed to load users.</li>';
                    }
                } catch (error) {
                    console.error('Fetch users error:', error);
                    showMessage(userMessage, 'Network error fetching users.', 'error');
                    existingUsersList.innerHTML = '<li>Network error.</li>';
                }
            }

            async function removeUser(username) {
                console.log(`Attempting to remove user: ${username}`); 
                try {
                    const response = await fetch(googleAppsScriptURL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'removeUser', username: username })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.status === 'SUCCESS') {
                        showMessage(userMessage, 'User removed successfully!', 'success');
                        await fetchAndRenderUsers(); 
                    } else {
                        showMessage(userMessage, `Failed to remove user: ${data.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Remove user error:', error);
                    showMessage(userMessage, 'Network error removing user.', 'error');
                }
            }
        });
    </script>
</body>
</html>
