<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles (copied from index.html) */
        .error-message {
            color: #dc2626; /* red-700 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }

        /* Navigation styles (copied from index.html) */
        .main-nav {
            width: 100%;
            background-color: #1a73e8;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .main-nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .main-nav ul li {
            margin-right: 1.5rem;
        }
        .main-nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.3s ease;
        }
        .main-nav ul li a:hover,
        .main-nav ul li a.active {
            background-color: #0d47a1; /* A darker blue for hover/active */
        }
        .logout-button {
            background-color: #f57c00; /* icealion-orange */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background-color: #e65100; /* darker orange */
        }

        /* Admin specific styles */
        .admin-section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .admin-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937; /* gray-800 */
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .admin-table th, .admin-table td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        .admin-table th {
            background-color: #eff6ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
        }
        .admin-table tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        .admin-table tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .admin-table .action-buttons button {
            margin-right: 0.5rem;
            padding: 0.3em 0.6em;
            font-size: 0.8em;
            border-radius: 0.25em;
            cursor: pointer;
        }
        /* Message Box styles (copied from index.html) */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8; /* icealion-blue */
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <div class="login-container absolute inset-0 flex items-center justify-center p-4 md:p-8 z-10" id="loginPage">
        <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-md">
            <div class="icealion-blue p-6 rounded-t-lg text-center">
                <h1 class="text-2xl font-semibold">ICEALION GROUP Login</h1>
            </div>

            <form id="loginForm" class="p-8 space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your username">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your password">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Login
                </button>
                <div id="loginMessage" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <nav class="main-nav" id="mainNav" style="display: none;">
        <ul>
            <li><a href="index.html" id="auditFormTab"><i class="fas fa-file-alt"></i> Audit Form</a></li>
            <li><a href="index.html#database" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
            <li><a href="reports.html" id="reportsTab"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="admin.html" id="adminTab" class="active"><i class="fas fa-user-cog"></i> Admin</a></li>
        </ul>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </nav>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-4xl mt-8 mb-8" id="adminContent" style="display: none;">
        <div class="icealion-blue p-4 text-xl font-semibold text-center">
            Admin Panel - Form Configuration
        </div>
        <div class="p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage CER Roles & Questions</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="admin-section">
                    <h3>Select Role to Manage</h3>
                    <div class="flex flex-col gap-2">
                        <select id="adminRoleSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="">Select a CER Role</option>
                            </select>
                        <button id="loadRoleQuestionsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md mt-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Load Questions
                        </button>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>Add New CER Role</h3>
                    <input type="text" id="newRoleNameInput" placeholder="Enter New Role Name"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border mb-2">
                    <button id="addNewRoleBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md">
                        Add Role
                    </button>
                </div>
            </div>

            <div id="questionsManagementSection" class="admin-section border-t border-gray-200 pt-6 mt-6 hidden">
                <h3 class="flex justify-between items-center">
                    Questions for <span id="currentRoleNameDisplay" class="icealion-orange-text"></span>
                    <button id="addNewQuestionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">
                        <i class="fas fa-plus mr-1"></i>Add Question
                    </button>
                </h3>
                <div class="overflow-x-auto max-h-[50vh] mt-4">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Weightage</th>
                                <th>Autofail</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="questionsTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-gray-500">No questions loaded for this role.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id="saveRoleConfigBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md mt-4 disabled:opacity-50 disabled:cursor-not-allowed">
                    Save Role Configuration
                </button>
                <button id="deleteRoleBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md mt-4 ml-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    Delete Role
                </button>
            </div>
        </div>
    </div>

    <div id="questionModalOverlay" class="message-box-overlay hidden">
        <div class="message-box max-w-md w-full p-6 text-left">
            <h3 id="questionModalTitle" class="text-center mb-4">Add New Question</h3>
            <div class="mb-4">
                <label for="questionDescInput" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="questionDescInput" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Enter question description" required></textarea>
            </div>
            <div class="mb-4">
                <label for="questionWeightageInput" class="block text-sm font-medium text-gray-700">Weightage</label>
                <input type="number" id="questionWeightageInput" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
            </div>
            <div class="mb-4 flex items-center">
                <input type="checkbox" id="questionAutofailCheckbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                <label for="questionAutofailCheckbox" class="ml-2 block text-sm text-gray-900">Autofail Question?</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="saveQuestionModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md">Save</button>
                <button id="cancelQuestionModalBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md">Cancel</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
        // No onSnapshot or query/where needed for Admin specific operations (unless real-time sync is desired, which is overkill for Admin)

        // --- Your Web App's Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
          authDomain: "icea-lion-qa.firebaseapp.com",
          projectId: "icea-lion-qa",
          storageBucket: "icea-lion-qa.firebasestorage.app",
          messagingSenderId: "820082472004",
          appId: "1:820082472004:web:8caddf941e1b5b6dfaf811",
          measurementId: "G-1RJJTT3QET"
        };

        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        
        // Expose necessary Firestore functions for the main script block
        window.fsCollection = collection;
        window.fsAddDoc = addDoc;
        window.fsGetDocs = getDocs; 
        window.fsDeleteDoc = deleteDoc;
        window.fsDoc = doc;
        window.fsUpdateDoc = updateDoc; // Needed for editing role configs
        window.fsSetDoc = setDoc; // Needed for adding/overwriting role configs

        window.currentUserId = null;
        window.isAuthReady = false;

        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase Auth State Changed: User logged in:", user.uid);
            } else {
                console.log("Firebase Auth State Changed: No user logged in. Attempting sign-in.");
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in with custom token:", window.currentUserId);
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        try {
                            await signInAnonymously(window.auth);
                            window.currentUserId = window.auth.currentUser.uid;
                            console.log("Signed in anonymously:", window.currentUserId);
                        } catch (anonError) {
                            console.error("Error signing in anonymously (fallback):", anonError);
                        }
                    }
                } else {
                    try {
                        await signInAnonymously(window.auth);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in anonymously:", window.currentUserId);
                    } catch (anonError) {
                        console.error("Error signing in anonymously:", anonError);
                    }
                }
                if (!window.currentUserId) {
                    console.error("No user ID available after authentication attempts. Using random UUID as fallback.");
                    window.currentUserId = crypto.randomUUID();
                }
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
        });

        window.FORM_CONFIGS_COLLECTION_PATH = `artifacts/${appId}/public/form_configs`; // New collection for form configs

    </script>
    <script>
        // --- GLOBAL DATA STORES ---
        let allFormConfigs = {}; // Stores all CER role configurations fetched from Firestore
        let currentEditingRoleQuestions = { // Structure for the currently loaded role's questions
            'CUSTOMER EXPERIENCE': [],
            'PROBLEM SOLVING SKILLS': [],
            'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': []
        };
        let currentEditingRoleName = ''; // The name of the role currently loaded for editing
        let editingQuestionIndex = -1; // -1 for new question, otherwise index of question being edited
        let editingQuestionSection = ''; // 'CUSTOMER EXPERIENCE', 'PROBLEM SOLVING SKILLS', etc.


        // --- UI ELEMENTS ---
        const loginPage = document.getElementById('loginPage');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');

        const mainNav = document.getElementById('mainNav');
        const adminTab = document.getElementById('adminTab'); // This page's tab
        const logoutBtn = document.getElementById('logoutBtn');

        const adminContent = document.getElementById('adminContent');

        const adminRoleSelect = document.getElementById('adminRoleSelect');
        const loadRoleQuestionsBtn = document.getElementById('loadRoleQuestionsBtn');
        const newRoleNameInput = document.getElementById('newRoleNameInput');
        const addNewRoleBtn = document.getElementById('addNewRoleBtn');

        const questionsManagementSection = document.getElementById('questionsManagementSection');
        const currentRoleNameDisplay = document.getElementById('currentRoleNameDisplay');
        const addNewQuestionBtn = document.getElementById('addNewQuestionBtn');
        const questionsTableBody = document.getElementById('questionsTableBody');
        const saveRoleConfigBtn = document.getElementById('saveRoleConfigBtn');
        const deleteRoleBtn = document.getElementById('deleteRoleBtn');

        // Question Modal Elements
        const questionModalOverlay = document.getElementById('questionModalOverlay');
        const questionModalTitle = document.getElementById('questionModalTitle');
        const questionDescInput = document.getElementById('questionDescInput');
        const questionWeightageInput = document.getElementById('questionWeightageInput');
        const questionAutofailCheckbox = document.getElementById('questionAutofailCheckbox');
        const saveQuestionModalBtn = document.getElementById('saveQuestionModalBtn');
        const cancelQuestionModalBtn = document.getElementById('cancelQuestionModalBtn');


        // Message Box elements (re-used for confirmation modals etc.)
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxSpinner = document.getElementById('messageBoxSpinner');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');


        // --- MESSAGE BOX FUNCTIONS (copied from index.html) ---
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            if (isError) {
                messageBoxTitle.style.color = '#dc2626';
            } else {
                messageBoxTitle.style.color = '#1a73e8';
            }

            messageBoxCloseBtn.onclick = () => {
                messageBoxOverlay.classList.add('hidden');
                if (onClose) onClose();
            };
        }

        function hideMessageBox() {
            messageBoxOverlay.classList.add('hidden');
        }

        // --- ADMIN SPECIFIC FUNCTIONS ---

        async function loadFormConfigurations() {
            if (!window.db || !window.currentUserId) {
                showMessageBox("Authentication Required", "Please log in to manage configurations.", true, false, true);
                return;
            }
            if (!window.FORM_CONFIGS_COLLECTION_PATH) {
                showMessageBox("Configuration Error", "Form configs path not set up. Check Firebase configuration.", true, false, true);
                return;
            }

            showMessageBox("Loading Configs", "Fetching form configurations...", false, true, false);
            try {
                const configColRef = window.fsCollection(window.db, window.FORM_CONFIGS_COLLECTION_PATH);
                const querySnapshot = await window.fsGetDocs(configColRef);
                
                allFormConfigs = {}; // Reset global configs
                querySnapshot.forEach(doc => {
                    allFormConfigs[doc.id] = doc.data(); // doc.id is the CER Role name
                });
                console.log("Form configurations loaded:", allFormConfigs);
                populateRoleSelect();
                hideMessageBox();
            } catch (error) {
                console.error("Error loading form configurations:", error);
                showMessageBox("Load Error", `Failed to load form configurations: ${error.message}`, true, false, true);
            }
        }

        function populateRoleSelect() {
            adminRoleSelect.innerHTML = '<option value="">Select a CER Role</option>';
            for (const roleName in allFormConfigs) {
                const option = document.createElement('option');
                option.value = roleName;
                option.textContent = roleName;
                adminRoleSelect.appendChild(option);
            }
            adminRoleSelect.disabled = false;
            loadRoleQuestionsBtn.disabled = false;
        }

        function loadRoleQuestionsForEditing() {
            const selectedRole = adminRoleSelect.value;
            if (!selectedRole) {
                questionsManagementSection.classList.add('hidden');
                showMessageBox("Select Role", "Please select a CER Role to load its questions.", false, false, true);
                return;
            }

            currentEditingRoleName = selectedRole;
            currentEditingRoleQuestions = JSON.parse(JSON.stringify(allFormConfigs[selectedRole])); // Deep copy
            currentRoleNameDisplay.textContent = selectedRole;
            questionsManagementSection.classList.remove('hidden');
            renderQuestionsTable();
            saveRoleConfigBtn.disabled = false;
            deleteRoleBtn.disabled = false;
        }

        async function addNewRole() {
            const newRoleName = newRoleNameInput.value.trim();
            if (!newRoleName) {
                showMessageBox("Input Required", "Please enter a name for the new role.", true, false, true);
                return;
            }
            if (allFormConfigs[newRoleName]) {
                showMessageBox("Duplicate Role", `Role "${newRoleName}" already exists.`, true, false, true);
                return;
            }

            showMessageBox("Adding Role", `Adding new role "${newRoleName}"...`, false, true, false);
            try {
                // Initialize with empty sections, matching the structure required by the form
                const emptyConfig = {
                    'CUSTOMER EXPERIENCE': [],
                    'PROBLEM SOLVING SKILLS': [],
                    'COMPLIANCE AND BUSINESS CRITICAL ACCURACY': []
                };
                const docRef = window.fsDoc(window.db, window.FORM_CONFIGS_COLLECTION_PATH, newRoleName);
                await window.fsSetDoc(docRef, emptyConfig); // setDoc creates or overwrites

                newRoleNameInput.value = '';
                await loadFormConfigurations(); // Reload all configs including the new one
                adminRoleSelect.value = newRoleName; // Select the new role
                loadRoleQuestionsForEditing(); // Load its (empty) questions
                showMessageBox("Success", `Role "${newRoleName}" added successfully!`, false, false, true);

            } catch (error) {
                console.error("Error adding new role:", error);
                showMessageBox("Add Role Failed", `Failed to add role: ${error.message}`, true, false, true);
            }
        }

        async function saveRoleConfiguration() {
            if (!currentEditingRoleName) {
                showMessageBox("No Role Loaded", "Please load a role before saving.", true, false, true);
                return;
            }

            showMessageBox("Saving Config", `Saving configuration for "${currentEditingRoleName}"...`, false, true, false);
            try {
                const docRef = window.fsDoc(window.db, window.FORM_CONFIGS_COLLECTION_PATH, currentEditingRoleName);
                await window.fsSetDoc(docRef, currentEditingRoleQuestions); // Overwrite with current state

                await loadFormConfigurations(); // Refresh all configs to reflect saved state
                showMessageBox("Success", `Configuration for "${currentEditingRoleName}" saved successfully!`, false, false, true);

            } catch (error) {
                console.error("Error saving role configuration:", error);
                showMessageBox("Save Failed", `Failed to save configuration: ${error.message}`, true, false, true);
            }
        }

        async function deleteRole() {
            if (!currentEditingRoleName) {
                showMessageBox("No Role Loaded", "Please load a role before deleting.", true, false, true);
                return;
            }

            showMessageBox("Confirm Deletion", `Are you sure you want to delete the entire role "${currentEditingRoleName}" and all its questions? This cannot be undone.`, true, false, false);
            
            const confirmDeleteBtn = document.createElement('button');
            confirmDeleteBtn.textContent = 'Delete Role';
            confirmDeleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md mr-2';
            confirmDeleteBtn.onclick = async () => {
                hideMessageBox();
                showMessageBox("Deleting Role", `Deleting role "${currentEditingRoleName}"...`, false, true, false);
                try {
                    const docRef = window.fsDoc(window.db, window.FORM_CONFIGS_COLLECTION_PATH, currentEditingRoleName);
                    await window.fsDeleteDoc(docRef);

                    adminRoleSelect.value = ''; // Clear selection
                    questionsManagementSection.classList.add('hidden'); // Hide questions section
                    newRoleNameInput.value = ''; // Clear new role input
                    currentEditingRoleName = ''; // Reset editing state
                    
                    await loadFormConfigurations(); // Reload configs without the deleted role
                    showMessageBox("Success", `Role deleted successfully!`, false, false, true);
                    
                } catch (error) {
                    console.error("Error deleting role:", error);
                    showMessageBox("Delete Failed", `Failed to delete role: ${error.message}`, true, false, true);
                } finally {
                    messageBoxContent.innerHTML = originalMessageBoxContentHTML; // Restore original content structure
                }
            };

            const cancelDeleteBtn = document.createElement('button');
            cancelDeleteBtn.textContent = 'Cancel';
            cancelDeleteBtn.className = 'bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md';
            cancelDeleteBtn.onclick = () => {
                hideMessageBox();
                messageBoxContent.innerHTML = originalMessageBoxContentHTML;
            };

            const originalMessageBoxContentHTML = messageBoxContent.innerHTML; // Store original for restore
            messageBoxContent.innerHTML = ''; // Clear initial message
            messageBoxContent.appendChild(confirmDeleteBtn);
            messageBoxContent.appendChild(cancelDeleteBtn);
            messageBoxCloseBtn.onclick = () => { hideMessageBox(); messageBoxContent.innerHTML = originalMessageBoxContentHTML; };
        }


        function renderQuestionsTable() {
            questionsTableBody.innerHTML = '';
            let qNum = 1;

            // Define sections in desired order
            const sections = ['CUSTOMER EXPERIENCE', 'PROBLEM SOLVING SKILLS', 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY'];

            sections.forEach(sectionTitle => {
                const questionsInSection = currentEditingRoleQuestions[sectionTitle];
                if (questionsInSection && questionsInSection.length > 0) {
                    // Add a header row for the section
                    const sectionHeaderRow = questionsTableBody.insertRow();
                    sectionHeaderRow.className = 'bg-gray-200';
                    const headerCell = sectionHeaderRow.insertCell(0);
                    headerCell.colSpan = 4; // Span all columns
                    headerCell.textContent = sectionTitle;
                    headerCell.className = 'font-semibold text-gray-800 text-center py-2';

                    questionsInSection.forEach((q, qIndex) => {
                        const row = questionsTableBody.insertRow();
                        row.insertCell().textContent = `${qNum}. ${q.desc}`;
                        row.insertCell().textContent = q.weightage;
                        row.insertCell().textContent = q.autofail ? 'Yes' : 'No';
                        const actionsCell = row.insertCell();
                        actionsCell.className = 'action-buttons';
                        actionsCell.innerHTML = `
                            <button class="edit-question-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-md" 
                                data-section="${sectionTitle}" data-index="${qIndex}">Edit</button>
                            <button class="delete-question-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-md" 
                                data-section="${sectionTitle}" data-index="${qIndex}">Delete</button>
                        `;
                        qNum++;
                    });
                }
            });

            if (qNum === 1) { // No questions were rendered
                questionsTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No questions loaded for this role. Click "Add Question" to start.</td></tr>';
            }

            // Attach listeners to dynamically created buttons
            document.querySelectorAll('.edit-question-btn').forEach(btn => btn.onclick = editQuestion);
            document.querySelectorAll('.delete-question-btn').forEach(btn => btn.onclick = deleteQuestion);
        }

        function openQuestionModal(title, question = null, section = '', index = -1) {
            questionModalTitle.textContent = title;
            questionDescInput.value = question ? question.desc : '';
            questionWeightageInput.value = question ? question.weightage : '';
            questionAutofailCheckbox.checked = question ? question.autofail : false;
            
            editingQuestionIndex = index;
            editingQuestionSection = section; // Store section for later update/add

            questionModalOverlay.classList.remove('hidden');
        }

        function closeQuestionModal() {
            questionModalOverlay.classList.add('hidden');
            // Reset state
            editingQuestionIndex = -1;
            editingQuestionSection = '';
        }

        function saveQuestion() {
            const desc = questionDescInput.value.trim();
            const weightage = parseInt(questionWeightageInput.value);
            const autofail = questionAutofailCheckbox.checked;

            if (!desc || isNaN(weightage) || weightage <= 0) {
                showMessageBox("Validation Error", "Please enter a valid description and weightage (must be positive number).", true, false, true);
                return;
            }

            const newQuestion = { desc, weightage, autofail };

            // Determine which section to add/edit in if not explicitly editing existing
            let targetSection = editingQuestionSection;
            if (!targetSection) { // If adding new, determine default section (or prompt user)
                if (currentEditingRoleQuestions['CUSTOMER EXPERIENCE'].length < 5) { // Arbitrary limit for CX
                    targetSection = 'CUSTOMER EXPERIENCE';
                } else if (currentEditingRoleQuestions['PROBLEM SOLVING SKILLS'].length < 6) { // Arbitrary limit for PS
                    targetSection = 'PROBLEM SOLVING SKILLS';
                } else { // Default to Compliance if others are full
                    targetSection = 'COMPLIANCE AND BUSINESS CRITICAL ACCURACY';
                }
            }


            if (editingQuestionIndex === -1) { // Adding new question
                // Check for duplicate description within the target section
                if (currentEditingRoleQuestions[targetSection].some(q => q.desc === desc)) {
                    showMessageBox("Duplicate Question", `A question with this description already exists in ${targetSection}.`, true, false, true);
                    return;
                }
                currentEditingRoleQuestions[targetSection].push(newQuestion);
            } else { // Editing existing question
                // Check for duplicate description if description changed
                const originalQuestion = currentEditingRoleQuestions[editingQuestionSection][editingQuestionIndex];
                if (originalQuestion.desc !== desc && currentEditingRoleQuestions[editingQuestionSection].some(q => q.desc === desc)) {
                     showMessageBox("Duplicate Question", `A question with this description already exists in ${editingQuestionSection}.`, true, false, true);
                     return;
                }
                currentEditingRoleQuestions[editingQuestionSection][editingQuestionIndex] = newQuestion;
            }

            renderQuestionsTable(); // Re-render table to show changes
            closeQuestionModal();
            saveRoleConfigBtn.disabled = false; // Enable save button to prompt user to save changes to Firestore
        }

        function editQuestion(event) {
            const section = event.target.dataset.section;
            const index = parseInt(event.target.dataset.index);
            const question = currentEditingRoleQuestions[section][index];
            openQuestionModal("Edit Question", question, section, index);
        }

        function deleteQuestion(event) {
            const section = event.target.dataset.section;
            const index = parseInt(event.target.dataset.index);

            showMessageBox("Confirm Delete", `Are you sure you want to delete "${currentEditingRoleQuestions[section][index].desc}"?`, false, false, false);
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Delete';
            confirmBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md mr-2';
            confirmBtn.onclick = () => {
                hideMessageBox();
                currentEditingRoleQuestions[section].splice(index, 1); // Remove from array
                renderQuestionsTable(); // Re-render table
                saveRoleConfigBtn.disabled = false; // Enable save
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md';
            cancelBtn.onclick = hideMessageBox;

            const messageBoxContent = document.getElementById('messageBoxContent'); // Get here for local use
            const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn'); // Get here for local use
            const originalMessageBoxContentHTML = messageBoxContent.innerHTML;

            messageBoxContent.innerHTML = '';
            messageBoxContent.appendChild(confirmBtn);
            messageBoxContent.appendChild(cancelBtn);
            messageBoxCloseBtn.onclick = () => { hideMessageBox(); messageBoxContent.innerHTML = originalMessageBoxContentHTML; };
        }


        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            // Check login state and show appropriate content
            const isLoggedIn = sessionStorage.getItem('loggedIn');
            if (isLoggedIn === 'true') {
                loginPage.style.display = 'none';
                mainNav.style.display = 'flex';
                adminContent.style.display = 'block'; // Show admin content
                loadFormConfigurations(); // Load configs on page load
            } else {
                loginPage.style.display = 'flex';
                mainNav.style.display = 'none';
                adminContent.style.display = 'none'; // Keep admin hidden
            }

            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                loginMessage.classList.add('hidden');

                const CORRECT_USERNAME = 'Supervisor';
                const CORRECT_PASSWORD = 'Supervisor';

                if (usernameInput.value === CORRECT_USERNAME && passwordInput.value === CORRECT_PASSWORD) {
                    sessionStorage.setItem('loggedIn', 'true');
                    loginPage.style.display = 'none';
                    mainNav.style.display = 'flex';
                    adminContent.style.display = 'block';
                    loadFormConfigurations(); // Load configs after login
                } else {
                    loginMessage.textContent = 'Invalid Username or Password. Please try again.';
                    loginMessage.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'index.html'; // Redirect to index/login
            });

            adminRoleSelect.addEventListener('change', (e) => {
                loadRoleQuestionsBtn.disabled = !e.target.value;
                questionsManagementSection.classList.add('hidden'); // Hide section until loaded
            });
            loadRoleQuestionsBtn.addEventListener('click', loadRoleQuestionsForEditing);
            addNewRoleBtn.addEventListener('click', addNewRole);
            saveRoleConfigBtn.addEventListener('click', saveRoleConfiguration);
            deleteRoleBtn.addEventListener('click', deleteRole);
            addNewQuestionBtn.addEventListener('click', () => openQuestionModal("Add New Question"));
            saveQuestionModalBtn.addEventListener('click', saveQuestion);
            cancelQuestionModalBtn.addEventListener('click', closeQuestionModal);

            // Hide question modal if overlay clicked directly (not the box)
            questionModalOverlay.addEventListener('click', (e) => {
                if (e.target === questionModalOverlay) {
                    closeQuestionModal();
                }
            });
        });

        // Listen for Firebase Auth readiness (from module script)
        document.addEventListener('firebaseAuthReady', () => {
            // Once Firebase is ready, if user is logged in, attempt to load configs
            if (sessionStorage.getItem('loggedIn') === 'true') {
                loadFormConfigurations();
            }
        });
    </script>
</body>
</html>
