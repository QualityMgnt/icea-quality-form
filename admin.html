<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6;
        }
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange {
            background-color: #f57c00;
            color: white;
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            background-color: #cbd5e1; /* gray-300 */
            color: #1f2937; /* gray-800 */
        }
        .tab-button.active {
            background-color: #1a73e8; /* icealion-blue */
            color: white;
        }
        .tab-button:hover:not(.active) {
            background-color: #94a3b8; /* gray-400 */
        }
        .user-table th, .user-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }
        .user-table th {
            background-color: #eff6ff;
            font-weight: 600;
            color: #1f2937;
        }
        .user-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .user-table tr:hover {
            background-color: #f3f4f6;
        }
        .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f9ff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="messageBoxOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle" class="text-xl font-semibold text-blue-600 mb-3"></h3>
            <p id="messageBoxContent" class="text-gray-700 mb-5"></p>
            <button id="messageBoxCloseBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md hidden">OK</button>
        </div>
    </div>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-4xl p-8 mt-8 mb-8">
        <div class="icealion-blue p-4 flex items-center justify-between mb-6">
            <div class="text-2xl font-semibold">ICEA LION GROUP Admin Portal</div>
            <img src="https://placehold.co/120x40/1a73e8/FFFFFF?text=ICEALION" alt="ICEALION Logo" class="h-10 rounded-md">
        </div>

        <div id="loginSection" class="w-full max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="loginEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div id="loginError" class="error-message hidden"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Login</button>
            </form>

            <p class="mt-4 text-center text-sm text-gray-600">
                Don't have an account? <a href="#" id="showRegisterForm" class="text-blue-600 hover:underline">Register</a>
            </p>
        </div>

        <div id="registerSection" class="w-full max-w-md mx-auto hidden">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Register New User</h2>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="registerEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                    <input type="password" id="registerPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div>
                    <label for="registerRole" class="block text-sm font-medium text-gray-700">Role:</label>
                    <select id="registerRole" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        <option value="">Select Role</option>
                        <option value="CER">CER</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div id="registerError" class="error-message hidden"></div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Register</button>
            </form>
            <p class="mt-4 text-center text-sm text-gray-600">
                Already have an account? <a href="#" id="showLoginForm" class="text-blue-600 hover:underline">Login</a>
            </p>
        </div>

        <div id="adminDashboard" class="hidden">
            <div class="flex space-x-2 border-b border-gray-200 mb-6">
                <button id="usersTabBtn" class="tab-button active">User Management</button>
                <button id="dropdownsTabBtn" class="tab-button">Dropdown Options</button>
                <button id="autofailsTabBtn" class="tab-button">Autofail Types</button>
                <button id="logoutAdminBtn" class="ml-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Logout</button>
            </div>

            <div id="usersContent" class="tab-content">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Manage Users</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white user-table rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="3" class="text-center py-4 text-gray-500">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Add New User</h4>
                    <form id="addNewUserForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="email" id="newEmail" placeholder="New User Email" class="p-2 border rounded-md" required>
                        <input type="password" id="newPassword" placeholder="Initial Password" class="p-2 border rounded-md" required>
                        <select id="newUserRole" class="p-2 border rounded-md" required>
                            <option value="">Select Role</option>
                            <option value="CER">CER</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Admin">Admin</option>
                        </select>
                        <button type="submit" class="col-span-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Add User</button>
                    </form>
                    <div id="addNewUserError" class="error-message hidden"></div>
                </div>
            </div>

            <div id="dropdownsContent" class="tab-content hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Manage Dropdown Options</h3>

                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">CER Names</h4>
                    <div id="cerNamesList" class="space-y-2 mb-2"></div>
                    <input type="text" id="newCerName" placeholder="Add new CER Name" class="p-2 border rounded-md w-full md:w-1/2">
                    <button class="add-option-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md mt-2" data-type="cerNames">Add</button>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">CER Roles</h4>
                    <div id="cerRolesList" class="space-y-2 mb-2"></div>
                    <input type="text" id="newCerRole" placeholder="Add new CER Role" class="p-2 border rounded-md w-full md:w-1/2">
                    <button class="add-option-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md mt-2" data-type="cerRoles">Add</button>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Reviewer Names</h4>
                    <div id="reviewerNamesList" class="space-y-2 mb-2"></div>
                    <input type="text" id="newReviewerName" placeholder="Add new Reviewer Name" class="p-2 border rounded-md w-full md:w-1/2">
                    <button class="add-option-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md mt-2" data-type="reviewerNames">Add</button>
                </div>

                 <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Autofail Types</h4>
                    <div id="autofailTypesList" class="space-y-2 mb-2"></div>
                    <input type="text" id="newAutofailType" placeholder="Add new Autofail Type" class="p-2 border rounded-md w-full md:w-1/2">
                    <button class="add-option-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md mt-2" data-type="autofailTypes">Add</button>
                </div>
            </div>

            <div id="autofailsContent" class="tab-content hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Manage Autofail Rules</h3>
                <p class="text-gray-600 mb-4">
                    This section would allow adding, editing, and deleting specific autofail rules.
                    (e.g., if "Improper Authentication" is selected, score becomes 0).
                    For this prototype, it's a placeholder for future functionality.
                </p>
                <div class="mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Current Autofail Rules (Conceptual)</h4>
                    <ul class="list-disc list-inside text-gray-700">
                        <li>Improper Authentication -> Overall Score = 0%</li>
                        <li>Data Capture Error -> Overall Score = 0%</li>
                        </ul>
                </div>
                <div class="mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Add New Autofail Rule</h4>
                    <form id="addAutofailRuleForm" class="space-y-3">
                        <input type="text" placeholder="Rule Name (e.g., Data Breach)" class="p-2 border rounded-md w-full">
                        <textarea placeholder="Description (e.g., Disclosure of sensitive customer data)" rows="2" class="p-2 border rounded-md w-full"></textarea>
                        <select class="p-2 border rounded-md w-full">
                            <option value="">Set Score to</option>
                            <option value="0">0% (Critical Fail)</option>
                            </select>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Add Rule</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            deleteDoc,
            doc,
            onSnapshot,
            query,
            where,
            setDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Firebase Configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // !!! REPLACE THIS !!!
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.firebasestorage.app",
            messagingSenderId: "820082472004",
            appId: "1:820082472004:web:8caddf941e1b5b661d76c94e",
            measurementId: "G-1RJJTT3QET"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global app ID for collection paths (consistent with index.html)
        window.appId = firebaseConfig.appId;

        // Firebase Collection Paths (consistent with index.html)
        const USERS_COLLECTION_PATH = `artifacts/${window.appId}/users`;
        const DROPDOWN_OPTIONS_COLLECTION_PATH = `artifacts/${window.appId}/public/data/dropdown_options`;
        // Autofail Types will be managed via the dropdown_options collection for simplicity in this prototype.
        // If you want a separate collection for Autofail rules with more complex properties,
        // you would define AUTOFAIL_RULES_COLLECTION_PATH here.

        // --- DOM Elements ---
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const adminDashboard = document.getElementById('adminDashboard');

        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');

        const registerForm = document.getElementById('registerForm');
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const registerRole = document.getElementById('registerRole');
        const registerError = document.getElementById('registerError');
        const showRegisterFormBtn = document.getElementById('showRegisterForm');
        const showLoginFormBtn = document.getElementById('showLoginForm');

        const usersTabBtn = document.getElementById('usersTabBtn');
        const dropdownsTabBtn = document.getElementById('dropdownsTabBtn');
        const autofailsTabBtn = document.getElementById('autofailsTabBtn');
        const logoutAdminBtn = document.getElementById('logoutAdminBtn');

        const userTableBody = document.getElementById('userTableBody');
        const addNewUserForm = document.getElementById('addNewUserForm');
        const addNewUserError = document.getElementById('addNewUserError');

        const cerNamesList = document.getElementById('cerNamesList');
        const cerRolesList = document.getElementById('cerRolesList');
        const reviewerNamesList = document.getElementById('reviewerNamesList');
        const autofailTypesList = document.getElementById('autofailTypesList'); // For autofail types dropdown


        // --- Message Box Functions (copied from index.html for consistency) ---
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxSpinner = document.getElementById('messageBoxSpinner');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxContent = document.getElementById('messageBoxContent');
            const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;

            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            messageBoxTitle.style.color = isError ? '#dc2626' : '#1a73e8';

            messageBoxCloseBtn.onclick = () => {
                messageBoxOverlay.classList.add('hidden');
                if (onClose) onClose();
            };
        }

        function hideMessageBox() {
            document.getElementById('messageBoxOverlay').classList.add('hidden');
        }

        // --- Session Management (consistent with index.html) ---
        window.checkSessionTimeout = function() {
            const lastActivity = localStorage.getItem('lastActivity');
            const loginTime = localStorage.getItem('loginTime');
            if (lastActivity && loginTime) {
                const now = new Date().getTime();
                const eightHours = 8 * 60 * 60 * 1000; // 8 hours in milliseconds

                if ((now - parseInt(lastActivity) > eightHours) || (now - parseInt(loginTime) > eightHours)) {
                    console.log("Session expired. Logging out.");
                    localStorage.removeItem('lastActivity');
                    localStorage.removeItem('loginTime');
                    sessionStorage.removeItem('loggedIn');
                    return true;
                }
            }
            return false;
        };

        window.updateLastActivity = function() {
            localStorage.setItem('lastActivity', new Date().getTime().toString());
        };

        document.addEventListener('mousemove', window.updateLastActivity);
        document.addEventListener('keydown', window.updateLastActivity);
        document.addEventListener('click', window.updateLastActivity);


        // --- Auth State Listener ---
        let currentAdminUser = null; // Store current logged-in admin user object
        let currentAdminUserRole = null;

        onAuthStateChanged(auth, async (user) => {
            if (window.checkSessionTimeout()) {
                await signOut(auth); // Clear any expired Firebase session
                return;
            }

            if (user) {
                const userDocRef = doc(db, USERS_COLLECTION_PATH, user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    currentAdminUserRole = userData.role;
                    currentAdminUser = user; // Store the user object
                    console.log(`User ${user.email} logged in with role: ${currentAdminUserRole}`);

                    // If logged in as Admin, show dashboard, otherwise redirect to main app
                    if (currentAdminUserRole === 'Admin') {
                        loginSection.classList.add('hidden');
                        registerSection.classList.add('hidden'); // Ensure register section is hidden
                        adminDashboard.classList.remove('hidden');
                        loadAdminDashboard(); // Load all admin data
                        showAdminTab('usersContent'); // Default to Users tab
                    } else {
                        // NON-ADMIN USER REDIRECTION TO EVALUATION FORM
                        sessionStorage.setItem('loggedIn', 'true'); // Indicate successful login for main app
                        localStorage.setItem('loginTime', new Date().getTime().toString()); // Record login time
                        showMessageBox("Login Successful", "Redirecting to Evaluation Form...", false, false, false);
                        window.location.href = 'index.html'; // Redirect non-admin users
                    }
                } else {
                    console.warn(`User profile for ${user.email} not found in Firestore. Logging out.`);
                    await signOut(auth); // Log them out from Firebase Auth
                    showMessageBox("Access Denied", "User profile missing. Please contact administrator.", true);
                    // After message, show login form again
                    showLoginForm();
                }
            } else {
                currentAdminUser = null;
                currentAdminUserRole = null;
                console.log("No user logged in to admin portal.");
                // Ensure login/register forms are visible if no one is logged in
                showLoginForm();
                adminDashboard.classList.add('hidden'); // Ensure dashboard is hidden
            }
        });

        // --- Login/Register Form Toggles ---
        function showLoginForm() {
            loginSection.classList.remove('hidden');
            registerSection.classList.add('hidden');
            loginError.classList.add('hidden');
            registerError.classList.add('hidden');
        }

        function showRegisterForm() {
            loginSection.classList.add('hidden');
            registerSection.classList.remove('hidden');
            loginError.classList.add('hidden');
            registerError.classList.add('hidden');
        }

        showRegisterFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterForm();
        });

        showLoginFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showLoginForm();
        });

        // --- Login Form Submission ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden'); // Hide any previous errors
            const email = loginEmail.value;
            const password = loginPassword.value;

            showMessageBox("Logging In", "Please wait...", false, true, false); // Show loading spinner

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Fetch user role immediately after successful login from Firestore
                const userDocRef = doc(db, USERS_COLLECTION_PATH, user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    currentAdminUserRole = userData.role; // Update global role
                    currentAdminUser = user; // Store user object
                    sessionStorage.setItem('loggedIn', 'true'); // Mark session as logged in
                    localStorage.setItem('loginTime', new Date().getTime().toString()); // Record login time

                    if (currentAdminUserRole === 'Admin') {
                        hideMessageBox();
                        loginSection.classList.add('hidden');
                        adminDashboard.classList.remove('hidden');
                        loadAdminDashboard(); // Fetch data for dashboard
                        showAdminTab('usersContent'); // Default to Users tab after admin login
                    } else {
                        // NON-ADMIN USER REDIRECTION TO EVALUATION FORM
                        hideMessageBox();
                        showMessageBox("Login Successful", "Redirecting to Evaluation Form...", false, false, false);
                        window.location.href = 'index.html'; // Redirect non-admin users
                    }
                } else {
                    // User authenticated with Firebase Auth but no role document found in Firestore
                    await signOut(auth); // Log them out from Firebase Auth
                    hideMessageBox();
                    loginError.textContent = "User profile incomplete. Please contact administrator.";
                    loginError.classList.remove('hidden');
                }

            } catch (error) {
                hideMessageBox(); // Hide spinner
                let errorMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else {
                    errorMessage = `Error: ${error.message}`; // Catch other Firebase errors
                }
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
            }
        });

        // --- Register Form Submission (Admins only after initial login) ---
        // This form is intended for an already logged-in Admin to create new users.
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            registerError.classList.add('hidden');

            // Ensure only an Admin can use this registration form
            if (currentAdminUserRole !== 'Admin') {
                registerError.textContent = "Access Denied: Only administrators can register new users.";
                registerError.classList.remove('hidden');
                return;
            }

            const email = registerEmail.value;
            const password = registerPassword.value;
            const role = registerRole.value;

            if (!role) {
                registerError.textContent = "Please select a role for the new user.";
                registerError.classList.remove('hidden');
                return;
            }

            showMessageBox("Registering User", "Please wait...", false, true, false);

            try {
                // Creates user in Firebase Authentication. Note: For robust production apps,
                // user creation by admin is often done via Firebase Admin SDK (Node.js backend)
                // which handles creating users without needing their password on the client-side.
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Store user's role in Firestore after creation
                await setDoc(doc(db, USERS_COLLECTION_PATH, user.uid), {
                    email: user.email,
                    role: role,
                    createdAt: new Date().toISOString()
                });

                hideMessageBox();
                showMessageBox("Success", `New user ${email} registered as ${role}!`, false, false, true, () => {
                    registerForm.reset(); // Clear the form
                    loadUsers(); // Refresh the user list in the dashboard
                });

            } catch (error) {
                hideMessageBox();
                let errorMessage = "Registration failed.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak (min 6 characters).";
                } else if (error.code) {
                    errorMessage = `Error: ${error.message}`;
                }
                registerError.textContent = errorMessage;
                registerError.classList.remove('hidden');
            }
        });

        // --- Admin Dashboard Tabs Logic ---
        function showAdminTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.remove('hidden');
            // Ensure the correct button gets the 'active' class
            if (tabId === 'usersContent') usersTabBtn.classList.add('active');
            else if (tabId === 'dropdownsContent') dropdownsTabBtn.classList.add('active');
            else if (tabId === 'autofailsContent') autofailsTabBtn.classList.add('active');
        }

        usersTabBtn.addEventListener('click', () => showAdminTab('usersContent'));
        dropdownsTabBtn.addEventListener('click', () => showAdminTab('dropdownsContent'));
        autofailsTabBtn.addEventListener('click', () => showAdminTab('autofailsContent'));
        
        logoutAdminBtn.addEventListener('click', async () => {
            await signOut(auth);
            sessionStorage.removeItem('loggedIn'); // Clear session
            localStorage.removeItem('lastActivity'); // Clear activity
            localStorage.removeItem('loginTime'); // Clear login time
            window.location.href = 'admin.html'; // Redirect to login page after logout
        });

        // --- Load Admin Dashboard Data ---
        async function loadAdminDashboard() {
            // This function is only called if currentAdminUserRole is 'Admin'
            // no need for additional role check here.
            showMessageBox("Loading Admin Data", "Fetching user data and configurations...", false, true, false);
            try {
                await Promise.all([loadUsers(), loadDropdownOptions()]); // Removed loadAutofailTypes for now as it's just conceptual text
                hideMessageBox();
            } catch (error) {
                hideMessageBox();
                showMessageBox("Error Loading Data", `Failed to load admin data: ${error.message}`, true);
            }
        }

        // --- User Management Functions ---
        async function loadUsers() {
            userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Loading users...</td></tr>';
            try {
                const q = query(collection(db, USERS_COLLECTION_PATH));
                const querySnapshot = await getDocs(q);
                userTableBody.innerHTML = ''; // Clear loading message

                if (querySnapshot.empty) {
                    userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No users found.</td></tr>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const userData = docSnap.data();
                    const userId = docSnap.id;
                    const row = userTableBody.insertRow();
                    row.innerHTML = `
                        <td>${userData.email}</td>
                        <td>
                            <select class="user-role-select p-1 border rounded-md" data-user-id="${userId}">
                                <option value="CER" ${userData.role === 'CER' ? 'selected' : ''}>CER</option>
                                <option value="Supervisor" ${userData.role === 'Supervisor' ? 'selected' : ''}>Supervisor</option>
                                <option value="Admin" ${userData.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                        <td>
                            <button class="delete-user-btn bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded-md" data-user-id="${userId}">Delete</button>
                        </td>
                    `;
                    // Attach event listeners to dynamically created elements
                    row.querySelector('.user-role-select').addEventListener('change', (e) => updateRole(userId, e.target.value));
                    row.querySelector('.delete-user-btn').addEventListener('click', (e) => deleteUser(userId, userData.email));
                });
            } catch (error) {
                console.error("Error loading users:", error);
                userTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading users: ${error.message}</td></tr>`;
            }
        }

        async function updateRole(userId, newRole) {
            // Prevent an admin from demoting themselves
            if (currentAdminUser && currentAdminUser.uid === userId && newRole !== 'Admin') {
                showMessageBox("Action Blocked", "You cannot demote your own admin role. Please ask another admin to change your role.", true);
                loadUsers(); // Revert selection by reloading users
                return;
            }
            if (!confirm(`Are you sure you want to change the role of user ${userId} to ${newRole}?`)) {
                loadUsers(); // Revert selection if cancelled
                return;
            }
            showMessageBox("Updating Role", "Updating user role...", false, true, false);
            try {
                const userDocRef = doc(db, USERS_COLLECTION_PATH, userId);
                await updateDoc(userDocRef, { role: newRole });
                hideMessageBox();
                showMessageBox("Success", "User role updated successfully!", false);
            } catch (error) {
                hideMessageBox();
                showMessageBox("Error", `Failed to update role: ${error.message}`, true);
            }
        }

        async function deleteUser(userId, userEmail) {
            // Prevent an admin from deleting themselves
            if (currentAdminUser && currentAdminUser.uid === userId) {
                showMessageBox("Action Blocked", "You cannot delete your own user account from here.", true);
                return;
            }
            if (!confirm(`Are you sure you want to delete user ${userEmail}? This action cannot be undone and will not delete the Firebase Authentication user.`)) {
                return;
            }
            showMessageBox("Deleting User", "Deleting user...", false, true, false);
            try {
                // Delete user document from Firestore
                await deleteDoc(doc(db, USERS_COLLECTION_PATH, userId));
                // NOTE: Deleting the actual user from Firebase Authentication requires
                // calling `admin.auth().deleteUser(uid)` from a secure backend (e.g., Firebase Cloud Function).
                // Client-side JavaScript cannot directly delete other users from Firebase Auth.
                hideMessageBox();
                showMessageBox("Success", `User ${userEmail} document deleted from Firestore! (Manual Firebase Authentication user deletion may be required.)`, false);
                loadUsers(); // Refresh user list
            } catch (error) {
                hideMessageBox();
                showMessageBox("Error", `Failed to delete user: ${error.message}`, true);
            }
        }

        // --- Add New User Form Submission ---
        addNewUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addNewUserError.classList.add('hidden');
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!role) {
                addNewUserError.textContent = "Please select a role.";
                addNewUserError.classList.remove('hidden');
                return;
            }

            showMessageBox("Adding User", "Creating user account...", false, true, false);

            try {
                // Client-side user creation in Firebase Authentication.
                // Firebase security rules should be configured to prevent non-admins
                // from creating users if this form is ever accessed by non-admins.
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Store user's role in Firestore after creation
                await setDoc(doc(db, USERS_COLLECTION_PATH, user.uid), {
                    email: user.email,
                    role: role,
                    createdAt: new Date().toISOString()
                });

                hideMessageBox();
                showMessageBox("Success", `New user ${email} (${role}) added successfully!`, false, false, true, () => {
                    addNewUserForm.reset(); // Clear the form
                    loadUsers(); // Refresh the user list in the dashboard
                });

            } catch (error) {
                hideMessageBox();
                let errorMessage = "Failed to add user.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak (min 6 characters).";
                } else if (error.code) {
                    errorMessage = `Error: ${error.message}`;
                }
                addNewUserError.textContent = errorMessage;
                addNewUserError.classList.remove('hidden');
            }
        });


        // --- Dropdown Options Management Functions ---
        // These functions manage options stored in a single Firestore document 'options'
        // within the DROPDOWN_OPTIONS_COLLECTION_PATH.
        // E.g., 'options' document might look like: { cerNames: [], cerRoles: [], reviewerNames: [], autofailTypes: [] }
        async function loadDropdownOptions() {
            // Note: Removed the showMessageBox during loading of dropdown options within loadAdminDashboard()
            // to avoid nested message boxes when dashboard loads.
            try {
                const docSnap = await getDoc(doc(db, DROPDOWN_OPTIONS_COLLECTION_PATH, 'options')); // Assuming one document stores all options
                const data = docSnap.exists() ? docSnap.data() : {};

                renderDropdownList(data.cerNames || [], cerNamesList, 'cerNames');
                renderDropdownList(data.cerRoles || [], cerRolesList, 'cerRoles');
                renderDropdownList(data.reviewerNames || [], reviewerNamesList, 'reviewerNames');
                renderDropdownList(data.autofailTypes || [], autofailTypesList, 'autofailTypes');

            } catch (error) {
                console.error("Error loading dropdown options:", error);
                showMessageBox("Error", `Failed to load dropdown options: ${error.message}`, true);
            }
        }

        function renderDropdownList(optionsArray, containerElement, type) {
            containerElement.innerHTML = ''; // Clear existing list
            if (optionsArray.length === 0) {
                containerElement.innerHTML = `<p class="text-gray-500 text-sm">No ${type} defined yet.</p>`;
                return;
            }
            optionsArray.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.innerHTML = `
                    <span>${option}</span>
                    <button class="delete-option-btn bg-red-400 hover:bg-red-500 text-white text-xs px-2 py-1 rounded-md" data-index="${index}" data-type="${type}">Delete</button>
                `;
                containerElement.appendChild(div);
            });
            // Attach event listeners after all buttons are created
            containerElement.querySelectorAll('.delete-option-btn').forEach(btn => {
                btn.addEventListener('click', deleteDropdownOption);
            });
        }

        document.querySelectorAll('.add-option-btn').forEach(button => {
            button.addEventListener('click', addDropdownOption);
        });

        async function addDropdownOption(e) {
            const type = e.target.dataset.type; // e.g., 'cerNames', 'cerRoles'
            let inputElement;
            if (type === 'cerNames') inputElement = document.getElementById('newCerName');
            else if (type === 'cerRoles') inputElement = document.getElementById('newCerRole');
            else if (type === 'reviewerNames') inputElement = document.getElementById('newReviewerName');
            else if (type === 'autofailTypes') inputElement = document.getElementById('newAutofailType');

            const newValue = inputElement.value.trim();
            if (!newValue) {
                showMessageBox("Input Required", `Please enter a value for ${type}.`, true);
                return;
            }

            showMessageBox("Adding Option", "Saving new option...", false, true, false);
            try {
                const docRef = doc(db, DROPDOWN_OPTIONS_COLLECTION_PATH, 'options');
                const docSnap = await getDoc(docRef);
                const currentOptions = docSnap.exists() ? docSnap.data() : {};
                const optionsArray = currentOptions[type] || [];

                if (optionsArray.includes(newValue)) {
                    hideMessageBox();
                    showMessageBox("Duplicate", `${newValue} already exists in ${type}.`, false);
                    inputElement.value = '';
                    return;
                }

                optionsArray.push(newValue);
                // Update specific field in the document without overwriting others
                await updateDoc(docRef, { [type]: optionsArray });

                hideMessageBox();
                showMessageBox("Success", `${newValue} added to ${type}!`, false, false, true, () => {
                    inputElement.value = '';
                    loadDropdownOptions(); // Refresh all dropdown lists
                });
            } catch (error) {
                hideMessageBox();
                showMessageBox("Error", `Failed to add option: ${error.message}`, true);
            }
        }

        async function deleteDropdownOption(e) {
            const index = parseInt(e.target.dataset.index);
            const type = e.target.dataset.type;

            if (!confirm(`Are you sure you want to delete this option from ${type}?`)) {
                return;
            }

            showMessageBox("Deleting Option", "Removing option...", false, true, false);
            try {
                const docRef = doc(db, DROPDOWN_OPTIONS_COLLECTION_PATH, 'options');
                const docSnap = await getDoc(docRef);
                const currentOptions = docSnap.exists() ? docSnap.data() : {};
                const optionsArray = currentOptions[type] || [];

                if (index > -1 && index < optionsArray.length) {
                    optionsArray.splice(index, 1);
                    await updateDoc(docRef, { [type]: optionsArray });

                    hideMessageBox();
                    showMessageBox("Success", "Option deleted successfully!", false, false, true, () => {
                        loadDropdownOptions(); // Refresh all dropdown lists
                    });
                } else {
                    hideMessageBox();
                    showMessageBox("Error", "Option not found.", true);
                }
            } catch (error) {
                hideMessageBox();
                showMessageBox("Error", `Failed to delete option: ${error.message}`, true);
            }
        }

        // --- Autofail Types Management (Conceptual for now) ---
        // This function is called but currently just logs a message.
        // In a full implementation, you'd add logic here to fetch, display,
        // and allow editing of detailed autofail rules if they are more than just types.
        async function loadAutofailTypes() {
             console.log("Autofail Rules Management section loaded (conceptual).");
        }

        // --- Initial Page Load Setup ---
        // This onAuthStateChanged handles the initial display based on session status
        // and prevents flashing of login/dashboard before Firebase confirms auth state.
        // It's the primary entry point for displaying UI after page load.
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in. Their role needs to be determined from Firestore.
                // The main onAuthStateChanged listener (at the very top of the script)
                // already handles this: it fetches the role, then decides whether to
                // show the admin dashboard or redirect to index.html.
                // No additional action needed directly here.
            } else {
                // No user is signed in. Display the login form.
                showLoginForm();
                adminDashboard.classList.add('hidden'); // Ensure dashboard is hidden
            }
        });
    </script>
</body>
</html>
