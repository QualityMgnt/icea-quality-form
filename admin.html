document.addEventListener('DOMContentLoaded', function() {
    // --- Constants ---
    // IMPORTANT: This URL should be the deployed URL of your Google Apps Script Web App.
    // Ensure the Apps Script is deployed as a Web App accessible by "Anyone, even anonymous".
    // For production, consider using a more secure authentication mechanism and dedicated backend.
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhmxq-pQ8NUpSNg-xAkJWRW_LEUKbw5NOzUunt-j4EO7QIEJnKjWRdclvNjYMXL2kJvg/exec';

    // --- DOM Element References ---
    const loginPage = document.getElementById('loginPage');
    const loginForm = document.getElementById('loginForm');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');

    const adminContent = document.getElementById('adminContent');
    const mainNav = document.getElementById('mainNav');
    const logoutBtn = document.getElementById('logoutBtn');

    const dropdownTypeSelect = document.getElementById('dropdownTypeSelect');
    const dropdownValueInputGroup = document.getElementById('dropdownValueInputGroup');
    const currentDropdownItemsList = document.getElementById('currentDropdownItems'); // Renamed for clarity
    const newDropdownValueInput = document.getElementById('newDropdownValue');
    const addDropdownValueBtn = document.getElementById('addDropdownValueBtn');
    const removeDropdownValueBtn = document.getElementById('removeDropdownValueBtn');
    const dropdownMessage = document.getElementById('dropdownMessage');

    const newUsernameInput = document.getElementById('newUsername');
    const newPasswordInput = document.getElementById('newPassword');
    const newUserRoleSelect = document.getElementById('newUserRole');
    const createUserBtn = document.getElementById('createUserBtn');
    const userMessage = document.getElementById('userMessage');
    const existingUsersList = document.getElementById('existingUsersList');

    // --- State Variables ---
    let currentSelectedDropdownType = '';

    // --- Utility Functions ---

    /**
     * Displays a message to the user, fading out after a delay.
     * @param {HTMLElement} element - The DOM element to display the message in.
     * @param {string} message - The message text.
     * @param {'success' | 'error'} type - The type of message for styling.
     * @param {number} [duration=5000] - Duration in milliseconds before hiding.
     */
    const showMessage = (element, message, type, duration = 5000) => {
        element.textContent = message;
        element.classList.remove('hidden', 'success', 'error');
        element.classList.add(type);
        setTimeout(() => {
            element.classList.add('hidden');
        }, duration);
    };

    /**
     * Hides the login error message.
     */
    const hideLoginErrorMessage = () => {
        loginMessage.classList.add('hidden');
        loginMessage.textContent = '';
    };

    /**
     * Fetches and renders dropdown options for the given type.
     * @param {string} type - The type of dropdown ('cerNames', 'cerRoles', etc.).
     */
    async function fetchAndRenderDropdownOptions(type) {
        currentDropdownItemsList.innerHTML = '<li>Loading...</li>';
        try {
            const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getDropdownOptions&type=${type}`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();

            currentDropdownItemsList.innerHTML = ''; // Clear previous list

            if (data.status === 'SUCCESS' && Array.isArray(data.options)) {
                if (data.options.length === 0) {
                    currentDropdownItemsList.innerHTML = '<li>No items found.</li>';
                } else {
                    data.options.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        li.classList.add('cursor-pointer', 'hover:bg-blue-100'); // Add hover effect
                        li.addEventListener('click', () => {
                            li.classList.toggle('bg-blue-200'); // Highlight/unhighlight
                        });
                        currentDropdownItemsList.appendChild(li);
                    });
                }
            } else {
                showMessage(dropdownMessage, `Error fetching options: ${data.message || 'Unknown error'}`, 'error');
                currentDropdownItemsList.innerHTML = '<li>Failed to load items.</li>';
            }
        } catch (error) {
            console.error('Fetch dropdown options error:', error);
            showMessage(dropdownMessage, 'Network error fetching options. Check console for details.', 'error');
            currentDropdownItemsList.innerHTML = '<li>Network error.</li>';
        }
    }

    /**
     * Fetches and renders the list of existing users.
     */
    async function fetchAndRenderUsers() {
        existingUsersList.innerHTML = '<li>Loading users...</li>';
        try {
            const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getUsers`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();

            existingUsersList.innerHTML = ''; // Clear previous list

            if (data.status === 'SUCCESS' && Array.isArray(data.users)) {
                if (data.users.length === 0) {
                    existingUsersList.innerHTML = '<li>No users found.</li>';
                } else {
                    data.users.forEach(user => {
                        const li = document.createElement('li');
                        li.classList.add('flex', 'items-center', 'justify-between', 'gap-2'); // Tailwind flex classes
                        li.innerHTML = `
                            <span>${user.Username} (${user.Role})</span>
                            <button class="admin-btn admin-btn-danger text-sm px-2 py-1">Remove</button>
                        `;
                        const removeBtn = li.querySelector('button');
                        removeBtn.addEventListener('click', async () => {
                            if (confirm(`Are you sure you want to remove user "${user.Username}"?`)) {
                                removeBtn.textContent = 'Removing...';
                                removeBtn.disabled = true;
                                await removeUser(user.Username);
                            }
                        });
                        existingUsersList.appendChild(li);
                    });
                }
            } else {
                showMessage(userMessage, `Error fetching users: ${data.message || 'Unknown error'}`, 'error');
                existingUsersList.innerHTML = '<li>Failed to load users.</li>';
            }
        } catch (error) {
            console.error('Fetch users error:', error);
            showMessage(userMessage, 'Network error fetching users. Check console for details.', 'error');
            existingUsersList.innerHTML = '<li>Network error.</li>';
        }
    }

    /**
     * Removes a user via the Apps Script.
     * @param {string} username - The username to remove.
     */
    async function removeUser(username) {
        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'removeUser', username: username })
            });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status === 'SUCCESS') {
                showMessage(userMessage, 'User removed successfully!', 'success');
                await fetchAndRenderUsers(); // Re-fetch and render the updated list
            } else {
                showMessage(userMessage, `Failed to remove user: ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('Remove user error:', error);
            showMessage(userMessage, 'Network error removing user. Check console for details.', 'error');
        }
    }

    // --- Authentication Flow ---

    /**
     * Initializes the admin panel after successful login.
     */
    const initializeAdminPanel = () => {
        loginPage.style.display = 'none';
        adminContent.style.display = 'block';
        mainNav.style.display = 'flex';
        fetchAndRenderUsers(); // Load users on admin page load
        // Trigger change event to load default dropdown if any is pre-selected or first option
        if (dropdownTypeSelect.value) {
            fetchAndRenderDropdownOptions(dropdownTypeSelect.value);
            dropdownValueInputGroup.style.display = 'block';
        } else {
             // If no default value, hide the input group initially
            dropdownValueInputGroup.style.display = 'none';
        }
    };

    // Check for login status on admin.html load
    const isLoggedIn = sessionStorage.getItem('loggedIn');
    if (isLoggedIn === 'true') {
        initializeAdminPanel();
    } else {
        loginPage.style.display = 'flex';
        adminContent.style.display = 'none';
        mainNav.style.display = 'none';
    }

    // --- Event Listeners ---

    // Login Form Submission
    if (loginForm) {
        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            hideLoginErrorMessage();

            const username = usernameInput.value;
            const password = passwordInput.value;

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                if (data.status === 'SUCCESS' && data.authenticated) {
                    sessionStorage.setItem('loggedIn', 'true');
                    initializeAdminPanel(); // Directly initialize UI instead of reloading
                } else {
                    showMessage(loginMessage, 'Invalid username or password.', 'error');
                }
            } catch (error) {
                console.error('Authentication Error:', error);
                showMessage(loginMessage, 'An error occurred during login. Please try again. Check console for details.', 'error');
            }
        });
    }

    // Logout functionality
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            sessionStorage.removeItem('loggedIn');
            // Redirect to index.html to ensure consistent login state management
            window.location.href = 'index.html';
        });
    }

    // Dropdown type selection change
    if (dropdownTypeSelect) {
        dropdownTypeSelect.addEventListener('change', function() {
            currentSelectedDropdownType = this.value;
            currentDropdownItemsList.innerHTML = ''; // Clear previous list
            dropdownValueInputGroup.style.display = 'none';
            dropdownMessage.classList.add('hidden');

            if (currentSelectedDropdownType) {
                fetchAndRenderDropdownOptions(currentSelectedDropdownType);
                dropdownValueInputGroup.style.display = 'block';
            }
        });
    }

    // Add Dropdown Value button
    if (addDropdownValueBtn) {
        addDropdownValueBtn.addEventListener('click', async function() {
            const newValue = newDropdownValueInput.value.trim();
            if (!currentSelectedDropdownType) {
                showMessage(dropdownMessage, 'Please select a dropdown type first.', 'error');
                return;
            }
            if (!newValue) {
                showMessage(dropdownMessage, 'Value cannot be empty.', 'error');
                return;
            }

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'addDropdownOption', type: currentSelectedDropdownType, value: newValue })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'SUCCESS') {
                    showMessage(dropdownMessage, 'Value added successfully!', 'success');
                    newDropdownValueInput.value = '';
                    await fetchAndRenderDropdownOptions(currentSelectedDropdownType);
                } else {
                    showMessage(dropdownMessage, `Failed to add value: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Add dropdown value error:', error);
                showMessage(dropdownMessage, 'Network error adding value. Check console for details.', 'error');
            }
        });
    }

    // Remove Dropdown Value button
    if (removeDropdownValueBtn) {
        removeDropdownValueBtn.addEventListener('click', async function() {
            const selectedItems = Array.from(currentDropdownItemsList.children)
                .filter(li => li.classList.contains('bg-blue-200'))
                .map(li => li.textContent.trim());

            if (!currentSelectedDropdownType) {
                showMessage(dropdownMessage, 'Please select a dropdown type first.', 'error');
                return;
            }
            if (selectedItems.length === 0) {
                showMessage(dropdownMessage, 'Please select at least one item to remove.', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to remove these ${selectedItems.length} item(s)?`)) {
                return;
            }

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'removeDropdownOption', type: currentSelectedDropdownType, values: selectedItems })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'SUCCESS') {
                    showMessage(dropdownMessage, 'Value(s) removed successfully!', 'success');
                    await fetchAndRenderDropdownOptions(currentSelectedDropdownType);
                } else {
                    showMessage(dropdownMessage, `Failed to remove value(s): ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Remove dropdown value error:', error);
                showMessage(dropdownMessage, 'Network error removing value(s). Check console for details.', 'error');
            }
        });
    }

    // Create User button
    if (createUserBtn) {
        createUserBtn.addEventListener('click', async function() {
            const username = newUsernameInput.value.trim();
            const password = newPasswordInput.value.trim();
            const role = newUserRoleSelect.value;

            if (!username || !password) {
                showMessage(userMessage, 'Username and password cannot be empty.', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to create user "${username}" with role "${role}"?`)) {
                return;
            }

            createUserBtn.textContent = 'Creating...';
            createUserBtn.disabled = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'createUser', username: username, password: password, role: role })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'SUCCESS') {
                    showMessage(userMessage, 'User created successfully!', 'success');
                    newUsernameInput.value = '';
                    newPasswordInput.value = '';
                    newUserRoleSelect.value = 'User'; // Reset to default
                    await fetchAndRenderUsers();
                } else {
                    showMessage(userMessage, `Failed to create user: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Create user error:', error);
                showMessage(userMessage, 'Network error creating user. Check console for details.', 'error');
            } finally {
                createUserBtn.textContent = 'Create User';
                createUserBtn.disabled = false;
            }
        });
    }
});
