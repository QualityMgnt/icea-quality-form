<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autofail Records - ICEA LION GROUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ICEALION Branding Colors */
        .icealion-blue {
            background-color: #1a73e8;
            color: white;
        }
        .icealion-orange-text {
            color: #f57c00;
        }

        /* Error/Message styles */
        .error-message {
            color: #dc2626; /* red-700 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }

        /* Navigation styles */
        .main-nav {
            width: 100%;
            background-color: #1a73e8;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .main-nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .main-nav ul li {
            margin-right: 1.5rem;
        }
        .main-nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.3s ease;
        }
        .main-nav ul li a:hover,
        .main-nav ul li a.active {
            background-color: #0d47a1; /* A darker blue for hover/active */
        }
        .logout-button {
            background-color: #f57c00; /* icealion-orange */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background-color: #e65100; /* darker orange */
        }

        /* Report specific styles */
        .autofail-section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .autofail-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937; /* gray-800 */
        }
        .autofail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .autofail-table th, .autofail-table td {
            border: 1px solid #e5e7eb; /* gray-300 */
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        .autofail-table th {
            background-color: #eff6ff; /* blue-50 */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
        }
        .autofail-table tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        .autofail-table tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .autofail-table .action-btn {
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            margin-right: 0.25rem;
        }
        .autofail-table .review-btn {
            background-color: #4CAF50; /* Green */
            color: white;
        }
        .autofail-table .review-btn:hover {
            background-color: #388E3C;
        }
        .autofail-table .delete-btn {
            background-color: #EF4444; /* Red */
            color: white;
        }
        .autofail-table .delete-btn:hover {
            background-color: #DC2626;
        }
        .autofail-table .email-btn {
            background-color: #F57C00; /* Orange */
            color: white;
        }
        .autofail-table .email-btn:hover {
            background-color: #E65100;
        }
            /* Specific styles for modal/message box */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a73e8; /* icealion-blue */
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .message-box button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0d47a1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="messageBoxOverlay" class="message-box-overlay hidden">
        <div class="message-box">
            <div id="messageBoxSpinner" class="spinner hidden"></div>
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button id="messageBoxCloseBtn" class="hidden">OK</button>
        </div>
    </div>

    <div class="login-container absolute inset-0 flex items-center justify-center p-4 md:p-8 z-10" id="loginPage">
        <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-md">
            <div class="icealion-blue p-6 rounded-t-lg text-center">
                <h1 class="text-2xl font-semibold">ICEALION GROUP Login</h1>
            </div>

            <form id="loginForm" class="p-8 space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your username">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border"
                           required placeholder="Enter your password">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Login
                </button>
                <div id="loginMessage" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <nav class="main-nav" id="mainNav" style="display: none;">
        <ul>
            <li><a href="index.html" id="auditFormTab"><i class="fas fa-file-alt"></i> Audit Form</a></li>
            <li><a href="index.html#database" id="databaseTab"><i class="fas fa-database"></i> Database</a></li>
            <li><a href="reports.html" id="reportsTab"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="autofails.html" id="autofailsTab" class="active"><i class="fas fa-exclamation-triangle"></i> Autofails</a></li>
            <li><a href="admin.html" id="adminTab"><i class="fas fa-user-cog"></i> Admin</a></li>
        </ul>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </nav>

    <div class="container mx-auto bg-white shadow-lg rounded-lg overflow-hidden max-w-5xl mt-8 mb-8" id="autofailsContent" style="display: none;">
        <div class="icealion-blue p-4 text-xl font-semibold text-center">
            Autofail Records
        </div>
        <div class="p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add New Autofail Record</h2>
            <form id="addAutofailForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div>
                    <label for="cerRole" class="block text-sm font-medium text-gray-700">CER Role</label>
                    <input type="text" id="cerRole" name="cerRole" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border" required>
                </div>
                <div>
                    <label for="cerName" class="block text-sm font-medium text-gray-700">CER Name</label>
                    <input type="text" id="cerName" name="cerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border" required>
                </div>
                <div>
                    <label for="contactId" class="block text-sm font-medium text-gray-700">Contact ID</label>
                    <input type="text" id="contactId" name="contactId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border" required>
                </div>
                <div>
                    <label for="autofailType" class="block text-sm font-medium text-gray-700">Autofail Type</label>
                    <input type="text" id="autofailType" name="autofailType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border" required>
                </div>
                <div class="md:col-span-2">
                    <label for="autofailReason" class="block text-sm font-medium text-gray-700">Reason for Autofail</label>
                    <textarea id="autofailReason" name="autofailReason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border" required></textarea>
                </div>
                <div class="md:col-span-2 text-right">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                        Add Autofail Record
                    </button>
                </div>
            </form>
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Existing Autofail Records</h2>
                <button id="generateReportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-file-csv mr-2"></i>Generate Autofail Report
                </button>
            </div>

            <div id="autofailTableContainer" class="overflow-x-auto max-h-[70vh]">
                <table class="autofail-table min-w-full">
                    <thead>
                        <tr>
                            <th>CER Role</th>
                            <th>CER Name</th>
                            <th>Overall Score</th>
                            <th>Contact ID</th>
                            <th>Evaluation Date</th>
                            <th>Autofail Type</th>
                            <th>Reason for Autofail</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="autofailRecordsTableBody">
                        <tr>
                            <td colspan="8" class="text-center py-4 text-gray-500">Loading autofail records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"; // Added signOut
        import { getFirestore, collection, getDocs, query, where, orderBy, limit, doc, updateDoc, deleteDoc, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js"; // Added getDoc

        // --- Your Web App's Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
          authDomain: "icea-lion-qa.firebaseapp.com",
          projectId: "icea-lion-qa",
          storageBucket: "icea-lion-qa.firebasestorage.app",
          messagingSenderId: "820082472004",
          appId: "1:820082472004:web:8caddf941e1b5b6dfaf811",
          measurementId: "G-1RJJTT3QET"
        };

        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        
        // Expose ALL necessary Firestore functions globally
        window.fsCollection = collection;
        window.fsGetDocs = getDocs; 
        window.fsQuery = query;
        window.fsWhere = where;
        window.fsOrderBy = orderBy;
        window.fsLimit = limit;
        window.fsDoc = doc; // For doc references
        window.fsUpdateDoc = updateDoc; // For updating documents
        window.fsDeleteDoc = deleteDoc; // For deleting documents
        window.fsAddDoc = addDoc; // For adding documents
        window.fsServerTimestamp = serverTimestamp; // For adding timestamps
        window.fsGetDoc = getDoc; // For getting a single doc

        window.currentUserId = null;
        window.currentUserRole = null; // Track current user's role
        window.isAuthReady = false;

        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase Auth State Changed: User logged in:", user.uid);
                // Fetch user role from Firestore
                const userDocRef = window.fsDoc(window.db, `artifacts/${appId}/users/${user.uid}`);
                try {
                    const userDocSnap = await window.fsGetDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        window.currentUserRole = userDocSnap.data().role;
                        console.log("User role fetched:", window.currentUserRole);
                    } else {
                        window.currentUserRole = 'Guest'; // Default if profile missing
                        console.warn("User profile not found in Firestore for UID:", user.uid, "Defaulting to Guest role.");
                    }
                } catch (error) {
                    console.error("Error fetching user role:", error);
                    window.currentUserRole = 'Guest';
                }
            } else {
                console.log("Firebase Auth State Changed: No user logged in. Attempting sign-in.");
                // Redirect to login page if no user or session not found
                window.location.href = 'admin.html'; // Assuming admin.html is your centralized login
                return; // Stop execution
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
        });

        // Define collection path
        window.EVALUATION_RECORDS_COLLECTION_PATH = `artifacts/${appId}/public/data/evaluation_records`;

    </script>
    <script>
        // --- GLOBAL DATA STORES ---
        let autofailRecords = []; // Stores records fetched for this page

        // --- UI ELEMENTS ---
        const loginPage = document.getElementById('loginPage');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');

        const mainNav = document.getElementById('mainNav');
        const autofailsTab = document.getElementById('autofailsTab');
        const logoutBtn = document.getElementById('logoutBtn');

        const autofailsContent = document.getElementById('autofailsContent');
        const autofailRecordsTableBody = document.getElementById('autofailRecordsTableBody');
        const generateReportBtn = document.getElementById('generateReportBtn'); // New: Report Button

        const addAutofailForm = document.getElementById('addAutofailForm');
        const cerRoleInput = document.getElementById('cerRole');
        const cerNameInput = document.getElementById('cerName');
        const contactIdInput = document.getElementById('contactId');
        const autofailTypeInput = document.getElementById('autofailType');
        const autofailReasonInput = document.getElementById('autofailReason');

        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxSpinner = document.getElementById('messageBoxSpinner');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');


        // --- MESSAGE BOX FUNCTIONS (replicated for self-contained page) ---
        function showMessageBox(title, message, isError = false, showSpinner = false, showCloseButton = true, onClose = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxOverlay.classList.remove('hidden');
            messageBoxSpinner.classList.toggle('hidden', !showSpinner);
            messageBoxCloseBtn.classList.toggle('hidden', !showCloseButton);

            if (isError) {
                messageBoxTitle.style.color = '#dc2626';
            } else {
                messageBoxTitle.style.color = '#1a73e8';
            }

            messageBoxCloseBtn.onclick = () => {
                messageBoxOverlay.classList.add('hidden');
                if (onClose) onClose();
            };
        }

        function hideMessageBox() {
            messageBoxOverlay.classList.add('hidden');
        }

        // --- DATABASE FETCH AND RENDER FUNCTIONS ---

        async function fetchAutofailRecords() {
            if (!window.db || !window.currentUserId) {
                showMessageBox("Authentication Required", "Please log in to view autofail records.", true, false, true);
                autofailRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Authentication required.</td></tr>';
                return;
            }
            if (window.currentUserRole !== 'Admin') { // Only Admin can view autofails
                showMessageBox("Access Denied", "You do not have permission to view this page.", true, false, true, () => {
                    window.location.href = 'index.html'; // Redirect to a page accessible by the user's role
                });
                autofailRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Access Denied. Only Admin can view autofails.</td></tr>';
                return;
            }
            if (!window.EVALUATION_RECORDS_COLLECTION_PATH) {
                showMessageBox("Configuration Error", "Database path not set up. Check Firebase configuration.", true, false, true);
                autofailRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Configuration Error.</td></tr>';
                return;
            }

            autofailRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Loading autofail records...</td></tr>';
            showMessageBox("Loading Records", "Fetching autofail records...", false, true, false);

            try {
                const recordsColRef = window.fsCollection(window.db, window.EVALUATION_RECORDS_COLLECTION_PATH);
                
                // Query records where 'Auto Fail Type' is not empty to identify autofails
                const q = window.fsQuery(
                    recordsColRef,
                    window.fsWhere('Auto Fail Type', '!=', ''), // Filter for records with an autofail type
                    window.fsOrderBy('Auto Fail Type', 'asc'), // First orderBy must be on the inequality field
                    window.fsOrderBy('submittedAt', 'desc')    // Then you can orderBy other fields
                );
                
                const querySnapshot = await window.fsGetDocs(q);
                autofailRecords = [];
                querySnapshot.forEach(doc => {
                    autofailRecords.push({ id: doc.id, ...doc.data() });
                });

                console.log(`Fetched ${autofailRecords.length} autofail records.`);
                renderAutofailTable(autofailRecords);
                hideMessageBox();

            } catch (error) {
                console.error("Error fetching autofail records:", error);
                autofailRecordsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Error loading records: ${error.message}</td></tr>`;
                showMessageBox("Error", `Failed to load autofail records: ${error.message}`, true, false, true);
            }
        }

        function renderAutofailTable(records) {
            autofailRecordsTableBody.innerHTML = ''; // Clear previous content

            if (records.length === 0) {
                autofailRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">No autofail records found.</td></tr>';
                return;
            }

            records.forEach(record => {
                const row = autofailRecordsTableBody.insertRow();
                row.className = 'border-b border-gray-200';
                row.innerHTML = `
                    <td class="py-2 px-4">${record['CER Role'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['CER Name'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['Total Pts.'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['Contact ID'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['Evaluation Date'] || (record.submittedAt ? new Date(record.submittedAt.toDate()).toLocaleDateString() : 'N/A')}</td>
                    <td class="py-2 px-4">${record['Auto Fail Type'] || 'N/A'}</td>
                    <td class="py-2 px-4">${record['Autofail Description'] || 'N/A'}</td>
                    <td class="py-2 px-4 whitespace-nowrap">
                        <button class="action-btn review-btn" data-id="${record.id}">Review</button>
                        <button class="action-btn delete-btn" data-id="${record.id}">Delete</button>
                        <button class="action-btn email-btn" data-id="${record.id}">Email</button>
                    </td>
                `;
            });

            // Attach event listeners to buttons
            document.querySelectorAll('.review-btn').forEach(button => {
                button.addEventListener('click', (e) => reviewAutofailRecord(e.target.dataset.id));
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteAutofailRecord(e.target.dataset.id));
            });
            document.querySelectorAll('.email-btn').forEach(button => {
                button.addEventListener('click', (e) => emailAutofailRecord(e.target.dataset.id));
            });
        }

        // --- ACTION BUTTON FUNCTIONS ---

        async function reviewAutofailRecord(recordId) {
            if (window.currentUserRole !== 'Admin') { // Restrict to Admin
                showMessageBox("Access Denied", "Only Admin users can review autofail records.", true, false, true);
                return;
            }
            const recordRef = window.fsDoc(window.db, window.EVALUATION_RECORDS_COLLECTION_PATH, recordId);
            showMessageBox("Reviewing Record", "Marking record as reviewed...", false, true, false);
            try {
                // To "review" and remove from autofail, we clear the autofail-related fields
                await window.fsUpdateDoc(recordRef, {
                    'Auto Fail Type': '',
                    'Autofail Description': '',
                    'Final Score': 'Reviewed' // Or adjust score as needed
                });
                showMessageBox("Success", "Record marked as reviewed.", false, false, true, () => {
                    fetchAutofailRecords(); // Refresh the list
                });
            } catch (error) {
                console.error("Error reviewing record:", error);
                showMessageBox("Error", `Failed to mark record as reviewed: ${error.message}`, true, false, true);
            }
        }

        async function deleteAutofailRecord(recordId) {
            if (window.currentUserRole !== 'Admin') { // Restrict to Admin
                showMessageBox("Access Denied", "Only Admin users can delete autofail records.", true, false, true);
                return;
            }
            const recordRef = window.fsDoc(window.db, window.EVALUATION_RECORDS_COLLECTION_PATH, recordId);
            showMessageBox("Confirm Delete", "Are you sure you want to delete this autofail record permanently?", false, false, false);
            
            // Create custom confirm/cancel buttons for the message box
            const confirmDeleteBtn = document.createElement('button');
            confirmDeleteBtn.textContent = 'Delete';
            confirmDeleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md mr-2';
            confirmDeleteBtn.onclick = async () => {
                hideMessageBox();
                showMessageBox("Deleting Record", "Deleting autofail record...", false, true, false);
                try {
                    await window.fsDeleteDoc(recordRef);
                    showMessageBox("Success", "Record deleted successfully.", false, false, true, () => {
                        fetchAutofailRecords(); // Refresh the list
                    });
                } catch (error) {
                    console.error("Error deleting record:", error);
                    showMessageBox("Error", `Failed to delete record: ${error.message}`, true, false, true);
                }
            };

            const cancelDeleteBtn = document.createElement('button');
            cancelDeleteBtn.textContent = 'Cancel';
            cancelDeleteBtn.className = 'bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md';
            cancelDeleteBtn.onclick = () => hideMessageBox();

            // Clear previous message box content and append new buttons
            messageBoxContent.innerHTML = 'Are you sure you want to delete this autofail record permanently?';
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-4';
            buttonContainer.appendChild(confirmDeleteBtn);
            buttonContainer.appendChild(cancelDeleteBtn);
            messageBoxContent.appendChild(buttonContainer);

            // Ensure the main close button is hidden when custom buttons are shown
            messageBoxCloseBtn.classList.add('hidden');
        }

        function emailAutofailRecord(recordId) {
            // Email functionality is usually for sending, not modifying/deleting,
            // so it can remain accessible to any role that can view autofails.
            // If you want to restrict email sending to Admin too, add a check here.
            const record = autofailRecords.find(r => r.id === recordId);
            if (!record) {
                showMessageBox("Error", "Record not found for email.", true, false, true);
                return;
            }

            const cerName = record['CER Name'] || 'N/A';
            const contactId = record['Contact ID'] || 'N/A';
            const autofailType = record['Auto Fail Type'] || 'N/A';
            const autofailDescription = record['Autofail Description'] || 'No description provided.';
            const overallScore = record['Total Pts.'] || 'N/A'; // Using 'Total Pts.' as 'Overall Score'
            const evaluationDate = record['Evaluation Date'] || (record.submittedAt ? new Date(record.submittedAt.toDate()).toLocaleDateString() : 'N/A');

            const subject = `Autofail Feedback - ${cerName} - Contact ID: ${contactId}`;
            const body = `Dear ${cerName},\n\n` +
                                     `This email is regarding an autofail detected in your recent evaluation.\n\n` +
                                     `Contact ID: ${contactId}\n` +
                                     `Evaluation Date: ${evaluationDate}\n` +
                                     `Overall Score: ${overallScore}\n` +
                                     `Autofail Type: ${autofailType}\n` +
                                     `Reason for Autofail: ${autofailDescription}\n\n` +
                                     `Please review this feedback and reach out to your supervisor for further discussion.\n\n` +
                                     `Kind Regards,\nQuality Evaluation Team`;

            const mailtoLink = `mailto:${cerName.replace(/\s/g, '').toLowerCase()}@icealion.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; // Example email, adjust as needed

            try {
                window.location.href = mailtoLink;
                showMessageBox("Email Client Opened", "Your email client should open shortly. Please review and send the email.", false, false, true);
            } catch (e) {
                console.error("Failed to open email client:", e);
                showMessageBox("Email Failed", "Could not open email client. Please try again or copy the details manually.", true, false, true);
            }
        }

        // --- ADD NEW AUTOFAIL RECORD FUNCTION ---
        async function addNewAutofailRecord(event) {
            event.preventDefault(); // Prevent default form submission

            if (window.currentUserRole !== 'Admin') { // Restrict to Admin
                showMessageBox("Access Denied", "Only Admin users can add new autofail records.", true, false, true);
                return;
            }

            if (!window.db || !window.currentUserId) {
                showMessageBox("Authentication Required", "Please log in to add autofail records.", true, false, true);
                return;
            }

            const newRecord = {
                'CER Role': cerRoleInput.value,
                'CER Name': cerNameInput.value,
                'Contact ID': contactIdInput.value,
                'Auto Fail Type': autofailTypeInput.value,
                'Autofail Description': autofailReasonInput.value,
                'Total Pts.': 'N/A', // New autofail records might not have an immediate overall score
                'Evaluation Date': new Date().toLocaleDateString(), // Capture current date
                submittedAt: window.fsServerTimestamp() // Firestore server timestamp
            };

            // Basic client-side validation
            if (!newRecord['CER Role'] || !newRecord['CER Name'] || !newRecord['Contact ID'] || !newRecord['Auto Fail Type'] || !newRecord['Autofail Description']) {
                showMessageBox("Missing Information", "All fields are required to add a new autofail record.", true, false, true);
                return;
            }


            showMessageBox("Adding Record", "Submitting new autofail record...", false, true, false);

            try {
                const recordsColRef = window.fsCollection(window.db, window.EVALUATION_RECORDS_COLLECTION_PATH);
                await window.fsAddDoc(recordsColRef, newRecord);

                showMessageBox("Success", "New autofail record added successfully!", false, false, true, () => {
                    addAutofailForm.reset(); // Clear the form
                    fetchAutofailRecords(); // Refresh the table
                });
            } catch (error) {
                console.error("Error adding new autofail record:", error);
                showMessageBox("Error", `Failed to add autofail record: ${error.message}`, true, false, true);
            }
        }

        // --- GENERATE AUTOFAIL REPORT FUNCTION ---
        function generateAutofailReport() {
            if (autofailRecords.length === 0) {
                showMessageBox("No Data", "There are no autofail records to generate a report.", false, false, true);
                return;
            }

            // Report generation doesn't modify data, so it might not need role restriction
            // if you want Supervisors to also generate reports.
            // If you want to restrict it to Admin, add:
            // if (window.currentUserRole !== 'Admin') {
            //     showMessageBox("Access Denied", "Only Admin users can generate autofail reports.", true, false, true);
            //     return;
            // }

            showMessageBox("Generating Report", "Preparing autofail report...", false, true, false);

            try {
                const headers = [
                    "CER Role", "CER Name", "Overall Score", "Contact ID", 
                    "Evaluation Date", "Autofail Type", "Reason for Autofail"
                ];

                const csvRows = [];
                csvRows.push(headers.map(header => `"${header}"`).join(',')); // Add quoted headers

                autofailRecords.forEach(record => {
                    const row = [
                        record['CER Role'] || '',
                        record['CER Name'] || '',
                        record['Total Pts.'] || '',
                        record['Contact ID'] || '',
                        record['Evaluation Date'] || (record.submittedAt ? new Date(record.submittedAt.toDate()).toLocaleDateString() : ''),
                        record['Auto Fail Type'] || '',
                        record['Autofail Description'] || ''
                    ];
                    // Escape double quotes and wrap each field in double quotes
                    csvRows.push(row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','));
                });

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `autofail_report_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link); // Append to body for Firefox compatibility
                link.click(); // Trigger download
                document.body.removeChild(link); // Clean up the link

                showMessageBox("Report Generated", "Autofail report downloaded successfully!", false, false, true);

            } catch (error) {
                console.error("Error generating report:", error);
                showMessageBox("Error", `Failed to generate report: ${error.message}`, true, false, true);
            }
        }


        // --- INITIALIZATION ---
        // Changed initializeAutofailsPage to wait for Firebase Auth to be ready
        function initializeAutofailsPage() {
            if (window.isAuthReady) {
                if (window.currentUserRole === 'Admin') {
                    loginPage.style.display = 'none';
                    mainNav.style.display = 'flex';
                    autofailsContent.style.display = 'block';
                    fetchAutofailRecords(); // Fetch records only if Admin
                } else {
                    // Redirect or show access denied message if not Admin
                    showMessageBox("Access Denied", "You must be logged in as an Admin to access this page. Redirecting...", true, false, true, () => {
                        window.location.href = 'admin.html'; // Or 'index.html'
                    });
                }
            } else {
                // If auth is not ready, wait for the event
                document.addEventListener('firebaseAuthReady', initializeAutofailsPage);
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Autofails DOM fully loaded and parsed.");

            // Initial check/redirect based on session storage and auth state
            // The `onAuthStateChanged` callback will handle the primary routing
            // after Firebase authentication determines the user's state and role.

            loginForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                loginMessage.classList.add('hidden');

                const enteredUsername = usernameInput.value;
                const enteredPassword = passwordInput.value;

                // IMPORTANT: In a real application, you would authenticate these credentials
                // against Firebase Authentication (e.g., signInWithEmailAndPassword).
                // For this example, we're using a hardcoded check for the "Admin" role.
                const ADMIN_USERNAME = 'Admin'; // Your actual admin username
                const ADMIN_PASSWORD = 'Admin'; // Your actual admin password

                if (enteredUsername === ADMIN_USERNAME && enteredPassword === ADMIN_PASSWORD) {
                    try {
                        // Assuming you have an Admin user set up in Firebase Authentication
                        // You might need a custom token generated from a backend,
                        // or directly sign in with email/password if using that.
                        // For simplicity in a client-side only example, if you just want
                        // to *simulate* an Admin login for the UI:
                        // This bypasses real Firebase Auth if initialAuthToken isn't present
                        // and relies on anonymous sign-in, then setting role.
                        // For production, this part should be securely handled.
                        
                        // For demonstration: If you have a dedicated Admin email/password
                        // you'd use signInWithEmailAndPassword here.
                        // Example:
                        // await signInWithEmailAndPassword(window.auth, 'admin@yourdomain.com', 'yourAdminPassword');
                        // Then your onAuthStateChanged listener would pick it up and fetch role.

                        // Since your current auth flow for this page relies on anonymous sign-in or custom token,
                        // and then checking role:
                        // For the purpose of getting into the Admin section if hardcoded credentials match,
                        // we can set a session flag and then rely on onAuthStateChanged to pick up the actual role.
                        // However, directly calling initializeAutofailsPage (which fetches role)
                        // might be better here to ensure the Firebase role is also 'Admin'.

                        // Instead of a direct hardcoded login that grants access,
                        // it's better to ensure this page only loads if Firebase auth confirms the user is Admin.
                        // This hardcoded check is only for UI access; real auth comes from Firebase.

                        sessionStorage.setItem('loggedIn', 'true');
                        // Instead of directly displaying, rely on onAuthStateChanged to redirect/display
                        // if the authenticated user's role is indeed 'Admin'.
                        // For this page, we're assuming the user has already successfully authenticated
                        // in `admin.html` or `index.html` and their session persists.
                        // The `onAuthStateChanged` at the top will handle role checking and page access.
                        initializeAutofailsPage(); // Trigger initial load logic again
                    } catch (error) {
                        console.error("Login simulation error:", error);
                        loginMessage.textContent = 'An error occurred during login. Please try again.';
                        loginMessage.classList.remove('hidden');
                    }

                } else {
                    loginMessage.textContent = 'Invalid Admin Username or Password. Please try again.';
                    loginMessage.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', async function() {
                sessionStorage.removeItem('loggedIn');
                await signOut(window.auth); // Sign out from Firebase
                window.location.href = 'admin.html'; // Redirect to a centralized login/admin page
            });

            // Listen for Firebase Auth readiness
            // This event ensures that currentUserId and currentUserRole are populated
            // before trying to fetch/render anything sensitive.
            document.addEventListener('firebaseAuthReady', initializeAutofailsPage);
            
            // If the DOM is already complete and auth is already ready (e.g., cached session),
            // call initializeAutofailsPage directly.
            if (document.readyState === 'complete' && window.isAuthReady) {
                initializeAutofailsPage();
            }

            // Add event listener for the new autofail form
            addAutofailForm.addEventListener('submit', addNewAutofailRecord);

            // New: Add event listener for the generate report button
            generateReportBtn.addEventListener('click', generateAutofailReport);
        });

    </script>
</body>
</html>
