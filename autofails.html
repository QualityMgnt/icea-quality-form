<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Quality Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }
        .top-header {
            background-color: #003366;
            color: white;
            padding: 1rem;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 64px;
        }
        .main-nav {
            background-color: #002347;
            color: white;
            position: fixed;
            top: 64px;
            left: 0;
            height: calc(100% - 64px);
            width: 256px;
            z-index: 999;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #004a8d;
        }
        .logout-button {
            background-color: #ff6f61;
            color: white;
        }
        main {
            padding-top: 80px;
            padding-left: 272px;
            padding-right: 16px;
            padding-bottom: 16px;
        }
        .dashboard-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .kpi-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .kpi-green { background-color: #10B981; }
        .kpi-amber { background-color: #F59E0B; }
        .kpi-red { background-color: #EF4444; }
        .hidden { display: none; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #0056b3;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">
    <header class="top-header flex items-center justify-center relative">
        <span class="text-xl font-semibold">ICEA LION ANALYTICS DASHBOARD</span>
        <img id="header-logo" src="https://placehold.co/150x60/FFFFFF/003366?text=Logo" alt="Company Logo" class="absolute right-4 h-12 w-auto">
    </header>

    <nav class="main-nav" id="mainNav">
        <div class="sidebar p-4 h-full flex flex-col">
            <ul class="flex-grow">
                <li class="nav-tab mb-2"><a href="home.html" class="flex items-center p-2 rounded-md"><i class="fas fa-home w-6 mr-2"></i> Home</a></li>
                <li class="nav-tab mb-2"><a href="Dashboard.html" class="flex items-center p-2 rounded-md"><i class="fas fa-chart-bar w-6 mr-2"></i> Dashboard</a></li>
                <li class="nav-tab mb-2"><a href="analytics.html" class="active flex items-center p-2 rounded-md"><i class="fas fa-chart-pie w-6 mr-2"></i> Analytics</a></li>
                <li class="nav-tab mb-2"><a href="index.html" class="flex items-center p-2 rounded-md"><i class="fas fa-file-alt w-6 mr-2"></i> Evaluation Form</a></li>
                <li class="nav-tab mb-2"><a href="autofails.html" class="flex items-center p-2 rounded-md"><i class="fas fa-exclamation-triangle w-6 mr-2"></i> Autofails</a></li>
                <li class="nav-tab mb-2"><a href="database.html" class="flex items-center p-2 rounded-md"><i class="fas fa-database w-6 mr-2"></i> Database</a></li>
            </ul>
            <button id="logoutBtn" class="logout-button w-full font-bold py-2 px-4 rounded-md shadow-md mt-auto">Logout</button>
        </div>
    </nav>

    <main id="mainContent">
        <div id="loadingMessage" class="flex flex-col items-center justify-center h-[calc(100vh-100px)]">
            <div class="spinner"></div>
            <p class="mt-4 text-lg text-gray-600">Loading Analytics...</p>
        </div>

        <div id="analyticsContent" class="hidden">
            <!-- Filters -->
            <div class="dashboard-card mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                    <div class="lg:col-span-1"><label class="text-sm font-medium">Start Date</label><input type="date" id="startDateFilter" class="p-2 border rounded-md w-full"></div>
                    <div class="lg:col-span-1"><label class="text-sm font-medium">End Date</label><input type="date" id="endDateFilter" class="p-2 border rounded-md w-full"></div>
                    <div class="lg:col-span-1"><label class="text-sm font-medium">Channel</label><select id="channelFilter" class="p-2 border rounded-md w-full"><option value="">All Channels</option></select></div>
                    <div class="lg:col-span-1"><label class="text-sm font-medium">CER Name</label><select id="cerNameFilter" class="p-2 border rounded-md w-full"><option value="">All Names</option></select></div>
                    <div class="lg:col-span-1"><label class="text-sm font-medium">CER Role</label><select id="cerRoleFilter" class="p-2 border rounded-md w-full"><option value="">All Roles</option></select></div>
                    <div class="flex gap-2">
                        <button id="applyFilters" class="bg-blue-600 text-white p-2 rounded-md w-full">Apply</button>
                        <button id="resetFilters" class="bg-gray-300 text-gray-700 p-2 rounded-md w-full">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Overall Quality Performance -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Overall Quality Performance</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="dashboard-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Average Quality Score</h3>
                        <p id="avgQualityScore" class="text-4xl font-bold mt-2">0%</p>
                    </div>
                    <div class="dashboard-card">
                        <canvas id="scoreByChannelChart" height="150"></canvas>
                    </div>
                    <div class="dashboard-card md:col-span-2">
                        <canvas id="scoreTrendChart" height="150"></canvas>
                    </div>
                </div>
            </section>

            <!-- Evaluation Insights -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Evaluation Insights</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="dashboard-card">
                        <h3 class="font-semibold mb-2">Evaluations Completed</h3>
                        <p id="evalsCompleted" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="dashboard-card" style="height: 5in;">
                        <h3 class="font-semibold mb-2">Pass vs Fail Rate</h3>
                        <canvas id="passFailChart"></canvas>
                    </div>
                    <div class="dashboard-card" style="height: 5in; overflow-y: auto;">
                        <h3 class="font-semibold mb-2">Top 5 Strength Areas</h3>
                        <ul id="strengthAreas" class="list-disc list-inside"></ul>
                    </div>
                </div>
            </section>

            <!-- Pass Rate Analysis by Role -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Pass Rate Analysis by Role</h2>
                <div class="dashboard-card overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead id="passRateByRoleHead"></thead>
                        <tbody id="passRateByRoleBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Pass Rate Analysis by Agent -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Pass Rate Analysis by Agent</h2>
                <div class="dashboard-card overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead id="passRateByAgentHead"></thead>
                        <tbody id="passRateByAgentBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Agent/Team Breakdown -->
            <section class="mb-8">
                 <h2 class="text-2xl font-bold mb-4">Agent & Team Breakdown</h2>
                 <div class="dashboard-card">
                    <h3 class="font-semibold mb-4">Agent Scorecards</h3>
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b">
                                <th class="p-2">Agent</th>
                                <th class="p-2">Score</th>
                                <th class="p-2">Trend</th>
                                <th class="p-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="agentScorecards"></tbody>
                    </table>
                 </div>
            </section>
            
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, doc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCw4nE6cvBJ9QmPp8wxyL-Jdm6hWQ0dVjs",
            authDomain: "icea-lion-qa.firebaseapp.com",
            projectId: "icea-lion-qa",
            storageBucket: "icea-lion-qa.appspot.com",
            messagingSenderId: "820082472004",
            appId: "1:820082472004:web:8caddf941e1b5b667faf811",
        };
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.appId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const EVALUATION_RECORDS_PATH = `artifacts/${appId}/public/data/evaluation_records`;
        const QUESTIONS_DOC_REF = doc(db, `artifacts/${appId}/public/data/questions`, 'question_configurations');

        let allEvaluations = [];
        let allQuestions = {};
        let charts = {};

        // --- Data Fetching and Processing ---
        async function fetchData() {
            const evalsSnapshot = await getDocs(query(collection(db, EVALUATION_RECORDS_PATH)));
            allEvaluations = evalsSnapshot.docs.map(doc => doc.data());
            
            const questionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/questions`));
            questionsSnapshot.forEach(doc => {
                allQuestions = {...allQuestions, ...doc.data()};
            });

            populateFilters(allEvaluations);
            processAndRenderAnalytics(allEvaluations);

            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('analyticsContent').classList.remove('hidden');
        }

        function populateFilters(data) {
            const cerNameFilter = document.getElementById('cerNameFilter');
            const cerRoleFilter = document.getElementById('cerRoleFilter');
            const channelFilter = document.getElementById('channelFilter');

            const names = [...new Set(data.map(r => r['CER Name']).filter(Boolean))];
            const roles = [...new Set(data.map(r => r['CER Role']).filter(Boolean))];
            const channels = [...new Set(data.map(r => r.channel || 'Unknown').filter(Boolean))];

            names.forEach(name => cerNameFilter.innerHTML += `<option value="${name}">${name}</option>`);
            roles.forEach(role => cerRoleFilter.innerHTML += `<option value="${role}">${role}</option>`);
            channels.forEach(channel => channelFilter.innerHTML += `<option value="${channel}">${channel}</option>`);
        }

        function processAndRenderAnalytics(data) {
            // ... (rest of the function remains the same)
            renderPassRateByRoleTable(data);
            renderPassRateByAgentTable(data);
        }
        
        // ... (rest of the chart and analytics functions)

        function renderPassRateByRoleTable(data) {
            const thead = document.getElementById('passRateByRoleHead');
            const tbody = document.getElementById('passRateByRoleBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const roles = [...new Set(data.map(r => r['CER Role']).filter(Boolean))].sort();
            
            let headerHtml = '<tr><th class="p-2 border">Question/Section</th>';
            roles.forEach(role => headerHtml += `<th class="p-2 border text-center">${role}</th>`);
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            Object.entries(allQuestions).forEach(([role, sections]) => {
                if(roles.includes(role)){
                    Object.entries(sections).forEach(([sectionName, questions]) => {
                        tbody.innerHTML += `<tr><td class="p-2 border font-bold bg-gray-100" colspan="${roles.length + 1}">${sectionName}</td></tr>`;
                        questions.forEach(q => {
                            let rowHtml = `<tr><td class="p-2 border">${q.desc}</td>`;
                            roles.forEach(r => {
                                const relevantEvals = data.filter(e => e['CER Role'] === r);
                                const questionRatings = relevantEvals.map(e => e[`${q.desc} (Rating)`]).filter(Boolean);
                                const passCount = questionRatings.filter(rating => rating === 'Yes').length;
                                const totalCount = questionRatings.length;
                                const passRate = totalCount > 0 ? ((passCount / totalCount) * 100).toFixed(1) : '-';
                                rowHtml += `<td class="p-2 border text-center">${passRate}%</td>`;
                            });
                            rowHtml += '</tr>';
                            tbody.innerHTML += rowHtml;
                        });
                    });
                }
            });
        }

        function renderPassRateByAgentTable(data) {
            const thead = document.getElementById('passRateByAgentHead');
            const tbody = document.getElementById('passRateByAgentBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const agents = [...new Set(data.map(r => r['CER Name']).filter(Boolean))].sort();
            
            let headerHtml = '<tr><th class="p-2 border">Question/Section</th>';
            agents.forEach(agent => headerHtml += `<th class="p-2 border text-center">${agent}</th>`);
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            const uniqueRolesInData = [...new Set(data.map(r => r['CER Role']))];

            uniqueRolesInData.forEach(role => {
                 if(allQuestions[role]){
                    Object.entries(allQuestions[role]).forEach(([sectionName, questions]) => {
                        tbody.innerHTML += `<tr><td class="p-2 border font-bold bg-gray-100" colspan="${agents.length + 1}">${sectionName}</td></tr>`;
                        questions.forEach(q => {
                            let rowHtml = `<tr><td class="p-2 border">${q.desc}</td>`;
                            agents.forEach(agent => {
                                const relevantEvals = data.filter(e => e['CER Name'] === agent);
                                const questionRatings = relevantEvals.map(e => e[`${q.desc} (Rating)`]).filter(Boolean);
                                const passCount = questionRatings.filter(rating => rating === 'Yes').length;
                                const totalCount = questionRatings.length;
                                const passRate = totalCount > 0 ? ((passCount / totalCount) * 100).toFixed(1) : '-';
                                rowHtml += `<td class="p-2 border text-center">${passRate}%</td>`;
                            });
                            rowHtml += '</tr>';
                            tbody.innerHTML += rowHtml;
                        });
                    });
                 }
            });
        }


        // --- Event Listeners ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                fetchData();
            } else {
                window.location.href = 'index.html';
            }
        });

        document.getElementById('applyFilters').addEventListener('click', () => {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            const channel = document.getElementById('channelFilter').value;
            const cerName = document.getElementById('cerNameFilter').value;
            const cerRole = document.getElementById('cerRoleFilter').value;
            
            let filteredData = allEvaluations;

            if (startDate) {
                filteredData = filteredData.filter(rec => new Date(rec['Evaluation Date']) >= new Date(startDate));
            }
            if (endDate) {
                filteredData = filteredData.filter(rec => new Date(rec['Evaluation Date']) <= new Date(endDate));
            }
            if (channel) {
                filteredData = filteredData.filter(rec => (rec.channel || 'Unknown') === channel);
            }
            if (cerName) {
                filteredData = filteredData.filter(r => r['CER Name'] === cerName);
            }
            if (cerRole) {
                filteredData = filteredData.filter(r => r['CER Role'] === cerRole);
            }
            processAndRenderAnalytics(filteredData);
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('channelFilter').value = '';
            document.getElementById('cerNameFilter').value = '';
            document.getElementById('cerRoleFilter').value = '';
            processAndRenderAnalytics(allEvaluations);
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

    </script>
</body>
</html>
